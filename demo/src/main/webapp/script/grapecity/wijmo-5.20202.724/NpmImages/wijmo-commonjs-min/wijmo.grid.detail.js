/*!
    *
    * Wijmo Library 5.20202.724
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(e,i){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,i){e.__proto__=i}||function(e,i){for(var t in i)i.hasOwnProperty(t)&&(e[t]=i[t])})(e,i)};return function(e,i){extendStatics(e,i);function __(){this.constructor=e}e.prototype=null===i?Object.create(i):(__.prototype=i.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var wijmo_1=require("wijmo/wijmo"),wijmo_grid_1=require("wijmo/wijmo.grid"),selfModule=require("wijmo/wijmo.grid.detail"),DetailRow=function(e){__extends(DetailRow,e);function DetailRow(i){var t=e.call(this)||this;t.isReadOnly=!0;return t}Object.defineProperty(DetailRow.prototype,"detail",{get:function(){return this._detail},set:function(e){this._detail=e},enumerable:!0,configurable:!0});return DetailRow}(wijmo_grid_1.Row);exports.DetailRow=DetailRow;var KeyAction,DetailVisibilityMode,DetailMergeManager=function(e){__extends(DetailMergeManager,e);function DetailMergeManager(i){return e.call(this,i)||this}DetailMergeManager.prototype.getMergedRange=function(i,t,o,r){void 0===r&&(r=!0);switch(i.cellType){case wijmo_grid_1.CellType.Cell:if(i.rows[t]instanceof DetailRow){i.columns.frozen>0&&i.grid&&(i.grid.cloneFrozenCells=!1);return new wijmo_grid_1.CellRange(t,0,t,i.columns.length-1)}break;case wijmo_grid_1.CellType.RowHeader:var l=i.rows.frozen;if(i.rows[t]instanceof DetailRow&&t!=l)return new wijmo_grid_1.CellRange(t-1,o,t,o);if(t<i.rows.length-1&&i.rows[t+1]instanceof DetailRow&&t!=l-1)return new wijmo_grid_1.CellRange(t,o,t+1,o)}return e.prototype.getMergedRange.call(this,i,t,o,r)};return DetailMergeManager}(wijmo_grid_1.MergeManager);exports.DetailMergeManager=DetailMergeManager;wijmo_1._addCultureInfo("FlexGridDetailProvider",{ariaLabels:{toggleDetail:"Toggle Row Detail"}});!function(e){e[e.None=0]="None";e[e.ToggleDetail=1]="ToggleDetail"}(KeyAction=exports.KeyAction||(exports.KeyAction={}));!function(e){e[e.Code=0]="Code";e[e.Selection=1]="Selection";e[e.ExpandSingle=2]="ExpandSingle";e[e.ExpandMulti=3]="ExpandMulti"}(DetailVisibilityMode=exports.DetailVisibilityMode||(exports.DetailVisibilityMode={}));var FlexGridDetailProvider=function(){function FlexGridDetailProvider(e,i){var t=this;this._mode=DetailVisibilityMode.ExpandSingle;this._animated=!1;this._keyActionEnter=KeyAction.None;this._g=e;e.mergeManager=new DetailMergeManager(e);e.rowHeaders.hostElement.addEventListener("click",this._hdrClick.bind(this));e.rowHeaders.hostElement.addEventListener("mousedown",(function(i){var o=e.editableCollectionView;if(e.activeEditor||o&&o.currentEditItem){t._hdrClick(i);i.preventDefault()}}));e.formatItem.addHandler(this._formatItem,this);e.selectionChanged.addHandler(this._selectionChanged,this);e.resizedRow.addHandler(this._resizedRow,this);e.loadingRows.addHandler((function(){return t.hideDetail()}));e.deletingRow.addHandler((function(e,i){t.hideDetail(i.row)}));e.updatedView.addHandler(this._handleFrozenCells,this);e.draggingRow.addHandler((function(e,i){if(i.row<e.rows.length-1&&e.rows[i.row+1]instanceof DetailRow){i.cancel=!0;t.hideDetail(i.row)}}));e.hostElement.addEventListener("keydown",(function(e){if(e.keyCode==wijmo_1.Key.Enter&&t._keyActionEnter==KeyAction.ToggleDetail){var i=t._g.selection.row;t._toggleRowDetail(i)&&e.preventDefault()}}),!0);e._root.addEventListener("scroll",(function(){wijmo_1.Control.refreshAll(e._root)}));wijmo_1.copy(this,i)}Object.defineProperty(FlexGridDetailProvider.prototype,"grid",{get:function(){return this._g},enumerable:!0,configurable:!0});Object.defineProperty(FlexGridDetailProvider.prototype,"detailVisibilityMode",{get:function(){return this._mode},set:function(e){if((e=wijmo_1.asEnum(e,DetailVisibilityMode))!=this._mode){this._mode=e;this.hideDetail();this._g.invalidate()}},enumerable:!0,configurable:!0});Object.defineProperty(FlexGridDetailProvider.prototype,"maxHeight",{get:function(){return this._maxHeight},set:function(e){if((e=wijmo_1.asNumber(e,!0))!=this._maxHeight){this._maxHeight=e;this.hideDetail()}},enumerable:!0,configurable:!0});Object.defineProperty(FlexGridDetailProvider.prototype,"isAnimated",{get:function(){return this._animated},set:function(e){e!=this._animated&&(this._animated=wijmo_1.asBoolean(e))},enumerable:!0,configurable:!0});Object.defineProperty(FlexGridDetailProvider.prototype,"keyActionEnter",{get:function(){return this._keyActionEnter},set:function(e){this._keyActionEnter=wijmo_1.asEnum(e,KeyAction)},enumerable:!0,configurable:!0});Object.defineProperty(FlexGridDetailProvider.prototype,"createDetailCell",{get:function(){return this._createDetailCellFn},set:function(e){this._createDetailCellFn=wijmo_1.asFunction(e,!0)},enumerable:!0,configurable:!0});Object.defineProperty(FlexGridDetailProvider.prototype,"disposeDetailCell",{get:function(){return this._disposeDetailCellFn},set:function(e){this._disposeDetailCellFn=wijmo_1.asFunction(e,!0)},enumerable:!0,configurable:!0});Object.defineProperty(FlexGridDetailProvider.prototype,"rowHasDetail",{get:function(){return this._rowHasDetailFn},set:function(e){if((e=wijmo_1.asFunction(e,!0))!=this._rowHasDetailFn){this._rowHasDetailFn=e;this.hideDetail();this._g.invalidate()}},enumerable:!0,configurable:!0});FlexGridDetailProvider.prototype.getDetailRow=function(e){var i=this._g.rows,t=this._toIndex(e),o=i[t];!(o instanceof DetailRow)&&t<i.length-1&&(o=i[t+1]);return o instanceof DetailRow?o:null};FlexGridDetailProvider.prototype.isDetailVisible=function(e){return null!=this.getDetailRow(e)};FlexGridDetailProvider.prototype.isDetailAvailable=function(e){e=this._toIndex(e);return this._hasDetail(e)};FlexGridDetailProvider.prototype.hideDetail=function(e){var i=this._g.rows;if(null!=e){var t=this._toIndex(e);!(i[t]instanceof DetailRow)&&t<i.length-1&&i[t+1]instanceof DetailRow&&t++;var o=i[t];if(o instanceof DetailRow){!!this.disposeDetailCell&&this.disposeDetailCell(o)||wijmo_1.Control.disposeAll(o.detail);i.removeAt(t)}}else for(var r=0;r<i.length;r++)i[r]instanceof DetailRow&&this.hideDetail(r)};FlexGridDetailProvider.prototype.showDetail=function(e,i){void 0===i&&(i=!1);var t=this._g,o=t.rows,r=this._toIndex(e);r>0&&o[r]instanceof DetailRow&&r--;if(i){for(var l=t.selection,n=!1,a=0;a<o.length-1;a++)if(a!=r&&o[a+1]instanceof DetailRow){this.hideDetail(a);a<r&&r--;if(a<l.row){l.row--;l.row2--;n=!0}}n&&t.select(l,!1)}if(!this.isDetailVisible(r)&&this._hasDetail(r)){var s=new DetailRow(o[r]),d=this._createDetailCell(o[r]);s.detail=d;if(d){o.insert(r+1,s);var c=t.containsFocus();if(this._animated){var _=d.style;_.transform="translateY(-100%)";_.opacity="0";wijmo_1.animate((function(e){if(e<1){_.transform="translateY("+(100*-(1-e)).toFixed(0)+"%)";_.opacity=(e*e).toString()}else{_.transform=_.opacity="";wijmo_1.Control.invalidateAll(d);c&&t.scrollIntoView(r+1,-1)}}))}else c&&t.scrollIntoView(r+1,-1,!0)}}};FlexGridDetailProvider.prototype._sizeDetailRow=function(e){var i=this._g,t=e.detail;wijmo_1.Control.refreshAll(t);var o=t.offsetHeight+i._cellPadVert+1,r=this._maxHeight;wijmo_1.isNumber(r)&&r>0&&o>r&&(o=r);e.height=o;t.style.height||(t.style.height="100%");var l=t.querySelector(".wj-flexgrid");l&&!l.style.height&&(l.style.height="100%")};FlexGridDetailProvider.prototype._handleFrozenCells=function(){var e=this._g,i=e.hostElement,t=wijmo_1.Control.getControl(i.querySelector(".wj-flexgrid"));if(t instanceof wijmo_grid_1.FlexGrid&&(t.frozenRows||t.frozenColumns)){wijmo_1.setCss([e._eTL,e._eBL,e._eCHdr,e._eCFtr,e._eRHdr,e._eMarquee],{zIndex:"13"});for(var o=i.querySelectorAll(".wj-frozen"),r=0;r<o.length;r++){var l=o[r];if(wijmo_1.closest(l,".wj-flexgrid")==i){var n=parseInt(l.style.zIndex);l.style.zIndex=(n%10+10).toString()}}}};FlexGridDetailProvider.prototype._toIndex=function(e){return e instanceof wijmo_grid_1.Row?e.index:wijmo_1.asNumber(e)};FlexGridDetailProvider.prototype._hdrClick=function(e){if(!e.defaultPrevented&&0==e.button&&wijmo_1.closestClass(e.target,FlexGridDetailProvider._WJC_DETAIL)){var i=DetailVisibilityMode;switch(this._mode){case i.ExpandMulti:case i.ExpandSingle:var t=this._g,o=t.hitTest(e.target);o.panel||(o=t.hitTest(e));o.panel&&this._toggleRowDetail(o.row)&&e.preventDefault()}}};FlexGridDetailProvider.prototype._toggleRowDetail=function(e){if(e>-1){if(this.isDetailVisible(e)){this.hideDetail(e);return!0}if(this._hasDetail(e)){var i=this._g;i.select(new wijmo_grid_1.CellRange(e,0,e,i.columns.length-1));this.showDetail(e,this._mode==DetailVisibilityMode.ExpandSingle);return!0}}return!1};FlexGridDetailProvider.prototype._selectionChanged=function(e,i){var t=this;if(this._mode==DetailVisibilityMode.Selection){this._toSel&&clearTimeout(this._toSel);this._toSel=setTimeout((function(){var i=e._selHdl.selection.row;i>-1?t.showDetail(i,!0):t.hideDetail()}),300)}};FlexGridDetailProvider.prototype._formatItem=function(e,i){var t=this._g,o=i.cell,r=i.getRow(),l=DetailVisibilityMode;if(i.panel==t.cells&&r instanceof DetailRow&&null!=r.detail&&!wijmo_1.hasClass(o,"wj-detail")){wijmo_1.addClass(o,"wj-detail");o.textContent="";o.style.textAlign=o.style.zIndex="";o.className=o.className.replace(/wj\-align\-[\S]+/g,"");o.appendChild(r.detail);null==r.height?this._sizeDetailRow(r):wijmo_1.Control.refreshAll(r.detail)}if(i.panel==t.rowHeaders&&0==i.col&&this._hasDetail(i.row)){o.style.cursor="";switch(this._mode){case l.ExpandMulti:case l.ExpandSingle:var n=t.rows[i.row+1]instanceof DetailRow,a=n?"minus":"plus",s=FlexGridDetailProvider._WJC_DETAIL;o.innerHTML='<div class="wj-btn wj-btn-glyph '+s+'" role="button" tabindex="-1"><span class="wj-glyph-'+a+'"></span></div>';var d=o.children[0],c=wijmo_1.culture.FlexGridDetailProvider.ariaLabels.toggleDetail;wijmo_1.setAriaLabel(d,c);wijmo_1.setAttribute(d,"aria-expanded",n)}}};FlexGridDetailProvider.prototype._resizedRow=function(e,i){var t=i.getRow();t instanceof DetailRow&&t.detail&&wijmo_1.Control.refreshAll(t.detail)};FlexGridDetailProvider.prototype._hasDetail=function(e){var i=this._g.rows[e];return wijmo_1.isFunction(this._rowHasDetailFn)?this._rowHasDetailFn(i):this._isRegularRow(i)};FlexGridDetailProvider.prototype._isRegularRow=function(e){return!(e instanceof wijmo_grid_1._NewRowTemplate||e instanceof DetailRow)&&!(e instanceof wijmo_grid_1.GroupRow&&!this._g.childItemsPath)};FlexGridDetailProvider.prototype._createDetailCell=function(e){return this.createDetailCell?this.createDetailCell(e):null};FlexGridDetailProvider._WJC_DETAIL="wj-elem-detail";return FlexGridDetailProvider}();exports.FlexGridDetailProvider=FlexGridDetailProvider;wijmo_1._registerModule("wijmo.grid.detail",selfModule);