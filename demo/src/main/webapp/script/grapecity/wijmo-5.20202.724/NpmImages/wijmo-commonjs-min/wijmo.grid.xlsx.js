/*!
    *
    * Wijmo Library 5.20202.724
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(e,l){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,l){e.__proto__=l}||function(e,l){for(var o in l)l.hasOwnProperty(o)&&(e[o]=l[o])})(e,l)};return function(e,l){extendStatics(e,l);function __(){this.constructor=e}e.prototype=null===l?Object.create(l):(__.prototype=l.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var wijmo_1=require("wijmo/wijmo"),wijmo_grid_1=require("wijmo/wijmo.grid"),mXlsx=require("wijmo/wijmo.xlsx"),selfModule=require("wijmo/wijmo.grid.xlsx");function softDetail(){return wijmo_1._getModule("wijmo.grid.detail")}exports.softDetail=softDetail;function softMultiRow(){return wijmo_1._getModule("wijmo.grid.multirow")}exports.softMultiRow=softMultiRow;function softTransposed(){return wijmo_1._getModule("wijmo.grid.transposed")}exports.softTransposed=softTransposed;function softTransposedMultiRow(){return wijmo_1._getModule("wijmo.grid.transposedmultirow")}exports.softTransposedMultiRow=softTransposedMultiRow;var FlexGridXlsxConverter=function(){function FlexGridXlsxConverter(){}FlexGridXlsxConverter.save=function(e,l,o){var t=new mXlsx.Workbook;this._saveFlexGridToWorkbook(t,e,l,!1,null);o&&t.save(o);return t};FlexGridXlsxConverter.saveAsync=function(e,l,o,t,r,n,s){var i=this,a=new mXlsx.Workbook;if(!s){this._saveFlexGridToWorkbook(a,e,l,!1,null);o?a.saveAsync(o,(function(e){wijmo_1.isFunction(t)&&t(e,a)}),r,null):wijmo_1.isFunction(t)&&t(null,a);return a}var u=null!=o;this.cancelAsync((function(){var s,d=[e.collectionView&&e.collectionView.collectionChanged,e.columns&&e.columns.collectionChanged,e.rows&&e.rows.collectionChanged,e.resizedColumn,e.resizedRow],removeHandlers=function(){return d.forEach((function(e){e&&e.removeHandler(restart)}))},restart=function(){i._cs&&i._cs.cancel(!1);clearTimeout(s);s=setTimeout((function(){removeHandlers();a=null;i.saveAsync(e,l,o,t,r,n)}),100)},finish=function(){clearTimeout(s);i._cs=null;removeHandlers()};i._cs=new mXlsx._SyncPromise(null,finish);d.forEach((function(e){e&&e.addHandler(restart)}));i._saveFlexGridToWorkbook(a,e,l,!0,i._cs,(function(e){wijmo_1.isFunction(n)&&n(u?Math.round(mXlsx._map(e,0,100,0,50)):e)})).then((function(){if(o){a._externalCancellation=function(){return i._cs};a.saveAsync(o,(function(e){finish();wijmo_1.isFunction(t)&&t(e,a)}),(function(e){finish();wijmo_1.isFunction(r)&&r(e)}),(function(e){wijmo_1.isFunction(n)&&n(Math.round(mXlsx._map(e,0,100,51,100)))}))}else{finish();wijmo_1.isFunction(n)&&n(100);wijmo_1.isFunction(t)&&t(null,a)}}),(function(e){finish();throw e}))}));return null};FlexGridXlsxConverter.cancelAsync=function(e){var l=this;if(this._cs){this._cs.cancel();setTimeout((function(){l._cs=null;wijmo_1.isFunction(e)&&e()}),100)}else wijmo_1.isFunction(e)&&e()};FlexGridXlsxConverter.load=function(e,l,o){var t=this;if(l instanceof Blob){var r=new FileReader;r.onload=function(){var l=mXlsx.Workbook._base64EncArr(new Uint8Array(r.result)),n=new mXlsx.Workbook;n.load(l);l=null;e.deferUpdate((function(){t._loadToFlexGrid(e,n,o);n=null}))};r.readAsArrayBuffer(l)}else if(l instanceof mXlsx.Workbook)e.deferUpdate((function(){t._loadToFlexGrid(e,l,o);l=null}));else{if(l instanceof ArrayBuffer)l=mXlsx.Workbook._base64EncArr(new Uint8Array(l));else if(!wijmo_1.isString(l))throw"Invalid workbook.";var n=new mXlsx.Workbook;n.load(l);l=null;e.deferUpdate((function(){t._loadToFlexGrid(e,n,o);n=null}))}};FlexGridXlsxConverter.loadAsync=function(e,l,o,t,r){var n=this;if(l instanceof Blob){var s=new FileReader;s.onload=function(){var l=mXlsx.Workbook._base64EncArr(new Uint8Array(s.result)),i=new mXlsx.Workbook;i.loadAsync(l,(function(r){l=null;i=null;e.deferUpdate((function(){n._loadToFlexGrid(e,r,o);t&&t(r);r=null}))}),r)};s.readAsArrayBuffer(l)}else if(l instanceof mXlsx.Workbook)e.deferUpdate((function(){n._loadToFlexGrid(e,l,o);t&&t(l);l=null}));else{if(l instanceof ArrayBuffer)l=mXlsx.Workbook._base64EncArr(new Uint8Array(l));else if(!wijmo_1.isString(l))throw"Invalid workbook.";(new mXlsx.Workbook).loadAsync(l,(function(r){l=null;e.deferUpdate((function(){n._loadToFlexGrid(e,r,o);t&&t(r);r=null}))}),r)}};FlexGridXlsxConverter._saveFlexGridToWorkbook=function(e,l,o,t,r,n){var s,i=this,a=new mXlsx._SyncPromise(r),u=new mXlsx.WorkSheet,d=!o||null==o.includeColumnHeaders||o.includeColumnHeaders,c=!(!o||null==o.includeRowHeaders)&&o.includeRowHeaders,f=_IncludeCellStyles.Cache,m=o?o.includeColumns:null,h=o?o.formatItem:null,p=0,_=c?l.rowHeaders.columns.length:0,w=[];o&&(f=!1===wijmo_1.asBoolean(o.includeCellStyles,!0)?_IncludeCellStyles.None:!1===wijmo_1.asBoolean(o.quickCellStyles,!0)?_IncludeCellStyles.Regular:_IncludeCellStyles.Cache);var x=f===_IncludeCellStyles.Cache?new _StyleCache(500):null;null==this.hasCssText&&(this.hasCssText="cssText"in document.body.style);var g,y=l.wj_sheetInfo;u.name=o?o.sheetName:"";u.visible=!o||!1!==o.sheetVisible;if(y&&y.tables&&y.tables.length>0)for(var v=0;v<y.tables.length;v++)u.tables.push(y.tables[v]);s=[];if(!y&&(f!==_IncludeCellStyles.None||h)){(g=document.createElement("div")).style.visibility="hidden";g.setAttribute(wijmo_grid_1.FlexGrid._WJS_MEASURE,"true");l.hostElement.appendChild(g)}(c?[l.rowHeaders,l.columnHeaders]:[l.columnHeaders]).forEach((function(e){for(var o=e.rows,t=e.columns,r=0,n=e.cellType===wijmo_grid_1.CellType.ColumnHeader?_:0,a=0;a<o.length;a++)if(!(o[a].renderSize<=0)){s[r]||(s[r]=[]);for(var c=0,f=0;c<t.length;c++){var h=l._getBindingColumn(e,a,t[c]),w=i._getColumnSetting(h,c,t);if(w){s[r][n+c]=w;if(0===r){if(e.cellType===wijmo_grid_1.CellType.ColumnHeader&&m&&!m(h))continue;var x=new mXlsx.WorkbookColumn;x._deserialize(w);u._addWorkbookColumn(x,n+f++)}}}r++}e.cellType===wijmo_grid_1.CellType.ColumnHeader&&(p=d?r:0)}));var C=[[l.topLeftCells,l.columnHeaders],[l.rowHeaders,l.cells],[l.bottomLeftCells,l.columnFooters]];d||C.shift();var b=C.map((function(e){return e[1].rows.length})).reduce((function(e,l){return e+l}));this._saveContentToWorksheet(r,t,Date.now(),0,{panels:C,panelIdx:0,globRowIdx:0,rowsOffset:0,totalRows:b},l,u,c,s,f,g,w,x,m,h,(function(e){n(Math.round(e/b*100))}),(function(){var t=new mXlsx.WorkbookFrozenPane;t.rows=d?l.frozenRows+p:l.frozenRows;t.columns=c?l.frozenColumns+_:l.frozenColumns;u.frozenPane=t;e._addWorkSheet(u);if(!y&&(f!==_IncludeCellStyles.None||h)){l.hostElement.removeChild(g);w.forEach((function(e){return e.forEach((function(e){e&&e.parentElement&&e.parentElement.removeChild(e)}))}))}x&&x.clear();e.activeWorksheet=o?o.activeWorksheet:null;a.resolve()}));return a};FlexGridXlsxConverter._saveContentToWorksheet=function(e,l,o,t,r,n,s,i,a,u,d,c,f,m,h,p,_){for(var w=this,x=u?20:200,_loop_1=function(y){if(e&&e.cancelled)return{value:void 0};if(l&&y-t>x&&Date.now()-o>100){setTimeout((function(){if(!e||!e.cancelled){p(y);w._saveContentToWorksheet(e,l,Date.now(),y,r,n,s,i,a,u,d,c,f,m,h,p,_)}}),0);return{value:void 0}}for(;y-r.rowsOffset>=r.panels[r.panelIdx][1].rows.length;){r.rowsOffset+=r.panels[r.panelIdx][1].rows.length;r.panelIdx++}var v=r.panels[r.panelIdx],C=v[0],b=v[1],S=y-r.rowsOffset,X=b.rows[S];if(b.cellType!==wijmo_grid_1.CellType.Cell&&X.renderSize<=0||X instanceof wijmo_grid_1._NewRowTemplate)return"continue";var T=0,j={},k=new mXlsx.WorkbookRow,F=X instanceof wijmo_grid_1.GroupRow,R=0;b.cellType===wijmo_grid_1.CellType.Cell&&(F?R=X.level:n.rows.maxGroupLevel>-1&&(R=n.rows.maxGroupLevel+1));i&&(T=g._parseFlexGridRowToSheetRow(C,j,S,0,a,u,d,c,f,F,R,m,h));g._parseFlexGridRowToSheetRow(b,j,S,T,a,u,d,c,f,F,R,m,h);if(j.cells.length>0){k._deserialize(j);s._addWorkbookRow(k,r.globRowIdx)}r.globRowIdx++},g=this,y=t;y<r.totalRows;y++){var v=_loop_1(y);if("object"==typeof v)return v.value}wijmo_1.isFunction(_)&&_()};FlexGridXlsxConverter._loadToFlexGrid=function(e,l,o){if(softTransposedMultiRow()&&e instanceof softTransposedMultiRow().TransposedMultiRow)throw"Not supported.";o=o||{};var t,r=null!=e.wj_sheetInfo,n={},s=[],i=[],a={};e.itemsSource=null;e.columns.clear();e.columnHeaders.rows.clear();e.rowHeaders.columns.clear();e.rows.clear();e.frozenColumns=0;e.frozenRows=0;var u=null==o.sheetIndex||isNaN(o.sheetIndex)?0:o.sheetIndex;if(u<0||u>=l.sheets.length)throw"The sheet index option is out of the sheet range of current workbook.";if(null!=o.sheetName)for(var d=0;d<l.sheets.length;d++)if(o.sheetName===l.sheets[d].name){t=l.sheets[d];break}if(null!=(t=t||l.sheets[u]).rows){for(var c=this._getColumnCount(t.rows),f=this._getRowCount(t.rows,c),m=t.columns,h=0;h<c;h++){e.columns.push(new wijmo_grid_1.Column);if(m[h]){isNaN(+m[h].width)||(e.columns[h].width=+m[h].width);m[h].visible||null==m[h].visible||(e.columns[h].visible=!!m[h].visible);m[h].style&&m[h].style.wordWrap&&(e.columns[h].wordWrap=m[h].style.wordWrap)}}var p,_=(null==o.includeColumnHeaders||o.includeColumnHeaders)&&t.rows.length>0,w=_?this._getColumnHeadersHeight(t):0,x=!1,g=[],y=t.frozenPane&&t.frozenPane.rows,v=t.frozenPane&&t.frozenPane.columns;y=wijmo_1.isNumber(y)&&!isNaN(y)?y:null;v=wijmo_1.isNumber(v)&&!isNaN(v)?v:null;for(var C=w;C<f;C++){var b=!1,S=null,X=t.rows[C];if(X)for(var T=C+1;T<t.rows.length;){var j=t.rows[T];if(j){(isNaN(X.groupLevel)&&!isNaN(j.groupLevel)||!isNaN(X.groupLevel)&&X.groupLevel<j.groupLevel)&&(b=!0);break}T++}if(b&&!t.summaryBelow){p&&(p.isCollapsed=x);(p=new wijmo_grid_1.GroupRow).isReadOnly=!1;x=null!=X.collapsed&&X.collapsed;p.level=isNaN(X.groupLevel)?0:X.groupLevel;a[p.level]=x;this._checkParentCollapsed(a,p.level)&&p._setFlag(wijmo_grid_1.RowColFlags.ParentCollapsed,!0);e.rows.push(p)}else{var k=new wijmo_grid_1.Row;X&&this._checkParentCollapsed(a,X.groupLevel)&&k._setFlag(wijmo_grid_1.RowColFlags.ParentCollapsed,!0);e.rows.push(k)}X&&X.height&&!isNaN(X.height)&&(e.rows[C-w].height=X.height);for(h=0;h<c;h++)if(X){var F=X.cells[h],R=F?F.formula:null;R&&"="!==R[0]&&(R="="+R);if(F&&F.textRuns&&F.textRuns.length>0){e.rows[C-w].isContentHtml=!0;e.setCellData(C-w,h,this._parseTextRunsToHTML(F.textRuns))}else e.setCellData(C-w,h,R&&r?R:this._getItemValue(F));b||this._setColumn(g,h,F);var A=C*c+h,W=F?F.style:null,G=mXlsx.Workbook._parseExcelFormat(F),I=void 0;if(W){S=null==S?!!W.wordWrap:S&&!!W.wordWrap;if(W.hAlign)I=mXlsx.Workbook._parseHAlignToString(wijmo_1.asEnum(W.hAlign,mXlsx.HAlign));else switch(this._getItemType(F)){case wijmo_1.DataType.Number:I="right";break;case wijmo_1.DataType.Boolean:I="center";break;default:I=G&&0===G.search(/[n,c,p]/i)?"right":"left"}n[A]={fontWeight:W.font&&W.font.bold?"bold":"none",fontStyle:W.font&&W.font.italic?"italic":"none",textDecoration:W.font&&W.font.underline?"underline":"none",textAlign:I,fontFamily:W.font&&W.font.family?W.font.family:"",fontSize:W.font&&W.font.size?W.font.size+"px":"",color:W.font&&W.font.color?W.font.color:"",backgroundColor:W.fill&&W.fill.color?W.fill.color:"",whiteSpace:W.wordWrap?"pre-wrap":"normal",format:G};if(W.borders){if(W.borders.left){this._parseBorderStyle(W.borders.left.style,"Left",n[A]);n[A].borderLeftColor=W.borders.left.color}if(W.borders.right){this._parseBorderStyle(W.borders.right.style,"Right",n[A]);n[A].borderRightColor=W.borders.right.color}if(W.borders.top){this._parseBorderStyle(W.borders.top.style,"Top",n[A]);n[A].borderTopColor=W.borders.top.color}if(W.borders.bottom){this._parseBorderStyle(W.borders.bottom.style,"Bottom",n[A]);n[A].borderBottomColor=W.borders.bottom.color}}if(W.fill&&W.fill.color){var E=n[A],D=W.borders,N=W.fill.color;if(D){D.left&&D.left.color||(E.borderLeftColor=N);D.right&&D.right.color||h===v-1||(E.borderRightColor=N);D.top&&D.top.color||(E.borderTopColor=N);D.bottom&&D.bottom.color||C===y-1||(E.borderBottomColor=N)}else{E.borderLeftColor=N;h!==v-1&&(E.borderRightColor=N);E.borderTopColor=N;C!==y-1&&(E.borderBottomColor=N)}}W.font&&-1===i.indexOf(W.font.family)&&i.push(W.font.family)}F&&wijmo_1.isNumber(F.rowSpan)&&F.rowSpan>0&&wijmo_1.isNumber(F.colSpan)&&F.colSpan>0&&(F.rowSpan>1||F.colSpan>1)&&s.push(new wijmo_grid_1.CellRange(C,h,C+F.rowSpan-1,h+F.colSpan-1))}if(X){this._checkParentCollapsed(a,X.groupLevel)||X.visible||null==X.visible||(e.rows[C-w].visible=X.visible);e.rows[C-w].wordWrap=!!X.style&&!!X.style.wordWrap||!!S}}p&&(p.isCollapsed=x);null!=v&&(e.frozenColumns=v);null!=y&&(e.frozenRows=_&&y>0?y-1:y);for(h=0;h<e.columnHeaders.columns.length;h++){var B=g[h],H=e.columns[h];H.isRequired=!1;if(B){B.dataType===wijmo_1.DataType.Boolean&&(H.dataType=B.dataType);H.format=B.format;H.align=B.hAlign;H.wordWrap=H.wordWrap||!!B.wordWrap}}for(d=0;d<Math.max(w,1);d++)e.columnHeaders.rows.push(new wijmo_grid_1.Row);var M=Object.keys(t.rows);for(d=0;d<w;d++)for(var z=0;z<e.columnHeaders.columns.length;z++){var O=t.rows[M[d]].cells[z],L=O&&O.value||"",P=e.columnHeaders.columns[z];if(L){var V=mXlsx.Workbook._parseExcelFormat(O);L=wijmo_1.Globalize.format(L,V)}P.header=P.header||L;e.columnHeaders.setCellData(d,z,L)}if(r){var U=null==o.sheetVisible||o.sheetVisible;e.wj_sheetInfo.name=t.name;e.wj_sheetInfo.visible=!0===U||!1!==t.visible;e.wj_sheetInfo.styledCells=n;e.wj_sheetInfo.mergedRanges=s;e.wj_sheetInfo.fonts=i;e.wj_sheetInfo.tables=t.tables}}};FlexGridXlsxConverter._getColumnHeadersHeight=function(e){if(!e&&!e.rows.length)return 0;for(var l=1,o=0;o<e.rows.length;o++){var t=e.rows[o];if(t){t.cells.forEach((function(e){l=Math.max(l,e.rowSpan||0)}));break}}return l};FlexGridXlsxConverter._escapePlainText=function(e){return null==e?"":""===e?"'":e&&("'"===e[0]||e.length>1&&"="===e[0]&&"="===e[1])?"'"+e:e};FlexGridXlsxConverter._parseFlexGridRowToSheetRow=function(e,l,o,t,r,n,s,i,a,u,d,c,f){var m,h,p,_,w,x,g,y,v,C,b,S,X,T,j,k,F,R,A,W,G,I,E,D,N,B,H,M,z,O,L=!1,P=!1;(A=(m=e.grid).wj_sheetInfo)&&(W=A.evaluateFormula);if(null==(h=e.rows[o]).recordIndex){D=0;e.cellType===wijmo_grid_1.CellType.ColumnHeader&&e.rows.length>1&&(D=o===r.length?o-1:o)}else D=h.recordIndex;l.cells||(l.cells=[]);l.visible=h.isVisible;l.height=h.renderHeight||e.rows.defaultSize;l.groupLevel=d;u&&(l.collapsed=h.isCollapsed);h.wordWrap&&(l.style={wordWrap:h.wordWrap});(h.constructor===wijmo_grid_1.Row||h.constructor===wijmo_grid_1._NewRowTemplate||softTransposed()&&m instanceof softTransposed().TransposedGrid&&h instanceof wijmo_grid_1.Row||softDetail()&&h.constructor===softDetail().DetailRow||softMultiRow()&&h.constructor===softMultiRow()._MultiRow||softTransposedMultiRow()&&h instanceof softTransposedMultiRow()._MultiRow)&&(L=!0);softDetail()&&h.constructor===softDetail().DetailRow&&(P=!0);for(_=0;_<e.columns.length;_++){w=null;R=1;F=1;z=0;E=!1;j=null;null;B=null;y=null;I=m._getBindingColumn(e,o,e.columns[_]);k=null;if(A&&e===m.cells){T=o*e.columns.length+_;A.mergedRanges&&(k=this._getMergedRange(o,_,A.mergedRanges));A.styledCells&&(j=A.styledCells[T])}else if(n!==_IncludeCellStyles.None){B=this._getMeasureCell(e,_,s,i);j=(k=m.getMergedRange(e,o,_,!1))?this._getCellStyle(e,B,k.bottomRow,k.rightCol,a)||{}:this._getCellStyle(e,B,o,_,a)||{}}k||(k=m.getMergedRange(e,o,_,!1));if(k){if(o===k.topRow&&_===k.leftCol){F=k.bottomRow-k.topRow+1;R=this._getColSpan(e,k,c);E=!0}}else E=!0;if(!c||c(I)){p=r[D]?r[D][_+t]:null;if(L||u){g=E?e.getCellData(o,_,!0):null;v=E?e.getCellData(o,_,!1):null;b=this._isFormula(g);X=null;G=wijmo_1.isDate(v);if(j&&j.format){w=j.format;/[hsmyt\:]/i.test(w)&&(G=!0);x=mXlsx.Workbook._parseCellFormat(j.format,G)}else if(p&&p.style&&p.style.format){w=I.format;x=p.style.format}else x=null;b&&null!=W&&wijmo_1.isFunction(W)&&(X=W(g));if(!x)if(G)x="m/d/yyyy";else if(wijmo_1.isNumber(v)&&!I.dataMap)x=wijmo_1.isInt(v)?"#,##0":"#,##0.00";else if(b){if((S=g.toLowerCase()).indexOf("now()")>-1){x="m/d/yyyy h:mm";G=!0}else if(S.indexOf("today()")>-1||S.indexOf("date(")>-1){x="m/d/yyyy";G=!0}else if(S.indexOf("time(")>-1){x="h:mm AM/PM";G=!0}}else x="General"}else{g=E?m.columnHeaders.getCellData(0,_,!0):null;x="General"}if(wijmo_1.isString(g)&&-1!==g.indexOf("<span")){y=this._parseToTextRuns(g);g=null}H=this._parseCellStyle(j)||{};if(e===m.cells&&u&&h.hasChildren&&_===m.columns.firstVisibleIndex){b&&null!=X?C=X:g?C=g:E&&(C=h.getGroupHeader().replace(/<\/?\w+>/g,"").replace(/&#39;/g,"'"));if(null==C&&!j)continue;!(G=wijmo_1.isDate(C))&&w&&"d"===w.toLowerCase()&&wijmo_1.isInt(C)&&(x="0");C=wijmo_1.isString(C)?mXlsx.Workbook._unescapeXML(C):C;_===m.columns.firstVisibleIndex&&m.treeIndent&&(z=d);N={value:C,isDate:G,formula:b?this._parseToExcelFormula(g,G):null,colSpan:R,rowSpan:F,style:this._extend(H,{format:x,font:{bold:!0},hAlign:mXlsx.HAlign.Left,indent:z}),textRuns:y}}else{g=wijmo_1.isString(g)?mXlsx.Workbook._unescapeXML(g):g;v=wijmo_1.isString(v)?mXlsx.Workbook._unescapeXML(v):v;!G&&w&&"d"===w.toLowerCase()&&wijmo_1.isInt(v)&&(x="0");M=H&&H.hAlign?H.hAlign:p&&p.style&&null!=p.style.hAlign?wijmo_1.asEnum(p.style.hAlign,mXlsx.HAlign,!0):wijmo_1.isDate(v)?mXlsx.HAlign.Left:mXlsx.HAlign.General;_!==m.columns.firstVisibleIndex||!m.treeIndent||M!==mXlsx.HAlign.Left&&M!==mXlsx.HAlign.General||(z=d);N={value:b?X:"General"!==x||""===g&&null==v?this._escapePlainText(v):this._escapePlainText(g),isDate:G,formula:b?this._parseToExcelFormula(g,G):null,colSpan:_<m.columns.firstVisibleIndex?1:R,rowSpan:F,style:this._extend(H,{format:x,hAlign:M,vAlign:F>1?e===m.cells||!1===m.centerHeadersVertically?mXlsx.VAlign.Top:mXlsx.VAlign.Center:null,indent:z}),textRuns:y};P&&(O=e.getCellElement(o,_))&&O.appendChild(h.detail)}f&&f(new XlsxFormatItemEventArgs(e,new wijmo_grid_1.CellRange(o,_),B,s,i,a,N));l.cells.push(N)}}return t+_};FlexGridXlsxConverter._parseCellStyle=function(e,l){void 0===l&&(l=!1);if(null==e)return null;var o=e.fontSize;o=o?+o.substring(0,o.indexOf("px")):null;isNaN(o)&&(o=null);var t=e.fontWeight;t="bold"===t||+t>=700;var r="italic"===e.fontStyle,n=e.textDecorationStyle;null==n&&(n=e.textDecoration);n="underline"===n;var s=e.whiteSpace;s=!!s&&s.indexOf("pre")>-1;return{font:{bold:t,italic:r,underline:n,family:this._parseToExcelFontFamily(e.fontFamily),size:o,color:e.color},fill:{color:e.backgroundColor},borders:this._parseBorder(e,l),hAlign:mXlsx.Workbook._parseStringToHAlign(e.textAlign),wordWrap:s}};FlexGridXlsxConverter._parseBorder=function(e,l){var o={};o.left=this._parseEgdeBorder(e,"Left");o.right=this._parseEgdeBorder(e,"Right");o.top=this._parseEgdeBorder(e,"Top");o.bottom=this._parseEgdeBorder(e,"Bottom");if(l){o.vertical=this._parseEgdeBorder(e,"Vertical");o.horizontal=this._parseEgdeBorder(e,"Horizontal")}return o};FlexGridXlsxConverter._parseEgdeBorder=function(e,l){var o,t=e["border"+l+"Style"],r=e["border"+l+"Width"];r&&(r=parseFloat(r));if(t&&"none"!==t&&"hidden"!==t&&0!==r){o={};switch(t=t.toLowerCase()){case"dotted":o.style=r>1?mXlsx.BorderStyle.MediumDashDotted:mXlsx.BorderStyle.Dotted;break;case"dashed":o.style=r>1?mXlsx.BorderStyle.MediumDashed:mXlsx.BorderStyle.Dashed;break;case"double":o.style=mXlsx.BorderStyle.Double;break;default:o.style=r>2?mXlsx.BorderStyle.Thick:r>1?mXlsx.BorderStyle.Medium:mXlsx.BorderStyle.Thin}o.color=e["border"+l+"Color"]}return o};FlexGridXlsxConverter._parseBorderStyle=function(e,l,o){var t="border"+l+"Style",r="border"+l+"Width";switch(e){case mXlsx.BorderStyle.Dotted:case mXlsx.BorderStyle.Hair:o[t]="dotted";o[r]="1px";break;case mXlsx.BorderStyle.Dashed:case mXlsx.BorderStyle.ThinDashDotDotted:case mXlsx.BorderStyle.ThinDashDotted:o[t]="dashed";o[r]="1px";break;case mXlsx.BorderStyle.MediumDashed:case mXlsx.BorderStyle.MediumDashDotDotted:case mXlsx.BorderStyle.MediumDashDotted:case mXlsx.BorderStyle.SlantedMediumDashDotted:o[t]="dashed";o[r]="2px";break;case mXlsx.BorderStyle.Double:o[t]="double";o[r]="3px";break;case mXlsx.BorderStyle.Medium:o[t]="solid";o[r]="2px";break;case mXlsx.BorderStyle.Thick:o[t]="solid";o[r]="3px";break;default:o[t]="solid";o[r]="1px"}};FlexGridXlsxConverter._parseToExcelFontFamily=function(e){var l;e&&(l=e.split(","))&&l.length>0&&(e=l[0].replace(/\"|\'/g,""));return e};FlexGridXlsxConverter._parseToExcelFormula=function(e,l){var o,t,r,n,s,i,a,u=/\"?\w+\"?\s*\,\s*\"(\w+)\"/i;if(o=e.match(/(floor|ceiling)\([+-]?\d+\.?\d*\)/gi))for(s=0;s<o.length;s++){a=(i=o[s]).substring(0,i.lastIndexOf(")"))+", 1)";e=e.replace(i,a)}o=null;if(o=e.match(/text\(\"?\w+\"?\s*\,\s*\"\w+\"\)/gi))for(s=0;s<o.length;s++)if((t=(i=o[s]).match(u))&&2===t.length){r=t[1];if(!/^d{1,4}?$/.test(r)){n=mXlsx.Workbook._parseCellFormat(r,l);a=i.replace(r,n);e=e.replace(i,a)}}return e};FlexGridXlsxConverter._parseToTextRuns=function(e){var l,o,t,r=e.split("<span "),n=[];for(l=0;l<r.length;l++){t=-1!==(o=r[l]).indexOf("</span>")?{text:o.substring(o.indexOf(">")+1,o.indexOf("</span>")),font:this._parseToTextRunFont(o.substring(o.indexOf('style="')+7,o.indexOf(';"')))}:{text:o};n.push(t)}return n};FlexGridXlsxConverter._parseToTextRunFont=function(e){var l,o,t,r,n,s,i,a,u,d=e.split(";");if(d.length>0){for(l=0;l<d.length;l++)if(2===(o=d[l].split(":")).length){o[1]=o[1].trim();switch(o[0]){case"font-size":s=+o[1].substring(0,o[1].indexOf("px"));isNaN(s)&&(s=null);break;case"font-weight":t="bold"===o[1]||+o[1]>=700;break;case"font-style":r="italic"===o[1];break;case"text-decoration-style":case"text-decoration":n="underline"===o[1];break;case"font-family":i=this._parseToExcelFontFamily(o[1]);break;case"color":a=o[1]}}u={bold:t,italic:r,underline:n,family:i,size:s,color:a}}return u};FlexGridXlsxConverter._getMeasureCell=function(e,l,o,t){var r=t[e.cellType],n=r&&r[l],s=null==n;if(n){if(this.hasCssText){n.style;n.style.cssText="";n.style.visibility="hidden"}}else{r||(t[e.cellType]=r=[]);r[l]=n=o.cloneNode()}!s&&n.parentElement||(e.hostElement.children.length>0?e.hostElement.children[0].appendChild(n):e.hostElement.appendChild(n));return n};FlexGridXlsxConverter._getColumnSetting=function(e,l,o){var t=e;null!=e.colspan&&(t=this._getRenderColumn(l,o));return t?{autoWidth:!0,width:t.renderWidth||o.defaultSize,visible:t.visible,style:{format:t.format?mXlsx.Workbook._parseCellFormat(t.format,t.dataType===wijmo_1.DataType.Date):"",hAlign:mXlsx.Workbook._parseStringToHAlign(this._toExcelHAlign(t.getAlignment())),wordWrap:t.wordWrap}}:null};FlexGridXlsxConverter._toExcelHAlign=function(e){return(e=e?e.trim().toLowerCase():e)?e.indexOf("center")>-1?"center":e.indexOf("right")>-1||e.indexOf("end")>-1?"right":e.indexOf("justify")>-1?"justify":"left":e};FlexGridXlsxConverter._getColumnCount=function(e){for(var l,o=0,t=0,r=0;r<e.length;r++)if((l=e[r]&&e[r].cells?e[r].cells:[])&&l.length>0){t=l.length;wijmo_1.isInt(l[t-1].colSpan)&&l[t-1].colSpan>1&&(t=t+l[t-1].colSpan-1);t>o&&(o=t)}return o};FlexGridXlsxConverter._getRowCount=function(e,l){for(var o,t,r=e.length,n=r-1,s=0;s<l;s++)e:for(;n>=0;n--)if((t=((o=e[n])&&o.cells?o.cells:[])[s])&&(null!=t.value&&""!==t.value||wijmo_1.isInt(t.rowSpan)&&t.rowSpan>1)){wijmo_1.isInt(t.rowSpan)&&t.rowSpan>1&&n+t.rowSpan>r&&(r=n+t.rowSpan);break e}return r};FlexGridXlsxConverter._numAlpha=function(e){var l=Math.floor(e/26)-1;return(l>-1?this._numAlpha(l):"")+String.fromCharCode(65+e%26)};FlexGridXlsxConverter._getItemType=function(e){return null==e||null==e.value||isNaN(e.value)?null:wijmo_1.getType(e.value)};FlexGridXlsxConverter._setColumn=function(e,l,o){var t,r,n,s=e[l];if(s){t=this._getItemType(o);s.dataType!==t&&s.dataType===wijmo_1.DataType.Boolean&&t!==wijmo_1.DataType.Boolean&&(s.dataType=t);!o||null==o.value||wijmo_1.isString(o.value)&&wijmo_1.isNullOrWhiteSpace(o.value)||(r=mXlsx.Workbook._parseExcelFormat(o))&&s.format!==r&&"General"!==r&&(s.format=r);if(o&&o.style){o.style.hAlign&&(n=mXlsx.Workbook._parseHAlignToString(wijmo_1.asEnum(o.style.hAlign,mXlsx.HAlign)));null==s.wordWrap?s.wordWrap=!!o.style.wordWrap:s.wordWrap=s.wordWrap&&!!o.style.wordWrap}n||t!==wijmo_1.DataType.Number||(n="right");s.hAlign=n}else e[l]={dataType:this._getItemType(o),format:mXlsx.Workbook._parseExcelFormat(o),hAlign:"",wordWrap:null}};FlexGridXlsxConverter._getItemValue=function(e){if(null==e||null==e.value)return null;var l=e.value;wijmo_1.isString(l)&&"'"===l[0]&&(l=l.substr(1));return wijmo_1.isNumber(l)&&isNaN(l)?"":l instanceof Date&&isNaN(l.getTime())?"":l};FlexGridXlsxConverter._getCellStyle=function(e,l,o,t,r){var n,s=e.grid;try{var i=!(r&&!s.formatItem.hasHandlers&&!s.itemFormatter);s.cellFactory.updateCell(e,o,t,l,null,i);l.className=l.className.replace("wj-state-selected","");l.className=l.className.replace("wj-state-multi-selected","")}catch(e){return null}if(r){var a,u=e.hostElement,d=l;a=d.style.cssText.split(/;\s+/).filter((function(e){var l=e.substring(0,e.indexOf(":"));return/^(color|background|border|font|text|whitespace)/i.test(l)})).join(";");do{a=d.className+a}while(d!==u&&(d=d.parentElement));if(!(n=r.getValue(a))){n=window.getComputedStyle(l);r.add(a,n)}}else n=window.getComputedStyle(l);return n};FlexGridXlsxConverter._parseTextRunsToHTML=function(e){var l,o,t,r;t="";for(r=0;r<e.length;r++)t+=(o=(l=e[r]).font)?'<span style="'+(o.bold?"font-weight: bold;":"")+(o.italic?"font-style: italic;":"")+(o.underline?"text-decoration: underline;":"")+(o.family?"font-family: "+o.family+";":"")+(null!=o.size?"font-size: "+o.size+"px;":"")+(o.color?"color: "+o.color+";":"")+'">'+l.text+"</span>":l.text;return t};FlexGridXlsxConverter._extend=function(e,l){for(var o in l){var t=l[o];wijmo_1.isObject(t)&&e[o]?wijmo_1.copy(e[o],t):e[o]=t}return e};FlexGridXlsxConverter._checkParentCollapsed=function(e,l){var o=!1;Object.keys(e).forEach((function(t){!0===e[t]&&!1===o&&!isNaN(l)&&+t<l&&(o=!0)}));return o};FlexGridXlsxConverter._getColSpan=function(e,l,o){for(var t=0,r=l.leftCol;r<=l.rightCol;r++)o&&!o(e.columns[r])||t++;return t};FlexGridXlsxConverter._getRenderColumn=function(e,l){return e>=l.length?null:l[e]};FlexGridXlsxConverter._getMergedRange=function(e,l,o){var t,r;for(t=0;t<o.length;t++)if(e>=(r=o[t]).topRow&&e<=r.bottomRow&&l>=r.leftCol&&l<=r.rightCol)return r;return null};FlexGridXlsxConverter._isFormula=function(e){return e&&"string"==typeof e&&e.length>1&&"="===e[0]&&"="!==e[1]};return FlexGridXlsxConverter}();exports.FlexGridXlsxConverter=FlexGridXlsxConverter;var _IncludeCellStyles,XlsxFormatItemEventArgs=function(e){__extends(XlsxFormatItemEventArgs,e);function XlsxFormatItemEventArgs(l,o,t,r,n,s,i){var a=e.call(this,l,o)||this;a._cell=t;a._patternCell=r;a._xlsxCell=i;a._cellsCache=n;a._styleCache=s;return a}Object.defineProperty(XlsxFormatItemEventArgs.prototype,"cell",{get:function(){return this._cell},enumerable:!0,configurable:!0});Object.defineProperty(XlsxFormatItemEventArgs.prototype,"xlsxCell",{get:function(){return this._xlsxCell},set:function(e){this._xlsxCell=e},enumerable:!0,configurable:!0});XlsxFormatItemEventArgs.prototype.getFormattedCell=function(){if(!this._cell){this._cell=FlexGridXlsxConverter._getMeasureCell(this.panel,this.col,this._patternCell,this._cellsCache);FlexGridXlsxConverter._getCellStyle(this.panel,this._cell,this.row,this.col,this._styleCache)}return this._cell};return XlsxFormatItemEventArgs}(wijmo_grid_1.CellRangeEventArgs);exports.XlsxFormatItemEventArgs=XlsxFormatItemEventArgs;!function(e){e[e.None=0]="None";e[e.Regular=1]="Regular";e[e.Cache=2]="Cache"}(_IncludeCellStyles||(_IncludeCellStyles={}));var _StyleCache=function(){function _StyleCache(e){this._cache={};this._size=0;this._max=e}_StyleCache.prototype.add=function(e,l){this._size>=this._max&&this.clear();this._cache[e]=this._cloneStyle(l);this._size++};_StyleCache.prototype.clear=function(){this._cache={};this._size=0};_StyleCache.prototype.getValue=function(e){return this._cache[e]||null};_StyleCache.prototype.hasKey=function(e){return!!this._cache[e]};_StyleCache.prototype._cloneStyle=function(e){if(!e)return null;for(var l={},toCamel=function(e){return e.replace(/\-([a-z])/g,(function(e,l,o){return o>0?l.toUpperCase():l}))},o=0,t=e.length;o<t;o++){var r=e[o];l[toCamel(r)]=e.getPropertyValue(r)}return l};return _StyleCache}();exports._StyleCache=_StyleCache;wijmo_1._registerModule("wijmo.grid.xlsx",selfModule);