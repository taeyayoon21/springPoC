/*!
    *
    * Wijmo Library 5.20202.724
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const wijmo_1=require("wijmo/wijmo"),selfModule=require("wijmo/wijmo.cloud");class OAuth2{constructor(e,t,i,s){this.userChanged=new wijmo_1.Event;this.error=new wijmo_1.Event;this._gapi=window.gapi;if(this._gapi)this._gapiLoaded(e,t,i);else{let s=document.createElement("script");s.src="https://apis.google.com/js/api.js";s.onload=()=>this._gapiLoaded(e,t,i);document.head.appendChild(s)}wijmo_1.copy(this,s)}get user(){let e=this._auth();if(e&&e.isSignedIn.get()){let t=e.currentUser.get().getBasicProfile();return{id:t.getId(),name:t.getName(),firstName:t.getGivenName(),lastName:t.getFamilyName(),imageUrl:t.getImageUrl(),eMail:t.getEmail()}}return null}get accessToken(){let e=this._gapi.auth.getToken();return e?e.access_token:null}get idToken(){let e=this._gapi.auth.getToken();return e?e.id_token:null}signIn(){this._auth().signIn()}signOut(){this._auth().signOut()}onUserChanged(e){this.userChanged.raise(this,e)}onError(e){this.error.raise(this,e)}_gapiLoaded(e,t,i){let s=this._gapi=window.gapi;wijmo_1.assert(s,"Failed to load google gapi.");s.load("client:auth2",()=>{let r=i&&i.length?i.join(" "):"";r=r||"https://www.googleapis.com/auth/userinfo.email";s.client.init({apiKey:e,clientId:t,scope:r}).then(()=>{this._auth().isSignedIn.listen(()=>{this.onUserChanged()});this.onUserChanged()},e=>{this.onError(new OAuthError(e))})})}_auth(){return this._gapi&&this._gapi.auth2?this._gapi.auth2.getAuthInstance():null}}exports.OAuth2=OAuth2;class OAuthError extends wijmo_1.EventArgs{constructor(e){super();this._error=e}get error(){return this._error}}exports.OAuthError=OAuthError;class Snapshot extends wijmo_1.CollectionView{constructor(e,t){super();this._loading=!1;this._deferCommits=!1;this._hasPendingChanges=!1;this.loading=new wijmo_1.Event;this.loaded=new wijmo_1.Event;this.error=new wijmo_1.Event;this.hasPendingChangesChanged=new wijmo_1.Event;this._checkType("CollectionReference",e,"firestore","doc","onSnapshot");this._collection=e;wijmo_1.copy(this,t);this.itemsEdited.collectionChanged.addHandler(this._updateHasChanges,this);this.itemsAdded.collectionChanged.addHandler(this._updateHasChanges,this);this.itemsRemoved.collectionChanged.addHandler(this._updateHasChanges,this);this._getData()}get query(){return this._query}set query(e){if(e!=this._query){this._checkType("Query",e,"firestore","onSnapshot");this._query=e;this._getData()}}get deferCommits(){return this._deferCommits}set deferCommits(e){this._deferCommits=wijmo_1.asBoolean(e);this.deferCommits&&(this.trackChanges=!0)}commitChanges(){if(this.deferCommits&&this.hasPendingChanges){let e=this._collection.firestore.batch();this.itemsEdited.forEach(t=>{let i=this._getItemDoc(t),s=this._getItemData(t);e.update(i,s)});this.itemsAdded.forEach(t=>{let i=this._getItemDoc(t),s=this._getItemData(t);e.set(i,s)});this.itemsRemoved.forEach(t=>{let i=this._getItemDoc(t);e.delete(i)});e.commit().then(()=>{this.clearChanges();this._getData(!0)}).catch(e=>this._raiseError(e,!0))}}cancelChanges(){if(this.deferCommits){this.clearChanges();this._getData(!0)}}get hasPendingChanges(){return!!this.deferCommits&&(this.itemsAdded.length>0||this.itemsEdited.length>0||this.itemsRemoved.length>0)}get isLoading(){return this._loading}load(e){this._getData(e)}onLoading(e){this.loading.raise(this,e);return!e.cancel}onLoaded(e){this.loaded.raise(this,e)}onError(e){if(this._loading){this._loading=!1;this.onLoaded()}this.error.raise(this,e);return!e.cancel}onHasPendingChangesChanged(e){this.hasPendingChangesChanged.raise(this,e)}commitNew(){if(!this.deferCommits){let e=this.currentAddItem;e&&this._collection.add(this._getItemData(e)).catch(e=>this._raiseError(e,!0))}super.commitNew()}commitEdit(){if(!this.deferCommits){let e=this.currentEditItem;if(e&&!this.currentAddItem&&this._getChangedFields(e,this._edtClone)){let t=this._getItemDoc(e),i=this._getItemData(e);t.update(i).catch(e=>this._raiseError(e,!0))}}super.commitEdit()}remove(e){if(!this.deferCommits&&e&&e!=this.currentAddItem){this._getItemDoc(e).delete().catch(e=>this._raiseError(e,!0))}super.remove(e)}_raiseError(e,t){this.onError(new FirestoreErrorEventArgs(e));t&&this._getData(!0)}_updateHasChanges(){let e=this.hasPendingChanges;if(e!=this._hasPendingChanges){this._hasPendingChanges=e;this.onHasPendingChangesChanged()}}_getItemDoc(e){let t=e&&e.$META?e.$META.id:this._generateID();return this._collection.doc(t)}_getItemData(e){let t={};for(var i in e)"$META"!=i&&(t[i]=e[i]);return t}_getData(e){this._toGetData&&clearTimeout(this._toGetData);this._toGetData=setTimeout(()=>{this._toGetData=null;this._loading=!0;if(this.onLoading(new wijmo_1.CancelEventArgs)){this._unsubscribe&&this._unsubscribe();this._unsubscribe=this._getQuery().onSnapshot(t=>{let i=[],s=e||!this._loading?this.currentPosition:null;t.forEach(e=>{i.push(Object.assign({$META:{id:e.id}},e.data()))});this.sourceCollection=i;null!=s&&this.moveCurrentToPosition(s);if(this._loading){this._loading=!1;this.onLoaded()}},e=>this._raiseError(e,!0))}},wijmo_1.Control._REFRESH_INTERVAL)}_generateID(){let e="";for(;e.length<20;)e+=Math.random().toString(36).substr(2,5);return e}_checkType(e,t,...i){if(null!=t)for(let s=0;s<i.length;s++){let r=i[s];null==t[r]&&wijmo_1.assert(!1,'Expected "'+e+'" but the value does not have "'+r+'".')}}_getQuery(){return this._query||this._collection}}exports.Snapshot=Snapshot;class FirestoreErrorEventArgs extends wijmo_1.CancelEventArgs{constructor(e){super();this._error=e}get error(){return this._error}get message(){return this._error.message}}exports.FirestoreErrorEventArgs=FirestoreErrorEventArgs;class Sheet extends wijmo_1.CollectionView{constructor(e,t,i){super();this._loading=!1;this.loading=new wijmo_1.Event;this.loaded=new wijmo_1.Event;this.error=new wijmo_1.Event;this._gSheet=e;this._title=t;this._id=i;this._getData();e.accessTokenChanged.addHandler(()=>{e.accessToken&&!this.items.length&&this._getData(!0)})}get googleSheet(){return this._gSheet}get title(){return this._title}load(e){this._getData(e)}get isLoading(){return this._loading}onLoading(e){this.loading.raise(this,e);return!e.cancel}onLoaded(e){this.loaded.raise(this,e)}onError(e){if(this._loading){this._loading=!1;this.onLoaded()}this.error.raise(this,e);return!e.cancel}commitNew(){let e=this.currentAddItem;e&&this._saveItem(e);super.commitNew()}commitEdit(){let e=this.currentEditItem;e&&!this.currentAddItem&&this._getChangedFields(e,this._edtClone)&&this._saveItem(e);super.commitEdit()}remove(e){if(e&&e!=this.currentAddItem){let t=this.sourceCollection.indexOf(e);wijmo_1.assert(t>-1,"Item not found.");let i=t+1;wijmo_1.assert(null!=this._id,"Sheet doesn't have an ID ? ");let s=this.googleSheet,r=s._getUrl(":batchUpdate");wijmo_1.httpRequest(r,{method:"POST",requestHeaders:s._getRequestHeaders(),data:{requests:[{deleteDimension:{range:{sheetId:this._id,dimension:"ROWS",startIndex:i,endIndex:i+1}}}]},error:e=>this._handleError(e,!1)})}super.remove(e)}_getData(e){this._toGetData&&clearTimeout(this._toGetData);this._toGetData=setTimeout(()=>{this._loading=!0;this._itemKeys=null;if(this.onLoading(new wijmo_1.CancelEventArgs)){let t=this.currentPosition,i=this.googleSheet,s=i._getUrl("/values/"+this.title+"!2:2");wijmo_1.httpRequest(s,{requestHeaders:i._getRequestHeaders(),data:{valueRenderOption:"UNFORMATTED_VALUE",dateTimeRenderOption:"FORMATTED_STRING"},success:s=>{let r=JSON.parse(s.responseText).values[0],o=i._getUrl("/values/"+this.title);wijmo_1.httpRequest(o,{requestHeaders:i._getRequestHeaders(),data:{valueRenderOption:"UNFORMATTED_VALUE",dateTimeRenderOption:"SERIAL_NUMBER"},success:i=>{let s=JSON.parse(i.responseText).values;this.sourceCollection=this._parseData(s,r);e&&this.moveCurrentToPosition(t);this._loading=!1;this.onLoaded()},error:e=>this._handleError(e,!1)})},error:e=>this._handleError(e,!1)})}},wijmo_1.Control._REFRESH_INTERVAL)}_parseData(e,t){let i=[],s=e[0],r=!0;for(let e=0;e<s.length&&r;e++){let t=s[e];t&&wijmo_1.isString(t)&&s.indexOf(t)==e||(r=!1)}if(r)e.splice(0,1);else{let e=[];for(let t=0;t<s.length;t++)e.push(this._toSheetHeader(t));s=e}this._itemKeys=s;let o=[],a=this._gSheet.columnDataTypes,n=wijmo_1.DataType;s.forEach(e=>{let t=n.Object;a&&a.forEach(i=>{i.pattern.test(e)&&(t=i.dataType)});o.push(t)});e.forEach(e=>{let r={};s.forEach((i,s)=>{let a=e[s],h=t[s],l=o[s];l==n.Object&&wijmo_1.isNumber(a)&&wijmo_1.isString(h)&&h.length&&(l=n.Date);l!=n.Object&&(a=l==n.Date&&wijmo_1.isNumber(a)?new Date(86400*(a-25568)*1e3):wijmo_1.changeType(a,l));r[i]=a});i.push(r)});return i}_toSheetHeader(e){return e<26?String.fromCharCode(65+e):this._toSheetHeader(Math.floor(e/26)-1)+this._toSheetHeader(e%26)}_saveItem(e){let t=this.sourceCollection.indexOf(e);wijmo_1.assert(t>-1,"Item not found?");let i=[];this._itemKeys.forEach(t=>{let s=e[t];i.push(null!=s?s.toString():"")});let s=this.googleSheet,r=(t+2).toString(),o=this.title+"!A"+r+":Z"+r,a=s._getUrl("/values/"+o);a+=(a.indexOf("?key=")>-1?"&":"?")+"valueInputOption=USER_ENTERED";wijmo_1.httpRequest(a,{method:"PUT",requestHeaders:s._getRequestHeaders(),data:{range:o,values:[i]},error:e=>this._handleError(e,!0)})}_handleError(e,t){this.onError(new wijmo_1.RequestErrorEventArgs(e));t&&this._getData(!0)}}exports.Sheet=Sheet;class GoogleSheet{constructor(e,t,i){this._sheetId="";this._accessToken="";this._apiKey="";this._loading=!1;this._sheets=new wijmo_1.ObservableArray;this.loading=new wijmo_1.Event;this.loaded=new wijmo_1.Event;this.error=new wijmo_1.Event;this.accessTokenChanged=new wijmo_1.Event;this._sheetId=wijmo_1.asString(e,!1);this._apiKey=wijmo_1.asString(t,!1);wijmo_1.copy(this,i);this._getSheetInfo()}get sheetId(){return this._sheetId}get apiKey(){return this._apiKey}get accessToken(){return this._accessToken}set accessToken(e){if(e!=this._accessToken){this._accessToken=wijmo_1.asString(e);this.onAccessTokenChanged()}}get columnDataTypes(){return this._colTypes}set columnDataTypes(e){this._colTypes=e}get sheets(){return this._sheets}getSheet(e){for(let t=0;t<this._sheets.length;t++){let i=this._sheets[t];if(i.title==e)return i}return null}get isLoading(){return this._loading}onLoading(e){this.loading.raise(this,e)}onLoaded(e){this.loaded.raise(this,e)}onError(e){if(this._loading){this._loading=!1;this.onLoaded()}this.error.raise(this,e);return!e.cancel}onAccessTokenChanged(e){this.accessTokenChanged.raise(this,e)}_copy(e,t){if("sheets"==e&&wijmo_1.isArray(t)){t.forEach(e=>{let t=new Sheet(this,e);this.sheets.push(t)});return!0}return!1}_getUrl(e){let t="https://sheets.googleapis.com/v4/spreadsheets/"+this.sheetId;e&&(t+=e);this.apiKey&&(t+="?key="+this.apiKey);return t}_getRequestHeaders(){let e={"Content-Type":"application/json"};this.accessToken&&(e.Authorization="Bearer "+this.accessToken);return e}_getSheetInfo(){this._loading=!0;this.onLoading();wijmo_1.httpRequest(this._getUrl(),{requestHeaders:this._getRequestHeaders(),data:{fields:"sheets.properties"},success:e=>{let t=JSON.parse(e.responseText),i=t.sheets;this.sheets.length?this.sheets.forEach(e=>{for(let t=0;t<i.length;t++){let s=i[t].properties;if(s.title==e.title){e._id=s.sheetId;break}}wijmo_1.assert(null!=e._id,'Could not find sheet "'+e.title+'".')}):t.sheets.forEach(e=>{let t=e.properties;if("GRID"==t.sheetType){let e=new Sheet(this,t.title,t.sheetId);this.sheets.push(e)}})},error:e=>{this.onError(new wijmo_1.RequestErrorEventArgs(e))},complete:e=>{this._loading=!1;this.onLoaded()}})}}exports.GoogleSheet=GoogleSheet;class Firestore{constructor(e,t,i){this._projectId="";this._collections=new wijmo_1.ObservableArray;this._accessToken="";this._idToken="";this._fbToken="";this._apiKey="";this.accessTokenChanged=new wijmo_1.Event;this._projectId=wijmo_1.asString(e,!1);this._apiKey=wijmo_1.asString(t,!1);wijmo_1.copy(this,i)}get projectId(){return this._projectId}get apiKey(){return this._apiKey}get accessToken(){return this._accessToken}set accessToken(e){if(e!=this._accessToken){this._accessToken=wijmo_1.asString(e);this.onAccessTokenChanged()}}get idToken(){return this._idToken}set idToken(e){if(e!=this._idToken){this._idToken=wijmo_1.asString(e);if(this._idToken){let e="https://identitytoolkit.googleapis.com/v1/accounts:signInWithIdp?key="+this._apiKey;wijmo_1.httpRequest(e,{method:"POST",data:{requestUri:window.location.href,postBody:"id_token="+this._idToken+"&providerId=google.com",returnSecureToken:!0,returnIdpCredential:!0},success:e=>{let t=JSON.parse(e.responseText);this._fbToken=t.idToken;this.onAccessTokenChanged()},error:e=>{this._fbToken="";this.onAccessTokenChanged()}})}else{this._fbToken="";this.onAccessTokenChanged()}}}get collections(){return this._collections}getCollection(e){let t=this._collections;for(let i=0;i<t.length;i++){let s=t[i];if(s.name==e)return s}return null}onAccessTokenChanged(e){this.accessTokenChanged.raise(this,e)}_copy(e,t){if("collections"==e&&wijmo_1.isArray(t)){t.forEach(e=>{let t=new Collection(this,e);this.collections.push(t)});return!0}return!1}}exports.Firestore=Firestore;function softGridFilter(){return wijmo_1._getModule("wijmo.grid.filter")}exports.softGridFilter=softGridFilter;class Collection extends wijmo_1.CollectionView{constructor(e,t,i){super();this._loading=!1;this._sortOnServer=!1;this._pageOnServer=!1;this._filterOnServer=!1;this._deferCommits=!1;this._hasPendingChanges=!1;this._orderBy=[];this._fieldFilters=[];this._limit=0;this.loading=new wijmo_1.Event;this.loaded=new wijmo_1.Event;this.error=new wijmo_1.Event;this.hasPendingChangesChanged=new wijmo_1.Event;this._store=e;this._name=t;wijmo_1.copy(this,i);this.sortDescriptions.collectionChanged.addHandler(()=>{this.sortOnServer&&!this.hasPendingChanges&&this._getData(!0)});e.accessTokenChanged.addHandler(()=>{e.accessToken&&!this.items.length&&this.load()});this.itemsEdited.collectionChanged.addHandler(this._updateHasChanges,this);this.itemsAdded.collectionChanged.addHandler(this._updateHasChanges,this);this.itemsRemoved.collectionChanged.addHandler(this._updateHasChanges,this);this._getData()}get store(){return this._store}get name(){return this._name}get fields(){return this._fields}set fields(e){if(e!=this._fields){this._fields=wijmo_1.asArray(e);this._getData(!0)}}get limit(){return this._limit}set limit(e){if(e!=this._limit){this._limit=wijmo_1.asInt(e);this._getData(!0)}}get sortOnServer(){return this._sortOnServer}set sortOnServer(e){if(e!=this._sortOnServer){this._sortOnServer=wijmo_1.asBoolean(e);this._getData(!0)}}get pageOnServer(){return this._pageOnServer}set pageOnServer(e){if(e!=this._pageOnServer){this._pageOnServer=wijmo_1.asBoolean(e);this.pageSize&&this._getData(!0)}}get filterOnServer(){return this._filterOnServer}set filterOnServer(e){if(e!=this._filterOnServer){this._filterOnServer=wijmo_1.asBoolean(e);if(softGridFilter()){null==Collection._filterCulture&&(Collection._filterCulture=wijmo_1.culture.FlexGridFilter);if(this._filterOnServer){let e=wijmo_1.culture.FlexGridFilter,t=e.numberOperators;for(let e=0;e<t.length;e++)if(t[e].op==softGridFilter().Operator.NE){t.splice(e,1);break}e.stringOperators=t}else wijmo_1.culture.FlexGridFilter=Collection._filterCulture}this._getData(!0)}}get deferCommits(){return this._deferCommits}set deferCommits(e){this._deferCommits=wijmo_1.asBoolean(e);this.deferCommits&&(this.trackChanges=!0)}commitChanges(e){if(this.deferCommits){let t=[];this.itemsEdited.forEach(e=>{t.push({update:this._itemToDoc(e)})});this.itemsAdded.forEach(e=>{let i=this._itemToDoc(e);i.name="projects/"+this.store.projectId+"/databases/(default)/documents/"+this.name+"/"+this._generateID();t.push({update:i})});this.itemsRemoved.forEach(e=>{t.push({delete:e.$META.name})});t.length&&wijmo_1.httpRequest(this._getUrl(":beginTransaction"),{method:"POST",requestHeaders:this._getRequestHeaders(),success:i=>{let s=JSON.parse(i.responseText);wijmo_1.httpRequest(this._getUrl(":commit"),{method:"POST",data:{writes:t,transaction:s.transaction},requestHeaders:this._getRequestHeaders(),success:e=>{this.clearChanges();this.load()},complete:t=>{wijmo_1.isFunction(e)&&e(t)},error:e=>this._raiseError(e,!0)})},error:e=>this._raiseError(e,!0)})}}cancelChanges(){if(this.deferCommits){this.clearChanges();this.load()}}get hasPendingChanges(){return!!this.deferCommits&&(this.itemsAdded.length>0||this.itemsEdited.length>0||this.itemsRemoved.length>0)}get isLoading(){return this._loading}load(e){this._getData(e)}select(...e){this.fields=e;return this}orderBy(e,t=!0){e?this._orderBy.push(new wijmo_1.SortDescription(wijmo_1.asString(e),wijmo_1.asBoolean(t))):this._orderBy=[];this._getData(!1);return this}where(e,t,i){if(e){switch(t.toUpperCase()){case"==":t="EQUAL";break;case">":t="GREATER_THAN";break;case">=":t="GREATER_THAN_OR_EQUAL";break;case"<":t="LESS_THAN";break;case"<=":t="LESS_THAN_OR_EQUAL";break;case"IN":t="IN";wijmo_1.assert(wijmo_1.isArray(i),"IN operator requires array values.");break;default:wijmo_1.assert(!1,"Unknown operator (should be ==, >, >=, <, <=, or IN).")}for(let i=0;i<this._fieldFilters.length;i++){let s=this._fieldFilters[i].fieldFilter;if(s.field.fieldPath==e&&s.op==t){this._fieldFilters.splice(i,1);break}}this._fieldFilters.push({fieldFilter:{field:{fieldPath:e},op:t,value:this._getValueObject(i)}})}else this._fieldFilters=[];this._getData(!1);return this}onLoading(e){this.loading.raise(this,e);return!e.cancel}onLoaded(e){this.loaded.raise(this,e)}onError(e){if(this._loading){this._loading=!1;this.onLoaded()}this.error.raise(this,e);return!e.cancel}onHasPendingChangesChanged(e){this.hasPendingChangesChanged.raise(this,e)}get totalItemCount(){let e=this._totalCount;return this.pageOnServer?null!=e?e:1e6:this.items.length}set totalItemCount(e){this._totalCount=wijmo_1.asInt(e)}get pageCount(){return this.pageSize?Math.ceil(this.totalItemCount/this.pageSize):1}get pageSize(){return this._pgSz}set pageSize(e){if(e!=this._pgSz){this._pgSz=wijmo_1.asInt(e);if(this.pageOnServer){this._pgIdx=wijmo_1.clamp(this._pgIdx,0,this.pageCount-1);this._getData(!0)}else this.refresh()}}onPageChanging(e){super.onPageChanging(e);!e.cancel&&this.pageOnServer&&(0==this.pageIndex&&0==this.items.length?e.cancel=!0:this._getData(!0));return!e.cancel}commitNew(){if(!this.deferCommits){let e=this.currentAddItem;if(e){let t=this._itemToDoc(e);wijmo_1.httpRequest(this._getUrl(),{method:"POST",data:{fields:t.fields},requestHeaders:this._getRequestHeaders(),success:t=>{let i=JSON.parse(t.responseText);this._saveDocName(i,e);this._totalCount++},error:e=>this._raiseError(e,!0)})}}super.commitNew()}commitEdit(){if(!this.deferCommits){let e=this.currentEditItem;if(e&&!this.currentAddItem&&this._getChangedFields(e,this._edtClone)){let t=this._itemToDoc(e);wijmo_1.httpRequest(this._getUrl(t),{method:"PATCH",data:{fields:t.fields},requestHeaders:this._getRequestHeaders(),error:e=>this._raiseError(e,!0)})}}super.commitEdit()}remove(e){if(!this.deferCommits&&e&&e!=this.currentAddItem){let t=this._itemToDoc(e);wijmo_1.httpRequest(this._getUrl(t),{method:"DELETE",requestHeaders:this._getRequestHeaders(),success:e=>this._totalCount--,error:e=>this._raiseError(e,!0)})}super.remove(e)}updateFilterDefinition(e){this._filterProvider=null;if(this.filterOnServer&&softGridFilter()&&e instanceof softGridFilter().FlexGridFilter){this._filterProvider=e;this._totalCount=null;this.moveCurrentToFirst();this._getData(!0)}}_getPageView(){return this.pageOnServer?this._view:super._getPageView()}_generateID(){let e="";for(;e.length<20;)e+=Math.random().toString(36).substr(2,5);return e}_updateHasChanges(){let e=this.hasPendingChanges;if(e!=this._hasPendingChanges){this._hasPendingChanges=e;this.onHasPendingChangesChanged()}}_getData(e){this._toGetData&&clearTimeout(this._toGetData);this._toGetData=setTimeout(()=>{this._toGetData=null;this._loading=!0;if(this.onLoading(new wijmo_1.CancelEventArgs)){let t=this.currentPosition;wijmo_1.httpRequest(this._getUrl(":runQuery"),{method:"POST",data:this._getQuery(),requestHeaders:this._getRequestHeaders(),success:i=>{let s=JSON.parse(i.responseText),r=this._parseData(s),o=this.pageSize;if(this.pageOnServer&&o&&r.length<o){let e=s[0].skippedResults||0;this._totalCount=e+r.length;if(0==r.length&&this.pageIndex>0){this.moveToLastPage();return}}this.sourceCollection=r;e&&this.moveCurrentToPosition(t);this._loading=!1;this.onLoaded()},error:e=>this._raiseError(e,!1)})}},wijmo_1.Control._REFRESH_INTERVAL)}_getQuery(){let e={from:[{collectionId:this.name}]};this.fields&&this.fields.length&&(e.select={fields:this.fields.map(e=>({fieldPath:e}))});let t=this._fieldFilters;!t.length&&this._filterProvider&&this.filterOnServer&&(t=this._getQueryFilters());t&&t.length&&(e.where=1==t.length?t[0]:{compositeFilter:{filters:t,op:"AND"}});let i=[];t&&t.length&&t.forEach(e=>{let t=e.fieldFilter;"IN"!=t.op&&"EQUAL"!=t.op&&i.push({field:t.field.fieldPath,asc:!0})});this._orderBy.forEach(e=>{i.push({field:e.property,asc:e.ascending})});!i.length&&this.sortOnServer&&this.sortDescriptions.forEach(e=>{i.push({field:e.property,asc:e.ascending})});i.length&&(e.orderBy=i.map(e=>({field:{fieldPath:e.field},direction:e.asc?"ASCENDING":"DESCENDING"})));let s=this.pageSize;if(this.pageOnServer&&s){e.limit=s;e.offset=s*this.pageIndex}!e.limit&&this.limit>0&&(e.limit=this.limit);return{structuredQuery:e}}_parseData(e){let t=[];wijmo_1.isArray(e)&&e.forEach(e=>{let i=this._docToItem(e);i&&t.push(i)});return t}_raiseError(e,t){this.onError(new wijmo_1.RequestErrorEventArgs(e));t&&this._getData(!0)}_saveDocName(e,t){if(e.name&&!t.$META){t.$META={name:e.name};return!0}return!1}_docToItem(e){e.name||(e=e.document);if(!e||!e.name)return null;let t={};this._saveDocName(e,t);for(let i in e.fields)t[i]=this._getDocValue(e.fields[i]);return t}_getDocValue(e){let t=null;for(let i in e){t=e[i];switch(i){case"integerValue":t=parseInt(t);break;case"timestampValue":t=new Date(t);break;case"mapValue":let e={};for(let i in t.fields)e[i]=this._getDocValue(t.fields[i]);t=e;break;case"arrayValue":t=t.values?t.values.map(e=>this._getDocValue(e)):[]}}return t}_itemToDoc(e){let t={},i=e.$META;i&&i.name&&(t.name=i.name);t.fields={};for(let i in e)"$META"!=i&&(t.fields[i]=this._getValueObject(e[i]));return t}_getValueObject(e){let t={},i=wijmo_1.DataType;switch(wijmo_1.getType(e)){case i.String:t.stringValue=e;break;case i.Boolean:t.booleanValue=e;break;case i.Date:t.timestampValue=e.toJSON();break;case i.Number:e==Math.round(e)?t.integerValue=e.toString():t.doubleValue=e;break;case i.Array:t.arrayValue={values:e.map(e=>this._getValueObject(e))};break;case i.Object:let s={};for(let t in e)s[t]=this._getValueObject(e[t]);t.mapValue={fields:s};break;default:wijmo_1.assert(!1,"failed to create value object.")}return t}_getRequestHeaders(){let e={},t=this.store._fbToken||this.store.accessToken;t&&(e.Authorization="Bearer "+t);return e}_getUrl(e){let t="https://firestore.googleapis.com/v1/";if(wijmo_1.isObject(e)&&e.name)return t+e.name;e=e||"/"+this.name;return t+"projects/"+this.store.projectId+"/databases/(default)/documents"+e}_getQueryFilters(){let e=[],t=this._filterProvider;if(softGridFilter()&&t instanceof softGridFilter().FlexGridFilter)for(let i=0;i<t.grid.columns.length;i++){let s=t.grid.columns[i],r=t.getColumnFilter(s,!1);if(r&&r.isActive){r.conditionFilter&&r.conditionFilter.isActive?this._getQueryConditionFilter(e,r.conditionFilter):r.valueFilter&&r.valueFilter.isActive&&this._getQueryValueFilter(e,r.valueFilter);break}}return e}_getQueryConditionFilter(e,t){let i=t.column.binding,s=this._getQuerySimpleFilter(t.condition1,i),r=this._getQuerySimpleFilter(t.condition2,i);s&&r&&t.and?e.push({compositeFilter:{op:t.and?"AND":"OR",filters:[s,r]}}):s?e.push(s):r&&e.push(r)}_getQuerySimpleFilter(e,t){return e.isActive?{fieldFilter:{field:{fieldPath:t},op:this._getFilterOperator(e.operator),value:this._getValueObject(e.value)}}:null}_getFilterOperator(e){let t=softGridFilter().Operator;switch(e){case t.EQ:return"EQUAL";case t.GE:return"GREATER_THAN_OR_EQUAL";case t.GT:return"GREATER_THAN";case t.LE:return"LESS_THAN_OR_EQUAL";case t.LT:return"LESS_THAN"}wijmo_1.assert(!1,t[e]+" operator not supported (use EQ, GT, GE, LT, or LE)")}_getQueryValueFilter(e,t){let i=t.column,s=i.dataMap,r=[];for(let e in t.showValues){let t=wijmo_1.changeType(e,i.dataType,i.format);s&&wijmo_1.isString(t)&&(t=s.getKeyValue(t));r.push(t);if(r.length>=10)break}r.length&&e.push({fieldFilter:{field:{fieldPath:i.binding},op:"IN",value:this._getValueObject(r)}})}}Collection._filterCulture=null;exports.Collection=Collection;wijmo_1._registerModule("wijmo.cloud",selfModule);