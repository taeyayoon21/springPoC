/*!
    *
    * Wijmo Library 5.20202.724
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const wijmo_1=require("wijmo/wijmo"),wijmo_grid_1=require("wijmo/wijmo.grid"),selfModule=require("wijmo/wijmo.grid.transposed");class TransposedGrid extends wijmo_grid_1.FlexGrid{constructor(e,i){super(e,null);this._keyPrefix="item";this._autoGenRows=!0;wijmo_1.addClass(this.hostElement,"wj-transposed-grid");this.allowSorting=wijmo_grid_1.AllowSorting.None;this.headersVisibility=wijmo_grid_1.HeadersVisibility.Row;this._rowInfo=new wijmo_grid_1.ColumnCollection(this,this.columns.defaultSize);this.initialize(i);this._rowInfo.collectionChanged.addHandler(this._rowInfoChanged,this);this.deferUpdate(()=>{let e=this.rowHeaders.columns;if(e.length){e[e.length-1].width=this.columns.defaultSize}})}get autoGenerateRows(){return this._autoGenRows}set autoGenerateRows(e){this._autoGenRows=wijmo_1.asBoolean(e)}refresh(e){let i=this._rowInfo;if(i._dirty){i._dirty=!1;this._rowInfoChanged()}else super.refresh(e)}get allowAddNew(){return!1}set allowAddNew(e){}get allowDelete(){return!1}set allowDelete(e){}onRowEditEnded(e){if(null!=this._view){let e=new wijmo_1.NotifyCollectionChangedEventArgs(wijmo_1.NotifyCollectionChangedAction.Change);this._view.collectionChanged.raise(this._view,e)}super.onRowEditEnded(e)}_getCollectionView(e){let i=null;null!=this._view&&this._view.collectionChanged.removeHandler(this._sourceViewChanged);if(wijmo_1.isArray(e))e=this._transposeItemsSource(e);else if(e){this._view&&this._view.collectionChanged.removeHandler(this._sourceViewChanged);this._view=wijmo_1.tryCast(e,"ICollectionView");if(this._view){this._view.collectionChanged.addHandler(this._sourceViewChanged,this);e instanceof wijmo_1.CollectionView&&(i=e.getError);e=this._transposeItemsSource(this._view.items)}}this.autoGenerateColumns=!0;let t=super._getCollectionView(e);i&&t instanceof wijmo_1.CollectionView&&(this._supportsProxies()?t.getError=(e,t)=>{let o=e._keys.indexOf(t);return i(e._arr[o],e._bnd.path)}:t.getError=(e,t)=>{let o=parseInt(t.substr(this._keyPrefix.length));return i(e._arr[o],e._rowInfo.binding)});return t}_getColumnTypes(e){if(this._view){let e=this._view.items;if(wijmo_1.isArray(e))return e.map((e,i)=>({binding:this._keyPrefix+i,dataType:wijmo_1.DataType.Object}))}return wijmo_1.getTypes(e)}_copy(e,i){if(/rows|columns/.test(e)){wijmo_1.assert(wijmo_1.isArray(i),"Array Expected.");this._rowInfo.deferUpdate(()=>{this.autoGenerateRows=!1;this._rowInfo.clear();i.forEach(e=>{let i=new wijmo_grid_1.Column(e);this._rowInfo.push(i)})});return!0}return super._copy(e,i)}onLoadedRows(e){let i=this.rowHeaders.columns;for(let e=0;e<i.length;e++)i[e].align="left";let t=this.columns;for(let e=0;e<t.length;e++){let i=t[e];i.align=null;i.dataType=0}let o=wijmo_grid_1.FlexGrid._getSerializableProperties(wijmo_grid_1.Row);this.rows.forEach(e=>{let t=e.dataItem._rowInfo;if(t){this._copyProps(t,e,o,"showDropDown");if(i.length){let o=t.header||wijmo_1.toHeaderCase(t.binding);this.rowHeaders.setCellData(e.index,i.length-1,o)}}});super.onLoadedRows(e)}_getBindingColumn(e,i,t){let o=t;if(e!=this.cells)return o;let r=e.rows[i].dataItem._rowInfo;if(wijmo_1.isUndefined(r))return o;o=new wijmo_grid_1.Column;let n=wijmo_grid_1.FlexGrid._getSerializableProperties(wijmo_grid_1.Column);this._copyProps(r,o,n);o.binding=t.binding;o.header=r.header||wijmo_1.toHeaderCase(r.binding);return o}_copyProps(e,i,t,o=""){for(let r in e)if(t.indexOf(r)>-1&&r!=o){let t=e[r];if(!wijmo_1.isUndefined(t))try{i[r]=t}catch(e){}}}_rowInfoChanged(){this._toRowInfo&&clearTimeout(this._toRowInfo);this._toRowInfo=setTimeout(()=>{let e=this.selection,i=this.itemsSource;this.itemsSource=null;this.itemsSource=i;this.selection=e},wijmo_1.Control._REFRESH_INTERVAL)}_sourceViewChanged(e,i){this.activeEditor||this.invalidate()}_transposeItemsSource(e){let i=new wijmo_1.ObservableArray,t=wijmo_1.getTypes(e),o=e.map((e,i)=>this._keyPrefix+i);(this.autoGenerateRows?this._getRowInfo(e):this._rowInfo).forEach((r,n)=>{let s=new wijmo_1.Binding(r.binding);if(null==r.dataType){let i=s.getValue(e[0]);r.dataType=null!=i?wijmo_1.getType(i):t[n].dataType}if(this._supportsProxies()){let t=this._createProxy(e,r,o);i.push(t)}else{let t=this._createTransposedObject(e,r,this._keyPrefix);i.push(t)}});e instanceof wijmo_1.ObservableArray&&e.collectionChanged.addHandler(()=>{let e=new wijmo_1.NotifyCollectionChangedEventArgs(wijmo_1.NotifyCollectionChangedAction.Reset);i.onCollectionChanged(e);this._rowInfoChanged()});return i}_supportsProxies(){return null!=window.Proxy}_createProxy(e,i,t){let o={_arr:e,_rowInfo:i,_bnd:new wijmo_1.Binding(i.binding),_keys:t};return new Proxy(o,{ownKeys:e=>e._keys,getOwnPropertyDescriptor:()=>({enumerable:!0,configurable:!0,writable:!0}),get:(e,i)=>{let t=e._keys.indexOf(i);return t>-1?e._bnd.getValue(e._arr[t]):e[i]},set:(e,i,t)=>{let o=e._keys.indexOf(i);if(o>-1){let i=e._arr,r=i[o];e._bnd.setValue(r,t);if(i instanceof wijmo_1.ObservableArray){let e=new wijmo_1.NotifyCollectionChangedEventArgs(wijmo_1.NotifyCollectionChangedAction.Change,r,o);i.onCollectionChanged(e)}return!0}return!1}})}_createTransposedObject(e,i,t){let o={_arr:e,_rowInfo:i},r=new wijmo_1.Binding(i.binding);for(let i=0;i<e.length;i++){let n=e[i];Object.defineProperty(o,t+i,{enumerable:!0,get:()=>r.getValue(n),set:t=>{r.setValue(n,t);if(e instanceof wijmo_1.ObservableArray){let t=new wijmo_1.NotifyCollectionChangedEventArgs(wijmo_1.NotifyCollectionChangedAction.Change,n,i);e.onCollectionChanged(t)}return!0}})}return o}_getRowInfo(e){let i=[];wijmo_1.getTypes(e).forEach(e=>{let t=e.binding,o=e.dataType;if(o!=wijmo_1.DataType.Object&&o!=wijmo_1.DataType.Array){let e={binding:t,header:wijmo_1.toHeaderCase(t),dataType:o},r=wijmo_grid_1.FlexGrid._defTypeWidth[o];if(null!=r){if(wijmo_1.isString(r)){let e=Math.round(parseFloat(r));r=r.indexOf("*")<0?e:e*this.columns.defaultSize}wijmo_1.isNumber(r)&&r>0&&(e.width=r)}i.push(e)}});return i}}exports.TransposedGrid=TransposedGrid;class TransposedGridRow extends wijmo_grid_1.Column{}exports.TransposedGridRow=TransposedGridRow;wijmo_1._registerModule("wijmo.grid.transposed",selfModule);