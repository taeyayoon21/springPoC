/*!
    *
    * Wijmo Library 5.20202.724
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const wijmo_1=require("wijmo/wijmo"),wijmo_grid_1=require("wijmo/wijmo.grid"),selfModule=require("wijmo/wijmo.grid.transposedmultirow");class _MultiRow extends wijmo_grid_1.Row{constructor(e,t){super(e);this._idxData=t}}exports._MultiRow=_MultiRow;class _Cell extends wijmo_grid_1.Column{constructor(e){super();this._row=this._col=0;this._rowspan=this._colspan=1;wijmo_1.copy(this,e)}get row(){return this._row}set row(e){this._row=wijmo_1.asInt(e,!1,!0)}get col(){return this._col}set col(e){this._col=wijmo_1.asInt(e,!1,!0)}get colspan(){return this._colspan}set colspan(e){this._colspan=wijmo_1.asInt(e,!1,!0);wijmo_1.assert(this._colspan>0,"colspan must be >= 1")}get rowspan(){return this._rowspan}set rowspan(e){this._rowspan=wijmo_1.asInt(e,!1,!0);wijmo_1.assert(this._rowspan>0,"colspan must be >= 1")}}exports._Cell=_Cell;class _CellGroup extends _Cell{constructor(e,t){super();this._colstart=0;this._rowstart=0;this._layout=e;this._g=e._grid;wijmo_1.copy(this,t);if(!this._cells)throw"Cell group with no cells?";let o=0,l=0;this._cells.forEach((e,t)=>{for(;!this._cellFits(e,t,o,l);)0==(l=(l+1)%this.colspan)&&o++;e.row=o;e.col=l});let r=1,s=1;this._cells.forEach(e=>{r=Math.max(r,e.row+e.rowspan);s=Math.max(s,e.col+e.colspan)});this.rowspan=r;this.colspan=s}_copy(e,t){if("cells"==e){this._cells=[];wijmo_1.isArray(t)&&t.forEach(e=>{let t=new _Cell(e);t.binding&&!t.header&&(t.header=wijmo_1.toHeaderCase(t.binding));this._cells.push(t);this.colspan=Math.max(this.colspan,t.colspan)});return!0}return!1}get cells(){return this._cells}closeGroup(e){if(e>this.colspan){this._cells.forEach(t=>{t.col==this.colspan-1&&(t.colspan=e-t.col)});this.colspan=e}this._cells.forEach(e=>{for(;e.col+e.colspan<this.colspan&&!this._slotTaken(e.row,e.col+e.colspan);)e.colspan++});this._cells.forEach(e=>{for(;e.row+e.rowspan<this.rowspan&&!this._slotTaken(e.row+e.rowspan,e.col);)e.rowspan++});for(let e=0;e<this.rowspan;e++)for(let t=0;t<this.colspan;t++)wijmo_1.assert(this._slotTaken(e,t),"Invalid layout (empty cells).");this._cols=new wijmo_grid_1.ColumnCollection(this._g,this._g.columns.defaultSize);this._rng=new Array(e*this.rowspan);this._cells.forEach(e=>{for(let t=0;t<e.rowspan;t++)for(let o=0;o<e.colspan;o++){let l=(e.row+t)*this.colspan+(e.col+o);this._cols.setAt(l,e);let r=new wijmo_grid_1.CellRange(e.row,e.col,e.row+e.rowspan-1,e.col+e.colspan-1);r.isSingleCell||(this._rng[l]=r)}});this._rng[-1]=new wijmo_grid_1.CellRange(this._rowstart,this._colstart,this._rowstart+this._rowspan-1,this._colstart)}getMergedRange(e,t,o){if(o<0)return this._rng[-1];let l=t-this._rowstart,r=o%this.colspan,s=this._rng[l*this.colspan+r];e.cellType==wijmo_grid_1.CellType.RowHeader&&o++;let i=t-l,n=o-r;return s?new wijmo_grid_1.CellRange(i+s.row,n+s.col,i+s.row2,n+s.col2):null}getBindingColumn(e,t,o){if(o<0)return this;let l=t-this._rowstart,r=o%this.colspan;return this._cols[l*this.colspan+r]}_cellFits(e,t,o,l){if(l>0&&l+e.colspan>this.colspan)return!1;for(let r=0;r<e.colspan;r++)if(this._slotTaken(o,l+r,t))return!1;this.colspan=Math.max(this.colspan,l+e.colspan-1);return!0}_slotTaken(e,t,o=this._cells.length){for(let l=0;l<o;l++){let o=this._cells[l];if(e>=o.row&&e<=o.row+o.rowspan-1&&t>=o.col&&t<=o.col+o.colspan-1)return!0}return!1}_updateCellTypes(e){this._cols.forEach(t=>{let o=t;null==o.dataType&&o._binding&&(o.dataType=wijmo_1.getType(o._binding.getValue(e)))})}}exports._CellGroup=_CellGroup;class _MergeManager extends wijmo_grid_1.MergeManager{getMergedRange(e,t,o,l=!0){let r=e.grid;if(t<0||t>=e.rows.length||o<0||o>=e.columns.length)return null;switch(e.cellType){case wijmo_grid_1.CellType.Cell:case wijmo_grid_1.CellType.RowHeader:let l=e.rows[t].dataItem._rowInfo.index,s=o;e.cellType==wijmo_grid_1.CellType.RowHeader&&s--;let i=r._getGroupByRow(t);wijmo_1.assert(i instanceof _CellGroup,"Failed to get the group!");let n=i.getMergedRange(e,l,s);if(n){let o=l,r=t;if(t>0){o=e.rows[t-1].dataItem._rowInfo.index;r=t-1}n.row<=o?n.row=r:n.row=t;let s=l,i=t;if(t<e.rows.length-1){s=e.rows[t+1].dataItem._rowInfo.index;i=t+1}n.row2>=s?n.row2=i:n.row2=t}wijmo_1.assert(!n||n.contains(t,o),"Merged range must contain source cell");return n;case wijmo_grid_1.CellType.ColumnHeader:let a=r.columnsPerItem,_=o-o%a,w=Math.min(_+a-1,e.columns.length-1);return new wijmo_grid_1.CellRange(0,_,e.rows.length-1,w);case wijmo_grid_1.CellType.TopLeft:return new wijmo_grid_1.CellRange(0,0,e.rows.length-1,e.columns.length-1)}return null}}exports._MergeManager=_MergeManager;class _MultiRowLayout{constructor(e,t){this._columnsPerItem=1;this._bindingGroups=[];this._groupsByRow={};this._grid=e;this._bindingGroups=this._parseCellGroups(t)}get totalRowSpan(){let e=this._bindingGroups;if(e&&e.length){let t=e[e.length-1];return t._rowstart+t.rowspan}return 0}_parseCellGroups(e){let t=[],o=1;if(e){for(let l=0,r=0;l<e.length;l++){let s=new _CellGroup(this,e[l]);s._rowstart=r;r+=s._rowspan;o=Math.max(o,s._colspan);t.push(s)}t.forEach(e=>{e.closeGroup(o)});this._columnsPerItem=o}return t}_getGroupByRow(e){let t=this._getGroupIndexByRow(e);return t>-1?this._bindingGroups[t]:null}_getGroupIndexByRow(e){let t=this._groupsByRow[e];if(t)return t;let o=this._bindingGroups;for(let t=0;t<o.length;t++){let l=o[t];if(e>=l._rowstart&&e<=l._rowstart+l._rowspan-1){this._groupsByRow[e]=t;return t}}return-1}_updateCellTypes(e){this._bindingGroups.forEach(t=>{t._updateCellTypes(e)})}}exports._MultiRowLayout=_MultiRowLayout;class TransposedMultiRow extends wijmo_grid_1.FlexGrid{constructor(e,t){super(e);this._bindingColumns={};this._keyPrefix="item";wijmo_1.addClass(this.hostElement,"wj-transposed-multirow");this._layout=new _MultiRowLayout(this,null);this.allowDragging=wijmo_grid_1.AllowDragging.None;this.allowSorting=wijmo_grid_1.AllowSorting.None;this.mergeManager=new _MergeManager(this);this.formatItem.addHandler(this._formatItem,this);this._rowInfo=new wijmo_grid_1.ColumnCollection(this,this.columns.defaultSize);this.initialize(t);this._rowInfo.collectionChanged.addHandler(this._rowInfoChanged,this)}get layoutDefinition(){return this._layoutDef}set layoutDefinition(e){this._layoutDef=wijmo_1.asArray(e);this._layout=new _MultiRowLayout(this,e);this._rowInfoChanged()}getBindingColumn(e,t,o){if(e.cellType!=wijmo_grid_1.CellType.Cell)return null;let l=e.rows[t].dataItem._rowInfo.index,r=l+"_"+o,s=this._bindingColumns[r];if(s)return s;let i=this._getGroupByRow(t).getBindingColumn(e,l,o);if(i){s=new wijmo_grid_1.Column;wijmo_grid_1.FlexGrid._getSerializableProperties(wijmo_grid_1.Column).forEach(e=>{null!=i[e]&&(s[e]=i[e])});let e=Math.floor(o/this.columnsPerItem),t=o%this.columnsPerItem;s.binding=this._keyPrefix+e+"_"+t;this._bindingColumns[r]=s}return s}get columnsPerItem(){return this._layout._columnsPerItem}get allowAddNew(){return!1}set allowAddNew(e){wijmo_1.assert(!e,"TransposedMultiRow does not support items addition.")}get allowDelete(){return!1}set allowDelete(e){wijmo_1.assert(!e,"TransposedMultiRow does not support items deletion.")}get allowDragging(){return wijmo_grid_1.AllowDragging.None}set allowDragging(e){wijmo_1.assert(e===wijmo_grid_1.AllowDragging.None,"TransposedMultiRow does not support dragging.");if(e!==this._alDragging){this._alDragging=e;this.invalidate()}}get allowPinning(){return!1}set allowPinning(e){wijmo_1.assert(!e,"TransposedMultiRow does not support pinning.")}get allowSorting(){return wijmo_grid_1.AllowSorting.None}set allowSorting(e){wijmo_1.assert(e===wijmo_grid_1.AllowSorting.None,"TransposedMultiRow does not support sorting.");this._alSorting=e}get columnLayout(){throw"TransposedMultiRow does not support column layout."}set columnLayout(e){throw"TransposedMultiRow does not support column layout."}refresh(e){let t=this._rowInfo;if(t._dirty){t._dirty=!1;this._rowInfoChanged()}else super.refresh(e)}onLoadedRows(e){let t=this.columnHeaders.columns;for(let e=0;e<t.length;e++)this.columnHeaders.setCellData(0,e,"");let o=this.columns;for(let e=0;e<o.length;e++){let t=o[e];t.align=null;t.dataType=0}let l=this.rowHeaders.columns;this.rows.forEach(e=>{let t=e.dataItem._rowInfo;if(t)for(let o=l.length-2;o>=0;o--){let l=t.headers[o]||wijmo_1.toHeaderCase(t.bindings[o]);this.rowHeaders.setCellData(e.index,o+1,l)}});l[0].visible=!1;for(let e=1;e<l.length;e++){l[e].align="left";l[e].visible=!0;l[e].width=this.columns.defaultSize}super.onLoadedRows(e)}_getGroupByRow(e){let t=this.cells.rows[e].dataItem._rowInfo.index,o=this._layout._getGroupByRow(t);wijmo_1.assert(o instanceof _CellGroup,"Failed to get the group!");return o}_addBoundRow(e,t){let o=e[t];this.rows.push(new _MultiRow(o,t))}_updateColumnTypes(){super._updateColumnTypes();let e=this.collectionView;if(wijmo_1.hasItems(e)&&this._layout){let t=e.items[0]._arr;t&&t.length>0&&this._layout._updateCellTypes(t[0])}}_getBindingColumn(e,t,o){if(this._layout){e==this.cells&&(o=this.getBindingColumn(e,t,o.index));return o}return super._getBindingColumn(e,t,o)}_getCollectionView(e){let t=null;null!=this._view&&this._view.collectionChanged.removeHandler(this._sourceViewChanged);if(wijmo_1.isArray(e))e=this._transposeItemsSource(e);else if(e){this._view&&this._view.collectionChanged.removeHandler(this._sourceViewChanged);this._view=wijmo_1.tryCast(e,"ICollectionView");if(this._view){this._view.collectionChanged.addHandler(this._sourceViewChanged,this);e instanceof wijmo_1.CollectionView&&(t=e.getError);e=this._transposeItemsSource(this._view.items)}}this.autoGenerateColumns=!0;let o=super._getCollectionView(e);t&&o instanceof wijmo_1.CollectionView&&(o.getError=(e,o)=>{let l=e._keys.indexOf(o),r=l%e._bnd.length,s=Math.floor(l/e._bnd.length);return t(e._arr[s],e._bnd[r].path)});return o}_rowInfoChanged(){let e=this.selection,t=this.itemsSource;this._bindingColumns={};this.itemsSource=null;this.itemsSource=t;e&&e.isValid&&(this.selection=e)}_formatItem(e,t){let o=this.columnsPerItem,l=t.panel,r=l.cellType,s=l.rows[t.range.row],i=(l.rows[t.range.row2],t.cell);r==wijmo_grid_1.CellType.RowHeader&&wijmo_1.toggleClass(i,"wj-group-header",0==t.range.row);if(r==wijmo_grid_1.CellType.Cell||r==wijmo_grid_1.CellType.RowHeader){let e=this._getGroupByRow(t.row);wijmo_1.toggleClass(i,"wj-group-start",e._rowstart==t.range.row);wijmo_1.toggleClass(i,"wj-group-end",e._rowstart+e._rowspan-1==t.range.row2)}if(o>1&&(r==wijmo_grid_1.CellType.Cell||r==wijmo_grid_1.CellType.ColumnHeader)){wijmo_1.toggleClass(i,"wj-record-start",t.range.col%o==0);wijmo_1.toggleClass(i,"wj-record-end",t.range.col2%o==o-1)}let n=this.alternatingRowStep;if(n&&r==wijmo_grid_1.CellType.Cell){let e=this._layout.totalRowSpan,t=this._layout._bindingGroups.length,o=Math.floor(s.dataIndex/e)*t,l=s.dataIndex%e,r=(o+=this._layout._getGroupIndexByRow(l)+1)%(n+1)==0;wijmo_1.toggleClass(i,"wj-alt",r)}}_sourceViewChanged(e,t){this.activeEditor||this.invalidate()}_transposeItemsSource(e){let t=new wijmo_1.ObservableArray;if(this._layout&&this._layout._bindingGroups.length){this._getRowInfo(e).forEach((o,l)=>{let r=this._createKeys(e);if(this._supportsProxies()){let l=this._createProxy(e,o,r);t.push(l)}else{let l=this._createTransposedObject(e,o,r);t.push(l)}});e instanceof wijmo_1.ObservableArray&&e.collectionChanged.addHandler(()=>{let e=new wijmo_1.NotifyCollectionChangedEventArgs(wijmo_1.NotifyCollectionChangedAction.Reset);t.onCollectionChanged(e);this._rowInfoChanged()})}return t}_createKeys(e){let t=Array.apply(null,{length:this.columnsPerItem}),o=e.map((e,o)=>t.map((e,t)=>this._keyPrefix+o+"_"+t));return[].concat.apply([],o)}_supportsProxies(){return null!=window.Proxy}_createProxy(e,t,o){let l={_arr:e,_rowInfo:t,_bnd:t.bindings.map(e=>new wijmo_1.Binding(e)),_keys:o};return new Proxy(l,{ownKeys:e=>e._keys,getOwnPropertyDescriptor:()=>({enumerable:!0,configurable:!0,writable:!0}),get:(e,t)=>{let o=e._keys.indexOf(t);if(o>-1){let t=e._bnd,l=e._arr,r=t.length,s=o%r,i=Math.floor(o/r);return t[s].getValue(l[i])}return e[t]},set:(e,t,o)=>{let l=e._keys.indexOf(t);if(l>-1){let t=e._bnd,r=e._arr,s=t.length,i=l%s,n=Math.floor(l/s);t[i].setValue(r[n],o);if(r instanceof wijmo_1.ObservableArray){let e=new wijmo_1.NotifyCollectionChangedEventArgs(wijmo_1.NotifyCollectionChangedAction.Change,r[n],n);r.onCollectionChanged(e)}return!0}return!1}})}_createTransposedObject(e,t,o){let l={_arr:e,_rowInfo:t,_bnd:t.bindings.map(e=>new wijmo_1.Binding(e)),_keys:o};for(let t=0;t<o.length;t++){let r=o[t];Object.defineProperty(l,r,{enumerable:!0,get:()=>{let o=l._bnd,r=o.length,s=t%r,i=Math.floor(t/r);return o[s].getValue(e[i])},set:o=>{let r=l._bnd,s=r.length,i=t%s,n=Math.floor(t/s);r[i].setValue(e[n],o);if(e instanceof wijmo_1.ObservableArray){let t=new wijmo_1.NotifyCollectionChangedEventArgs(wijmo_1.NotifyCollectionChangedAction.Change,e[n],n);e.onCollectionChanged(t)}return!0}})}return l}_getRowInfo(e){let t=[];if(this._layout){let e=this.rowHeaders.columns,o=this.columnsPerItem+1;for(;e.length>o;)e.removeAt(e.length-1);for(;e.length<o;)e.push(new wijmo_grid_1.Column);this._layout._bindingGroups.forEach(e=>{for(let o=0;o<e.rowspan;o++){let l={index:e._rowstart+o,bindings:[],headers:[]};for(let t=0;t<e.colspan;t++)for(let r=0;r<e.cells.length;r++){let s=e.cells[r];if(o>=s.row&&o<s.row+s.rowspan&&t>=s.col&&t<s.col+s.colspan){l.bindings.push(s.binding);l.headers.push(s.header);break}}t.push(l)}})}return t}}exports.TransposedMultiRow=TransposedMultiRow;wijmo_1._registerModule("wijmo.grid.transposedmultirow",selfModule);