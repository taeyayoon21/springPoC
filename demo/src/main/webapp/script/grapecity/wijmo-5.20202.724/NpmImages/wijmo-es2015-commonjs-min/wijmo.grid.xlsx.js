/*!
    *
    * Wijmo Library 5.20202.724
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const wijmo_1=require("wijmo/wijmo"),wijmo_grid_1=require("wijmo/wijmo.grid"),mXlsx=require("wijmo/wijmo.xlsx"),selfModule=require("wijmo/wijmo.grid.xlsx");function softDetail(){return wijmo_1._getModule("wijmo.grid.detail")}exports.softDetail=softDetail;function softMultiRow(){return wijmo_1._getModule("wijmo.grid.multirow")}exports.softMultiRow=softMultiRow;function softTransposed(){return wijmo_1._getModule("wijmo.grid.transposed")}exports.softTransposed=softTransposed;function softTransposedMultiRow(){return wijmo_1._getModule("wijmo.grid.transposedmultirow")}exports.softTransposedMultiRow=softTransposedMultiRow;class FlexGridXlsxConverter{static save(e,l,t){let o=new mXlsx.Workbook;this._saveFlexGridToWorkbook(o,e,l,!1,null);t&&o.save(t);return o}static saveAsync(e,l,t,o,r,s,i){let n=new mXlsx.Workbook;if(!i){this._saveFlexGridToWorkbook(n,e,l,!1,null);t?n.saveAsync(t,e=>{wijmo_1.isFunction(o)&&o(e,n)},r,null):wijmo_1.isFunction(o)&&o(null,n);return n}let a=null!=t;this.cancelAsync(()=>{let i,d=[e.collectionView&&e.collectionView.collectionChanged,e.columns&&e.columns.collectionChanged,e.rows&&e.rows.collectionChanged,e.resizedColumn,e.resizedRow],removeHandlers=()=>d.forEach(e=>{e&&e.removeHandler(restart)}),restart=()=>{this._cs&&this._cs.cancel(!1);clearTimeout(i);i=setTimeout(()=>{removeHandlers();n=null;this.saveAsync(e,l,t,o,r,s)},100)},finish=()=>{clearTimeout(i);this._cs=null;removeHandlers()};this._cs=new mXlsx._SyncPromise(null,finish);d.forEach(e=>{e&&e.addHandler(restart)});this._saveFlexGridToWorkbook(n,e,l,!0,this._cs,e=>{wijmo_1.isFunction(s)&&s(a?Math.round(mXlsx._map(e,0,100,0,50)):e)}).then(()=>{if(t){n._externalCancellation=()=>this._cs;n.saveAsync(t,e=>{finish();wijmo_1.isFunction(o)&&o(e,n)},e=>{finish();wijmo_1.isFunction(r)&&r(e)},e=>{wijmo_1.isFunction(s)&&s(Math.round(mXlsx._map(e,0,100,51,100)))})}else{finish();wijmo_1.isFunction(s)&&s(100);wijmo_1.isFunction(o)&&o(null,n)}},e=>{finish();throw e})});return null}static cancelAsync(e){if(this._cs){this._cs.cancel();setTimeout(()=>{this._cs=null;wijmo_1.isFunction(e)&&e()},100)}else wijmo_1.isFunction(e)&&e()}static load(e,l,t){if(l instanceof Blob){var o=new FileReader;o.onload=()=>{var l=mXlsx.Workbook._base64EncArr(new Uint8Array(o.result)),r=new mXlsx.Workbook;r.load(l);l=null;e.deferUpdate(()=>{this._loadToFlexGrid(e,r,t);r=null})};o.readAsArrayBuffer(l)}else if(l instanceof mXlsx.Workbook)e.deferUpdate(()=>{this._loadToFlexGrid(e,l,t);l=null});else{if(l instanceof ArrayBuffer)l=mXlsx.Workbook._base64EncArr(new Uint8Array(l));else if(!wijmo_1.isString(l))throw"Invalid workbook.";var r=new mXlsx.Workbook;r.load(l);l=null;e.deferUpdate(()=>{this._loadToFlexGrid(e,r,t);r=null})}}static loadAsync(e,l,t,o,r){if(l instanceof Blob){var s=new FileReader;s.onload=()=>{var l=mXlsx.Workbook._base64EncArr(new Uint8Array(s.result)),i=new mXlsx.Workbook;i.loadAsync(l,r=>{l=null;i=null;e.deferUpdate(()=>{this._loadToFlexGrid(e,r,t);o&&o(r);r=null})},r)};s.readAsArrayBuffer(l)}else if(l instanceof mXlsx.Workbook)e.deferUpdate(()=>{this._loadToFlexGrid(e,l,t);o&&o(l);l=null});else{if(l instanceof ArrayBuffer)l=mXlsx.Workbook._base64EncArr(new Uint8Array(l));else if(!wijmo_1.isString(l))throw"Invalid workbook.";(new mXlsx.Workbook).loadAsync(l,r=>{l=null;e.deferUpdate(()=>{this._loadToFlexGrid(e,r,t);o&&o(r);r=null})},r)}}static _saveFlexGridToWorkbook(e,l,t,o,r,s){let i,n=new mXlsx._SyncPromise(r),a=new mXlsx.WorkSheet,d=!t||null==t.includeColumnHeaders||t.includeColumnHeaders,u=!(!t||null==t.includeRowHeaders)&&t.includeRowHeaders,c=_IncludeCellStyles.Cache,m=t?t.includeColumns:null,h=t?t.formatItem:null,f=0,w=u?l.rowHeaders.columns.length:0,p=[];t&&(c=!1===wijmo_1.asBoolean(t.includeCellStyles,!0)?_IncludeCellStyles.None:!1===wijmo_1.asBoolean(t.quickCellStyles,!0)?_IncludeCellStyles.Regular:_IncludeCellStyles.Cache);let _=c===_IncludeCellStyles.Cache?new _StyleCache(500):null;null==this.hasCssText&&(this.hasCssText="cssText"in document.body.style);let g,x=l.wj_sheetInfo;a.name=t?t.sheetName:"";a.visible=!t||!1!==t.sheetVisible;if(x&&x.tables&&x.tables.length>0)for(let e=0;e<x.tables.length;e++)a.tables.push(x.tables[e]);i=[];if(!x&&(c!==_IncludeCellStyles.None||h)){(g=document.createElement("div")).style.visibility="hidden";g.setAttribute(wijmo_grid_1.FlexGrid._WJS_MEASURE,"true");l.hostElement.appendChild(g)}(u?[l.rowHeaders,l.columnHeaders]:[l.columnHeaders]).forEach(e=>{let t=e.rows,o=e.columns,r=0,s=e.cellType===wijmo_grid_1.CellType.ColumnHeader?w:0;for(let n=0;n<t.length;n++)if(!(t[n].renderSize<=0)){i[r]||(i[r]=[]);for(let t=0,d=0;t<o.length;t++){let u=l._getBindingColumn(e,n,o[t]),c=this._getColumnSetting(u,t,o);if(c){i[r][s+t]=c;if(0===r){if(e.cellType===wijmo_grid_1.CellType.ColumnHeader&&m&&!m(u))continue;let l=new mXlsx.WorkbookColumn;l._deserialize(c);a._addWorkbookColumn(l,s+d++)}}}r++}e.cellType===wijmo_grid_1.CellType.ColumnHeader&&(f=d?r:0)});let y=[[l.topLeftCells,l.columnHeaders],[l.rowHeaders,l.cells],[l.bottomLeftCells,l.columnFooters]];d||y.shift();let b=y.map(e=>e[1].rows.length).reduce((e,l)=>e+l);this._saveContentToWorksheet(r,o,Date.now(),0,{panels:y,panelIdx:0,globRowIdx:0,rowsOffset:0,totalRows:b},l,a,u,i,c,g,p,_,m,h,e=>{s(Math.round(e/b*100))},()=>{let o=new mXlsx.WorkbookFrozenPane;o.rows=d?l.frozenRows+f:l.frozenRows;o.columns=u?l.frozenColumns+w:l.frozenColumns;a.frozenPane=o;e._addWorkSheet(a);if(!x&&(c!==_IncludeCellStyles.None||h)){l.hostElement.removeChild(g);p.forEach(e=>e.forEach(e=>{e&&e.parentElement&&e.parentElement.removeChild(e)}))}_&&_.clear();e.activeWorksheet=t?t.activeWorksheet:null;n.resolve()});return n}static _saveContentToWorksheet(e,l,t,o,r,s,i,n,a,d,u,c,m,h,f,w,p){let _=d?20:200;for(let g=o;g<r.totalRows;g++){if(e&&e.cancelled)return;if(l&&g-o>_&&Date.now()-t>100){setTimeout(()=>{if(!e||!e.cancelled){w(g);this._saveContentToWorksheet(e,l,Date.now(),g,r,s,i,n,a,d,u,c,m,h,f,w,p)}},0);return}for(;g-r.rowsOffset>=r.panels[r.panelIdx][1].rows.length;){r.rowsOffset+=r.panels[r.panelIdx][1].rows.length;r.panelIdx++}let x=r.panels[r.panelIdx],y=x[0],b=x[1],C=g-r.rowsOffset,v=b.rows[C];if(b.cellType!==wijmo_grid_1.CellType.Cell&&v.renderSize<=0||v instanceof wijmo_grid_1._NewRowTemplate)continue;let T=0,S={},k=new mXlsx.WorkbookRow,j=v instanceof wijmo_grid_1.GroupRow,R=0;b.cellType===wijmo_grid_1.CellType.Cell&&(j?R=v.level:s.rows.maxGroupLevel>-1&&(R=s.rows.maxGroupLevel+1));n&&(T=this._parseFlexGridRowToSheetRow(y,S,C,0,a,d,u,c,m,j,R,h,f));this._parseFlexGridRowToSheetRow(b,S,C,T,a,d,u,c,m,j,R,h,f);if(S.cells.length>0){k._deserialize(S);i._addWorkbookRow(k,r.globRowIdx)}r.globRowIdx++}wijmo_1.isFunction(p)&&p()}static _loadToFlexGrid(e,l,t){if(softTransposedMultiRow()&&e instanceof softTransposedMultiRow().TransposedMultiRow)throw"Not supported.";t=t||{};let o,r=null!=e.wj_sheetInfo,s={},i=[],n=[],a={};e.itemsSource=null;e.columns.clear();e.columnHeaders.rows.clear();e.rowHeaders.columns.clear();e.rows.clear();e.frozenColumns=0;e.frozenRows=0;let d=null==t.sheetIndex||isNaN(t.sheetIndex)?0:t.sheetIndex;if(d<0||d>=l.sheets.length)throw"The sheet index option is out of the sheet range of current workbook.";if(null!=t.sheetName)for(let e=0;e<l.sheets.length;e++)if(t.sheetName===l.sheets[e].name){o=l.sheets[e];break}if(null==(o=o||l.sheets[d]).rows)return;let u=this._getColumnCount(o.rows),c=this._getRowCount(o.rows,u),m=o.columns;for(let l=0;l<u;l++){e.columns.push(new wijmo_grid_1.Column);if(m[l]){isNaN(+m[l].width)||(e.columns[l].width=+m[l].width);m[l].visible||null==m[l].visible||(e.columns[l].visible=!!m[l].visible);m[l].style&&m[l].style.wordWrap&&(e.columns[l].wordWrap=m[l].style.wordWrap)}}let h,f=(null==t.includeColumnHeaders||t.includeColumnHeaders)&&o.rows.length>0,w=f?this._getColumnHeadersHeight(o):0,p=!1,_=[],g=o.frozenPane&&o.frozenPane.rows,x=o.frozenPane&&o.frozenPane.columns;g=wijmo_1.isNumber(g)&&!isNaN(g)?g:null;x=wijmo_1.isNumber(x)&&!isNaN(x)?x:null;for(let l=w;l<c;l++){let t=!1,d=null,c=o.rows[l];if(c){let e=l+1;for(;e<o.rows.length;){let l=o.rows[e];if(l){(isNaN(c.groupLevel)&&!isNaN(l.groupLevel)||!isNaN(c.groupLevel)&&c.groupLevel<l.groupLevel)&&(t=!0);break}e++}}if(t&&!o.summaryBelow){h&&(h.isCollapsed=p);(h=new wijmo_grid_1.GroupRow).isReadOnly=!1;p=null!=c.collapsed&&c.collapsed;h.level=isNaN(c.groupLevel)?0:c.groupLevel;a[h.level]=p;this._checkParentCollapsed(a,h.level)&&h._setFlag(wijmo_grid_1.RowColFlags.ParentCollapsed,!0);e.rows.push(h)}else{let l=new wijmo_grid_1.Row;c&&this._checkParentCollapsed(a,c.groupLevel)&&l._setFlag(wijmo_grid_1.RowColFlags.ParentCollapsed,!0);e.rows.push(l)}c&&c.height&&!isNaN(c.height)&&(e.rows[l-w].height=c.height);for(let o=0;o<u;o++)if(c){let a=c.cells[o],m=a?a.formula:null;m&&"="!==m[0]&&(m="="+m);if(a&&a.textRuns&&a.textRuns.length>0){e.rows[l-w].isContentHtml=!0;e.setCellData(l-w,o,this._parseTextRunsToHTML(a.textRuns))}else e.setCellData(l-w,o,m&&r?m:this._getItemValue(a));t||this._setColumn(_,o,a);let h,f=l*u+o,p=a?a.style:null,v=mXlsx.Workbook._parseExcelFormat(a);if(p){d=null==d?!!p.wordWrap:d&&!!p.wordWrap;if(p.hAlign)h=mXlsx.Workbook._parseHAlignToString(wijmo_1.asEnum(p.hAlign,mXlsx.HAlign));else switch(this._getItemType(a)){case wijmo_1.DataType.Number:h="right";break;case wijmo_1.DataType.Boolean:h="center";break;default:h=v&&0===v.search(/[n,c,p]/i)?"right":"left"}s[f]={fontWeight:p.font&&p.font.bold?"bold":"none",fontStyle:p.font&&p.font.italic?"italic":"none",textDecoration:p.font&&p.font.underline?"underline":"none",textAlign:h,fontFamily:p.font&&p.font.family?p.font.family:"",fontSize:p.font&&p.font.size?p.font.size+"px":"",color:p.font&&p.font.color?p.font.color:"",backgroundColor:p.fill&&p.fill.color?p.fill.color:"",whiteSpace:p.wordWrap?"pre-wrap":"normal",format:v};if(p.borders){if(p.borders.left){this._parseBorderStyle(p.borders.left.style,"Left",s[f]);s[f].borderLeftColor=p.borders.left.color}if(p.borders.right){this._parseBorderStyle(p.borders.right.style,"Right",s[f]);s[f].borderRightColor=p.borders.right.color}if(p.borders.top){this._parseBorderStyle(p.borders.top.style,"Top",s[f]);s[f].borderTopColor=p.borders.top.color}if(p.borders.bottom){this._parseBorderStyle(p.borders.bottom.style,"Bottom",s[f]);s[f].borderBottomColor=p.borders.bottom.color}}if(p.fill&&p.fill.color){var y=s[f],b=p.borders,C=p.fill.color;if(b){b.left&&b.left.color||(y.borderLeftColor=C);b.right&&b.right.color||o===x-1||(y.borderRightColor=C);b.top&&b.top.color||(y.borderTopColor=C);b.bottom&&b.bottom.color||l===g-1||(y.borderBottomColor=C)}else{y.borderLeftColor=C;o!==x-1&&(y.borderRightColor=C);y.borderTopColor=C;l!==g-1&&(y.borderBottomColor=C)}}p.font&&-1===n.indexOf(p.font.family)&&n.push(p.font.family)}a&&wijmo_1.isNumber(a.rowSpan)&&a.rowSpan>0&&wijmo_1.isNumber(a.colSpan)&&a.colSpan>0&&(a.rowSpan>1||a.colSpan>1)&&i.push(new wijmo_grid_1.CellRange(l,o,l+a.rowSpan-1,o+a.colSpan-1))}if(c){this._checkParentCollapsed(a,c.groupLevel)||c.visible||null==c.visible||(e.rows[l-w].visible=c.visible);e.rows[l-w].wordWrap=!!c.style&&!!c.style.wordWrap||!!d}}h&&(h.isCollapsed=p);null!=x&&(e.frozenColumns=x);null!=g&&(e.frozenRows=f&&g>0?g-1:g);for(let l=0;l<e.columnHeaders.columns.length;l++){let t=_[l],o=e.columns[l];o.isRequired=!1;if(t){t.dataType===wijmo_1.DataType.Boolean&&(o.dataType=t.dataType);o.format=t.format;o.align=t.hAlign;o.wordWrap=o.wordWrap||!!t.wordWrap}}for(let l=0;l<Math.max(w,1);l++)e.columnHeaders.rows.push(new wijmo_grid_1.Row);let v=Object.keys(o.rows);for(let l=0;l<w;l++)for(let t=0;t<e.columnHeaders.columns.length;t++){let r=o.rows[v[l]].cells[t],s=r&&r.value||"",i=e.columnHeaders.columns[t];if(s){let e=mXlsx.Workbook._parseExcelFormat(r);s=wijmo_1.Globalize.format(s,e)}i.header=i.header||s;e.columnHeaders.setCellData(l,t,s)}if(r){let l=null==t.sheetVisible||t.sheetVisible;e.wj_sheetInfo.name=o.name;e.wj_sheetInfo.visible=!0===l||!1!==o.visible;e.wj_sheetInfo.styledCells=s;e.wj_sheetInfo.mergedRanges=i;e.wj_sheetInfo.fonts=n;e.wj_sheetInfo.tables=o.tables}}static _getColumnHeadersHeight(e){if(!e&&!e.rows.length)return 0;let l=1;for(var t=0;t<e.rows.length;t++){var o=e.rows[t];if(o){o.cells.forEach(e=>{l=Math.max(l,e.rowSpan||0)});break}}return l}static _escapePlainText(e){return null==e?"":""===e?"'":e&&("'"===e[0]||e.length>1&&"="===e[0]&&"="===e[1])?"'"+e:e}static _parseFlexGridRowToSheetRow(e,l,t,o,r,s,i,n,a,d,u,c,m){var h,f,w,p,_,g,x,y,b,C,v,T,S,k,j,R,X,W,F,A,I,D,N,B,H,M,E,z,G,L,O=!1,P=!1;(F=(h=e.grid).wj_sheetInfo)&&(A=F.evaluateFormula);if(null==(f=e.rows[t]).recordIndex){B=0;e.cellType===wijmo_grid_1.CellType.ColumnHeader&&e.rows.length>1&&(B=t===r.length?t-1:t)}else B=f.recordIndex;l.cells||(l.cells=[]);l.visible=f.isVisible;l.height=f.renderHeight||e.rows.defaultSize;l.groupLevel=u;d&&(l.collapsed=f.isCollapsed);f.wordWrap&&(l.style={wordWrap:f.wordWrap});(f.constructor===wijmo_grid_1.Row||f.constructor===wijmo_grid_1._NewRowTemplate||softTransposed()&&h instanceof softTransposed().TransposedGrid&&f instanceof wijmo_grid_1.Row||softDetail()&&f.constructor===softDetail().DetailRow||softMultiRow()&&f.constructor===softMultiRow()._MultiRow||softTransposedMultiRow()&&f instanceof softTransposedMultiRow()._MultiRow)&&(O=!0);softDetail()&&f.constructor===softDetail().DetailRow&&(P=!0);for(p=0;p<e.columns.length;p++){_=null;W=1;X=1;G=0;N=!1;j=null;null;M=null;y=null;D=h._getBindingColumn(e,t,e.columns[p]);R=null;if(F&&e===h.cells){k=t*e.columns.length+p;F.mergedRanges&&(R=this._getMergedRange(t,p,F.mergedRanges));F.styledCells&&(j=F.styledCells[k])}else if(s!==_IncludeCellStyles.None){M=this._getMeasureCell(e,p,i,n);j=(R=h.getMergedRange(e,t,p,!1))?this._getCellStyle(e,M,R.bottomRow,R.rightCol,a)||{}:this._getCellStyle(e,M,t,p,a)||{}}R||(R=h.getMergedRange(e,t,p,!1));if(R){if(t===R.topRow&&p===R.leftCol){X=R.bottomRow-R.topRow+1;W=this._getColSpan(e,R,c);N=!0}}else N=!0;if(!c||c(D)){w=r[B]?r[B][p+o]:null;if(O||d){x=N?e.getCellData(t,p,!0):null;b=N?e.getCellData(t,p,!1):null;v=this._isFormula(x);S=null;I=wijmo_1.isDate(b);if(j&&j.format){_=j.format;/[hsmyt\:]/i.test(_)&&(I=!0);g=mXlsx.Workbook._parseCellFormat(j.format,I)}else if(w&&w.style&&w.style.format){_=D.format;g=w.style.format}else g=null;v&&null!=A&&wijmo_1.isFunction(A)&&(S=A(x));if(!g)if(I)g="m/d/yyyy";else if(wijmo_1.isNumber(b)&&!D.dataMap)g=wijmo_1.isInt(b)?"#,##0":"#,##0.00";else if(v){if((T=x.toLowerCase()).indexOf("now()")>-1){g="m/d/yyyy h:mm";I=!0}else if(T.indexOf("today()")>-1||T.indexOf("date(")>-1){g="m/d/yyyy";I=!0}else if(T.indexOf("time(")>-1){g="h:mm AM/PM";I=!0}}else g="General"}else{x=N?h.columnHeaders.getCellData(0,p,!0):null;g="General"}if(wijmo_1.isString(x)&&-1!==x.indexOf("<span")){y=this._parseToTextRuns(x);x=null}E=this._parseCellStyle(j)||{};if(e===h.cells&&d&&f.hasChildren&&p===h.columns.firstVisibleIndex){v&&null!=S?C=S:x?C=x:N&&(C=f.getGroupHeader().replace(/<\/?\w+>/g,"").replace(/&#39;/g,"'"));if(null==C&&!j)continue;!(I=wijmo_1.isDate(C))&&_&&"d"===_.toLowerCase()&&wijmo_1.isInt(C)&&(g="0");C=wijmo_1.isString(C)?mXlsx.Workbook._unescapeXML(C):C;p===h.columns.firstVisibleIndex&&h.treeIndent&&(G=u);H={value:C,isDate:I,formula:v?this._parseToExcelFormula(x,I):null,colSpan:W,rowSpan:X,style:this._extend(E,{format:g,font:{bold:!0},hAlign:mXlsx.HAlign.Left,indent:G}),textRuns:y}}else{x=wijmo_1.isString(x)?mXlsx.Workbook._unescapeXML(x):x;b=wijmo_1.isString(b)?mXlsx.Workbook._unescapeXML(b):b;!I&&_&&"d"===_.toLowerCase()&&wijmo_1.isInt(b)&&(g="0");z=E&&E.hAlign?E.hAlign:w&&w.style&&null!=w.style.hAlign?wijmo_1.asEnum(w.style.hAlign,mXlsx.HAlign,!0):wijmo_1.isDate(b)?mXlsx.HAlign.Left:mXlsx.HAlign.General;p!==h.columns.firstVisibleIndex||!h.treeIndent||z!==mXlsx.HAlign.Left&&z!==mXlsx.HAlign.General||(G=u);H={value:v?S:"General"!==g||""===x&&null==b?this._escapePlainText(b):this._escapePlainText(x),isDate:I,formula:v?this._parseToExcelFormula(x,I):null,colSpan:p<h.columns.firstVisibleIndex?1:W,rowSpan:X,style:this._extend(E,{format:g,hAlign:z,vAlign:X>1?e===h.cells||!1===h.centerHeadersVertically?mXlsx.VAlign.Top:mXlsx.VAlign.Center:null,indent:G}),textRuns:y};P&&(L=e.getCellElement(t,p))&&L.appendChild(f.detail)}m&&m(new XlsxFormatItemEventArgs(e,new wijmo_grid_1.CellRange(t,p),M,i,n,a,H));l.cells.push(H)}}return o+p}static _parseCellStyle(e,l=!1){if(null==e)return null;var t=e.fontSize;t=t?+t.substring(0,t.indexOf("px")):null;isNaN(t)&&(t=null);var o=e.fontWeight;o="bold"===o||+o>=700;var r="italic"===e.fontStyle,s=e.textDecorationStyle;null==s&&(s=e.textDecoration);s="underline"===s;var i=e.whiteSpace;i=!!i&&i.indexOf("pre")>-1;return{font:{bold:o,italic:r,underline:s,family:this._parseToExcelFontFamily(e.fontFamily),size:t,color:e.color},fill:{color:e.backgroundColor},borders:this._parseBorder(e,l),hAlign:mXlsx.Workbook._parseStringToHAlign(e.textAlign),wordWrap:i}}static _parseBorder(e,l){var t={};t.left=this._parseEgdeBorder(e,"Left");t.right=this._parseEgdeBorder(e,"Right");t.top=this._parseEgdeBorder(e,"Top");t.bottom=this._parseEgdeBorder(e,"Bottom");if(l){t.vertical=this._parseEgdeBorder(e,"Vertical");t.horizontal=this._parseEgdeBorder(e,"Horizontal")}return t}static _parseEgdeBorder(e,l){var t,o=e["border"+l+"Style"],r=e["border"+l+"Width"];r&&(r=parseFloat(r));if(o&&"none"!==o&&"hidden"!==o&&0!==r){t={};switch(o=o.toLowerCase()){case"dotted":t.style=r>1?mXlsx.BorderStyle.MediumDashDotted:mXlsx.BorderStyle.Dotted;break;case"dashed":t.style=r>1?mXlsx.BorderStyle.MediumDashed:mXlsx.BorderStyle.Dashed;break;case"double":t.style=mXlsx.BorderStyle.Double;break;default:t.style=r>2?mXlsx.BorderStyle.Thick:r>1?mXlsx.BorderStyle.Medium:mXlsx.BorderStyle.Thin}t.color=e["border"+l+"Color"]}return t}static _parseBorderStyle(e,l,t){var o="border"+l+"Style",r="border"+l+"Width";switch(e){case mXlsx.BorderStyle.Dotted:case mXlsx.BorderStyle.Hair:t[o]="dotted";t[r]="1px";break;case mXlsx.BorderStyle.Dashed:case mXlsx.BorderStyle.ThinDashDotDotted:case mXlsx.BorderStyle.ThinDashDotted:t[o]="dashed";t[r]="1px";break;case mXlsx.BorderStyle.MediumDashed:case mXlsx.BorderStyle.MediumDashDotDotted:case mXlsx.BorderStyle.MediumDashDotted:case mXlsx.BorderStyle.SlantedMediumDashDotted:t[o]="dashed";t[r]="2px";break;case mXlsx.BorderStyle.Double:t[o]="double";t[r]="3px";break;case mXlsx.BorderStyle.Medium:t[o]="solid";t[r]="2px";break;case mXlsx.BorderStyle.Thick:t[o]="solid";t[r]="3px";break;default:t[o]="solid";t[r]="1px"}}static _parseToExcelFontFamily(e){var l;e&&(l=e.split(","))&&l.length>0&&(e=l[0].replace(/\"|\'/g,""));return e}static _parseToExcelFormula(e,l){var t,o,r,s,i,n,a,d=/\"?\w+\"?\s*\,\s*\"(\w+)\"/i;if(t=e.match(/(floor|ceiling)\([+-]?\d+\.?\d*\)/gi))for(i=0;i<t.length;i++){a=(n=t[i]).substring(0,n.lastIndexOf(")"))+", 1)";e=e.replace(n,a)}t=null;if(t=e.match(/text\(\"?\w+\"?\s*\,\s*\"\w+\"\)/gi))for(i=0;i<t.length;i++)if((o=(n=t[i]).match(d))&&2===o.length){r=o[1];if(!/^d{1,4}?$/.test(r)){s=mXlsx.Workbook._parseCellFormat(r,l);a=n.replace(r,s);e=e.replace(n,a)}}return e}static _parseToTextRuns(e){var l,t,o,r=e.split("<span "),s=[];for(l=0;l<r.length;l++){o=-1!==(t=r[l]).indexOf("</span>")?{text:t.substring(t.indexOf(">")+1,t.indexOf("</span>")),font:this._parseToTextRunFont(t.substring(t.indexOf('style="')+7,t.indexOf(';"')))}:{text:t};s.push(o)}return s}static _parseToTextRunFont(e){var l,t,o,r,s,i,n,a,d,u=e.split(";");if(u.length>0){for(l=0;l<u.length;l++)if(2===(t=u[l].split(":")).length){t[1]=t[1].trim();switch(t[0]){case"font-size":i=+t[1].substring(0,t[1].indexOf("px"));isNaN(i)&&(i=null);break;case"font-weight":o="bold"===t[1]||+t[1]>=700;break;case"font-style":r="italic"===t[1];break;case"text-decoration-style":case"text-decoration":s="underline"===t[1];break;case"font-family":n=this._parseToExcelFontFamily(t[1]);break;case"color":a=t[1]}}d={bold:o,italic:r,underline:s,family:n,size:i,color:a}}return d}static _getMeasureCell(e,l,t,o){let r=o[e.cellType],s=r&&r[l],i=null==s;if(s){if(this.hasCssText){s.style;s.style.cssText="";s.style.visibility="hidden"}}else{r||(o[e.cellType]=r=[]);r[l]=s=t.cloneNode()}!i&&s.parentElement||(e.hostElement.children.length>0?e.hostElement.children[0].appendChild(s):e.hostElement.appendChild(s));return s}static _getColumnSetting(e,l,t){let o=e;null!=e.colspan&&(o=this._getRenderColumn(l,t));return o?{autoWidth:!0,width:o.renderWidth||t.defaultSize,visible:o.visible,style:{format:o.format?mXlsx.Workbook._parseCellFormat(o.format,o.dataType===wijmo_1.DataType.Date):"",hAlign:mXlsx.Workbook._parseStringToHAlign(this._toExcelHAlign(o.getAlignment())),wordWrap:o.wordWrap}}:null}static _toExcelHAlign(e){return(e=e?e.trim().toLowerCase():e)?e.indexOf("center")>-1?"center":e.indexOf("right")>-1||e.indexOf("end")>-1?"right":e.indexOf("justify")>-1?"justify":"left":e}static _getColumnCount(e){for(var l,t=0,o=0,r=0;r<e.length;r++)if((l=e[r]&&e[r].cells?e[r].cells:[])&&l.length>0){o=l.length;wijmo_1.isInt(l[o-1].colSpan)&&l[o-1].colSpan>1&&(o=o+l[o-1].colSpan-1);o>t&&(t=o)}return t}static _getRowCount(e,l){for(var t,o,r=e.length,s=r-1,i=0;i<l;i++)e:for(;s>=0;s--)if((o=((t=e[s])&&t.cells?t.cells:[])[i])&&(null!=o.value&&""!==o.value||wijmo_1.isInt(o.rowSpan)&&o.rowSpan>1)){wijmo_1.isInt(o.rowSpan)&&o.rowSpan>1&&s+o.rowSpan>r&&(r=s+o.rowSpan);break e}return r}static _numAlpha(e){var l=Math.floor(e/26)-1;return(l>-1?this._numAlpha(l):"")+String.fromCharCode(65+e%26)}static _getItemType(e){return null==e||null==e.value||isNaN(e.value)?null:wijmo_1.getType(e.value)}static _setColumn(e,l,t){var o,r,s,i=e[l];if(i){o=this._getItemType(t);i.dataType!==o&&i.dataType===wijmo_1.DataType.Boolean&&o!==wijmo_1.DataType.Boolean&&(i.dataType=o);!t||null==t.value||wijmo_1.isString(t.value)&&wijmo_1.isNullOrWhiteSpace(t.value)||(r=mXlsx.Workbook._parseExcelFormat(t))&&i.format!==r&&"General"!==r&&(i.format=r);if(t&&t.style){t.style.hAlign&&(s=mXlsx.Workbook._parseHAlignToString(wijmo_1.asEnum(t.style.hAlign,mXlsx.HAlign)));null==i.wordWrap?i.wordWrap=!!t.style.wordWrap:i.wordWrap=i.wordWrap&&!!t.style.wordWrap}s||o!==wijmo_1.DataType.Number||(s="right");i.hAlign=s}else e[l]={dataType:this._getItemType(t),format:mXlsx.Workbook._parseExcelFormat(t),hAlign:"",wordWrap:null}}static _getItemValue(e){if(null==e||null==e.value)return null;var l=e.value;wijmo_1.isString(l)&&"'"===l[0]&&(l=l.substr(1));return wijmo_1.isNumber(l)&&isNaN(l)?"":l instanceof Date&&isNaN(l.getTime())?"":l}static _getCellStyle(e,l,t,o,r){var s,i=e.grid;try{var n=!(r&&!i.formatItem.hasHandlers&&!i.itemFormatter);i.cellFactory.updateCell(e,t,o,l,null,n);l.className=l.className.replace("wj-state-selected","");l.className=l.className.replace("wj-state-multi-selected","")}catch(e){return null}if(r){var a,d=e.hostElement,u=l;a=u.style.cssText.split(/;\s+/).filter(e=>{var l=e.substring(0,e.indexOf(":"));return/^(color|background|border|font|text|whitespace)/i.test(l)}).join(";");do{a=u.className+a}while(u!==d&&(u=u.parentElement));if(!(s=r.getValue(a))){s=window.getComputedStyle(l);r.add(a,s)}}else s=window.getComputedStyle(l);return s}static _parseTextRunsToHTML(e){var l,t,o,r;o="";for(r=0;r<e.length;r++)o+=(t=(l=e[r]).font)?'<span style="'+(t.bold?"font-weight: bold;":"")+(t.italic?"font-style: italic;":"")+(t.underline?"text-decoration: underline;":"")+(t.family?"font-family: "+t.family+";":"")+(null!=t.size?"font-size: "+t.size+"px;":"")+(t.color?"color: "+t.color+";":"")+'">'+l.text+"</span>":l.text;return o}static _extend(e,l){for(var t in l){var o=l[t];wijmo_1.isObject(o)&&e[t]?wijmo_1.copy(e[t],o):e[t]=o}return e}static _checkParentCollapsed(e,l){var t=!1;Object.keys(e).forEach(o=>{!0===e[o]&&!1===t&&!isNaN(l)&&+o<l&&(t=!0)});return t}static _getColSpan(e,l,t){for(var o=0,r=l.leftCol;r<=l.rightCol;r++)t&&!t(e.columns[r])||o++;return o}static _getRenderColumn(e,l){return e>=l.length?null:l[e]}static _getMergedRange(e,l,t){let o,r;for(o=0;o<t.length;o++)if(e>=(r=t[o]).topRow&&e<=r.bottomRow&&l>=r.leftCol&&l<=r.rightCol)return r;return null}static _isFormula(e){return e&&"string"==typeof e&&e.length>1&&"="===e[0]&&"="!==e[1]}}exports.FlexGridXlsxConverter=FlexGridXlsxConverter;class XlsxFormatItemEventArgs extends wijmo_grid_1.CellRangeEventArgs{constructor(e,l,t,o,r,s,i){super(e,l);this._cell=t;this._patternCell=o;this._xlsxCell=i;this._cellsCache=r;this._styleCache=s}get cell(){return this._cell}get xlsxCell(){return this._xlsxCell}set xlsxCell(e){this._xlsxCell=e}getFormattedCell(){if(!this._cell){this._cell=FlexGridXlsxConverter._getMeasureCell(this.panel,this.col,this._patternCell,this._cellsCache);FlexGridXlsxConverter._getCellStyle(this.panel,this._cell,this.row,this.col,this._styleCache)}return this._cell}}exports.XlsxFormatItemEventArgs=XlsxFormatItemEventArgs;var _IncludeCellStyles;!function(e){e[e.None=0]="None";e[e.Regular=1]="Regular";e[e.Cache=2]="Cache"}(_IncludeCellStyles||(_IncludeCellStyles={}));class _StyleCache{constructor(e){this._cache={};this._size=0;this._max=e}add(e,l){this._size>=this._max&&this.clear();this._cache[e]=this._cloneStyle(l);this._size++}clear(){this._cache={};this._size=0}getValue(e){return this._cache[e]||null}hasKey(e){return!!this._cache[e]}_cloneStyle(e){if(!e)return null;for(var l={},toCamel=e=>e.replace(/\-([a-z])/g,(e,l,t)=>t>0?l.toUpperCase():l),t=0,o=e.length;t<o;t++){var r=e[t];l[toCamel(r)]=e.getPropertyValue(r)}return l}}exports._StyleCache=_StyleCache;wijmo_1._registerModule("wijmo.grid.xlsx",selfModule);