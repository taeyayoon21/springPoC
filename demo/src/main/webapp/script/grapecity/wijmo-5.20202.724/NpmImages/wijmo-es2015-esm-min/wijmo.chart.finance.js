/*!
    *
    * Wijmo Library 5.20202.724
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

import{asNumber,asArray,assert,asInt,asType,isUndefined,Rect,Point,DataType,asEnum,asBoolean,isDate,Globalize,_registerModule}from"wijmo/wijmo";import{_FinancePlotter,SeriesBase,_DataPoint,_DataInfo,_BasePlotter,_RectArea,HitTestInfo,ChartElement,_LinesArea,_CircleArea,FlexChartCore,ChartType,FlexChart}from"wijmo/wijmo.chart";import*as selfModule from"wijmo/wijmo.chart.finance";export class FinancialSeries extends SeriesBase{get chartType(){return this._finChartType}set chartType(e){if((e=asEnum(e,FinancialChartType,!0))!=this._finChartType){this._finChartType=e;this._invalidate()}}_getChartType(){var e=null;switch(this.chartType){case FinancialChartType.Area:e=ChartType.Area;break;case FinancialChartType.Line:case FinancialChartType.Kagi:case FinancialChartType.PointAndFigure:e=ChartType.Line;break;case FinancialChartType.Column:case FinancialChartType.ColumnVolume:e=ChartType.Column;break;case FinancialChartType.LineSymbols:e=ChartType.LineSymbols;break;case FinancialChartType.Scatter:e=ChartType.Scatter;break;case FinancialChartType.Candlestick:case FinancialChartType.Renko:case FinancialChartType.HeikinAshi:case FinancialChartType.LineBreak:case FinancialChartType.EquiVolume:case FinancialChartType.CandleVolume:case FinancialChartType.ArmsCandleVolume:e=ChartType.Candlestick;break;case FinancialChartType.HighLowOpenClose:e=ChartType.HighLowOpenClose}return e}getDataRect(e,t){if(t)return t;var i=this.getValues(0),a=this.getValues(1)||(this.chart._xvals&&this.chart._xvals.length?this.chart._xvals:null),s=this._getBinding(0),n=this._getBinding(1),r=this._getBinding(2),l=this._getBinding(3);this._plotter;let h=this._getChartType()||this.chart._getChartType();if(h!==ChartType.HighLowOpenClose&&h!==ChartType.Candlestick||s===n)return null;if(i){for(var o=NaN,c=NaN,u=NaN,g=NaN,_=i.length,d=0;d<_;d++){var p=this._getItem(d),m=i[d];if(isFinite(m)){[m,n?p[n]:null,r?p[r]:null,l?p[l]:null].forEach(e=>{if(_DataInfo.isValid(e)&&null!==e){(isNaN(c)||e<c)&&(c=e);(isNaN(g)||e>g)&&(g=e)}})}if(a){var f=a[d];isFinite(f)&&(isNaN(o)?o=u=f:f<o?o=f:f>u&&(u=f))}}if(!a){o=0;u=_-1}if(!isNaN(c))return new Rect(o,c,u-o,g-c)}return null}}export function _trunc(e){asNumber(e,!0,!1);return e>0?Math.floor(e):Math.ceil(e)}export function _sum(e){arguments.length>1&&(e=Array.prototype.slice.call(arguments));asArray(e,!1);return e.reduce((e,t)=>e+asNumber(t),0)}export function _average(e){arguments.length>1&&(e=Array.prototype.slice.call(arguments));asArray(e,!1);return _sum(e)/e.length}export function _minimum(e){arguments.length>1&&(e=Array.prototype.slice.call(arguments));asArray(e,!1);return Math.min.apply(null,e)}export function _maximum(e){arguments.length>1&&(e=Array.prototype.slice.call(arguments));asArray(e,!1);return Math.max.apply(null,e)}export function _variance(e){arguments.length>1&&(e=Array.prototype.slice.call(arguments));asArray(e,!1);var t=_average(e);return _average(e.map(e=>Math.pow(e-t,2)))}export function _stdDeviation(e){arguments.length>1&&(e=Array.prototype.slice.call(arguments));asArray(e,!1);return Math.sqrt(_variance(e))}export function _avgTrueRng(e,t,i,a=14){asArray(e,!1);asArray(t,!1);asArray(i,!1);asInt(a,!1,!0);var s=_trueRng(e,t,i,a),n=Math.min(e.length,t.length,i.length,s.length),r=[];assert(n>a&&a>1,"Average True Range period must be an integer less than the length of the data and greater than one.");for(var l=0;l<n;l++){asNumber(e[l],!1);asNumber(t[l],!1);asNumber(i[l],!1);asNumber(s[l],!1);l+1===a?r.push(_average(s.slice(0,a))):l+1>a&&r.push(((a-1)*r[r.length-1]+s[l])/a)}return r}export function _trueRng(e,t,i,a=14){asArray(e,!1);asArray(t,!1);asArray(i,!1);asInt(a,!1,!0);var s=Math.min(e.length,t.length,i.length),n=[];assert(s>a&&a>1,"True Range period must be an integer less than the length of the data and greater than one.");for(var r=0;r<s;r++){asNumber(e[r],!1);asNumber(t[r],!1);asNumber(i[r],!1);0===r?n.push(e[r]-t[r]):n.push(Math.max(e[r]-t[r],Math.abs(e[r]-i[r-1]),Math.abs(t[r]-i[r-1])))}return n}export function _sma(e,t){asArray(e,!1);asNumber(t,!1,!0);assert(e.length>t&&t>1,"Simple Moving Average period must be an integer less than the length of the data and greater than one.");for(var i=[],a=t;a<=e.length;a++)i.push(_average(e.slice(a-t,a)));return i}export function _ema(e,t){asArray(e,!1);asNumber(t,!1,!0);assert(e.length>t&&t>1,"Exponential Moving Average period must be an integer less than the length of the data and greater than one.");var i=[],a=2/(t+1),s=_sma(e,t);e=e.slice(t-1);for(var n=0;n<e.length;n++)0===n?i.push(s[0]):i.push((e[n]-i[n-1])*a+i[n-1]);return i}export function _range(e,t,i=1){asNumber(e,!1);asNumber(t,!1);asNumber(i,!1);assert(e<t,"begin argument must be less than end argument.");for(var a=[],s=e;s<=t;s+=i)a.push(s);return a}export class _BaseCalculator{constructor(e,t,i,a){this.highs=e;this.lows=t;this.opens=i;this.closes=a}calculate(){}}export class _HeikinAshiCalculator extends _BaseCalculator{constructor(e,t,i,a){super(e,t,i,a)}calculate(){var e,t,i,a,s=Math.min(this.highs.length,this.lows.length,this.opens.length,this.closes.length),n=[];if(s<=0)return n;for(var r=0;r<s;r++){a=_average(this.highs[r],this.lows[r],this.opens[r],this.closes[r]);if(0===r){i=_average(this.opens[r],this.closes[r]);e=this.highs[r];t=this.lows[r]}else{i=_average(n[r-1].open,n[r-1].close);e=Math.max(this.highs[r],i,a);t=Math.min(this.lows[r],i,a)}n.push({high:e,low:t,close:a,open:i,pointIndex:r,x:null})}return n}}export class _BaseRangeCalculator extends _BaseCalculator{constructor(e,t,i,a,s,n,r,l){super(e,t,i,a);this.xs=s;this.size=n;this.unit=r;this.fields=l}_getValues(){var e,t=[],i=Math.min(this.highs.length,this.lows.length,this.opens.length,this.closes.length);switch(this.fields){case DataFields.High:t=this.highs;break;case DataFields.Low:t=this.lows;break;case DataFields.Open:t=this.opens;break;case DataFields.HL2:for(e=0;e<i;e++)t.push(_average(this.highs[e],this.lows[e]));break;case DataFields.HLC3:for(e=0;e<i;e++)t.push(_average(this.highs[e],this.lows[e],this.closes[e]));break;case DataFields.HLOC4:for(e=0;e<i;e++)t.push(_average(this.highs[e],this.lows[e],this.opens[e],this.closes[e]));break;case DataFields.Close:default:t=this.closes}return t}_getSize(){var e=this.unit===RangeMode.ATR?_avgTrueRng(this.highs,this.lows,this.closes,this.size):null;return this.unit===RangeMode.ATR?e[e.length-1]:this.size}}export class _LineBreakCalculator extends _BaseRangeCalculator{constructor(e,t,i,a,s,n){super(e,t,i,a,s,n)}calculate(){var e=null!==this.xs&&this.xs.length>0,t=this.closes.length,i=[],a=[[],[]];if(t<=0)return i;for(var s,n,r,l,h,o,c=[],u=1;u<t;u++){l=i.length-1;n=e?this.xs[u]:u;r=this.closes[u];if(-1===l){if((s=this.closes[0])===r)continue}else{c=this._trendExists(a)||1===this.size?a[0].slice(-this.size).concat(a[1].slice(-this.size)):a[0].slice(1-this.size).concat(a[1].slice(1-this.size));h=Math.max.apply(null,c);o=Math.min.apply(null,c);if(r>h)s=Math.max(a[0][l],a[1][l]);else{if(!(r<o))continue;s=Math.min(a[0][l],a[1][l])}}a[0].push(s);a[1].push(r);i.push({high:Math.max(s,r),low:Math.min(s,r),open:s,close:r,x:n,pointIndex:u})}return i}_trendExists(e){if(e[1].length<this.size)return!1;var t,i=!1,a=e[1].slice(-this.size);for(t=1;t<this.size&&(i=a[t]>a[t-1]);t++);if(!i)for(t=1;t<this.size&&(i=a[t]<a[t-1]);t++);return i}}export class _KagiCalculator extends _BaseRangeCalculator{constructor(e,t,i,a,s,n,r,l){super(e,t,i,a,s,n,r,l)}calculate(){var e,t,i,a,s,n,r,l,h,o=this._getSize(),c=Math.min(this.highs.length,this.lows.length,this.opens.length,this.closes.length),u=this._getValues(),g=null!==this.xs&&this.xs.length>0,_=[],d=[[],[]];if(c<=0)return _;for(var p=1;p<c;p++){a=_.length-1;t=g?this.xs[p]:p;h=p;l=!1;if(this.fields===DataFields.HighLow)if(-1===a)if(this.highs[p]>this.highs[0])i=this.highs[p];else{if(!(this.lows[p]<this.lows[0]))continue;i=this.lows[p]}else if((r=d[1][a]-d[0][a])>0)if(this.highs[p]>d[1][a])i=this.highs[p];else{if(!(this.lows[p]<d[1][a]))continue;i=this.lows[p]}else if(this.lows[p]<d[1][a])i=this.lows[p];else{if(!(this.highs[p]>d[1][a]))continue;i=this.highs[p]}else i=u[p];this.unit===RangeMode.Percentage&&(o=i*this.size);if(-1===a){t=g?this.xs[0]:0;h=0;e=this.fields===DataFields.HighLow?null==this.highs[0]?this.highs[this.highs.length-1]:this.highs[0]:null==u[0]?u[u.length-1]:u[0];if((r=Math.abs(e-i)||0)<o)continue}else{r=d[1][a]-d[0][a];n=Math.max(d[0][a],d[1][a]);s=Math.min(d[0][a],d[1][a]);if(r>0)if(i>n)l=!0;else{if(!((r=n-i)>=o))continue;e=n}else if(i<s)l=!0;else{if(!((r=i-s)>=o))continue;e=s}}if(l){d[1][a]=i;_[a].close=i;_[a].high=Math.max(_[a].open,_[a].close);_[a].low=Math.min(_[a].open,_[a].close)}else{d[0].push(e);d[1].push(i);_.push({high:Math.max(e,i),low:Math.min(e,i),open:e,close:i,x:t,pointIndex:h})}}return _}}export class _RenkoCalculator extends _BaseRangeCalculator{constructor(e,t,i,a,s,n,r,l,h=!1){super(e,t,i,a,s,n,r,l);this.rounding=h}calculate(){var e,t,i,a,s,n,r,l=this._getSize(),h=Math.min(this.highs.length,this.lows.length,this.opens.length,this.closes.length),o=null!==this.xs&&this.xs.length>0,c=this._getValues(),u=[],g=[[],[]];if(h<=0)return u;for(var _=1;_<h;_++){a=u.length-1;t=o?this.xs[_]:_;if(this.fields===DataFields.HighLow)if(-1===a)if(this.highs[_]-this.highs[0]>l){e=this.highs[0];i=this.highs[_]}else{if(!(this.lows[0]-this.lows[_]>l))continue;e=this.lows[0];i=this.lows[_]}else{s=Math.min(g[0][a],g[1][a]);n=Math.max(g[0][a],g[1][a]);if(this.highs[_]-n>l){e=n;i=this.highs[_]}else{if(!(s-this.lows[_]>l))continue;e=s;i=this.lows[_]}}else{i=c[_];if(-1===a)e=c[0];else{s=Math.min(g[0][a],g[1][a]);if(i>(n=Math.max(g[0][a],g[1][a])))e=n;else{if(!(i<s))continue;e=s}}}r=i-e;if(!(Math.abs(r)<l)){r=_trunc(r/l);for(var d=0;d<Math.abs(r);d++){var p={};this.rounding&&(e=this._round(e,l));g[0].push(e);p.open=e;e=r>0?e+l:e-l;g[1].push(e);p.close=e;p.x=t;p.pointIndex=_;p.high=Math.max(p.open,p.close);p.low=Math.min(p.open,p.close);u.push(p)}}}return u}_round(e,t){return Math.round(e/t)*t}}export class _BaseRangePlotter extends _BasePlotter{constructor(){super();this._symFactor=.7;this.clear()}clear(){super.clear();this._rangeValues=null;this._rangeXLabels=null;this._calculator=null}unload(){super.unload();for(var e,t,i=0;i<this.chart.series.length;i++)(e=this.chart.series[i])&&(t=e._getAxisX())&&t.itemsSource&&(t.itemsSource=null)}adjustLimits(e,t){var i,a,s,n=0,r=0,l=0,h=0,o=this.chart._xDataType===DataType.Date?.5:0;assert(this.chart.series.length<=1,"Current FinancialChartType only supports a single series");for(var c=0;c<this.chart.series.length;c++){i=this.chart.series[c];this._calculate(i);if(!(this._rangeValues.length<=0||this._rangeXLabels.length<=0)){(a=this._rangeValues.map(e=>e.open)).push.apply(a,this._rangeValues.map(e=>e.close));s=this._rangeXLabels.map(e=>e.value);l=Math.min.apply(null,a);h=Math.max.apply(null,a);n=Math.min.apply(null,s);r=Math.max.apply(null,s);i._getAxisX().itemsSource=this._rangeXLabels}}return new Rect(n-=o,l,r-n+o,h-l)}plotSeries(e,t,i,a,s,n,r){this._calculate(a);var l=this.chart.series.indexOf(a),h=this._rangeValues.length,o=t.actualMin,c=t.actualMax,u=this._DEFAULT_WIDTH,g=this._symFactor,_=a._getSymbolFill(l),d=a._getAltSymbolFill(l)||"transparent",p=a._getSymbolStroke(l),m=a._getAltSymbolStroke(l)||p;e.strokeWidth=u;var f,x,y,v,C=0;let w=this.getItemFormatter(a);for(var k=0;k<h;k++){f=k;if(_DataInfo.isValid(f)&&o<=f&&f<=c){x=this._rangeValues[k].open;y=this._rangeValues[k].close;e.fill=x>y?_:d;e.stroke=x>y?p:m;v=this._getDataPoint(l,k,a,Math.max(x,y));e.startGroup();if(w){var F=new HitTestInfo(this.chart,new Point(t.convert(f),i.convert(y)),ChartElement.SeriesSymbol);F._setData(a,k);F._setDataPoint(v);w(e,F,()=>{this._drawSymbol(e,t,i,l,C,g,f,x,y,v)})}else this._drawSymbol(e,t,i,l,C,g,f,x,y,v);e.endGroup();a._setPointIndex(k,C);C++}}}_drawSymbol(e,t,i,a,s,n,r,l,h,o){var c,u,g,_,d;if((g=t.convert(r-.5*n))>(_=t.convert(r+.5*n))){var p=g;g=_;_=p}if(_DataInfo.isValid(l)&&_DataInfo.isValid(h)){l=i.convert(l);h=i.convert(h);u=(c=Math.min(l,h))+Math.abs(l-h);e.drawRect(g,c,_-g,u-c);(d=new _RectArea(new Rect(g,c,_-g,u-c))).tag=o;this.hitTester.add(d,a)}}_getDataPoint(e,t,i,a){var s=new _DataPoint(e,t,t,a),n=i._getItem(this._rangeValues[t].pointIndex),r=i.bindingX||this.chart.bindingX,l=i._getBinding(0),h=i._getBinding(1),o=i._getBinding(2),c=i._getBinding(3),u=i._getAxisY();s.item=_BasePlotter.cloneStyle(n,[]);s.item[l]=this._rangeValues[t].high;s.item[h]=this._rangeValues[t].low;s.item[o]=this._rangeValues[t].open;s.item[c]=this._rangeValues[t].close;s.y=this._rangeValues[t].close;s.yfmt=u._formatValue(this._rangeValues[t].close);s.x=s.item[r];s.xfmt=this._rangeXLabels[t]._text;return s}_init(){this._rangeValues=[];this._rangeXLabels=[]}_calculate(e){}_generateXLabels(e){var t,i=e._getAxisX(),a=e.getDataType(1)||this.chart._xDataType;this._rangeValues.forEach((e,s)=>{var n=e.x;t=a===DataType.Date?Globalize.format(FlexChart._fromOADate(n),i.format||"d"):a===DataType.Number?i._formatValue(n):null!==a&&a!==DataType.String||!this.chart._xlabels?n.toString():this.chart._xlabels[n];this._rangeXLabels.push({value:s,text:t,_text:t})},this)}}export var DataFields;!function(e){e[e.Close=0]="Close";e[e.High=1]="High";e[e.Low=2]="Low";e[e.Open=3]="Open";e[e.HighLow=4]="HighLow";e[e.HL2=5]="HL2";e[e.HLC3=6]="HLC3";e[e.HLOC4=7]="HLOC4"}(DataFields||(DataFields={}));export var RangeMode;!function(e){e[e.Fixed=0]="Fixed";e[e.ATR=1]="ATR";e[e.Percentage=2]="Percentage"}(RangeMode||(RangeMode={}));export var PointAndFigureScaling;!function(e){e[e.Traditional=0]="Traditional";e[e.Fixed=1]="Fixed";e[e.Dynamic=2]="Dynamic"}(PointAndFigureScaling||(PointAndFigureScaling={}));export class _PointAndFigurePlotter extends _BasePlotter{constructor(){super()}clear(){super.clear();this._boxSize=null;this._fields=null;this._reversal=null;this._scaling=null}unload(){super.unload();this.chart.axisX.itemsSource=this._xlbls}_init(){this._boxSize=this.getNumOption("boxSize","pointAndFigure")||1;this._reversal=this.getNumOption("reversal","pointAndFigure")||3;this._period=this.getNumOption("period","pointAndFigure")||20;this._fields=this.getOption("fields","pointAndFigure")||DataFields.Close;this._fields=asEnum(this._fields,DataFields,!0);assert(this._fields==DataFields.Close||this._fields==DataFields.HighLow,"Only DataFields.Close and DataFields.HighLow are supported");this._scaling=this.getOption("scaling","pointAndFigure")||PointAndFigureScaling.Traditional;this._scaling=asEnum(this._scaling,PointAndFigureScaling,!0);this._xlbls=[]}adjustLimits(e,t){this._init();this.hitTester.clear();let i=new Rect(0,0,0,0),a=this.chart.series.length;assert(a<=1,"Current FinancialChartType only supports a single series");if(a>0){let e=this.chart.series[0],t=this._reversal,a=e.collectionView?e.collectionView:this.chart.collectionView,o=a?a.items:null;if(o&&o.length>0){let a=e._getBinding(0),c=e._getBinding(1),u=e._getBinding(2),g=e._getBinding(3);if(this._fields==DataFields.Close){g?a=g:u&&(a=u);c=a}let _=e.bindingX?e.bindingX:this.chart.bindingX,d=this._actualBoxSize=this.calcBoxSize(o,a,c);this._pfdata=this.calcPFHiLo2(o,a,c,_,d,t);if(this._pfdata&&this._pfdata.length>0){var s=this._pfdata.reduce((function(e,t){return Math.max(e,t.max)}),this._pfdata[0].max),n=this._pfdata.reduce((function(e,t){return Math.min(e,t.min)}),this._pfdata[0].min);i=new Rect(-.5,n-.5*d,this._pfdata.length,s-n+d);for(var r=1;r<this._pfdata.length;r++){var l=this._pfdata[r-1],h=this._pfdata[r];isDate(h.date)&&isDate(l.date)&&h.date.getYear()!=l.date.getYear()&&this._xlbls.push({value:r,text:Globalize.formatNumber(h.date.getFullYear()%100,"d2")})}}}}0==this._xlbls.length&&this._xlbls.push({value:0});let o=this.chart.axisY;this.axisYMajorGrid=o.majorGrid;o._chart=null;o.majorGrid=!1;o._chart=this.chart;this.chart.axisX.itemsSource=this._xlbls;return i}plotSeries(e,t,i,a,s,n,r){if(this._pfdata&&this._pfdata.length>0){var l=this._actualBoxSize;this.renderGrid(e,this._pfdata,l);this.renderData(this.chart,e,this._pfdata,l)}let h=this.chart.axisY;h._chart=null;h.majorGrid=this.axisYMajorGrid;h._chart=this.chart}calcBoxSize(e,t,i){var a=e.reduce((function(e,i){return Math.max(e,i[t])}),e[0][t]),s=e.reduce((function(e,t){return Math.min(e,t[i])}),e[0][i]),n=this._boxSize,r=a-s;switch(this._scaling){case PointAndFigureScaling.Traditional:r<.25?n=.0625:r>=.25&&r<1?n=.125:r>=1&&r<5?n=.25:r>=5&&r<20?n=.5:r>=20&&r<100?n=1:r>=100&&r<200?n=2:r>=200&&r<500?n=4:r>=500&&r<1e3?n=5:r>=1e3&&r<25e3?n=50:r>-25e3&&(n=500);break;case PointAndFigureScaling.Dynamic:let e=this.chart.series[0],t=e._getBindingValues(0),i=e._getBindingValues(1);e._getBindingValues(2);var l=_avgTrueRng(t,i,e._getBindingValues(3),this._period);n=l[l.length-1];break;case PointAndFigureScaling.Fixed:}return n}calcPFHiLo2(e,t,i,a,s,n){let r=[];for(let c=0;c<e.length;c++){let u=e[c][t],g=e[c][i];assert(u>=g,"'High' value must be larger than 'low' value.");let _=e[c][a];if(0==r.length)r.push({min:this.roundDown(g,s),max:this.roundDown(u,s),rise:!1,date:_});else{var l=r[r.length-1];if(l.rise){var h=l.max+s,o=l.max-n*s;this.roundUp(u,s)>=h?l.max=this.roundUp(u,s):g<=o&&r.push({min:this.roundDown(g,s),max:l.max-s,rise:!1,date:_})}else{h=l.min-s,o=l.min+n*s;this.roundDown(g,s)<=h?l.min=this.roundDown(g,s):u>=o&&r.push({min:l.min+s,max:this.roundUp(u,s),rise:!0,date:_})}}}if(r.length>0){var c=r[0];c.min==c.max&&r.splice(0,1)}return r}roundUp(e,t){return Math.ceil(e/t-.999999)*t}roundDown(e,t){return Math.floor(e/t+.999999)*t}renderGrid(e,t,i){if(this._pfdata){for(var a=this._pfdata.reduce((function(e,t){return Math.max(e,t.max)}),this._pfdata[0].max),s=this._pfdata.reduce((function(e,t){return Math.min(e,t.min)}),this._pfdata[0].min),n=this.chart,r=this._pfdata.length,l=s-.5*i;l<=a+i;l+=i){var h=new Point(-.5,l);h=n.dataToPoint(h);var o=new Point(r,l);o=n.dataToPoint(o);e.stroke=FlexChartCore._FG;e.strokeWidth=1;e.drawLine(h.x,h.y,o.x,o.y,FlexChartCore._CSS_GRIDLINE)}for(var c=-.5;c<=r;c+=1){h=new Point(c,this.chart.axisY.actualMin);h=n.dataToPoint(h);o=new Point(c,this.chart.axisY.actualMax);o=n.dataToPoint(o);e.stroke=FlexChartCore._FG;e.strokeWidth=1;e.drawLine(h.x,h.y,o.x,o.y,FlexChartCore._CSS_GRIDLINE)}}}renderData(e,t,i,a){let s=e.series[0],n=s._getSymbolStroke(0),r=s._getAltSymbolStroke(0)||n;for(let s=0;s<i.length;s++){let h=i[s],o=(i[s].max-i[s].min)/a;if(0==o)continue;let c=new Point(s-.5,h.min);c=e.dataToPoint(c);let u=new Point(s+.5,h.max);u=e.dataToPoint(u);t.fill="transparent";let g=(u.y-c.y)/o;for(var l=0;l<o+1;l++){t.strokeWidth=1.5;if(h.rise){t.stroke=n;t.drawLine(c.x,c.y+(l-.5)*g,u.x,c.y+(l+.5)*g);t.drawLine(u.x,c.y+(l-.5)*g,c.x,c.y+(l+.5)*g)}else{t.stroke=r;t.drawEllipse(.5*(c.x+u.x),c.y+l*g,.5*Math.abs(c.x-u.x),.5*Math.abs(g))}if(this.hitTester){let e=h.min+l*a,t=new _DataPoint(0,s,h.date,e);t.y=e;t.yfmt=this.chart.axisY._formatValue(e);if(isDate(h.date)){t.x=h.date;t.xfmt=Globalize.formatDate(h.date,"d")}let i=new Rect(Math.min(c.x,u.x),c.y+l*g-.5*g,Math.abs(u.x-c.x),g);if(i.height<0){i.top+=g;i.height=-i.height}let n=new _RectArea(i);n.tag=t;this.hitTester.add(n,0)}}}}}export class _KagiPlotter extends _BaseRangePlotter{constructor(){super()}_calculate(e){this._init();var t=e._getBindingValues(0),i=e._getBindingValues(1),a=e._getBindingValues(2),s=e._getBindingValues(3),n=e.getValues(1)||this.chart._xvals;this._calculator=new _KagiCalculator(t,i,a,s,n,this._reversalAmount,this._rangeMode,this._fields);this._rangeValues=this._calculator.calculate();(null===this._rangeValues||isUndefined(this._rangeValues))&&(this._rangeValues=[]);this._generateXLabels(e)}plotSeries(e,t,i,a,s,n,r){this._calculate(a);var l=this.chart.series.indexOf(a),h=this._rangeValues.length,o=t.actualMin,c=t.actualMax,u=this._DEFAULT_WIDTH,g=a._getSymbolStroke(l),_=a._getAltSymbolStroke(l)||g,d=[],p=[];e.stroke=g;e.strokeWidth=u;var m,f,x,y,v,C,w,k=0;e.startGroup();for(var F=0;F<h;F++){m=F;if(_DataInfo.isValid(m)&&o<=m&&m<=c){f=this._rangeValues[F].open;x=this._rangeValues[F].close;if(0===F){y=Math.min(f,x);v=Math.max(f,x);e.strokeWidth=f>x?u:2*u;e.stroke=f>x?g:_;e.drawLine(t.convert(m),i.convert(f),t.convert(m),i.convert(x));e.drawLine(t.convert(m-1)-e.strokeWidth/2,i.convert(f),t.convert(m)+e.strokeWidth/2,i.convert(f))}else if(e.strokeWidth===u)if(x>f){if(x>v){e.drawLine(t.convert(m),i.convert(f),t.convert(m),i.convert(v));e.strokeWidth=2*u;e.stroke=_;e.drawLine(t.convert(m),i.convert(v),t.convert(m),i.convert(x));y=f}else e.drawLine(t.convert(m),i.convert(f),t.convert(m),i.convert(x));v=x}else e.drawLine(t.convert(m),i.convert(f),t.convert(m),i.convert(x));else if(e.strokeWidth/2===u)if(x<f){if(x<y){e.drawLine(t.convert(m),i.convert(f),t.convert(m),i.convert(y));e.strokeWidth=u;e.stroke=g;e.drawLine(t.convert(m),i.convert(y),t.convert(m),i.convert(x));v=f}else e.drawLine(t.convert(m),i.convert(f),t.convert(m),i.convert(x));y=x}else e.drawLine(t.convert(m),i.convert(f),t.convert(m),i.convert(x));F<h-1&&e.drawLine(t.convert(m)-e.strokeWidth/2,i.convert(x),t.convert(m+1)+e.strokeWidth/2,i.convert(x));w=this._getDataPoint(l,F,a,x);(C=new _CircleArea(new Point(t.convert(m),i.convert(x)),.5*e.strokeWidth)).tag=w;this.hitTester.add(C,l);a._setPointIndex(F,k);k++;d.push(t.convert(m));p.push(i.convert(f));d.push(t.convert(m));p.push(i.convert(x))}}e.endGroup();this.hitTester.add(new _LinesArea(d,p),l)}_init(){super._init();this._reversalAmount=this.getNumOption("reversalAmount","kagi")||14;this._rangeMode=this.getOption("rangeMode","kagi")||RangeMode.Fixed;this._rangeMode=asEnum(this._rangeMode,RangeMode,!0);this._fields=this.getOption("fields","kagi")||DataFields.Close;this._fields=asEnum(this._fields,DataFields,!0)}clear(){super.clear();this._reversalAmount=null;this._rangeMode=null}}export class _RenkoPlotter extends _BaseRangePlotter{constructor(){super()}clear(){super.clear();this._boxSize=null;this._rangeMode=null}_calculate(e){this._init();var t=e._getBindingValues(0),i=e._getBindingValues(1),a=e._getBindingValues(2),s=e._getBindingValues(3),n=e.getValues(1)||this.chart._xvals;this._calculator=new _RenkoCalculator(t,i,a,s,n,this._boxSize,this._rangeMode,this._fields,this._rounding);this._rangeValues=this._calculator.calculate();(null===this._rangeValues||isUndefined(this._rangeValues))&&(this._rangeValues=[]);this._generateXLabels(e)}_init(){super._init();this._boxSize=this.getNumOption("boxSize","renko")||14;this._rangeMode=this.getOption("rangeMode","renko")||RangeMode.Fixed;this._rangeMode=asEnum(this._rangeMode,RangeMode,!0);assert(this._rangeMode!==RangeMode.Percentage,"RangeMode.Percentage is not supported");this._fields=this.getOption("fields","renko")||DataFields.Close;this._fields=asEnum(this._fields,DataFields,!0);assert(this._fields!==DataFields.HighLow,"DataFields.HighLow is not supported");this._rounding=asBoolean(this.getOption("rounding","renko"),!0)}_generateXLabels(e){super._generateXLabels(e);this._rangeXLabels.forEach((e,t)=>{t>0&&this._rangeXLabels[t-1]._text===e.text&&(e.text="")},this)}}export class _LineBreakPlotter extends _BaseRangePlotter{constructor(){super()}clear(){super.clear();this._newLineBreaks=null}_calculate(e){this._init();var t=e._getBindingValues(3),i=e.getValues(1)||this.chart._xvals;this._calculator=new _LineBreakCalculator(null,null,null,t,i,this._newLineBreaks);this._rangeValues=this._calculator.calculate();(null===this._rangeValues||isUndefined(this._rangeValues))&&(this._rangeValues=[]);this._generateXLabels(e)}_init(){super._init();this._newLineBreaks=asInt(this.getNumOption("newLineBreaks","lineBreak"),!0,!0)||3;assert(this._newLineBreaks>=1,"Value must be greater than 1")}}export class _HeikinAshiPlotter extends _FinancePlotter{constructor(){super();this._symFactor=.7;this.clear()}clear(){super.clear();this._haValues=null;this._calculator=null}plotSeries(e,t,i,a,s,n,r){this._calculate(a);var l=asType(a,SeriesBase),h=this.chart.series.indexOf(a),o=a.getValues(1),c=this._symFactor,u=this._haValues.length,g=!0;if(o){var _=this.dataInfo.getDeltaX();_>0&&(c*=_)}else o=this.dataInfo.getXVals();if(o)u=Math.min(u,o.length);else{g=!1;o=new Array(u)}var d=this._DEFAULT_WIDTH,p=l._getSymbolFill(h),m=l._getAltSymbolFill(h)||"transparent",f=l._getSymbolStroke(h),x=l._getAltSymbolStroke(h)||f,y=c,v=a.getDataType(1)||a.chart._xDataType;e.strokeWidth=d;var C,w,k,F,b,T,P,V,A=t.actualMin,M=t.actualMax,L=0;let D=this.getItemFormatter(a);for(var S=0;S<u;S++){k=g?o[S]:S;if(_DataInfo.isValid(k)&&A<=k&&k<=M){b=this._haValues[S].high;T=this._haValues[S].low;P=this._haValues[S].open;V=this._haValues[S].close;C=P<V?m:p;w=P<V?x:f;e.fill=C;e.stroke=w;e.startGroup();F=this._getDataPoint(h,S,k,a);if(D){var B=new HitTestInfo(this.chart,new Point(t.convert(k),i.convert(b)),ChartElement.SeriesSymbol);B._setData(l,S);B._setDataPoint(F);D(e,B,()=>{this._drawSymbol(e,t,i,h,S,C,y,k,b,T,P,V,F,v)})}else this._drawSymbol(e,t,i,h,S,C,y,k,b,T,P,V,F,v);e.endGroup();a._setPointIndex(S,L);L++}}}_drawSymbol(e,t,i,a,s,n,r,l,h,o,c,u,g,_){var d,p=null,m=null,f=null,x=null,y=_===DataType.Date?432e5:.5;if((f=t.convert(l-y*r))>(x=t.convert(l+y*r))){var v=f;f=x;x=v}l=t.convert(l);if(_DataInfo.isValid(c)&&_DataInfo.isValid(u)){c=i.convert(c);u=i.convert(u);m=(p=Math.min(c,u))+Math.abs(c-u);e.drawRect(f,p,x-f,m-p);(d=new _RectArea(new Rect(f,p,x-f,m-p))).tag=g;this.hitTester.add(d,a)}if(_DataInfo.isValid(h)){h=i.convert(h);if(null!==p){e.drawLine(l,p,l,h);d.rect.top=h;d.rect.height=d.rect.height+h}}if(_DataInfo.isValid(o)){o=i.convert(o);if(null!==m){e.drawLine(l,m,l,o);d.rect.height=d.rect.height+o}}}_getDataPoint(e,t,i,a){var s=new _DataPoint(e,t,i,this._haValues[t].high),n=a._getItem(t),r=a._getBinding(0),l=a._getBinding(1),h=a._getBinding(2),o=a._getBinding(3),c=a._getAxisY();if(null!=n){s.item=_BasePlotter.cloneStyle(n,[]);s.item[r]=this._haValues[t].high;s.item[l]=this._haValues[t].low;s.item[h]=this._haValues[t].open;s.item[o]=this._haValues[t].close}s.y=this._haValues[t].high;s.yfmt=c._formatValue(this._haValues[t].high);return s}_calculate(e){var t=e._getBindingValues(0),i=e._getBindingValues(1),a=e._getBindingValues(2),s=e._getBindingValues(3);this._calculator=new _HeikinAshiCalculator(t,i,a,s);this._haValues=this._calculator.calculate();(null===this._haValues||isUndefined(this._haValues))&&this._init()}_init(){this._haValues=[]}}export var FinancialChartType;!function(e){e[e.Column=0]="Column";e[e.Scatter=1]="Scatter";e[e.Line=2]="Line";e[e.LineSymbols=3]="LineSymbols";e[e.Area=4]="Area";e[e.Candlestick=5]="Candlestick";e[e.HighLowOpenClose=6]="HighLowOpenClose";e[e.HeikinAshi=7]="HeikinAshi";e[e.LineBreak=8]="LineBreak";e[e.Renko=9]="Renko";e[e.Kagi=10]="Kagi";e[e.ColumnVolume=11]="ColumnVolume";e[e.EquiVolume=12]="EquiVolume";e[e.CandleVolume=13]="CandleVolume";e[e.ArmsCandleVolume=14]="ArmsCandleVolume";e[e.PointAndFigure=15]="PointAndFigure"}(FinancialChartType||(FinancialChartType={}));export class FinancialChart extends FlexChartCore{constructor(e,t){super(e,null);this._chartType=FinancialChartType.Line;this.__heikinAshiPlotter=null;this.__lineBreakPlotter=null;this.__renkoPlotter=null;this.__kagiPlotter=null;this.__pfPlotter=null;this.initialize(t)}_getProductInfo(){return"A78U,FinancialChart"}get chartType(){return this._chartType}set chartType(e){if((e=asEnum(e,FinancialChartType))!=this._chartType){this._chartType=e;this.invalidate()}}get options(){return this._options}set options(e){if(e!=this._options){this._options=e;this.invalidate()}}get _heikinAshiPlotter(){if(null===this.__heikinAshiPlotter){this.__heikinAshiPlotter=new _HeikinAshiPlotter;this._initPlotter(this.__heikinAshiPlotter)}return this.__heikinAshiPlotter}get _lineBreakPlotter(){if(null===this.__lineBreakPlotter){this.__lineBreakPlotter=new _LineBreakPlotter;this._initPlotter(this.__lineBreakPlotter)}return this.__lineBreakPlotter}get _renkoPlotter(){if(null===this.__renkoPlotter){this.__renkoPlotter=new _RenkoPlotter;this._initPlotter(this.__renkoPlotter)}return this.__renkoPlotter}get _kagiPlotter(){if(null===this.__kagiPlotter){this.__kagiPlotter=new _KagiPlotter;this._initPlotter(this.__kagiPlotter)}return this.__kagiPlotter}get _pfPlotter(){if(null===this.__pfPlotter){this.__pfPlotter=new _PointAndFigurePlotter;this._initPlotter(this.__pfPlotter)}return this.__pfPlotter}_getChartType(){var e=null;switch(this.chartType){case FinancialChartType.Area:e=ChartType.Area;break;case FinancialChartType.Line:case FinancialChartType.Kagi:case FinancialChartType.PointAndFigure:e=ChartType.Line;break;case FinancialChartType.Column:case FinancialChartType.ColumnVolume:e=ChartType.Column;break;case FinancialChartType.LineSymbols:e=ChartType.LineSymbols;break;case FinancialChartType.Scatter:e=ChartType.Scatter;break;case FinancialChartType.Candlestick:case FinancialChartType.Renko:case FinancialChartType.HeikinAshi:case FinancialChartType.LineBreak:case FinancialChartType.EquiVolume:case FinancialChartType.CandleVolume:case FinancialChartType.ArmsCandleVolume:e=ChartType.Candlestick;break;case FinancialChartType.HighLowOpenClose:e=ChartType.HighLowOpenClose}return e}_getPlotter(e){var t=this.chartType,i=null;if(e){var a=e.chartType;if(a&&!isUndefined(a)&&a!=t){t=a;!0}}switch(t){case FinancialChartType.HeikinAshi:i=this._heikinAshiPlotter;break;case FinancialChartType.LineBreak:i=this._lineBreakPlotter;break;case FinancialChartType.Renko:i=this._renkoPlotter;break;case FinancialChartType.Kagi:i=this._kagiPlotter;break;case FinancialChartType.ColumnVolume:(i=super._getPlotter(e)).isVolume=!0;i.width=1;break;case FinancialChartType.EquiVolume:(i=super._getPlotter(e)).isEqui=!0;i.isCandle=!1;i.isArms=!1;i.isVolume=!0;i.symbolWidth="100%";break;case FinancialChartType.CandleVolume:(i=super._getPlotter(e)).isEqui=!1;i.isCandle=!0;i.isArms=!1;i.isVolume=!0;i.symbolWidth="100%";break;case FinancialChartType.ArmsCandleVolume:(i=super._getPlotter(e)).isEqui=!1;i.isCandle=!1;i.isArms=!0;i.isVolume=!0;i.symbolWidth="100%";break;case FinancialChartType.PointAndFigure:i=this._pfPlotter;break;default:i=super._getPlotter(e)}return i}_createSeries(){return new FinancialSeries}}_registerModule("wijmo.chart.finance",selfModule);