/*!
    *
    * Wijmo Library 5.20202.724
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

import{isString,isArray,CollectionView,Aggregate,assert,asEnum,Rect,Color,asBoolean,isFunction,Point,Size,isNumber,asNumber,asString,asArray,_registerModule}from"wijmo/wijmo";import{FlexPie,_DataPoint,HitTestInfo,SelectionMode,FlexChartBase,DataLabel,_KeyWords,FlexChart,ChartElement,Series,LabelPosition,DataLabelRenderEventArgs,RenderEventArgs,_RectArea,ChartTooltip,_SvgRenderEngine,Legend,Position}from"wijmo/wijmo.chart";import*as selfModule from"wijmo/wijmo.chart.hierarchical";export class HierarchicalUtil{static parseDataToHierarchical(e,t,i,s){var r,a=[];if(e instanceof CollectionView&&e.groups.length>0)a=HierarchicalUtil.parseGroupCV(e,t);else if(e.length>0){isString(i)&&i.indexOf(",")>-1&&(i=i.split(","));if(s)a=HierarchicalUtil.parseItems(e,t,i,s);else{r=HierarchicalUtil.convertFlatData(e,t,i);a=HierarchicalUtil.parseItems(r,"value",i,"items")}}return a}static parseGroupCV(e,t){for(var i=[],s=0,r=e.groups.length;s<r;s++){var a=this.parseGroups(e.groups[s],t);i.push(a)}return i}static parseGroups(e,t){var i={};i.name=e.name;i.nameField=e.groupDescription.propertyName;i.item=e.items;if(e.groups&&e.groups.length){i.items=[];for(var s=0,r=e.groups.length;s<r;s++){var a=this.parseGroups(e.groups[s],t);i.items.push(a)}}else e.isBottomLevel&&(i.value=e.getAggregate(Aggregate.Sum,t));return i}static parseItems(e,t,i,s){var r,a=[],l=e.length;for(r=0;r<l;r++)a.push(HierarchicalUtil.parseItem(e[r],t,i,s));return a}static isFlatItem(e,t){return!isArray(e[t])}static convertFlatData(e,t,i){var s,r,a=[],l={},h=e.length;for(s=0;s<h;s++){r=e[s];HierarchicalUtil.convertFlatItem(l,r,t,isArray(i)?i:[i])}HierarchicalUtil.convertFlatToHierarchical(a,l);return a}static convertFlatToHierarchical(e,t){var i=t.flatDataOrder;i&&i.forEach(i=>{var s,r={},a=t[i];r[t.field]=i;if(a.flatDataOrder){s=[];HierarchicalUtil.convertFlatToHierarchical(s,a);r.items=s}else r.value=a;e.push(r)})}static convertFlatItem(e,t,i,s){var r,a,l,h;a=(r=s.slice()).shift();if(null==(l=null==(a=isString(a)?a.trim():a)?i:t[a]))return!1;if(0===r.length){e[l]=t[i]||0;e.flatDataOrder?e.flatDataOrder.push(l):e.flatDataOrder=[l];e.field=a}else{if(null==e[l]){e[l]={};e.flatDataOrder?e.flatDataOrder.push(l):e.flatDataOrder=[l];e.field=a}h=e[l];HierarchicalUtil.convertFlatItem(h,t,i,r)||(e[l]=t[i])}return!0}static parseItem(e,t,i,s){var r,a,l,h,o,n={};if(isArray(s))h=(o=s.slice()).length?o.shift().trim():"";else{o=s;h=s}if(isArray(i)){a=null==(a=(r=i.slice()).shift())?a:a.trim();n.nameField=null==a?t:a;n.name=null==a?e[t]:e[a];l=e[h];0===r.length?n.value=e[t]:l&&isArray(l)&&l.length>0?n.items=HierarchicalUtil.parseItems(l,t,r,o):n.value=e[t]||0}else{n.nameField=null==i?t:i;n.name=null==i?e[t]:e[i];null!=(l=e[h])&&isArray(l)&&l.length>0?n.items=HierarchicalUtil.parseItems(l,t,i,o):n.value=e[t]}n.item=e;return n}static parseFlatItem(e,t,i,s){e.items||(e.items=[])}}export var TreeMapType;!function(e){e[e.Squarified=0]="Squarified";e[e.Horizontal=1]="Horizontal";e[e.Vertical=2]="Vertical"}(TreeMapType||(TreeMapType={}));export class TreeMap extends FlexChartBase{constructor(e,t){super(e,null,!0);this._values=[];this._labels=[];this._areas=[];this._sum=0;this._keywords=new _KeyWords;this._processedData=[];this._depth=1;this._itemIndex=0;this._processedItem=[];this._maxDepth=-1;this._tmItems=[];this._colRowLens=[];this._defPalette=[{titleColor:"#033884",maxColor:"#1450a7",minColor:"#83b3f9"},{titleColor:"#a83100",maxColor:"#dc4a0d",minColor:"#ffb190"},{titleColor:"#006658",maxColor:"#008d7a",minColor:"#7deddf"},{titleColor:"#a10046",maxColor:"#df0061",minColor:"#ff8cbe"},{titleColor:"#784d08",maxColor:"#99681a",minColor:"#efc989"},{titleColor:"#54156f",maxColor:"#722a90",minColor:"#cf95e7"},{titleColor:"#998605",maxColor:"#c2ac19",minColor:"#ffef8b"},{titleColor:"#9a0005",maxColor:"#c80c14",minColor:"#ff888d"}];this.applyTemplate("wj-control wj-flexchart wj-treemap",null,null);this._currentRenderEngine=new _SvgRenderEngine(this.hostElement);this._legend=new Legend(this);this._legend.position=Position.None;this._tooltip=new ChartTooltip;this._tooltip.content="<b>{name}</b><br/>{value}";this._tooltip.showDelay=0;this._lbl=new DataLabel;this._lbl.position=LabelPosition.Center;this._lbl._chart=this;this.hostElement.addEventListener("mousemove",e=>{this.isTouching||this._toogleTooltip(e)});this.hostElement.addEventListener("click",e=>{var t=!0;if(this.maxDepth>0){var i=this.hitTest(e),s=FlexChart._SELECTION_THRESHOLD;this.tooltip&&this.tooltip.threshold&&(s=this.tooltip.threshold);if(i.distance<=s&&i.pointIndex>=-1&&i.pointIndex<this._areas.length){var r=this._areas[i.pointIndex];if(this._currentItem!=r.item){this._currentItem=r.item;this._refreshChart();t=!1}}}t&&this.isTouching&&this._toogleTooltip(e)});this.hostElement.addEventListener("contextmenu",e=>{if(this.maxDepth>0){var t=this.hitTest(e),i=FlexChart._SELECTION_THRESHOLD;this.tooltip&&this.tooltip.threshold&&(i=this.tooltip.threshold);t.distance<=i&&this._rollUp()}e.preventDefault();return!1});this.hostElement.addEventListener("mouseleave",()=>{this._hideToolTip()});this.initialize(t);this.refresh()}_rollUp(){this._currentItem=this._currentItem&&this._currentItem.parent?this._currentItem.parent:null;this._refreshChart()}_toogleTooltip(e){var t=this._tooltip;if(t.content){var i=this.hitTest(e);if(i.distance<=t.threshold){var s=this._getLabelContent(i,this.tooltip.content);this._showToolTip(s,new Rect(e.clientX,e.clientY,5,5))}else this._hideToolTip()}}get selectionMode(){return SelectionMode.None}set selectionMode(e){}get _treeMapItems(){return this._tmItems}get tooltip(){return this._tooltip}get binding(){return this._binding}set binding(e){if(e!=this._binding){this._binding=asString(e,!0);this._bindChart()}}get type(){return null==this._type?TreeMapType.Squarified:this._type}set type(e){if((e=asEnum(e,TreeMapType))!=this._type){this._type=e;this.invalidate()}}get bindingName(){return this._bindingName}set bindingName(e){if(e!=this._bindingName){assert(null==e||isArray(e)||isString(e),"bindingName should be an array or a string.");this._bindingName=e;this._bindChart()}}get dataLabel(){return this._lbl}set dataLabel(e){if(e!=this._lbl){this._lbl=e;this._lbl&&(this._lbl._chart=this)}}get childItemsPath(){return this._childItemsPath}set childItemsPath(e){if(e!=this._childItemsPath){assert(null==e||isArray(e)||isString(e),"childItemsPath should be an array or a string.");this._childItemsPath=e;this._bindChart()}}get maxDepth(){return this._maxDepth}set maxDepth(e){if(e!=this._maxDepth){this._maxDepth=asNumber(e,!0);this.invalidate()}}get palette(){return this._palette}set palette(e){if(e!=this._palette){this._palette=asArray(e);this._tmItems&&this._tmItems.length>0&&this._calculateColorForItems(this._tmItems);this.invalidate()}}_initData(){this._sum=0;this._tmItems=[];this._currentItem=null;this._values=[];this._labels=[];this._processedData=[];this._depth=1;this._processedItem=[]}_performBind(){var e;this._initData();if(this._cv){e=this._cv.items;this._cv.groups&&this._cv.groups.length?this._processedData=HierarchicalUtil.parseDataToHierarchical(this._cv,this.binding,this.bindingName,this.childItemsPath):e&&(this._processedData=HierarchicalUtil.parseDataToHierarchical(e,this.binding,this.bindingName,this.childItemsPath));if(this._processedData&&this._processedData.length){this._sum=this._calculateValueAndDepth(this._processedData,1);this._sortData(this._processedData);this._values=[];this._getTMItemsAndLabelsAndValues(this._processedData,this._tmItems,1,null);this._calculateColorForItems(this._tmItems)}}}_sortData(e){e.forEach(e=>{e.items&&this._sortData(e.items)});e.sort((e,t)=>t.value-e.value)}_getTMItemsAndLabelsAndValues(e,t,i,s,r){e&&e.length>0&&e.forEach((e,r)=>{var a,l=new _TreeMapItem;l.items=[];l.parent=s;l.depth=i;e.items&&this._getTMItemsAndLabelsAndValues(e.items,l.items,i+1,l);a=e.name?e.name:e.value.toString();l.label=a;l.value=e.value;if(null!=s){e.value>s.maxValue&&(s.maxValue=e.value);e.value<s.minValue&&(s.minValue=e.value)}t.push(l);this._labels.push(a);this._values.push(e.value)})}_calculateColorForItems(e,t,i){var s=i;e.forEach((e,i)=>{var r=t;1===e.depth&&(r=this._getColor(i));e.palette=r;var a=e.palette;if(isString(a)){var l=a,h=this._getLightColor(l);e.titleFill=l;e.titleStroke=l;e.fill=h;e.stroke=l}else if(a.maxColor&&a.minColor&&a.titleColor){e.titleFill=a.titleColor;e.titleStroke=a.titleColor;if(null==e.parent){e.fill=a.maxColor;e.stroke=a.maxColor}else{null==s&&(s=new _ColorConverter(a.minColor,e.minValue,a.maxColor,e.maxValue));let t=s._calculateColorByVal(e.value,!0).toString();e.fill=t;e.stroke=t}}if(e.items&&e.items.length>0){var o=new _ColorConverter(a.minColor,e.minValue,a.maxColor,e.maxValue);this._calculateColorForItems(e.items,r,o)}})}_getBindData(e,t,i){var s,r=0;i&&(s=e[i]);r=0;isNumber(s)?r=asNumber(s):s&&(r=parseFloat(s.toString()));if(!isNaN(r)&&isFinite(r))t.push(r);else{r=0;t.push(r)}return r}_calculateValueAndDepth(e,t){var i=0,s=this._values;this._depth<t&&(this._depth=t);e.forEach(e=>{var r;if(e.items){r=this._calculateValueAndDepth(e.items,t+1);e.value=r;s.push(r)}else{r=this._getBindData(e,s,"value");e.value=r}i+=r});return i}_prepareRender(){this._areas=[]}_renderChart(e,t,i){var s,r,a,l=this._rectChart.clone();new Size(l.width,l.height);this.onRendering(new RenderEventArgs(e));var h=t.width,o=t.height;this._tmGroup=e.startGroup(null,null,!0);var n=this._parseMargin(this.plotMargin);this.dataLabel;isNaN(n.left)&&(n.left=TreeMap._MARGIN);isNaN(n.right)&&(n.right=TreeMap._MARGIN);isNaN(n.top)&&(n.top=TreeMap._MARGIN);isNaN(n.bottom)&&(n.bottom=TreeMap._MARGIN);t.top+=n.top;o=t.height-(n.top+n.bottom);t.height=o>0?o:24;t.left+=n.left;h=t.width-(n.left+n.right);t.width=h>0?h:24;this._plotRect=t;s=this._currentItem?[this._currentItem]:this._tmItems;r=null==this._currentItem||this.maxDepth<1?this.maxDepth:this._currentItem&&this._currentItem.items&&this._currentItem.items.length&&this.maxDepth>1?this.maxDepth:this.maxDepth+1;a=this._currentItem?this._currentItem.value:this._sum;this._renderTreeMap(e,t,this._tmGroup,s,a,r);e.endGroup();this.dataLabel.content&&this.dataLabel.position!=LabelPosition.None&&this._renderLabels(e);this.onRendered(new RenderEventArgs(e))}_renderTreeMap(e,t,i,s,r,a){if(r>0){this._itemIndex=0;this._resetItemRects(this._tmItems);this._calculateItemRects(t,s,r,1,a);this._renderHierarchicalTreeMapItems(e,i,t,this._tmItems,r,1,a)}}_resetItemRects(e){e.forEach(e=>{e.rect=new Rect(0,0,0,0);e.isTitle=!1;e.type=this.type;e.items&&e.items.length&&this._resetItemRects(e.items)})}_calculateItemRects(e,t,i,s,r){switch(this.type){case TreeMapType.Horizontal:_TreeMapUtils.horizontal(t,e,i);break;case TreeMapType.Vertical:_TreeMapUtils.vertical(t,e,i);break;case TreeMapType.Squarified:_TreeMapUtils.squarified(t,e,i)}t.forEach((e,t)=>{e.rect.clone();if(e.items&&e.items.length)if(s===r);else if(s>r&&r>=1);else{e.isTitle=!0;this._calculateItemRects(e.itemsRect,e.items,e.value,s+1,r)}})}_renderHierarchicalTreeMapItems(e,t,i,s,r,a,l){var h,o,n,_,c,d=s.length;this.type;if(0!==d)for(var m=0;m<d;m++){h=e.startGroup(TreeMap._CSS_ITEMDEPTH+a);o=s[m];n=Math.abs(o.value);_=o.rect;o.draw(e);c=new _RectArea(_);o.items&&this._renderHierarchicalTreeMapItems(e,h,o.itemsRect,o.items,n,a+1,l);c.tag=this._itemIndex;c.name=o.label;c.value=n;c.item=o;this._areas.push(c);this._itemIndex++;e.endGroup()}}_renderLabels(e){var t,i=this._areas.length,s=this.dataLabel,r=s.position,a=s.connectingLine,l=s.border,h=s.offset||0;e.stroke="null";e.fill="transparent";e.strokeWidth=1;e.startGroup("wj-data-labels");for(var o=0;o<i;o++){var n=this._areas[o];if(n){var _=n.rect,c=new HitTestInfo(this,t);c._setData(null,o);var d=this._getLabelContent(c,s.content);t=new Point(_.left+_.width/2,_.top+_.height/2);if(d&&_.width>0&&_.height>0){var m=new DataLabelRenderEventArgs(e,c,t,d);if(s.onRendering(m)){d=m.text;t=m.point;this._renderLabelAndBorder(e,n,_,d,r,h,t,a,2,l)}}}}e.endGroup()}_renderLabelAndBorder(e,t,i,s,r,a,l,h,o,n){var _,c="wj-data-label",d="wj-data-label-line";switch(r){case LabelPosition.Top:h&&e.drawLine(l.x,l.y,l.x,l.y-a,d);l.y-=o+a;_=this._renderText(e,t,i,s,l,1,2,c);break;case LabelPosition.Bottom:h&&e.drawLine(l.x,l.y,l.x,l.y+a,d);l.y+=o+a;_=this._renderText(e,t,i,s,l,1,0,c);break;case LabelPosition.Left:h&&e.drawLine(l.x,l.y,l.x-a,l.y,d);l.x-=o+a;_=this._renderText(e,t,i,s,l,2,1,c);break;case LabelPosition.Right:h&&e.drawLine(l.x,l.y,l.x+a,l.y,d);l.x+=o+a;_=this._renderText(e,t,i,s,l,0,1,c);break;case LabelPosition.Center:_=this._renderText(e,t,i,s,l,1,1,c)}n&&_&&e.drawRect(_.left-o,_.top-o,_.width+2*o,_.height+2*o,"wj-data-label-border");return _}_renderText(e,t,i,s,r,a,l,h){var o,n=s,_=t.item;o=e.measureString(s,h);if(this.type===TreeMapType.Horizontal&&_.isTitle){o.width>i.height&&(n=this._cutText(s,o.width,i.height));FlexChart._renderRotatedText(e,n,r,a,l,r,-90,h);return null}o.width>i.width&&(n=this._cutText(s,o.width,i.width));return FlexChart._renderText(e,n,r,a,l,h)}_cutText(e,t,i){var s="",r=e.length,a=Math.floor((1-(t-i)/t)*r);e.length>0&&(s=e[0]+(a>1?e.substring(1,a-1)+"..":""));return s}_measureLegendItem(e,t){var i=new Size;i.width=Series._LEGEND_ITEM_WIDTH;i.height=Series._LEGEND_ITEM_HEIGHT;if(t){var s=e.measureString(t,FlexChart._CSS_LABEL,FlexChart._CSS_LEGEND);i.width+=s.width;i.height<s.height&&(i.height=s.height)}i.width+=3*Series._LEGEND_ITEM_MARGIN;i.height+=2*Series._LEGEND_ITEM_MARGIN;return i}_getDesiredLegendSize(e,t,i,s){var r=new Size,a=(new Size(i,s),this._tmItems.length),l=0,h=0;this._colRowLens=[];for(var o=0;o<a;o++){var n=this._measureLegendItem(e,this._tmItems[o].label);if(t){if(h+n.height>s){r.height=s;this._colRowLens.push(l);l=0;h=0}l<n.width&&(l=n.width);h+=n.height}else{if(l+n.width>i){r.width=i;this._colRowLens.push(h);h=0;l=0}h<n.height&&(h=n.height);l+=n.width}}if(t){r.height<h&&(r.height=h);this._colRowLens.push(l);r.width=this._colRowLens.reduce((e,t)=>e+t,0);r.width=this._getLegendSize(i,r.width)}else{r.width<l&&(r.width=l);this._colRowLens.push(h);r.height=this._colRowLens.reduce((e,t)=>e+t,0);r.height=this._getLegendSize(s,r.height)}return r}_renderLegend(e,t,i,s,r,a){for(var l,h=this._rectLegend,o=this._tmItems.length,n=0,_=t.clone(),c=0;c<o;c++){l=this._tmItems[c].label;var d=this._measureLegendItem(e,l);if(s){if(_.y+d.height>h.top+h.height+1){_.x+=this._colRowLens[n];n++;_.y=t.y}}else if(_.x+d.width>h.left+h.width+1){_.y+=this._colRowLens[n];n++;_.x=t.x}var m=new Rect(_.x,_.y,d.width,d.height);this._drawLegendItem(e,m,c,l);i.push(m);s?_.y+=d.height:_.x+=d.width}}_drawLegendItem(e,t,i,s){e.strokeWidth=1;var r=Series._LEGEND_ITEM_MARGIN,a=this._getColor(i),l=a&&a.maxColor?a.maxColor:a,h=this._getLightColor(l);e.fill=l;e.stroke=h;var o=t.top+.5*t.height,n=Series._LEGEND_ITEM_WIDTH,_=Series._LEGEND_ITEM_HEIGHT;e.drawRect(t.left+r,o-.5*_,n,_,null);s&&FlexChart._renderText(e,s,new Point(t.left+_+2*r,o),0,1,FlexChart._CSS_LABEL)}_getLabelContent(e,t){return isString(t)?this._keywords.replace(t,e):isFunction(t)?t(e):null}hitTest(e,t){var i=this._toControl(e,t),s=new HitTestInfo(this,i),r=null;if(FlexChart._contains(this._rectHeader,i))s._chartElement=ChartElement.Header;else if(FlexChart._contains(this._rectFooter,i))s._chartElement=ChartElement.Footer;else if(FlexChart._contains(this._rectLegend,i)){s._chartElement=ChartElement.Legend;null!==(r=this.legend._hitTest(i))&&r>=0&&r<this._areas.length&&s._setData(null,r)}else if(FlexChart._contains(this._rectChart,i)){for(var a,l=this._areas.length,h=NaN,o=0;o<l;o++){var n=i.clone(),_=this._areas[o];if(_.contains(n)){s._setData(null,_.tag);s._dist=0}var c=_.distance(n);if(void 0!==c&&(isNaN(h)||c<h)){h=c;a=_}}if(0!==s._dist&&null!=a){s._setData(null,a.tag);s._dist=h}s._chartElement=ChartElement.ChartArea}else s._chartElement=ChartElement.None;return s}_getHitTestItem(e){var t=null,i=null;(t=null!=this._cv?this._cv.items:this.itemsSource)&&e<t.length&&(i=t[e]);return i}_getHitTestValue(e){return this._values[e]}_getHitTestLabel(e){return this._labels[e]}}TreeMap._CSS_ITEMDEPTH="wj-treemap-item-depth";TreeMap._MARGIN=0;class _TreeMapItem{constructor(){this.items=[];this.maxValue=Number.MIN_VALUE;this.minValue=Number.MAX_VALUE}draw(e){var t=this.rect;e.strokeWidth=0;if(this.isTitle){e.fill=this.titleFill;e.stroke=this.titleStroke}else{e.fill=this.fill;e.stroke=this.stroke}e.drawRect(t.left,t.top,t.width,t.height,_TreeMapItem._CLASSNAME)}get itemsRect(){var e=this.rect,t=this._rect,i=1===this.depth?2:.5;return this.isTitle?this.type===TreeMapType.Horizontal?new Rect(e.left+e.width+1,e.top,t.width-e.width-2*i,e.height+1):new Rect(e.left,e.top+e.height+1,e.width+1,t.height-e.height-2*i):new Rect(0,0,0,0)}get rect(){var e=this._rect,t=1===this.depth?2:.5,i=e.width,s=e.height,r=e.left,a=e.top;if(this.isTitle){if(this.type===TreeMapType.Horizontal){i=e.width>20?20:i;i=Math.max(20,i-2*t);s=s>2*t?s-2*t:0}else{s=e.height>20?20:s;s=Math.max(20,s-2*t);i=i>2*t?i-2*t:0}r+=t;a+=t}else{i=i>2*t?i-2*t:0;s=s>2*t?s-2*t:0}return new Rect(r,a,i,s)}set rect(e){e!=this._rect&&(this._rect=e)}get isTitle(){return this._isTitle}set isTitle(e){var t=asBoolean(e,!0);t!==this._isTitle&&(this._isTitle=t)}}_TreeMapItem._CLASSNAME="wj-treemap-item";class _ColorConverter{constructor(e,t,i,s,r,a){this.minColor=new Color(e);this.minColorValue=t;this.maxColor=new Color(i);this.maxColorValue=s;this.midColorValue=this.originalMidColorValue=a;this._calculateMidColorValue();this.midColor=this.originalMidColor=new Color(r);this._calculateMidColor()}_resetminColor(e){this.minColor=new Color(e);this._calculateMidColor()}_resetmidColor(e){this.midColor=this.originalMidColor=new Color(e);this._calculateMidColor()}_resetmaxColor(e){this.maxColor=new Color(e);this._calculateMidColor()}_resetminColorValue(e){this.minColorValue=e;this._calculateMidColorValue()}_resetmidColorValue(e){this.midColorValue=this.originalMidColorValue=e;this._calculateMidColorValue()}_resetmaxColorValue(e){this.maxColorValue=e;this._calculateMidColorValue()}_calculateMidColorValue(){null==this.originalMidColorValue&&(this.midColorValue=(this.maxColorValue+this.minColorValue)/2)}_calculateMidColor(){null==this.originalMidColor&&(this.midColor=this._calculateColorByVal(this.midColorValue,!0))}_calculateColorByVal(e,t=!1){var i=this.maxColor,s=this.minColor,r=this.maxColorValue,a=this.minColorValue;if(e>=this.maxColorValue)return new Color(i.toString());if(e<=this.minColorValue)return new Color(s.toString());if(!t){if(e===this.midColorValue)return new Color(this.midColor.toString());if(e<this.midColorValue){i=this.midColor;r=this.midColorValue}else{s=this.midColor;a=this.midColorValue}}return this._getColor(e,i,r,s,a)}_getColor(e,t,i,s,r){return Color.fromRgba(this._getValueByRatio(e,t.r,i,s.r,r),this._getValueByRatio(e,t.g,i,s.g,r),this._getValueByRatio(e,t.b,i,s.b,r),this._getValueByRatio(e,t.a,i,s.a,r))}_getValueByRatio(e,t,i,s,r){return Math.abs(s+Math.round((e-r)*(t-s)/(i-r)))}}class _TreeMapUtils{static squarified(e,t,i){var s=e.slice(),r=t.clone(),a=r.width*r.height/i;do{var l=_TreeMapUtils.getRowedItems(s,r,a);_TreeMapUtils.layoutRowedItems(t,l,r,r.width>r.height)}while(s.length)}static horizontal(e,t,i){var s=t.clone();e.forEach(e=>{var r=[{item:e,val:e.value*t.width*t.height/i}];_TreeMapUtils.layoutRowedItems(t,r,s,!1)})}static vertical(e,t,i){var s=t.clone();e.forEach(e=>{var r=[{item:e,val:e.value*t.width*t.height/i}];_TreeMapUtils.layoutRowedItems(t,r,s,!0)})}static getNarrowLen(e){return Math.min(e.width,e.height)}static getRowedItem(e,t,i){return{item:e,val:i*e.value}}static getRowedItems(e,t,i){var s=e.shift(),r=[],a=[],l=_TreeMapUtils.getNarrowLen(t),h=_TreeMapUtils.getRowedItem(s,t,i);r.push(h);a.push(h);if(e.length>0)do{a.push(_TreeMapUtils.getRowedItem(e[0],t,i));if(!(_TreeMapUtils.worst(r,l)>_TreeMapUtils.worst(a,l)))break;r=a.slice();e.shift()}while(e.length);return r}static layoutRowedItems(e,t,i,s){var r,a=i.left,l=i.top,h=a+i.width,o=l+i.height,n=_TreeMapUtils.sumRowedArray(t);if(s){r=0===i.height?0:n/i.height;a+r>=h&&(r=h-a);t.forEach((e,i)=>{var s=0===r?0:e.val/r;(l+s>o||i===t.length-1)&&(s=o-l);var h=new Rect(a,l,r,s);e.item.rect=h;l+=s});i.left+=r;i.width-=r}else{r=0===i.width?0:n/i.width;l+r>=o&&(r=o-l);t.forEach((e,i)=>{var s=0===r?0:e.val/r;(a+s>h||i===t.length-1)&&(s=h-a);var o=new Rect(a,l,s,r);e.item.rect=o;a+=s});i.top+=r;i.height-=r}}static sumRowedArray(e){for(var t=0,i=e.length,s=0;s<i;s++)t+=e[s].val;return t}static worst(e,t){var i,s,r=_TreeMapUtils.sumRowedArray(e),a=r*r,l=t*t;i=s=e[0].val;e.forEach((e,t)=>{e.val>i?i=e.val:e.val<s&&(s=e.val)});return Math.max(l*i/a,a/(l*s))}}export class Sunburst extends FlexPie{constructor(e,t){super(e,t);this._selectionIndex=0;this.applyTemplate("wj-sunburst",null,null);this.initialize(t);this.refresh()}get bindingName(){return this._bindName}set bindingName(e){if(e!=this._bindName){assert(null==e||isArray(e)||isString(e),"bindingName should be an array or a string.");this._bindName=e;this._bindChart()}}get childItemsPath(){return this._childItemsPath}set childItemsPath(e){if(e!=this._childItemsPath){assert(null==e||isArray(e)||isString(e),"childItemsPath should be an array or a string.");this._childItemsPath=e;this._bindChart()}}_initData(){super._initData();this._processedData=[];this._level=1;this._legendLabels=[];this._processedItem=[];this._values[0]=[]}_performBind(){var e;this._initData();if(this._cv){e=this._cv.items;this._cv.groups&&this._cv.groups.length?this._processedData=HierarchicalUtil.parseDataToHierarchical(this._cv,this.binding,this.bindingName,this.childItemsPath):e&&(this._processedData=HierarchicalUtil.parseDataToHierarchical(e,this.binding,this.bindingName,this.childItemsPath));if(this._processedData&&this._processedData.length){this._sums[0]=this._sum=this._calculateValueAndLevel(this._processedData,1);this._processedData.forEach(e=>{this._legendLabels.push(e.name)})}}}_calculateValueAndLevel(e,t){var i=0,s=this._values[0],r=this._labels;this._level<t&&(this._level=t);e.forEach(e=>{var a;if(e.items){a=this._calculateValueAndLevel(e.items,t+1);e.value=a;s.push(a);r.push(e.name)}else{a=this._getBindData(e,s,r,"value","name");e.value=a}i+=a});return i}_renderPie(e,t,i,s,r,a){var l=this._getCenter();this._sliceIndex=0;this._parentRef={};this._renderHierarchicalSlices(e,l.x,l.y,this._processedData,this._sum,i,s,r,2*Math.PI,a,1)}_renderHierarchicalSlices(e,t,i,s,r,a,l,h,o,n,_){var c,d,m,u,p,g,f,v,C,I,w=s.length,T=h,b=1==this.reversed;m=(a-l)/this._level;c=a-(this._level-_)*m;d=l+(_-1)*m;for(var x=0;x<w;x++){v=t;C=i;f=e.startGroup("wj-slice slice-level"+_);if(1===_){e.fill=this._getColorLight(x);e.stroke=this._getColor(x)}p=s[x];g=Math.abs(p.value);u=Math.abs(g-r)<1e-10?o:o*g/r;I=b?T-.5*u:T+.5*u;if(n>0&&u<o){v+=n*Math.cos(I);C+=n*Math.sin(I)}if(p.items){let t=this._sliceIndex;this._renderHierarchicalSlices(e,v,C,p.items,g,a,l,T,u,0,_+1);for(;t<this._sliceIndex;t++)null==this._parentRef[t]&&(this._parentRef[t]=this._sliceIndex)}this._renderSlice(e,v,C,I,0,this._sliceIndex,c,d,T,u,o);this._processedItem.push(p.item);this._sliceIndex++;b?T-=u:T+=u;e.endGroup();this._pels.push(f)}}_getLabelsForLegend(){return this._legendLabels||[]}_highlightCurrent(){this.selectionMode!=SelectionMode.None&&this._highlight(!0,this._selectionIndex)}hitTest(e,t){var i=super.hitTest(e,t),s=this._toControl(e,t);if(FlexChartBase._contains(this._rectChart,s)){var r=i.pointIndex,a=this._processedItem[r],l=new _DataPoint(null,r,null,null);l.item=a;i._setDataPoint(l)}return i}_getSelectedItemOffset(e,t){var i=0,s=0,r=0;if(this.selectedItemOffset>0)if(e==this.selectedIndex)r=this.selectedItemOffset;else{let i=this._getSelectedParentIndex(e);if(null!=i){let e=this._areas[i];this.dataLabel.position;r=this.selectedItemOffset;t=((t=e.langle+this._rotationAngles[0])%360+360)%360;t*=Math.PI/180}}if(r>0){i=Math.cos(t)*r*this._radius;s=Math.sin(t)*r*this._radius}return{x:i,y:s}}_getSelectedParentIndex(e){let t=this._parentRef[e];return null!=t?t===this.selectedIndex?t:this._getSelectedParentIndex(t):null}}_registerModule("wijmo.chart.hierarchical",selfModule);