/*!
    *
    * Wijmo Library 5.20202.724
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

import{_getModule,ObservableArray,Event,EventArgs,isArray,asString,copy,httpRequest,Control,CollectionView,DataType,SortDescription,CancelEventArgs,RequestErrorEventArgs,assert,getType,clamp,changeType,culture,isObject,isString,isFunction,asBoolean,asInt,asArray,isNumber,_registerModule}from"wijmo/wijmo";import*as selfModule from"wijmo/wijmo.cloud";export class OAuth2{constructor(e,t,s,i){this.userChanged=new Event;this.error=new Event;this._gapi=window.gapi;if(this._gapi)this._gapiLoaded(e,t,s);else{let i=document.createElement("script");i.src="https://apis.google.com/js/api.js";i.onload=()=>this._gapiLoaded(e,t,s);document.head.appendChild(i)}copy(this,i)}get user(){let e=this._auth();if(e&&e.isSignedIn.get()){let t=e.currentUser.get().getBasicProfile();return{id:t.getId(),name:t.getName(),firstName:t.getGivenName(),lastName:t.getFamilyName(),imageUrl:t.getImageUrl(),eMail:t.getEmail()}}return null}get accessToken(){let e=this._gapi.auth.getToken();return e?e.access_token:null}get idToken(){let e=this._gapi.auth.getToken();return e?e.id_token:null}signIn(){this._auth().signIn()}signOut(){this._auth().signOut()}onUserChanged(e){this.userChanged.raise(this,e)}onError(e){this.error.raise(this,e)}_gapiLoaded(e,t,s){let i=this._gapi=window.gapi;assert(i,"Failed to load google gapi.");i.load("client:auth2",()=>{let r=s&&s.length?s.join(" "):"";r=r||"https://www.googleapis.com/auth/userinfo.email";i.client.init({apiKey:e,clientId:t,scope:r}).then(()=>{this._auth().isSignedIn.listen(()=>{this.onUserChanged()});this.onUserChanged()},e=>{this.onError(new OAuthError(e))})})}_auth(){return this._gapi&&this._gapi.auth2?this._gapi.auth2.getAuthInstance():null}}export class OAuthError extends EventArgs{constructor(e){super();this._error=e}get error(){return this._error}}export class Snapshot extends CollectionView{constructor(e,t){super();this._loading=!1;this._deferCommits=!1;this._hasPendingChanges=!1;this.loading=new Event;this.loaded=new Event;this.error=new Event;this.hasPendingChangesChanged=new Event;this._checkType("CollectionReference",e,"firestore","doc","onSnapshot");this._collection=e;copy(this,t);this.itemsEdited.collectionChanged.addHandler(this._updateHasChanges,this);this.itemsAdded.collectionChanged.addHandler(this._updateHasChanges,this);this.itemsRemoved.collectionChanged.addHandler(this._updateHasChanges,this);this._getData()}get query(){return this._query}set query(e){if(e!=this._query){this._checkType("Query",e,"firestore","onSnapshot");this._query=e;this._getData()}}get deferCommits(){return this._deferCommits}set deferCommits(e){this._deferCommits=asBoolean(e);this.deferCommits&&(this.trackChanges=!0)}commitChanges(){if(this.deferCommits&&this.hasPendingChanges){let e=this._collection.firestore.batch();this.itemsEdited.forEach(t=>{let s=this._getItemDoc(t),i=this._getItemData(t);e.update(s,i)});this.itemsAdded.forEach(t=>{let s=this._getItemDoc(t),i=this._getItemData(t);e.set(s,i)});this.itemsRemoved.forEach(t=>{let s=this._getItemDoc(t);e.delete(s)});e.commit().then(()=>{this.clearChanges();this._getData(!0)}).catch(e=>this._raiseError(e,!0))}}cancelChanges(){if(this.deferCommits){this.clearChanges();this._getData(!0)}}get hasPendingChanges(){return!!this.deferCommits&&(this.itemsAdded.length>0||this.itemsEdited.length>0||this.itemsRemoved.length>0)}get isLoading(){return this._loading}load(e){this._getData(e)}onLoading(e){this.loading.raise(this,e);return!e.cancel}onLoaded(e){this.loaded.raise(this,e)}onError(e){if(this._loading){this._loading=!1;this.onLoaded()}this.error.raise(this,e);return!e.cancel}onHasPendingChangesChanged(e){this.hasPendingChangesChanged.raise(this,e)}commitNew(){if(!this.deferCommits){let e=this.currentAddItem;e&&this._collection.add(this._getItemData(e)).catch(e=>this._raiseError(e,!0))}super.commitNew()}commitEdit(){if(!this.deferCommits){let e=this.currentEditItem;if(e&&!this.currentAddItem&&this._getChangedFields(e,this._edtClone)){let t=this._getItemDoc(e),s=this._getItemData(e);t.update(s).catch(e=>this._raiseError(e,!0))}}super.commitEdit()}remove(e){if(!this.deferCommits&&e&&e!=this.currentAddItem){this._getItemDoc(e).delete().catch(e=>this._raiseError(e,!0))}super.remove(e)}_raiseError(e,t){this.onError(new FirestoreErrorEventArgs(e));t&&this._getData(!0)}_updateHasChanges(){let e=this.hasPendingChanges;if(e!=this._hasPendingChanges){this._hasPendingChanges=e;this.onHasPendingChangesChanged()}}_getItemDoc(e){let t=e&&e.$META?e.$META.id:this._generateID();return this._collection.doc(t)}_getItemData(e){let t={};for(var s in e)"$META"!=s&&(t[s]=e[s]);return t}_getData(e){this._toGetData&&clearTimeout(this._toGetData);this._toGetData=setTimeout(()=>{this._toGetData=null;this._loading=!0;if(this.onLoading(new CancelEventArgs)){this._unsubscribe&&this._unsubscribe();this._unsubscribe=this._getQuery().onSnapshot(t=>{let s=[],i=e||!this._loading?this.currentPosition:null;t.forEach(e=>{s.push(Object.assign({$META:{id:e.id}},e.data()))});this.sourceCollection=s;null!=i&&this.moveCurrentToPosition(i);if(this._loading){this._loading=!1;this.onLoaded()}},e=>this._raiseError(e,!0))}},Control._REFRESH_INTERVAL)}_generateID(){let e="";for(;e.length<20;)e+=Math.random().toString(36).substr(2,5);return e}_checkType(e,t,...s){if(null!=t)for(let i=0;i<s.length;i++){let r=s[i];null==t[r]&&assert(!1,'Expected "'+e+'" but the value does not have "'+r+'".')}}_getQuery(){return this._query||this._collection}}export class FirestoreErrorEventArgs extends CancelEventArgs{constructor(e){super();this._error=e}get error(){return this._error}get message(){return this._error.message}}export class Sheet extends CollectionView{constructor(e,t,s){super();this._loading=!1;this.loading=new Event;this.loaded=new Event;this.error=new Event;this._gSheet=e;this._title=t;this._id=s;this._getData();e.accessTokenChanged.addHandler(()=>{e.accessToken&&!this.items.length&&this._getData(!0)})}get googleSheet(){return this._gSheet}get title(){return this._title}load(e){this._getData(e)}get isLoading(){return this._loading}onLoading(e){this.loading.raise(this,e);return!e.cancel}onLoaded(e){this.loaded.raise(this,e)}onError(e){if(this._loading){this._loading=!1;this.onLoaded()}this.error.raise(this,e);return!e.cancel}commitNew(){let e=this.currentAddItem;e&&this._saveItem(e);super.commitNew()}commitEdit(){let e=this.currentEditItem;e&&!this.currentAddItem&&this._getChangedFields(e,this._edtClone)&&this._saveItem(e);super.commitEdit()}remove(e){if(e&&e!=this.currentAddItem){let t=this.sourceCollection.indexOf(e);assert(t>-1,"Item not found.");let s=t+1;assert(null!=this._id,"Sheet doesn't have an ID ? ");let i=this.googleSheet,r=i._getUrl(":batchUpdate");httpRequest(r,{method:"POST",requestHeaders:i._getRequestHeaders(),data:{requests:[{deleteDimension:{range:{sheetId:this._id,dimension:"ROWS",startIndex:s,endIndex:s+1}}}]},error:e=>this._handleError(e,!1)})}super.remove(e)}_getData(e){this._toGetData&&clearTimeout(this._toGetData);this._toGetData=setTimeout(()=>{this._loading=!0;this._itemKeys=null;if(this.onLoading(new CancelEventArgs)){let t=this.currentPosition,s=this.googleSheet,i=s._getUrl("/values/"+this.title+"!2:2");httpRequest(i,{requestHeaders:s._getRequestHeaders(),data:{valueRenderOption:"UNFORMATTED_VALUE",dateTimeRenderOption:"FORMATTED_STRING"},success:i=>{let r=JSON.parse(i.responseText).values[0],a=s._getUrl("/values/"+this.title);httpRequest(a,{requestHeaders:s._getRequestHeaders(),data:{valueRenderOption:"UNFORMATTED_VALUE",dateTimeRenderOption:"SERIAL_NUMBER"},success:s=>{let i=JSON.parse(s.responseText).values;this.sourceCollection=this._parseData(i,r);e&&this.moveCurrentToPosition(t);this._loading=!1;this.onLoaded()},error:e=>this._handleError(e,!1)})},error:e=>this._handleError(e,!1)})}},Control._REFRESH_INTERVAL)}_parseData(e,t){let s=[],i=e[0],r=!0;for(let e=0;e<i.length&&r;e++){let t=i[e];t&&isString(t)&&i.indexOf(t)==e||(r=!1)}if(r)e.splice(0,1);else{let e=[];for(let t=0;t<i.length;t++)e.push(this._toSheetHeader(t));i=e}this._itemKeys=i;let a=[],n=this._gSheet.columnDataTypes,o=DataType;i.forEach(e=>{let t=o.Object;n&&n.forEach(s=>{s.pattern.test(e)&&(t=s.dataType)});a.push(t)});e.forEach(e=>{let r={};i.forEach((s,i)=>{let n=e[i],h=t[i],l=a[i];l==o.Object&&isNumber(n)&&isString(h)&&h.length&&(l=o.Date);l!=o.Object&&(n=l==o.Date&&isNumber(n)?new Date(86400*(n-25568)*1e3):changeType(n,l));r[s]=n});s.push(r)});return s}_toSheetHeader(e){return e<26?String.fromCharCode(65+e):this._toSheetHeader(Math.floor(e/26)-1)+this._toSheetHeader(e%26)}_saveItem(e){let t=this.sourceCollection.indexOf(e);assert(t>-1,"Item not found?");let s=[];this._itemKeys.forEach(t=>{let i=e[t];s.push(null!=i?i.toString():"")});let i=this.googleSheet,r=(t+2).toString(),a=this.title+"!A"+r+":Z"+r,n=i._getUrl("/values/"+a);n+=(n.indexOf("?key=")>-1?"&":"?")+"valueInputOption=USER_ENTERED";httpRequest(n,{method:"PUT",requestHeaders:i._getRequestHeaders(),data:{range:a,values:[s]},error:e=>this._handleError(e,!0)})}_handleError(e,t){this.onError(new RequestErrorEventArgs(e));t&&this._getData(!0)}}export class GoogleSheet{constructor(e,t,s){this._sheetId="";this._accessToken="";this._apiKey="";this._loading=!1;this._sheets=new ObservableArray;this.loading=new Event;this.loaded=new Event;this.error=new Event;this.accessTokenChanged=new Event;this._sheetId=asString(e,!1);this._apiKey=asString(t,!1);copy(this,s);this._getSheetInfo()}get sheetId(){return this._sheetId}get apiKey(){return this._apiKey}get accessToken(){return this._accessToken}set accessToken(e){if(e!=this._accessToken){this._accessToken=asString(e);this.onAccessTokenChanged()}}get columnDataTypes(){return this._colTypes}set columnDataTypes(e){this._colTypes=e}get sheets(){return this._sheets}getSheet(e){for(let t=0;t<this._sheets.length;t++){let s=this._sheets[t];if(s.title==e)return s}return null}get isLoading(){return this._loading}onLoading(e){this.loading.raise(this,e)}onLoaded(e){this.loaded.raise(this,e)}onError(e){if(this._loading){this._loading=!1;this.onLoaded()}this.error.raise(this,e);return!e.cancel}onAccessTokenChanged(e){this.accessTokenChanged.raise(this,e)}_copy(e,t){if("sheets"==e&&isArray(t)){t.forEach(e=>{let t=new Sheet(this,e);this.sheets.push(t)});return!0}return!1}_getUrl(e){let t="https://sheets.googleapis.com/v4/spreadsheets/"+this.sheetId;e&&(t+=e);this.apiKey&&(t+="?key="+this.apiKey);return t}_getRequestHeaders(){let e={"Content-Type":"application/json"};this.accessToken&&(e.Authorization="Bearer "+this.accessToken);return e}_getSheetInfo(){this._loading=!0;this.onLoading();httpRequest(this._getUrl(),{requestHeaders:this._getRequestHeaders(),data:{fields:"sheets.properties"},success:e=>{let t=JSON.parse(e.responseText),s=t.sheets;this.sheets.length?this.sheets.forEach(e=>{for(let t=0;t<s.length;t++){let i=s[t].properties;if(i.title==e.title){e._id=i.sheetId;break}}assert(null!=e._id,'Could not find sheet "'+e.title+'".')}):t.sheets.forEach(e=>{let t=e.properties;if("GRID"==t.sheetType){let e=new Sheet(this,t.title,t.sheetId);this.sheets.push(e)}})},error:e=>{this.onError(new RequestErrorEventArgs(e))},complete:e=>{this._loading=!1;this.onLoaded()}})}}export class Firestore{constructor(e,t,s){this._projectId="";this._collections=new ObservableArray;this._accessToken="";this._idToken="";this._fbToken="";this._apiKey="";this.accessTokenChanged=new Event;this._projectId=asString(e,!1);this._apiKey=asString(t,!1);copy(this,s)}get projectId(){return this._projectId}get apiKey(){return this._apiKey}get accessToken(){return this._accessToken}set accessToken(e){if(e!=this._accessToken){this._accessToken=asString(e);this.onAccessTokenChanged()}}get idToken(){return this._idToken}set idToken(e){if(e!=this._idToken){this._idToken=asString(e);if(this._idToken){let e="https://identitytoolkit.googleapis.com/v1/accounts:signInWithIdp?key="+this._apiKey;httpRequest(e,{method:"POST",data:{requestUri:window.location.href,postBody:"id_token="+this._idToken+"&providerId=google.com",returnSecureToken:!0,returnIdpCredential:!0},success:e=>{let t=JSON.parse(e.responseText);this._fbToken=t.idToken;this.onAccessTokenChanged()},error:e=>{this._fbToken="";this.onAccessTokenChanged()}})}else{this._fbToken="";this.onAccessTokenChanged()}}}get collections(){return this._collections}getCollection(e){let t=this._collections;for(let s=0;s<t.length;s++){let i=t[s];if(i.name==e)return i}return null}onAccessTokenChanged(e){this.accessTokenChanged.raise(this,e)}_copy(e,t){if("collections"==e&&isArray(t)){t.forEach(e=>{let t=new Collection(this,e);this.collections.push(t)});return!0}return!1}}export function softGridFilter(){return _getModule("wijmo.grid.filter")}export class Collection extends CollectionView{constructor(e,t,s){super();this._loading=!1;this._sortOnServer=!1;this._pageOnServer=!1;this._filterOnServer=!1;this._deferCommits=!1;this._hasPendingChanges=!1;this._orderBy=[];this._fieldFilters=[];this._limit=0;this.loading=new Event;this.loaded=new Event;this.error=new Event;this.hasPendingChangesChanged=new Event;this._store=e;this._name=t;copy(this,s);this.sortDescriptions.collectionChanged.addHandler(()=>{this.sortOnServer&&!this.hasPendingChanges&&this._getData(!0)});e.accessTokenChanged.addHandler(()=>{e.accessToken&&!this.items.length&&this.load()});this.itemsEdited.collectionChanged.addHandler(this._updateHasChanges,this);this.itemsAdded.collectionChanged.addHandler(this._updateHasChanges,this);this.itemsRemoved.collectionChanged.addHandler(this._updateHasChanges,this);this._getData()}get store(){return this._store}get name(){return this._name}get fields(){return this._fields}set fields(e){if(e!=this._fields){this._fields=asArray(e);this._getData(!0)}}get limit(){return this._limit}set limit(e){if(e!=this._limit){this._limit=asInt(e);this._getData(!0)}}get sortOnServer(){return this._sortOnServer}set sortOnServer(e){if(e!=this._sortOnServer){this._sortOnServer=asBoolean(e);this._getData(!0)}}get pageOnServer(){return this._pageOnServer}set pageOnServer(e){if(e!=this._pageOnServer){this._pageOnServer=asBoolean(e);this.pageSize&&this._getData(!0)}}get filterOnServer(){return this._filterOnServer}set filterOnServer(e){if(e!=this._filterOnServer){this._filterOnServer=asBoolean(e);if(softGridFilter()){null==Collection._filterCulture&&(Collection._filterCulture=culture.FlexGridFilter);if(this._filterOnServer){let e=culture.FlexGridFilter,t=e.numberOperators;for(let e=0;e<t.length;e++)if(t[e].op==softGridFilter().Operator.NE){t.splice(e,1);break}e.stringOperators=t}else culture.FlexGridFilter=Collection._filterCulture}this._getData(!0)}}get deferCommits(){return this._deferCommits}set deferCommits(e){this._deferCommits=asBoolean(e);this.deferCommits&&(this.trackChanges=!0)}commitChanges(e){if(this.deferCommits){let t=[];this.itemsEdited.forEach(e=>{t.push({update:this._itemToDoc(e)})});this.itemsAdded.forEach(e=>{let s=this._itemToDoc(e);s.name="projects/"+this.store.projectId+"/databases/(default)/documents/"+this.name+"/"+this._generateID();t.push({update:s})});this.itemsRemoved.forEach(e=>{t.push({delete:e.$META.name})});t.length&&httpRequest(this._getUrl(":beginTransaction"),{method:"POST",requestHeaders:this._getRequestHeaders(),success:s=>{let i=JSON.parse(s.responseText);httpRequest(this._getUrl(":commit"),{method:"POST",data:{writes:t,transaction:i.transaction},requestHeaders:this._getRequestHeaders(),success:e=>{this.clearChanges();this.load()},complete:t=>{isFunction(e)&&e(t)},error:e=>this._raiseError(e,!0)})},error:e=>this._raiseError(e,!0)})}}cancelChanges(){if(this.deferCommits){this.clearChanges();this.load()}}get hasPendingChanges(){return!!this.deferCommits&&(this.itemsAdded.length>0||this.itemsEdited.length>0||this.itemsRemoved.length>0)}get isLoading(){return this._loading}load(e){this._getData(e)}select(...e){this.fields=e;return this}orderBy(e,t=!0){e?this._orderBy.push(new SortDescription(asString(e),asBoolean(t))):this._orderBy=[];this._getData(!1);return this}where(e,t,s){if(e){switch(t.toUpperCase()){case"==":t="EQUAL";break;case">":t="GREATER_THAN";break;case">=":t="GREATER_THAN_OR_EQUAL";break;case"<":t="LESS_THAN";break;case"<=":t="LESS_THAN_OR_EQUAL";break;case"IN":t="IN";assert(isArray(s),"IN operator requires array values.");break;default:assert(!1,"Unknown operator (should be ==, >, >=, <, <=, or IN).")}for(let s=0;s<this._fieldFilters.length;s++){let i=this._fieldFilters[s].fieldFilter;if(i.field.fieldPath==e&&i.op==t){this._fieldFilters.splice(s,1);break}}this._fieldFilters.push({fieldFilter:{field:{fieldPath:e},op:t,value:this._getValueObject(s)}})}else this._fieldFilters=[];this._getData(!1);return this}onLoading(e){this.loading.raise(this,e);return!e.cancel}onLoaded(e){this.loaded.raise(this,e)}onError(e){if(this._loading){this._loading=!1;this.onLoaded()}this.error.raise(this,e);return!e.cancel}onHasPendingChangesChanged(e){this.hasPendingChangesChanged.raise(this,e)}get totalItemCount(){let e=this._totalCount;return this.pageOnServer?null!=e?e:1e6:this.items.length}set totalItemCount(e){this._totalCount=asInt(e)}get pageCount(){return this.pageSize?Math.ceil(this.totalItemCount/this.pageSize):1}get pageSize(){return this._pgSz}set pageSize(e){if(e!=this._pgSz){this._pgSz=asInt(e);if(this.pageOnServer){this._pgIdx=clamp(this._pgIdx,0,this.pageCount-1);this._getData(!0)}else this.refresh()}}onPageChanging(e){super.onPageChanging(e);!e.cancel&&this.pageOnServer&&(0==this.pageIndex&&0==this.items.length?e.cancel=!0:this._getData(!0));return!e.cancel}commitNew(){if(!this.deferCommits){let e=this.currentAddItem;if(e){let t=this._itemToDoc(e);httpRequest(this._getUrl(),{method:"POST",data:{fields:t.fields},requestHeaders:this._getRequestHeaders(),success:t=>{let s=JSON.parse(t.responseText);this._saveDocName(s,e);this._totalCount++},error:e=>this._raiseError(e,!0)})}}super.commitNew()}commitEdit(){if(!this.deferCommits){let e=this.currentEditItem;if(e&&!this.currentAddItem&&this._getChangedFields(e,this._edtClone)){let t=this._itemToDoc(e);httpRequest(this._getUrl(t),{method:"PATCH",data:{fields:t.fields},requestHeaders:this._getRequestHeaders(),error:e=>this._raiseError(e,!0)})}}super.commitEdit()}remove(e){if(!this.deferCommits&&e&&e!=this.currentAddItem){let t=this._itemToDoc(e);httpRequest(this._getUrl(t),{method:"DELETE",requestHeaders:this._getRequestHeaders(),success:e=>this._totalCount--,error:e=>this._raiseError(e,!0)})}super.remove(e)}updateFilterDefinition(e){this._filterProvider=null;if(this.filterOnServer&&softGridFilter()&&e instanceof softGridFilter().FlexGridFilter){this._filterProvider=e;this._totalCount=null;this.moveCurrentToFirst();this._getData(!0)}}_getPageView(){return this.pageOnServer?this._view:super._getPageView()}_generateID(){let e="";for(;e.length<20;)e+=Math.random().toString(36).substr(2,5);return e}_updateHasChanges(){let e=this.hasPendingChanges;if(e!=this._hasPendingChanges){this._hasPendingChanges=e;this.onHasPendingChangesChanged()}}_getData(e){this._toGetData&&clearTimeout(this._toGetData);this._toGetData=setTimeout(()=>{this._toGetData=null;this._loading=!0;if(this.onLoading(new CancelEventArgs)){let t=this.currentPosition;httpRequest(this._getUrl(":runQuery"),{method:"POST",data:this._getQuery(),requestHeaders:this._getRequestHeaders(),success:s=>{let i=JSON.parse(s.responseText),r=this._parseData(i),a=this.pageSize;if(this.pageOnServer&&a&&r.length<a){let e=i[0].skippedResults||0;this._totalCount=e+r.length;if(0==r.length&&this.pageIndex>0){this.moveToLastPage();return}}this.sourceCollection=r;e&&this.moveCurrentToPosition(t);this._loading=!1;this.onLoaded()},error:e=>this._raiseError(e,!1)})}},Control._REFRESH_INTERVAL)}_getQuery(){let e={from:[{collectionId:this.name}]};this.fields&&this.fields.length&&(e.select={fields:this.fields.map(e=>({fieldPath:e}))});let t=this._fieldFilters;!t.length&&this._filterProvider&&this.filterOnServer&&(t=this._getQueryFilters());t&&t.length&&(e.where=1==t.length?t[0]:{compositeFilter:{filters:t,op:"AND"}});let s=[];t&&t.length&&t.forEach(e=>{let t=e.fieldFilter;"IN"!=t.op&&"EQUAL"!=t.op&&s.push({field:t.field.fieldPath,asc:!0})});this._orderBy.forEach(e=>{s.push({field:e.property,asc:e.ascending})});!s.length&&this.sortOnServer&&this.sortDescriptions.forEach(e=>{s.push({field:e.property,asc:e.ascending})});s.length&&(e.orderBy=s.map(e=>({field:{fieldPath:e.field},direction:e.asc?"ASCENDING":"DESCENDING"})));let i=this.pageSize;if(this.pageOnServer&&i){e.limit=i;e.offset=i*this.pageIndex}!e.limit&&this.limit>0&&(e.limit=this.limit);return{structuredQuery:e}}_parseData(e){let t=[];isArray(e)&&e.forEach(e=>{let s=this._docToItem(e);s&&t.push(s)});return t}_raiseError(e,t){this.onError(new RequestErrorEventArgs(e));t&&this._getData(!0)}_saveDocName(e,t){if(e.name&&!t.$META){t.$META={name:e.name};return!0}return!1}_docToItem(e){e.name||(e=e.document);if(!e||!e.name)return null;let t={};this._saveDocName(e,t);for(let s in e.fields)t[s]=this._getDocValue(e.fields[s]);return t}_getDocValue(e){let t=null;for(let s in e){t=e[s];switch(s){case"integerValue":t=parseInt(t);break;case"timestampValue":t=new Date(t);break;case"mapValue":let e={};for(let s in t.fields)e[s]=this._getDocValue(t.fields[s]);t=e;break;case"arrayValue":t=t.values?t.values.map(e=>this._getDocValue(e)):[]}}return t}_itemToDoc(e){let t={},s=e.$META;s&&s.name&&(t.name=s.name);t.fields={};for(let s in e)"$META"!=s&&(t.fields[s]=this._getValueObject(e[s]));return t}_getValueObject(e){let t={},s=DataType;switch(getType(e)){case s.String:t.stringValue=e;break;case s.Boolean:t.booleanValue=e;break;case s.Date:t.timestampValue=e.toJSON();break;case s.Number:e==Math.round(e)?t.integerValue=e.toString():t.doubleValue=e;break;case s.Array:t.arrayValue={values:e.map(e=>this._getValueObject(e))};break;case s.Object:let i={};for(let t in e)i[t]=this._getValueObject(e[t]);t.mapValue={fields:i};break;default:assert(!1,"failed to create value object.")}return t}_getRequestHeaders(){let e={},t=this.store._fbToken||this.store.accessToken;t&&(e.Authorization="Bearer "+t);return e}_getUrl(e){let t="https://firestore.googleapis.com/v1/";if(isObject(e)&&e.name)return t+e.name;e=e||"/"+this.name;return t+"projects/"+this.store.projectId+"/databases/(default)/documents"+e}_getQueryFilters(){let e=[],t=this._filterProvider;if(softGridFilter()&&t instanceof softGridFilter().FlexGridFilter)for(let s=0;s<t.grid.columns.length;s++){let i=t.grid.columns[s],r=t.getColumnFilter(i,!1);if(r&&r.isActive){r.conditionFilter&&r.conditionFilter.isActive?this._getQueryConditionFilter(e,r.conditionFilter):r.valueFilter&&r.valueFilter.isActive&&this._getQueryValueFilter(e,r.valueFilter);break}}return e}_getQueryConditionFilter(e,t){let s=t.column.binding,i=this._getQuerySimpleFilter(t.condition1,s),r=this._getQuerySimpleFilter(t.condition2,s);i&&r&&t.and?e.push({compositeFilter:{op:t.and?"AND":"OR",filters:[i,r]}}):i?e.push(i):r&&e.push(r)}_getQuerySimpleFilter(e,t){return e.isActive?{fieldFilter:{field:{fieldPath:t},op:this._getFilterOperator(e.operator),value:this._getValueObject(e.value)}}:null}_getFilterOperator(e){let t=softGridFilter().Operator;switch(e){case t.EQ:return"EQUAL";case t.GE:return"GREATER_THAN_OR_EQUAL";case t.GT:return"GREATER_THAN";case t.LE:return"LESS_THAN_OR_EQUAL";case t.LT:return"LESS_THAN"}assert(!1,t[e]+" operator not supported (use EQ, GT, GE, LT, or LE)")}_getQueryValueFilter(e,t){let s=t.column,i=s.dataMap,r=[];for(let e in t.showValues){let t=changeType(e,s.dataType,s.format);i&&isString(t)&&(t=i.getKeyValue(t));r.push(t);if(r.length>=10)break}r.length&&e.push({fieldFilter:{field:{fieldPath:s.binding},op:"IN",value:this._getValueObject(r)}})}}Collection._filterCulture=null;_registerModule("wijmo.cloud",selfModule);