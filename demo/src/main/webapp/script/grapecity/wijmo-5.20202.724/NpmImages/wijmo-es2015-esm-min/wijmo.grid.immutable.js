/*!
    *
    * Wijmo Library 5.20202.724
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

import{assert,CollectionView,isArray,Event,EventArgs,copy,CancelEventArgs,isObject,_registerModule}from"wijmo/wijmo";import{FlexGrid,GroupRow,_NewRowTemplate}from"wijmo/wijmo.grid";import*as selfModule from"wijmo/wijmo.grid.immutable";export class DataChangeEventArgs extends EventArgs{constructor(e,t,i,n){super();this.action=e;this.oldItem=t;this.newItem=i;this.itemIndex=n}}export var DataChangeAction;!function(e){e[e.Add=0]="Add";e[e.Remove=1]="Remove";e[e.Change=2]="Change"}(DataChangeAction||(DataChangeAction={}));export class CloningItemEventArgs extends EventArgs{constructor(e){super();this._originalItem=e}get originalItem(){return this._originalItem}}export class ImmutabilityProvider{constructor(e,t){this._isAddNew=!1;this._isPasting=!1;this.dataChanged=new Event;this.cloningItem=new Event;assert(e instanceof FlexGrid,"FlexGrid component is not specified.");this._grid=e;let i=this._cv=new CollectionView([]);e.itemsSource=i;e.rowAdded.addHandler(this._gridRowAdded,this);e.deletingRow.addHandler(this._gridDeletingRow,this);e.deletedRow.addHandler(this._gridDeletedRow,this);e.beginningEdit.addHandler(this._gridBeginningEdit,this);e.rowEditEnded.addHandler(this._gridRowEditEnded,this);e.pasting.addHandler(this._gridPasting,this);e.pasted.addHandler(this._gridPasted,this);copy(this,t)}_clearChg(){this._isAddNew=this._isPasting=!1;this._chg=this._iChg=null}get grid(){return this._grid}get collectionView(){return this._cv}get itemsSource(){return this._items}set itemsSource(e){assert(null==e||isArray(e),"Not an array");if(e!==this._items){this._items=e;let t=this._cv,i=t.sourceCollection,n=t.currentPosition,s=t.currentItem;this._replaceItems(i,e);t.refresh();if(n===t.currentPosition&&s!==t.currentItem){let e=new CancelEventArgs;t.onCurrentChanging(e);t.onCurrentChanged(e)}}}onDataChanged(e){this.dataChanged.raise(this,e)}onCloningItem(e){this.cloningItem.raise(this,e)}_gridRowAdded(e,t){this._isPasting||(this._isAddNew=!0)}_gridDeletingRow(e,t){if(this._isAddNew)return;let i=t.getRow(),n=i.dataItem,s=this._dataIndex(i);this._cv.sourceCollection.indexOf(n);s>-1&&(this._iChg={oldItem:n,index:s})}_gridDeletedRow(e,t){let i=this._iChg,n=this._isAddNew;if(i){this._clearChg();n||this.onDataChanged(new DataChangeEventArgs(DataChangeAction.Remove,i.oldItem,null,i.index))}}_gridBeginningEdit(e,t){if(this._isAddNew)return;let i=t.getRow(),n=i.dataItem,s=this._cv.sourceCollection.indexOf(n),o=this._chg;if(o){if(o.changedItems[s])return}else o=this._chg={changedItems:{}};this._addItemChange(i.index,s)}_gridRowEditEnded(e,t){this._isPasting||this._doRowEditEnded(e,t)}_doRowEditEnded(e,t){let i=this._isAddNew,n=this._chg;this._clearChg();if(i){if(!t.cancel){let e=this._cv.sourceCollection,t=e[e.length-1];this.onDataChanged(new DataChangeEventArgs(DataChangeAction.Add,null,t,e.length-1))}}else if(n)if(t.cancel){let e=t.getRow();this._swapBatchedItems(e,n.changedItems)>1&&this._cv.refresh()}else{let e=n.changedItems;for(let t in e){let i=e[t];this.onDataChanged(new DataChangeEventArgs(DataChangeAction.Change,i.oldItem,i.newItem,i.index))}}}_gridPasting(e,t){this._isPasting=!0;let i=t.range.rowSpan;if(this._chg&&1!==i){t.cancel=!0;return}if(1===i){this._isPasting=!1;t.getRow()instanceof _NewRowTemplate||this._gridBeginningEdit(e,t);return}let n=this._grid.rows,s=t.range.topRow,o=t.range.bottomRow,r=Math.min(n.length-1,o),a=this._cv.sourceCollection;this._chg={changedItems:{},cvLength:a.length};for(let e=s;e<=r;e++){let t=this._dataIndex(n[e]);t>-1&&this._addItemChange(e,t)}}_gridPasted(e,t){let i=this._chg;if(!i||1===t.range.rowSpan)return;let n=this._cv.sourceCollection,s=i.cvLength,o=n.slice(s,n.length);this._doRowEditEnded(e,t);for(let e=0;e<o.length;e++)this.onDataChanged(new DataChangeEventArgs(DataChangeAction.Add,null,o[e],s+e))}_swapItem(e,t,i,n){let s=e;s&&s.dataItem===n||this._grid.rows.some(e=>e.dataItem===n&&!!(s=e));let o=this._cv,r=o.sourceCollection.indexOf(n),a=o.items.indexOf(n);t.dataItem=i;s&&(s.dataItem=i);o.sourceCollection[r]=i;o.items[a]=i;return r}_swapBatchedItems(e,t){let i=Object.keys(t),n=i.length;n>1&&(e=null);for(let n of i){let i=t[n];this._swapItem(e,i.row,i.oldItem,i.newItem)}return n}_addItemChange(e,t){let i=this._grid.rows[e],n=i.dataItem,s=this._cloneItem(n);null==t&&(t=this._cv.sourceCollection.indexOf(n));this._chg.changedItems[t]={row:i,oldItem:n,newItem:s,index:t};this._swapItem(i,i,s,n)}_dataIndex(e){let t=e.dataItem;return t&&!(e instanceof GroupRow||e instanceof _NewRowTemplate)?this._cv.sourceCollection.indexOf(t):-1}_replaceItems(e,t){e.splice(0,e.length);let i=e.length=t.length;for(let n=0;n<i;n++)e[n]=t[n];return e}_cloneItem(e){let t=new CloningItemEventArgs(e);this.onCloningItem(t);let i=t.clonedItem;null==i&&(i=this._cloneBindings(e));return i}_cloneBindings(e){let t=copyObject({},e),i={},n=this.grid.columns;for(let e of n){let t=e._binding,n=t&&t._parts;if(n&&n.length>1){let e=n.length-2,t=i;for(let i=0;i<=e;i++){let e=n[i];t[e]||(t[e]={});t=t[e]}}}this._cloneProps(t,i);return t}_cloneProps(e,t){for(let i in t){let n=e[i];if(null!=n)if(isArray(n)){let s=e[i]=[].concat(n);this._cloneProps(s,t[i])}else if(isObject(n)){let s=e[i]=copyObject({},n);this._cloneProps(s,t[i])}}}}export function copyObject(e,...t){return _copyImpl(e,...t)}const _copyImpl="function"==typeof Object.assign?Object.assign:function(e,...t){for(let i of t)if(null!=i)for(let t in i){let n=Object.getOwnPropertyDescriptor(e,t);n&&!n.writable||(e[t]=i[t])}return e};_registerModule("wijmo.grid.immutable",selfModule);