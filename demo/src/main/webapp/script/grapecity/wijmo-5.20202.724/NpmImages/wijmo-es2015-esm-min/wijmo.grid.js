/*!
    *
    * Wijmo Library 5.20202.724
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

import{isInt,asInt,_addCultureInfo,tryCast,format,Size,CancelEventArgs,asType,asBoolean,ObservableArray,isNumber,assert,changeType,setAttribute,isIE,isFirefox,setCss,createElement,asNumber,isString,getType,hasClass,toggleClass,DateTime,DataType,Point,Rect,Globalize,CollectionView,CollectionViewGroup,NotifyCollectionChangedAction,NotifyCollectionChangedEventArgs,Aggregate,getAggregate,_getModule,Event,_MaskProvider,isArray,asString,asCollectionView,toPlainText,culture,escapeHtml,isBoolean,addClass,contains,setChecked,setAriaLabel,disableAutoComplete,evalTemplate,mouseToPage,closest,Control,SortDescription,isSafari,isIE9,closestClass,removeClass,getActiveElement,removeChild,_startDrag,clamp,Key,setSelectionRange,isDate,isUndefined,showPopup,hidePopup,Clipboard,isiOS,copy,asArray,toHeaderCase,Tooltip,Binding,isFunction,isPrimitive,enable,asFunction,asEnum,setText,getTypes,hasItems,getElementRect,supportsFocusOptions,_deprecated,isMobile,_registerModule}from"wijmo/wijmo";import*as mInput from"wijmo/wijmo.input";import*as selfModule from"wijmo/wijmo.grid";export var DataMapEditor;!function(e){e[e.AutoComplete=0]="AutoComplete";e[e.DropDownList=1]="DropDownList";e[e.RadioButtons=2]="RadioButtons"}(DataMapEditor||(DataMapEditor={}));export class DataMap{constructor(e,t,i){this._keyPath="";this._displayPath="";this._sortByVal=!0;this._editable=!1;this.mapChanged=new Event;if(isArray(e)&&!t&&!i){e=e.map(e=>({value:e}));t=i="value"}this._cv=asCollectionView(e);this._keyPath=asString(t,!1);this._displayPath=asString(i,!1);this._cv.collectionChanged.addHandler(this.onMapChanged,this)}get sortByDisplayValues(){return this._sortByVal}set sortByDisplayValues(e){this._sortByVal=asBoolean(e)}get collectionView(){return this._cv}get selectedValuePath(){return this._keyPath}get displayMemberPath(){return this._displayPath}getDataItem(e){if(!this._hash){let e=this._cv.sourceCollection,t={};isArray(e)&&this._keyPath&&e.forEach(e=>{let i=e[this._keyPath];null==t[i]&&(t[i]=e)});this._hash=t}return this._hash[e]}getDisplayValue(e){let t=this._displayPath,i=this.getDataItem(e);return t&&i?i[t]:e}getKeyValue(e,t){let i=this._displayPath,l=this._indexOf(e,i,t,!0);l<0&&(l=this._indexOf(e,i,t,!1));return l>-1?this._cv.sourceCollection[l][this._keyPath]:null}getDisplayValues(e){return this._cv&&this._displayPath?this._cv.items.map(e=>e[this._displayPath]):[]}getKeyValues(){return this._cv&&this._keyPath?this._cv.items.map(e=>e[this._keyPath]):[]}get isEditable(){return this._editable}set isEditable(e){this._editable=asBoolean(e)}onMapChanged(e){this._hash=null;this.mapChanged.raise(this,e)}_indexOf(e,t,i,l){let s=-1,o=-1;if(this._cv&&t){let n=null!=e?e.toString():"";n&&i&&(e=toPlainText(n));let r=l?n:n.toLowerCase(),a=this._cv.sourceCollection;for(let h=0;h<a.length;h++){let d=a[h],c=d[t];i&&isString(c)&&(c=toPlainText(c));c==e?s=h:l||c.length!=r.length||c.toLowerCase()!=r?null!=c&&c.toString()==n&&(s=h):s=h;if(s==h){if(!this._cv.filter||this._cv.filter(d))return s;o<0&&(o=s)}}}return o}}export class CellRange{constructor(e=-1,t=-1,i=e,l=t){this.setRange(e,t,i,l)}setRange(e=-1,t=-1,i=e,l=t){this._row=asInt(e);this._col=asInt(t);this._row2=asInt(i);this._col2=asInt(l)}get row(){return this._row}set row(e){this._row=asInt(e)}get col(){return this._col}set col(e){this._col=asInt(e)}get row2(){return this._row2}set row2(e){this._row2=asInt(e)}get col2(){return this._col2}set col2(e){this._col2=asInt(e)}clone(){return new CellRange(this._row,this._col,this._row2,this._col2)}copy(e){this.setRange(e._row,e._col,e._row2,e._col2)}get rowSpan(){return Math.abs(this._row2-this._row)+1}get columnSpan(){return Math.abs(this._col2-this._col)+1}get topRow(){return Math.min(this._row,this._row2)}get bottomRow(){return Math.max(this._row,this._row2)}get leftCol(){return Math.min(this._col,this._col2)}get rightCol(){return Math.max(this._col,this._col2)}get isValid(){return this._row>-1&&this._col>-1&&this._row2>-1&&this._col2>-1}get isSingleCell(){return this._row==this._row2&&this._col==this._col2}contains(e,t){let i=tryCast(e,CellRange);if(i)return i.topRow>=this.topRow&&i.bottomRow<=this.bottomRow&&i.leftCol>=this.leftCol&&i.rightCol<=this.rightCol;if(isInt(e)&&isInt(t))return e>=this.topRow&&e<=this.bottomRow&&t>=this.leftCol&&t<=this.rightCol;throw"contains expects a CellRange or row/column indices."}containsRow(e){return asInt(e)>=this.topRow&&e<=this.bottomRow}containsColumn(e){return asInt(e)>=this.leftCol&&e<=this.rightCol}intersects(e){return this.intersectsRow(e)&&this.intersectsColumn(e)}intersectsRow(e){return e&&!(this.bottomRow<e.topRow||this.topRow>e.bottomRow)}intersectsColumn(e){return e&&!(this.rightCol<e.leftCol||this.leftCol>e.rightCol)}getRenderSize(e){let t=new Size(0,0);if(this.isValid){for(let i=this.topRow;i<=this.bottomRow;i++)t.height+=e.rows[i].renderSize;for(let i=this.leftCol;i<=this.rightCol;i++)t.width+=e.columns[i].renderSize}return t}equals(e){return e instanceof CellRange&&this._row==e._row&&this._col==e._col&&this._row2==e._row2&&this._col2==e._col2}combine(e){return e?new CellRange(Math.min(this.topRow,e.topRow),Math.min(this.leftCol,e.leftCol),Math.max(this.bottomRow,e.bottomRow),Math.max(this.rightCol,e.rightCol)):this}toString(){return format("({row}, {col})-({row2}, {col2})",this)}}export var CellType;!function(e){e[e.None=0]="None";e[e.Cell=1]="Cell";e[e.ColumnHeader=2]="ColumnHeader";e[e.RowHeader=3]="RowHeader";e[e.TopLeft=4]="TopLeft";e[e.ColumnFooter=5]="ColumnFooter";e[e.BottomLeft=6]="BottomLeft"}(CellType||(CellType={}));export class GridPanel{constructor(e,t,i,l,s){this._offsetY=0;this._rng=new CellRange;this._g=asType(e,FlexGrid);this._ct=asInt(t);this._rows=asType(i,RowCollection);this._cols=asType(l,ColumnCollection);this._e=asType(s,HTMLElement);this._vrb=new CellRange}get grid(){return this._g}get cellType(){return this._ct}get viewRange(){return this._getViewRange()}get width(){return this._cols.getTotalSize()}get height(){return this._rows.getTotalSize()}get rows(){return this._rows}get columns(){return this._cols}getCellData(e,t,i){let l,s=this._g,o=this._rows[asNumber(e,!1,!0)],n=null;if(isString(t)&&(t=this._cols.indexOf(t))<0)throw"Invalid column name or binding.";l=this._cols[asNumber(t,!1,!0)];let r=s?s._getBindingColumn(this,e,l):l,a=null;o instanceof GroupRow&&o.dataItem instanceof CollectionViewGroup&&!s.childItemsPath&&(a=o.dataItem);r.binding&&o.dataItem&&!a?n=r._binding.getValue(o.dataItem):o._ubv&&(n=o._ubv[l._hash]);if(null==n)switch(this._ct){case CellType.ColumnHeader:e!=this._rows.length-1&&r==l||(n=r.header);break;case CellType.ColumnFooter:if(r.aggregate!=Aggregate.None&&o instanceof GroupRow){let e=this._g.collectionView;if(e){let t=tryCast(e,CollectionView);n=t?t.getAggregate(r.aggregate,r.binding):getAggregate(r.aggregate,e.items,r.binding)}}break;case CellType.Cell:r.aggregate!=Aggregate.None&&o instanceof GroupRow&&a&&(n=a.getAggregate(r.aggregate,r.binding,this._g.collectionView))}if(i){let e=r.dataMap||o.dataMap;this.cellType==CellType.Cell&&e&&(n=e.getDisplayValue(n));n=null!=n?Globalize.format(n,r.format||o.format):""}return n}setCellData(e,t,i,l=!0,s=!0){let o,n=this._g,r=this._rows[asNumber(e,!1,!0)],a=DataType;if(isString(t)&&(t=this._cols.indexOf(t))<0)throw"Invalid column name or binding.";o=this._cols[asNumber(t,!1,!0)];let h=n?n._getBindingColumn(this,e,o):o;if(this._ct==CellType.Cell){let s=h.dataMap||r.dataMap,o=h.getIsRequired(r),n=h.isContentHtml||r.isContentHtml;if(s&&null!=i){let e=s.getKeyValue(i,n);if(null==e&&null==s.getDisplayValue(null)){if(s.getDisplayValue(i)!=i);else if(!s.isEditable||s.displayMemberPath!=s.selectedValuePath){if(""!=i||o)return!1;i=null}}else i=e}let d=a.Object,c=h.dataType||r.dataType;if(c)d=c;else{let i=this.getCellData(e,t,!1);d=getType(i)}let g=null==i||""===i&&!s;if(!o&&g){d!=a.String&&(i=null);l=!1}else if(o&&g&&l)return!1;if(l){let e=h.format||r.format;e||d!=a.Date||(e="d");h.mask&&isString(i)&&d!=a.String&&(i=i.replace(/_/g,""));i=changeType(i,d,e);if(d!=a.Object&&getType(i)!=d)return!1}}if(r.dataItem&&h.binding){let e=h._binding,t=r.dataItem,l=e.getValue(t);if(i!==l&&!DateTime.equals(i,l)){e.setValue(t,i);let l=n.collectionView;if(l instanceof CollectionView&&t!=l.currentEditItem){let e=new NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Change,t,l.items.indexOf(t));l.onCollectionChanged(e)}}}else{r._ubv||(r._ubv={});r._ubv[o._hash]=i}s&&n&&n.invalidate();return!0}getCellBoundingRect(e,t,i){let l=this._g,s=this.rows[e],o=this.columns[t],n=new Rect(o.pos,s.pos,o.renderSize,s.renderSize);if(l.rightToLeft){n.left=this.hostElement.clientWidth-n.right;isIE()||(n.left-=l._root.offsetWidth-l._root.clientWidth)}if(!i){let e=this.hostElement.getBoundingClientRect();n.left+=e.left;n.top+=e.top-this._offsetY}e<this.rows.frozen&&(n.top-=l.scrollPosition.y);t<this.columns.frozen&&(n.left-=l.scrollPosition.x*(l.rightToLeft?-1:1));return n}getCellElement(e,t){let i=this.hostElement.children,l=Math.min(e+2,i.length);for(let s=0;s<l;s++){let l=i[s].children,o=Math.min(t+2,l.length);for(let i=0;i<o;i++){let s=l[i],o=s[GridPanel._INDEX_KEY];if(o&&(o.row==e&&o.col==t||o.rng&&o.rng.contains(e,t)))return s}}return null}getSelectedState(e,t,i){let l=this._g,s=l.selectionMode,o=l._selHdl.selection,n=SelectionMode,r=SelectedState;if(s==n.None)return r.None;switch(this._ct){case CellType.Cell:i||(i=l.getMergedRange(this,e,t));if(i){if(i.contains(o.row,o.col))return l.showMarquee?r.Active:r.Cursor;if(i.intersects(o)&&s!=n.ListBox)return r.Selected;for(let e=i.leftCol;e<=i.rightCol;e++)if(l.columns[e].isSelected)return r.Selected;for(let e=i.topRow;e<=i.bottomRow;e++)if(l.rows[e].isSelected)return r.Selected}if(o.row==e&&o.col==t)return l.showMarquee?r.Active:r.Cursor;if(l.rows[e].isSelected||l.columns[t].isSelected)return r.Selected;if(s==n.MultiRange){let s=l._selHdl.extendedSelection;for(let l=0;l<s.length;l++)if(s[l].contains(e,t)||i&&i.intersects(s[l]))return r.Selected}if(i)switch(s){case n.Row:case n.RowRange:if(i.containsRow(o.row))return r.Selected}return s==n.ListBox?r.None:(o=this._getAdjustedSelection(o)).containsRow(e)&&o.containsColumn(t)?r.Selected:r.None;case CellType.ColumnHeader:if(l.showSelectedHeaders&HeadersVisibility.Column&&(l.columns[t].isSelected||o.containsColumn(t)||o.intersectsColumn(i))){i&&(e=i.bottomRow);if(e==this.rows.length-1)return r.Selected}break;case CellType.RowHeader:if(l.showSelectedHeaders&HeadersVisibility.Row&&(l.rows[e].isSelected||o.containsRow(e)||o.intersectsRow(i))){i&&(t=i.rightCol);if(t==this.columns.length-1)return r.Selected}}return r.None}get hostElement(){return this._e}_getAdjustedSelection(e){let t=this._g,i=this._rng,l=SelectionMode;switch(t.selectionMode){case l.Cell:i.setRange(e.row,e.col,e.row,e.col);break;case l.Row:i.setRange(e.row,0,e.row,t.columns.length-1);break;case l.RowRange:case l.ListBox:i.setRange(e.row,0,e.row2,t.columns.length-1);break;default:i.copy(e)}return i}_getOffsetY(){return this._offsetY}_updateContent(e,t,i){let l=this._g,s=this._e,o=this._rows,n=this._cols,r=this._ct;if(r==CellType.ColumnHeader||r==CellType.ColumnFooter||r==CellType.RowHeader){let e=l._ptScrl,t=s.style;r==CellType.RowHeader?t.top=e.y+"px":l.rightToLeft?t.right=e.x+"px":t.left=e.x+"px"}if(this._offsetY!=i){e=!1;this._offsetY=i}let a=this._getViewRange(),h=a;if(h.isValid){let e=o.length<=l._vtRows?o.length:0,t=n.length<=l._vtCols?n.length:0;h=new CellRange(Math.max(a.row-e,o.frozen),Math.max(a.col-t,n.frozen),Math.min(a.row2+e,o.length-1),Math.min(a.col2+t,n.length-1))}if(e&&!t&&this._vrb.contains(a)&&!o.frozen&&!n.frozen)return this._activeCell;e&&h.equals(this._vrb)||(t=!1);e&&!t&&this._ct!=CellType.TopLeft&&this._reorderCells(h,this._vrb);this._activeCell=null;this._vru=a;this._vrb=h;this._recycle=e;let d=0;this._ct==CellType.Cell&&(d=this._renderColHdrRow(h,t));for(let e=0;e<o.frozen&&e<o.length;e++)d=this._renderRow(e,h,t,d);for(let e=h.topRow;e<=h.bottomRow&&e>-1;e++)d=this._renderRow(e,h,t,d);for(;s.childElementCount>d;){let e=s.lastElementChild;s.removeChild(e);this._removeExtraCells(e,0)}return this._activeCell}_clearCells(){let e=this.hostElement,t=this._g.cellFactory;for(let i=e.childElementCount-1;i>=0;i--){let l=e.children[i];e.removeChild(l);for(let e=l.childElementCount-1;e>=0;e--)t.disposeCell(l.children[e])}}_reorderCells(e,t){if(this._g._reorderCells&&t.isValid&&e.isValid&&e.intersects(t)){if(e.row!=t.row){let i=this._e,l=e.row-t.row,s=Math.max(1,e.rowSpan-1);if(0!=l&&Math.abs(l)<s){let e=this._ct==CellType.Cell?1:0,t=i.childElementCount;e+=this.rows.frozen;if(l>0){let s=e,o=Math.min(e+l,t),n=this._createRange(i,s,o);n&&i.appendChild(n.extractContents())}if(l<0){let s=t,o=Math.max(e,s+l),n=this._createRange(i,o,s);if(n&&o>e){let t=i.children[e];i.insertBefore(n.extractContents(),t)}}}}if(e.col!=t.col){let i=this._e,l=e.col-t.col,s=Math.max(1,e.columnSpan-1);if(0!=l&&Math.abs(l)<s){let e=this._ct==CellType.Cell&&this._g.rowHeaderPath?1:0;e+=this.columns.frozen;for(let t=0;t<i.children.length;t++){let s=i.children[t],o=s.children.length;if(hasClass(s,"wj-row")){if(l>0){let t=e,i=Math.min(e+l,o),n=this._createRange(s,t,i);n&&s.appendChild(n.extractContents())}if(l<0){let t=o,i=Math.max(e,t+l),n=this._createRange(s,i,t);if(n&&i>e){let t=s.children[e];s.insertBefore(n.extractContents(),t)}}}}}}}}_createRange(e,t,i){if(i>t&&i<=e.children.length&&t>-1){this._docRange||(this._docRange=document.createRange());let l=this._docRange;l.setStart(e,t);l.setEnd(e,i);return l}return null}_renderColHdrRow(e,t){if(t)return 1;let i=this._e.children[0];i||(i=createElement('<div class="wj-row" role="row"></div>',this._e));let l=this._g,s=l?l.columnHeaders.rows.ariaLabel:null;setAttribute(i,"aria-label",s);setAttribute(i,"aria-selected",null);let o=0,n=this._g._getRowHeaderPath();n&&(o=this._renderRowHdrCell(i,-1,n.path));for(let l=0;l<this.columns.frozen&&l<this.columns.length;l++)o=this._renderColHdrCell(i,l,e,t,o);for(let l=e.leftCol;l<=e.rightCol&&l>-1;l++)o=this._renderColHdrCell(i,l,e,t,o);this._removeExtraCells(i,o);return 1}_renderColHdrCell(e,t,i,l,s){let o=this.grid,n=this.columns[t];if(n.renderSize<=0)return s;if(l)return s+1;let r=e.children[s];r||(r=createElement(GridPanel._HTML_CELL,e));setAttribute(r,"role","columnheader");if(r&&this._recycle&&o._lazyRender){let e=r[GridPanel._INDEX_KEY];if(e&&-1==e.row&&e.col==t&&t>=this.columns.frozen)return s+1}r.textContent=this.columns[t].header;setCss(r,{position:"fixed",left:n.pos,top:-32e3,width:n.renderSize,height:.1,overflow:"hidden",opacity:"0",pointerEvents:"none"});if(n.describedById||this.columns.describedById){let e=[n.describedById,this.columns.describedById].join(" ").trim();setAttribute(r,"aria-describedby",e||null)}if(o.allowSorting){let e="none";switch(o._getBindingColumn(this,0,n).currentSort){case"+":e="ascending";break;case"-":e="descending"}setAttribute(r,"aria-sort",e)}if(!o.isReadOnly){setAttribute(r,"aria-readonly",n.isReadOnly);setAttribute(r,"aria-required",n.getIsRequired())}r[GridPanel._INDEX_KEY]={row:-1,col:t,panel:this};return s+1}_renderRowHdrCell(e,t,i){let l=e.children[0];l||(l=createElement(GridPanel._HTML_CELL,e));l.setAttribute("role",t<0?"columnheader":"rowheader");l.textContent=i?i.toString():"";setCss(l,{position:"fixed",left:-32e3,top:-32e3,width:.1,height:.1,overflow:"hidden",opacity:"0"});l[GridPanel._INDEX_KEY]={row:t,col:-1,panel:this};return 1}_renderRow(e,t,i,l){let s=this._g,o=this.rows[e];if(o.renderSize<=0)return l;let n=this._e.children[l];n||(n=createElement('<div class="wj-row"></div>',this._e));if(this._ct==CellType.Cell){n.setAttribute("role","row");let t=SelectionMode,i=o.isSelected;switch(s.selectionMode){case t.Row:case t.RowRange:i=i||this._g._selHdl.selection.containsRow(e)}setAttribute(n,"aria-selected",!!i||null);setAttribute(n,"aria-level",o instanceof GroupRow?o.level+1:null);setAttribute(n,"aria-expanded",o instanceof GroupRow?!o.isCollapsed:null);this.rows.ariaLabel&&setAttribute(n,"aria-label",this.rows.ariaLabel)}let r=0;if(this._ct==CellType.Cell){let t=this._g._getRowHeaderPath();t&&(r=this._renderRowHdrCell(n,e,t.getValue(o.dataItem)))}for(let l=0;l<this.columns.frozen&&l<this.columns.length;l++)r=this._renderCell(n,e,l,t,i,r);for(let l=t.leftCol;l<=t.rightCol&&l>-1;l++)r=this._renderCell(n,e,l,t,i,r);this._removeExtraCells(n,r);return l+1}_renderCell(e,t,i,l,s,o){let n=this._g,r=n.getMergedRange(this,t,i);if(r){for(let e=Math.max(l.row,r.row);e<t;e++)if(this.rows[e].renderSize)return o;for(let e=Math.max(l.col,r.col);e<i;e++)if(this.columns[e].renderSize)return o;var a=this.columns.frozen;if(a&&r.col<a&&r.col2>=a&&i>r.col)return o}let h=this.columns[i];if(h.renderSize<=0&&(!r||r.getRenderSize(this).width<=0))return o;let d=e.children[o];if(d&&!s&&this._recycle&&n._lazyRender&&!n.activeEditor){let e=d[GridPanel._INDEX_KEY];e&&e.row==t&&e.col==i&&e.rng==r&&t>=this.rows.frozen&&i>=this.columns.frozen&&(s=!0)}let c=SelectedState,g=this.getSelectedState(t,i,r),u=g==c.Cursor||g==c.Active;if(d&&s){toggleClass(d,"wj-state-active",u);toggleClass(d,"wj-state-selected",g==c.Cursor);toggleClass(d,"wj-state-multi-selected",g==c.Selected);setAttribute(d,"aria-selected",!(!u&&g==c.None)||null);u&&(this._activeCell=d);return o+1}d||(d=createElement(GridPanel._HTML_CELL,e));u&&(this._activeCell=d);if(this._ct==CellType.Cell){setAttribute(d,"role","gridcell");setAttribute(d,"aria-selected",!(g==c.None&&!u)||null);setAttribute(d,"aria-readonly",!n.canEditCell(t,i)||null);setAttribute(d,"aria-required",h.getIsRequired())}n.cellFactory.updateCell(this,t,i,d,r);d[GridPanel._INDEX_KEY]={row:t,col:i,rng:r,panel:this};return o+1}_removeExtraCells(e,t){let i=this._g.cellFactory;for(;e.childElementCount>t;){let t=e.lastElementChild;e.removeChild(t);i.disposeCell(t)}}_getViewRange(){let e=this._g,t=e._ptScrl,i=e._szClientSB,l=this._rows,s=this._cols,o=new CellRange(0,0,l.length-1,s.length-1);if(this._ct==CellType.Cell||this._ct==CellType.RowHeader){let s=-t.y+this._offsetY,n=i.height,r=Math.min(l.frozen,l.length-1);if(r>0){let e=l[r-1].pos;s+=e;n-=e}if(r>0&&l[r].pos>i.height)o.row=o.row2=-1;else{o.row=Math.min(l.length-1,Math.max(r,l.getItemAt(s)));o.row2=Math.max(o.row,l.getItemAt(s+n))}let a=e.hostElement;if(e._clipToScreen&&a){let t=a.getBoundingClientRect(),i=-t.top-e.cells._e.offsetTop;t.top<0&&(o.row=Math.max(o.row,l.getItemAt(i)-1));t.bottom>innerHeight&&(o.row2=Math.min(o.row2,l.getItemAt(i+innerHeight)+1))}}if(this._ct==CellType.Cell||this._ct==CellType.ColumnHeader){let e=-t.x,l=i.width,n=Math.min(s.frozen,s.length-1);if(n>0){let t=s[n-1].pos;e+=t;l-=t}if(n>0&&s[n].pos>i.width)o.col=o.col2=-1;else{o.col=Math.min(s.length-1,Math.max(n,s.getItemAt(e)));o.col2=Math.max(o.col,s.getItemAt(e+l))}}l.length<=l.frozen&&(o.row=o.row2=-1);s.length<=s.frozen&&(o.col=o.col2=-1);return o}_getFrozenPos(){let e=this._rows.frozen,t=this._cols.frozen,i=e>0?this._rows[e-1]:null,l=t>0?this._cols[t-1]:null,s=i?i.pos+i.renderSize:0,o=l?l.pos+l.renderSize:0;return new Point(o,s)}}GridPanel._INDEX_KEY="wj-cell-index";GridPanel._HTML_CELL='<div class="wj-cell" tabindex="-1"></div>';export class CellRangeEventArgs extends CancelEventArgs{constructor(e,t,i){super();this._p=asType(e,GridPanel,!0);this._rng=asType(t,CellRange,!0);this._data=i}get panel(){return this._p}get range(){return this._rng.clone()}get row(){return this._rng.row}get col(){return this._rng.col}get data(){return this._data}set data(e){this._data=e}getRow(){return this._p&&this.row>-1?this._p.rows[this.row]:null}getColumn(e){let t=this._p,i=t&&this.col>-1?t.columns[this.col]:null;i&&e&&(i=t.grid._getBindingColumn(t,this.row,i));return i}}export class FormatItemEventArgs extends CellRangeEventArgs{constructor(e,t,i){super(e,t);this._cell=asType(i,HTMLElement)}get cell(){return this._cell}}export class CellEditEndingEventArgs extends CellRangeEventArgs{constructor(){super(...arguments);this._stayInEditMode=!1;this._refresh=!0}get stayInEditMode(){return this._stayInEditMode}set stayInEditMode(e){this._stayInEditMode=asBoolean(e)}get refresh(){return this._refresh}set refresh(e){this._refresh=asBoolean(e)}}export var SelectionMode;!function(e){e[e.None=0]="None";e[e.Cell=1]="Cell";e[e.CellRange=2]="CellRange";e[e.Row=3]="Row";e[e.RowRange=4]="RowRange";e[e.ListBox=5]="ListBox";e[e.MultiRange=6]="MultiRange"}(SelectionMode||(SelectionMode={}));export var SelectedState;!function(e){e[e.None=0]="None";e[e.Selected=1]="Selected";e[e.Cursor=2]="Cursor";e[e.Active=3]="Active"}(SelectedState||(SelectedState={}));export var SelMove;!function(e){e[e.None=0]="None";e[e.Next=1]="Next";e[e.Prev=2]="Prev";e[e.NextPage=3]="NextPage";e[e.PrevPage=4]="PrevPage";e[e.Home=5]="Home";e[e.End=6]="End";e[e.NextCell=7]="NextCell";e[e.PrevCell=8]="PrevCell";e[e.NextEditableCell=9]="NextEditableCell";e[e.PrevEditableCell=10]="PrevEditableCell"}(SelMove||(SelMove={}));export class _SelectionHandler{constructor(e){this._sel=new CellRange(0,0);this._xSel=new ObservableArray;this._mode=SelectionMode.CellRange;this._g=e;this._e=new CellRangeEventArgs(e.cells,new CellRange(0,0));this._xSel.collectionChanged.addHandler(()=>{e.invalidate()})}get selectionMode(){return this._mode}set selectionMode(e){e!=this._mode&&this._setSelectionMode(e)}get selection(){return this._sel}set selection(e){this.select(e)}get extendedSelection(){return this._xSel}select(e,t=!0,i=!1){let l=this._g,s=this._e.range,o=this._sel,n=s,r=!1,a=SelectionMode;if(isNumber(e)&&isNumber(t)){s.setRange(e,t);t=!0}else e instanceof CellRange?s.copy(e):assert(!1,"CellRange expected");switch(l.selectionMode){case a.Cell:n.row2=n.row;n.col2=n.col;break;case a.Row:n.row2=n.row;break;case a.ListBox:r=!0}let h=n.equals(o);r&&n.row>-1&&n.row<l.rows.length&&(l.rows[n.row].isSelected||(h=!1));if(h&&l.isRangeValid(n)){t&&this._showSelection();return!0}let d=this._e;d._rng=n;d.cancel=!1;if(!l.onSelectionChanging(d)&&!i)return!1;r&&(n.row!=o.row||n.rowSpan>1||o.rowSpan>1)&&l.rows.forEach((e,t)=>{e._setFlag(RowColFlags.Selected,n.containsRow(t),!0)});n.row=Math.min(n.row,l.rows.length-1);n.row2=Math.min(n.row2,l.rows.length-1);this._sel.copy(n);l.refreshCells(!1,!0,!0);t&&this._showSelection();let c=l.collectionView;if(c){let e=l._getCvIndex(n.row);c.moveCurrentToPosition(e)}l.onSelectionChanged(d);return!0}moveSelection(e,t,i){let l=this._g,s=this._sel,o=i&&l.anchorCursor?new CellRange(s.row2,s.col2):new CellRange(s.row,s.col);this._adjustReferenceCell(o,e,t);let n=o.row,r=o.col,a=l.rows,h=l.columns,d=Math.max(0,l._szClient.height-l.columnHeaders.height),c=SelMove;switch(t){case c.NextCell:case c.NextEditableCell:if((r=h.getNextCell(r,t))==o.col&&(n=a.getNextCell(n,t))>o.row){r=h.getNextCell(0,t);r=h.getNextCell(r,t==c.NextCell?c.PrevCell:c.PrevEditableCell)}l.select(n,r);break;case c.PrevCell:case c.PrevEditableCell:if((r=h.getNextCell(o.col,t))==o.col&&(n=a.getNextCell(n,t))<o.row){r=h.getNextCell(h.length-1,t);r=h.getNextCell(r,t==c.PrevCell?c.NextCell:c.NextEditableCell)}l.select(n,r);break;default:n=a.getNextCell(n,e,d);r=h.getNextCell(r,t,d);i?l.selection=l.anchorCursor?new CellRange(s.row,s.col,n,r):new CellRange(n,r,s.row2,s.col2):l.select(n,r)}}_setSelectionMode(e){let t=this._g,i=t.rows,l=SelectionMode;if(e==l.ListBox||this._mode==l.ListBox)for(let t=0;t<i.length;t++){let s=e==l.ListBox&&this._sel.containsRow(t);i[t]._setFlag(RowColFlags.Selected,s,!0)}this._mode=e;this._xSel.clear();if(i.length){let i=this._sel;i=e!=l.None?new CellRange(i.row,i.col):new CellRange;this.select(i,!1,!0);t.invalidate()}}_expandSelection(){let e=this._g;if(e.expandSelectionOnCopyPaste&&e.selectionMode){let t=this.selection,i=e.cells,l=e.getMergedRange(i,t.topRow,t.leftCol,!1),s=e.getMergedRange(i,t.bottomRow,t.leftCol,!1),o=e.getMergedRange(i,t.topRow,t.rightCol,!1),n=e.getMergedRange(i,t.bottomRow,t.rightCol,!1);if(l||s||o||n){l=l||new CellRange(t.topRow,t.leftCol);s=s||new CellRange(t.bottomRow,t.leftCol);o=o||new CellRange(t.topRow,t.rightCol);n=n||new CellRange(t.bottomRow,t.rightCol);let e=new CellRange(Math.min(l.topRow,s.topRow,o.topRow,n.topRow),Math.min(l.leftCol,s.leftCol,o.leftCol,n.leftCol),Math.max(l.bottomRow,s.bottomRow,o.bottomRow,n.bottomRow),Math.max(l.rightCol,s.rightCol,o.rightCol,n.rightCol));this.select(e,!1)}}}_deselectRange(e){let t=this.selection,i=this.extendedSelection;if(t.contains(e)){let e=i.length;this._sel=e?i[e-1]:new CellRange;e&&i.removeAt(e-1);return!0}for(let t=0;t<i.length;t++)if(i[t].contains(e)){i.removeAt(t);return!0}return!1}_showSelection(){let e=this._g,t=this._sel;e.anchorCursor?e.scrollIntoView(t.row2,t.col2):e.scrollIntoView(t.row,t.col)}_adjustReferenceCell(e,t,i){let l=this._g,s=l.getMergedRange(l.cells,e.row,e.col);if(s&&!s.isSingleCell){let l=SelMove;switch(t){case l.Next:case l.NextCell:case l.NextEditableCell:e.row=s.bottomRow;break;case l.Prev:case l.PrevCell:case l.PrevEditableCell:e.row=s.topRow}switch(i){case l.Next:case l.NextCell:case l.NextEditableCell:e.col=s.rightCol;break;case l.Prev:case l.PrevCell:case l.PrevEditableCell:e.col=s.leftCol}}}}export var RowColFlags;!function(e){e[e.Visible=1]="Visible";e[e.AllowResizing=2]="AllowResizing";e[e.AllowDragging=4]="AllowDragging";e[e.AllowMerging=8]="AllowMerging";e[e.AllowSorting=16]="AllowSorting";e[e.AutoGenerated=32]="AutoGenerated";e[e.Collapsed=64]="Collapsed";e[e.ParentCollapsed=128]="ParentCollapsed";e[e.Selected=256]="Selected";e[e.ReadOnly=512]="ReadOnly";e[e.HtmlContent=1024]="HtmlContent";e[e.WordWrap=2048]="WordWrap";e[e.MultiLine=4096]="MultiLine";e[e.HasTemplate=8192]="HasTemplate";e[e.RowDefault=3]="RowDefault";e[e.ColumnDefault=23]="ColumnDefault"}(RowColFlags||(RowColFlags={}));export class RowCol{constructor(){this._pos=0;this._idx=-1;this._idxVis=-1;this._idxData=-1;this.gridChanged=new Event}get binding(){return this._binding?this._binding.path:null}set binding(e){if(e!=this.binding){let t=asString(e);this._binding=t?new Binding(t):null;if(!this._type&&this.grid&&this._binding){let e=this.grid.collectionView;if(e&&e.sourceCollection&&e.sourceCollection.length){let t=e.sourceCollection[0];this._type=getType(this._binding.getValue(t))}}this.onPropertyChanged()}}get sortMemberPath(){return this._bindingSort?this._bindingSort.path:null}set sortMemberPath(e){if(e!=this.sortMemberPath){let t=asString(e);this._bindingSort=t?new Binding(t):null;this.onPropertyChanged()}}get dataType(){return this._type}set dataType(e){e=asEnum(e,DataType,!0);if(this._type!=e){this._type=e;this.grid&&this.grid.invalidate()}}get inputType(){return this._inpType}set inputType(e){this._inpType=asString(e,!0)}get mask(){return this._mask}set mask(e){this._mask=asString(e,!0)}get maxLength(){return this._maxLen}set maxLength(e){this._maxLen=asNumber(e,!0,!0)}get align(){return this._align}set align(e){if(this._align!=e){this._align=e;this.onPropertyChanged()}}get format(){return this._fmt}set format(e){if(this._fmt!=e){this._fmt=e;this.onPropertyChanged()}}get dataMap(){return this._map}set dataMap(e){if(this._map!=e){this._map&&this._map.mapChanged.removeHandler(this.onPropertyChanged,this);isArray(e)&&(e=new DataMap(e,null,null));this._map=asType(e,DataMap,!0);this._map&&this._map.mapChanged.addHandler(this.onPropertyChanged,this);this.onPropertyChanged()}}get dataMapEditor(){return null!=this._mapEditor?this._mapEditor:DataMapEditor.DropDownList}set dataMapEditor(e){if(e!=this._mapEditor){this._mapEditor=asEnum(e,DataMapEditor);this.grid&&this.grid.invalidate()}}get showDropDown(){return this.dataMapEditor==DataMapEditor.DropDownList}set showDropDown(e){_deprecated("showDropDown","dataMapEditor");this.dataMapEditor=e?DataMapEditor.DropDownList:DataMapEditor.AutoComplete}get dropDownCssClass(){return this._ddCssClass}set dropDownCssClass(e){this._ddCssClass=asString(e)}get visible(){return this._getFlag(RowColFlags.Visible)}set visible(e){this._setFlag(RowColFlags.Visible,e)}get isVisible(){return!!this._getFlag(RowColFlags.Visible)&&(!this._getFlag(RowColFlags.ParentCollapsed)||this instanceof _NewRowTemplate)}get pos(){this._list&&this._list._dirty&&this._list._update();return this._pos}get index(){this._list&&this._list._dirty&&this._list._update();return this._idx}get visibleIndex(){this._list&&this._list._dirty&&this._list._update();return this.isVisible?this._idxVis:-1}get size(){return this._sz}set size(e){if(e!=this._sz){this._sz=asNumber(e,!0);this.onPropertyChanged()}}get renderSize(){let e=0,t=this._list;if(this.isVisible){(null==(e=this._sz)||e<0)&&(e=t?t.defaultSize:0);t&&null!=t.minSize&&e<t.minSize&&(e=t.minSize);t&&null!=t.maxSize&&e>t.maxSize&&(e=t.maxSize);null!=this._szMin&&e<this._szMin&&(e=this._szMin);null!=this._szMax&&e>this._szMax&&(e=this._szMax)}return e}get allowResizing(){return this._getFlag(RowColFlags.AllowResizing)}set allowResizing(e){this._setFlag(RowColFlags.AllowResizing,e)}get allowDragging(){return this._getFlag(RowColFlags.AllowDragging)}set allowDragging(e){this._setFlag(RowColFlags.AllowDragging,e)}get allowMerging(){return this._getFlag(RowColFlags.AllowMerging)}set allowMerging(e){this._setFlag(RowColFlags.AllowMerging,e)}get isSelected(){return this._getFlag(RowColFlags.Selected)}set isSelected(e){if(!!e!=this.isSelected){let t=this.grid;if(t){let i=this instanceof Row?new CellRange(this.index,-1):new CellRange(-1,this.index),l=new CellRangeEventArgs(t?t.cells:null,i);if(t.onSelectionChanging(l)&&this._setFlag(RowColFlags.Selected,e,!0)){t.refreshCells(!1,!0,!0);t.onSelectionChanged(l)}}else this._setFlag(RowColFlags.Selected,e)}}get isReadOnly(){return this._getFlag(RowColFlags.ReadOnly)}set isReadOnly(e){this._setFlag(RowColFlags.ReadOnly,e)}get isRequired(){return this._required}set isRequired(e){this._required=asBoolean(e,!0)}get isContentHtml(){return this._getFlag(RowColFlags.HtmlContent)}set isContentHtml(e){if(this.isContentHtml!=e){this._setFlag(RowColFlags.HtmlContent,e);this.grid&&this.grid.invalidate()}}get wordWrap(){return this._getFlag(RowColFlags.WordWrap)}set wordWrap(e){this._setFlag(RowColFlags.WordWrap,e)}get multiLine(){return this._getFlag(RowColFlags.MultiLine)}set multiLine(e){this._setFlag(RowColFlags.MultiLine,e)}get cssClass(){return this._cssClass}set cssClass(e){if(e!=this._cssClass){this._cssClass=asString(e);this.grid&&this.grid.invalidate()}}get cssClassAll(){return this._cssClassAll}set cssClassAll(e){if(e!=this._cssClassAll){this._cssClassAll=asString(e);this.grid&&this.grid.invalidate()}}get grid(){return this._list?this._list._g:null}get collectionView(){return this.grid?this.grid.collectionView:null}onPropertyChanged(){if(this._list){this._list._dirty=!0;this.grid.invalidate()}}onGridChanged(e){this.gridChanged.raise(this,e)}_setList(e){if(e!=this._list){this._list=e;this.onGridChanged()}}_getFlag(e){return 0!=(this._f&e)}_setFlag(e,t,i){if(!!t!=this._getFlag(e)){this._f=t?this._f|e:this._f&~e;i||this.onPropertyChanged();return!0}return!1}}export class Column extends RowCol{constructor(e){super();this._f=RowColFlags.ColumnDefault;this._hash=Column._ctr.toString(36);Column._ctr++;copy(this,e)}get name(){return this._name}set name(e){this._name=e}get width(){return null!=this._szStar?this._szStar:this.size}set width(e){if(null!=Column._parseStarSize(e)){this._szStar=e;this.onPropertyChanged()}else{this._szStar=null;this.size=asNumber(e,!0)}}get minWidth(){return this._szMin}set minWidth(e){if(e!=this._szMin){this._szMin=asNumber(e,!0,!0);this.onPropertyChanged()}}get maxWidth(){return this._szMax}set maxWidth(e){if(e!=this._szMax){this._szMax=asNumber(e,!0,!0);this.onPropertyChanged()}}get quickAutoSize(){return this._quickSize}set quickAutoSize(e){this._quickSize=asBoolean(e,!0)}_getQuickAutoSize(){return!!this.grid._getQuickAutoSize()&&(isBoolean(this._quickSize)?this._quickSize:!(this.isContentHtml||this.wordWrap||this.multiLine||this._getFlag(RowColFlags.HasTemplate)))}get renderWidth(){return this.renderSize}get header(){return this._hdr?this._hdr:this.binding}set header(e){if(this._hdr!=e){this._hdr=e;this.onPropertyChanged()}}get cellTemplate(){return this._tpl}set cellTemplate(e){if(e!=this._tpl){assert(null==e||isString(e)||isFunction(e),"cellTemplate should be a string or an ICellTemplateFunction.");this._tpl=e;this._setFlag(RowColFlags.HasTemplate,null!=e&&""!=e);this.onPropertyChanged()}}get editor(){let e=this._edt;return e?e.control:null}set editor(e){if(e!=this.editor){if(this._edt){this._edt.dispose();this._edt=null}if(null!=e){e=asType(e,Control);this._edt=new _CustomEditor(this,e)}}}get allowSorting(){return this._getFlag(RowColFlags.AllowSorting)}set allowSorting(e){this._setFlag(RowColFlags.AllowSorting,e)}get currentSort(){let e=this.currentSortIndex;if(e>-1){return this.grid.collectionView.sortDescriptions[e].ascending?"+":"-"}return null}get currentSortIndex(){let e=this.grid?this.grid.collectionView:null,t=e?e.sortDescriptions:null,i=t&&t.length?this._getBindingSort():null;if(i)for(let e=0;e<t.length;e++)if(t[e].property==i)return e;return-1}get aggregate(){return null!=this._agg?this._agg:Aggregate.None}set aggregate(e){if((e=asEnum(e,Aggregate))!=this._agg){this._agg=e;this.onPropertyChanged()}}get describedById(){return this._descById}set describedById(e){if(e!=this._descById){this._descById=asString(e);this.grid&&this.grid.invalidate()}}getIsRequired(e){return null!=this._required?this._required:e&&null!=e.isRequired?e.isRequired:this.dataType==DataType.String?null!=this.dataMap||null!=this._mask&&this._mask.length>0:!e||e.dataType!=DataType.String||(null!=e.dataMap||null!=e.mask&&e.mask.length>0)}getAlignment(e){if(null!=this._align)return this._align;if(e&&null!=e.align)return e.align;if(!this._map)switch(this.dataType){case DataType.Boolean:return"center";case DataType.Number:return"right"}if(e&&!e.dataMap)switch(e.dataType){case DataType.Boolean:return"center";case DataType.Number:return"right"}return""}_getBindingSort(){return this.sortMemberPath?this.sortMemberPath:this.binding?this.binding:null}static _parseStarSize(e){if(isString(e)){let t=e.length;if(t>0&&"*"==e[t-1]){let i=1==t?1:parseFloat(e);if(i>0&&!isNaN(i))return i}}return null}}Column._ctr=0;export class Row extends RowCol{constructor(e){super();this._f=RowColFlags.ColumnDefault;this._data=e}get dataItem(){return this._data}set dataItem(e){this._data=e}get dataIndex(){this._list&&this._list._dirty&&this._list._update();return this._idxData}get height(){return this.size}set height(e){this.size=e}get renderHeight(){return this.renderSize}}export class GroupRow extends Row{constructor(e){super(e);this._level=-1;this.level=e instanceof CollectionViewGroup?e.level:-1;this.isReadOnly=!0}get level(){return this._level}set level(e){asInt(e);if(e!=this._level){this._level=e;this.onPropertyChanged()}}get hasChildren(){if(null!=this.grid&&null!=this._list){this._list._update();let e=this.index<this._list.length-1?this._list[this.index+1]:null,t=tryCast(e,GroupRow),i=tryCast(e,_NewRowTemplate);return null!=e&&null==i&&(null==t||t.level>this.level)}return!0}get isCollapsed(){return this._getFlag(RowColFlags.Collapsed)}set isCollapsed(e){!!e!=this.isCollapsed&&null!=this._list&&this._setCollapsed(asBoolean(e))}getGroupHeader(){let e=this.grid,t=e.groupHeaderFormat||culture.FlexGrid.groupHeaderFormat,i=this.dataItem;if(i instanceof CollectionViewGroup&&t&&e.showGroups&&!e.childItemsPath){let l=i.groupDescription.propertyName,s=i.name,o=e.getColumn(l),n=this.isContentHtml;if(o){n=n||o.isContentHtml;o.header&&(l=o.header);let e=o.dataMap;e&&(s=e.getDisplayValue(s));o.dataType==getType(s)&&(s=Globalize.format(s,o.format))}else l=toHeaderCase(l);let r=i.getAggregate(Aggregate.CntAll,null,e.collectionView);return format(t,{name:escapeHtml(l),value:n?s:escapeHtml(s),level:i.level,count:r})}return""}_setCollapsed(e){let t=this.grid,i=t.rows,l=this.getCellRange(),s=new CellRangeEventArgs(t.cells,new CellRange(this.index,-1));if(t.onGroupCollapsedChanging(s)){t.deferUpdate(()=>{i.deferUpdate(()=>{this._setFlag(RowColFlags.Collapsed,e,!0);for(let t=l.topRow+1;t<=l.bottomRow&&t>-1&&t<i.length;t++){i[t]._setFlag(RowColFlags.ParentCollapsed,e,!0);let l=i[t];l instanceof GroupRow&&l.isCollapsed&&(t=l.getCellRange().bottomRow)}})});t.onGroupCollapsedChanged(s)}}getCellRange(){let e=this._list,t=this.index,i=e.length-1;for(let l=t+1;l<=i;l++){let t=e[l];if(t instanceof GroupRow&&t.level<=this.level){i=l-1;break}}return new CellRange(t,0,i,this.grid.columns.length-1)}}export class RowColCollection extends ObservableArray{constructor(e,t){super();this._frozen=0;this._lastFrozen=-1;this._firstVisible=-1;this._vlen=0;this._szDef=28;this._szTot=0;this._szCustom=!1;this._dirty=!1;this._g=asType(e,FlexGrid);this._szDef=asNumber(t,!1,!0)}get grid(){return this._g}get defaultSize(){return this._szDef}set defaultSize(e){this._szCustom=!0;if(this._szDef!=e){this._szDef=asNumber(e,!1,!0);this._dirty=!0;this._g.invalidate()}}get frozen(){return this._frozen}set frozen(e){if(e!=this._frozen){this._frozen=asNumber(e,!1,!0);this._dirty=!0;this._g.invalidate()}}isFrozen(e){return e<this.frozen}get minSize(){return this._szMin}set minSize(e){if(e!=this._szMin){this._szMin=asNumber(e,!0,!0);this._dirty=!0;this._g.invalidate()}}get maxSize(){return this._szMax}set maxSize(e){if(e!=this._szMax){this._szMax=asNumber(e,!0,!0);this._dirty=!0;this._g.invalidate()}}getTotalSize(){this._dirty&&this._update();return this._szTot}get visibleLength(){this._dirty&&this._update();return this._vlen}getItemAt(e){this._dirty&&this._update();if(e<=0&&this.length>0&&this[0].renderSize)return 0;let t,i,l=this.length,s=0,o=l-1;for(;s<=o;)if((i=this[t=s+o>>>1])._pos>e&&t>0)o=t-1;else{if(!(i._pos+i.renderSize<=e&&t<l-1)){for(;t>0&&!this[t].renderSize;)t--;for(;t<l-1&&!this[t].renderSize;)t++;return t}s=t+1}return o}getNextCell(e,t,i=0){let l,s=SelMove;switch(t){case s.Next:case s.NextCell:for(l=e+1;l<this.length;l++)if(this[l].renderSize>0)return l;break;case s.NextEditableCell:for(l=e+1;l<this.length;l++)if(this[l].renderSize>0&&!this[l].isReadOnly)return l;break;case s.Prev:case s.PrevCell:for(l=e-1;l>=0;l--)if(this[l].renderSize>0)return l;break;case s.PrevEditableCell:for(l=e-1;l>=0;l--)if(this[l].renderSize>0&&!this[l].isReadOnly)return l;break;case s.End:for(l=this.length-1;l>=0;l--)if(this[l].renderSize>0)return l;break;case s.Home:for(l=0;l<this.length;l++)if(this[l].renderSize>0)return l;break;case s.NextPage:return(l=this.getItemAt(this[e].pos+this[e].renderSize+i))<0?this.getNextCell(e,SelMove.End,i):l==e&&l<this.length-1&&this[l+1].renderSize?l+1:l;case s.PrevPage:return(l=this.getItemAt(this[e].pos-i))<0?this.getNextCell(e,SelMove.Home,i):l==e&&l>0&&this[l-1].renderSize?l-1:l}return e}canMoveElement(e,t,i=!0){if(t==e)return!1;if(e<0||e>=this.length||t>=this.length)return!1;if(i){t<0&&(t=this.length-1);let i=Math.min(e,t),l=Math.max(e,t);for(let e=i;e<=l;e++)if(!this[e].allowDragging)return!1}return!(this[t]instanceof _NewRowTemplate)}moveElement(e,t,i=!0){if(this.canMoveElement(e,t,i)){let l=this[e];this.removeAt(e);t<0&&(t=this.length);this.insert(t,l);if(i){let i=this.frozen;e<i&&t>=i?this.frozen--:e>=i&&t<i&&this.frozen++}return!0}return!1}onCollectionChanged(e=NotifyCollectionChangedEventArgs.reset){this._dirty=!0;this._g.invalidate();super.onCollectionChanged(e)}push(e){e._setList(this);return super.push(e)}splice(e,t,...i){for(let i=e;i<e+t&&i<this.length;i++){let e=this[i];e instanceof RowCol&&e._setList(null)}i.forEach(e=>e._setList(this));return super.splice(e,t,...i)}beginUpdate(){this._update();super.beginUpdate()}_setDefaultSize(e){if(!this._szCustom){this.defaultSize=e;this._szCustom=!1}}_update(){if(this._dirty&&!this.isUpdating){this._dirty=!1;this._lastFrozen=-1;this._firstVisible=-1;let e,t,i=0,l=0;for(let s=0;s<this.length;s++){(t=this[s])._idx=s;t._idxVis=i;t._pos=l;t._setList(this);if((e=t.renderSize)>0){l+=e;i++;s<this._frozen&&(this._lastFrozen=s)}this._firstVisible<0&&t.visible&&(this._firstVisible=s)}this._vlen=i;this._szTot=l;return!0}return!1}}export class ColumnCollection extends RowColCollection{getColumn(e){let t=isNumber(e)?e:this.indexOf(e);return t>-1?this[t]:null}indexOf(e){if(e instanceof Column)return super.indexOf(e);for(let t=0;t<this.length;t++)if(this[t].name==e)return t;for(let t=0;t<this.length;t++)if(this[t].binding==e)return t;return-1}get describedById(){return this._descById}set describedById(e){if(e!=this._descById){this._descById=asString(e);this._g&&this._g.invalidate()}}get firstVisibleIndex(){this._dirty&&this._update();return this._firstVisible}_updateStarSizes(e){let t,i=!1,l=0;for(let i=0;i<this.length;i++){let s=this[i];if(s.isVisible)if(s._szStar){l+=Column._parseStarSize(s._szStar);t=s}else e-=s.renderWidth}if(t){let s=e;for(let o=0;o<this.length;o++){let n=this[o];if(n.isVisible&&n._szStar){let o=n._sz;n==t&&s>0?o=s:s-=o=Math.max(0,Math.round(Column._parseStarSize(n._szStar)/l*e));if(o!=n._sz){n._sz=o;i=!0}}}if(i){this._dirty=!0;this._update()}return i}return!1}}export class RowCollection extends RowColCollection{constructor(){super(...arguments);this._maxLevel=-1}get ariaLabel(){return this._ariaLabel}set ariaLabel(e){if(e!=this.ariaLabel){this._ariaLabel=asString(e);this._g&&this._g.refresh()}}get maxGroupLevel(){this._dirty&&this._update();return this._maxLevel}_update(){if(super._update()){let e=this.grid?this.grid.collectionView:null,t=e?e.items:null,i=0;this._maxLevel=-1;this.forEach(e=>{e instanceof GroupRow&&e.level>this._maxLevel&&(this._maxLevel=e.level);e._idxData=-1;let l=e.dataItem;l&&t&&(e._idxData=l===t[i]?i:l===t[i+1]?++i:-1)});return!0}return!1}}_addCultureInfo("FlexGrid",{groupHeaderFormat:"{name}: <b>{value}</b> ({count:n0} items)",ariaLabels:{toggleDropDown:"Toggle Dropdown",toggleGroup:"Toggle Group"}});export var AllowSorting;!function(e){e[e.None=0]="None";e[e.SingleColumn=1]="SingleColumn";e[e.MultiColumn=2]="MultiColumn"}(AllowSorting||(AllowSorting={}));export var AllowPinning;!function(e){e[e.None=0]="None";e[e.SingleColumn=1]="SingleColumn";e[e.ColumnRange=2]="ColumnRange";e[e.Both=3]="Both"}(AllowPinning||(AllowPinning={}));export var HeadersVisibility;!function(e){e[e.None=0]="None";e[e.Column=1]="Column";e[e.Row=2]="Row";e[e.All=3]="All"}(HeadersVisibility||(HeadersVisibility={}));export var ClipStringOptions;!function(e){e[e.Default=0]="Default";e[e.CSV=1]="CSV";e[e.QuoteAll=2]="QuoteAll";e[e.SkipMerged=4]="SkipMerged";e[e.Unformatted=8]="Unformatted";e[e.InvisibleRows=16]="InvisibleRows";e[e.InvisibleColumns=32]="InvisibleColumns";e[e.InvisibleCells=48]="InvisibleCells"}(ClipStringOptions||(ClipStringOptions={}));export class FlexGrid extends Control{constructor(e,t){super(e,null,!0);this._szClient=new Size(0,0);this._szClientSB=new Size(0,0);this._offsetY=0;this._cssPage=0;this._ptScrl=new Point(0,0);this._cellPadLeft=3;this._cellPadHorz=3;this._cellPadVert=0;this._clipToScreen=!1;this._autoGenCols=!0;this._autoClipboard=!0;this._xOnCopyPaste=!0;this._autoScroll=!0;this._autoSearch=!1;this._caseSensitive=!1;this._readOnly=!1;this._indent=14;this._autoSizeMode=AutoSizeMode.Both;this._autoHeights=!1;this._hdrVis=HeadersVisibility.All;this._alSorting=AllowSorting.SingleColumn;this._alPinning=AllowPinning.None;this._alAddNew=!1;this._alDelete=!1;this._alResizing=AllowResizing.Columns;this._alDragging=AllowDragging.Columns;this._alMerging=AllowMerging.None;this._ssHdr=HeadersVisibility.None;this._shSort=!0;this._shGroups=!0;this._shMarquee=!1;this._shPlcHld=!1;this._altStep=1;this._shErr=!0;this._shDropDown=!0;this._valEdt=!0;this._deferResizing=!1;this._pSel=!0;this._pOutline=!0;this._stickyHdr=!1;this._anchorCursor=!1;this._copyHeaders=HeadersVisibility.None;this._bigChecks=!1;this._vt=0;this._vtRows=0;this._vtCols=0;this._lazyRender=!0;this._refreshOnEdit=!0;this._reorderCells=!0;this.itemsSourceChanging=new Event;this.itemsSourceChanged=new Event;this.scrollPositionChanged=new Event;this.selectionChanging=new Event;this.selectionChanged=new Event;this.loadingRows=new Event;this.loadedRows=new Event;this.updatingLayout=new Event;this.updatedLayout=new Event;this.resizingColumn=new Event;this.resizedColumn=new Event;this.autoSizingColumn=new Event;this.autoSizedColumn=new Event;this.starSizedColumns=new Event;this.draggingColumn=new Event;this.draggingColumnOver=new Event;this.draggedColumn=new Event;this.pinningColumn=new Event;this.pinnedColumn=new Event;this.resizingRow=new Event;this.resizedRow=new Event;this.autoSizingRow=new Event;this.autoSizedRow=new Event;this.draggingRow=new Event;this.draggingRowOver=new Event;this.draggedRow=new Event;this.groupCollapsedChanging=new Event;this.groupCollapsedChanged=new Event;this.columnGroupCollapsedChanging=new Event;this.columnGroupCollapsedChanged=new Event;this.sortingColumn=new Event;this.sortedColumn=new Event;this.beginningEdit=new Event;this.prepareCellForEdit=new Event;this.cellEditEnding=new Event;this.cellEditEnded=new Event;this.rowEditStarting=new Event;this.rowEditStarted=new Event;this.rowEditEnding=new Event;this.rowEditEnded=new Event;this.rowAdded=new Event;this.deletingRow=new Event;this.deletedRow=new Event;this.copying=new Event;this.copied=new Event;this.pasting=new Event;this.pasted=new Event;this.pastingCell=new Event;this.pastedCell=new Event;this.formatItem=new Event(()=>{this._clearCells()});this.updatingView=new Event;this.updatedView=new Event;this._mappedColumns=null;let i=this.hostElement;isIE()&&(i.style.borderRadius="0");let l=this.getTemplate();this.applyTemplate("wj-control wj-content wj-flexgrid",l,{_root:"root",_eSz:"sz",_eCt:"cells",_fCt:"fcells",_eTL:"tl",_eBL:"bl",_eCHdr:"ch",_eRHdr:"rh",_eCFtr:"cf",_eTLCt:"tlcells",_eBLCt:"blcells",_eCHdrCt:"chcells",_eCFtrCt:"cfcells",_eRHdrCt:"rhcells",_eMarquee:"marquee",_eFocus:"focus"});setCss(this._root.parentElement,{position:"relative",left:"0",top:"0",width:"100%",height:"100%",overflow:"hidden",maxWidth:"inherit",maxHeight:"inherit"});setCss(this._root,{position:"absolute",left:"0",top:"0",width:"100%",height:"100%",maxWidth:"inherit",maxHeight:"inherit",overflow:"auto",webkitOverflowScrolling:"touch"});setCss(this._eCt,{position:"absolute"});setCss(this._eMarquee,{display:"none"});setCss(this._eMarquee.firstChild,{width:"100%",height:"100%"});setCss(this._fCt,{position:"absolute",left:"0",top:"0",overflow:"hidden",pointerEvents:"none"});setCss(this._eFocus,{position:"fixed",left:"-32000px"});setCss(this._eSz,{position:"relative",visibility:"hidden"});[this._eRHdr,this._eCFtr,this._eCHdr,this._eBL,this._eTL].forEach(e=>{setAttribute(e,"aria-hidden",!0);setCss(e,{position:"absolute",overflow:"hidden",outline:"none"});setCss(e.firstElementChild,{position:"relative"})});[this._eFocus,this._eMarquee,this._fCt,this._eSz].forEach(e=>{setAttribute(e,"aria-hidden",!0)});i.tabIndex=-1;this.deferUpdate(()=>{let e=this._getDefaultRowHeight();this._rows=new RowCollection(this,e);this._cols=new ColumnCollection(this,4*e);this._hdrRows=new RowCollection(this,e);this._hdrCols=new ColumnCollection(this,Math.round(1.25*e));this._ftrRows=new RowCollection(this,e);let i=CellType;this._gpTL=new GridPanel(this,i.TopLeft,this._hdrRows,this._hdrCols,this._eTLCt);this._gpCHdr=new GridPanel(this,i.ColumnHeader,this._hdrRows,this._cols,this._eCHdrCt);this._gpRHdr=new GridPanel(this,i.RowHeader,this._rows,this._hdrCols,this._eRHdrCt);this._gpCells=new GridPanel(this,i.Cell,this._rows,this._cols,this._eCt);this._gpBL=new GridPanel(this,i.BottomLeft,this._ftrRows,this._hdrCols,this._eBLCt);this._gpCFtr=new GridPanel(this,i.ColumnFooter,this._ftrRows,this._cols,this._eCFtrCt);this._hdrRows.push(new Row);this._hdrCols.push(new Column({align:"center"}));this._cf=new CellFactory;this._keyHdl=new _KeyboardHandler(this);this._mouseHdl=new _MouseHandler(this);this._edtHdl=new _EditHandler(this);this._selHdl=new _SelectionHandler(this);this._addHdl=new _AddNewHandler(this);this._grpHdl=new _ColumnGroupHandler(this);this._mrgMgr=new MergeManager(this);this._bndSortConverter=this._sortConverter.bind(this);this._errorTip=new Tooltip({isContentHtml:!1,showDelay:0,cssClass:"wj-error-tip"});setAttribute(this.cells.hostElement,"role","grid");this.selectionMode=SelectionMode.CellRange;this._root.tabIndex=-1;this.initialize(t)});this.addEventListener(this._root,"scroll",e=>{if(this._updateScrollPosition()||this._forceScrollUpdate){let e=this.activeEditor,t=e?closest(e,".wj-cell").className:null;this._forceScrollUpdate||this.finishEditing(!1)||this.finishEditing(!0);this._forceScrollUpdate=!1;this._updateContent(!0);let i=this.activeEditor;if(e&&i){i.value=e.value;closest(i,".wj-cell").className=t;this._setFocusNoScroll(i)}this.frozenColumns&&setTimeout(()=>{let e=this.columnHeaders.hostElement.style,t=parseInt(e.left),i=this._ptScrl.x;Math.abs(t-i)>1&&this.invalidate()})}});this.addEventListener(i,"focus",e=>{if(i.tabIndex>-1){let t=e.target;t instanceof HTMLElement&&t.tabIndex<0&&this._setFocus(!0)}},!0)}_handleResize(){this._rcBounds=null;super._handleResize()}get headersVisibility(){return this._hdrVis}set headersVisibility(e){if((e=asEnum(e,HeadersVisibility))!=this._hdrVis){this._hdrVis=e;this.invalidate()}}get stickyHeaders(){return this._stickyHdr}set stickyHeaders(e){if(e!=this._stickyHdr){this._stickyHdr=asBoolean(e);this._updateStickyHeaders();this.invalidate()}}get preserveSelectedState(){return this._pSel}set preserveSelectedState(e){this._pSel=asBoolean(e)}get preserveOutlineState(){return this._pOutline}set preserveOutlineState(e){this._pOutline=asBoolean(e)}get anchorCursor(){return this._anchorCursor}set anchorCursor(e){this._anchorCursor=asBoolean(e)}get copyHeaders(){return this._copyHeaders}set copyHeaders(e){this._copyHeaders=asEnum(e,HeadersVisibility)}get lazyRender(){return this._lazyRender}set lazyRender(e){this._lazyRender=asBoolean(e)}get refreshOnEdit(){return this._refreshOnEdit}set refreshOnEdit(e){this._refreshOnEdit=asBoolean(e)}get virtualizationThreshold(){return this._vt}set virtualizationThreshold(e){this._vt=e;if(isNumber(e))this._vtRows=this._vtCols=asNumber(e);else if(e)if(isArray(e)&&2==e.length){this._vtRows=asNumber(e[0]);this._vtCols=asNumber(e[1])}else assert(!1,"virtualizationThreshold should be a number or an array with two numbers.");else this._vtRows=this._vtCols=0}get autoGenerateColumns(){return this._autoGenCols}set autoGenerateColumns(e){this._autoGenCols=asBoolean(e)}get autoClipboard(){return this._autoClipboard}set autoClipboard(e){this._autoClipboard=asBoolean(e)}get expandSelectionOnCopyPaste(){return this._xOnCopyPaste}set expandSelectionOnCopyPaste(e){this._xOnCopyPaste=asBoolean(e)}get autoScroll(){return this._autoScroll}set autoScroll(e){this._autoScroll=asBoolean(e)}get autoSearch(){return this._autoSearch}set autoSearch(e){this._autoSearch=asBoolean(e)}get caseSensitiveSearch(){return this._caseSensitive}set caseSensitiveSearch(e){this._caseSensitive=asBoolean(e)}get columnLayout(){let e=FlexGrid._getSerializableProperties(Column),t=new Column,i=[];this.columns.forEach(l=>{let s={};e.forEach(e=>{let i=l[e];i!=t[e]&&isPrimitive(i)&&"size"!=e&&(s[e]=i)});i.push(s)});return JSON.stringify({columns:i})}set columnLayout(e){let t=JSON.parse(asString(e));assert(t,"Invalid columnLayout data.");this.columns.deferUpdate(()=>{this.columns.clear();this.initialize(t)})}get columnGroups(){return this._grpHdl.getGroupDefinitions()}set columnGroups(e){this.columns.clear();this._grpHdl.createColumnGroups(asArray(e))}get isReadOnly(){return this._readOnly}set isReadOnly(e){if(e!=this._readOnly){this._readOnly=asBoolean(e);this.finishEditing();this.invalidate(!0);this._addHdl.updateNewRowTemplate();toggleClass(this.hostElement,"wj-state-readonly",this.isReadOnly);this._setAria("readonly",this.isReadOnly?"true":null)}}get bigCheckboxes(){return this._bigChecks}set bigCheckboxes(e){this._bigChecks=asBoolean(e)}get isDisabled(){return this._e&&null!=this._e.getAttribute("disabled")}set isDisabled(e){if((e=asBoolean(e,!0))!=this.isDisabled){let t=this._e;if(t){enable(t,!e);this.invalidate()}}}get imeEnabled(){return null!=this._imeHdl}set imeEnabled(e){if(asBoolean(e)!=this.imeEnabled&&this.finishEditing()){let t=this.containsFocus();if(this._imeHdl){this._imeHdl.dispose();this._imeHdl=null}e&&(this._imeHdl=new _ImeHandler(this));t&&this.focus()}}get allowResizing(){return this._alResizing}set allowResizing(e){this._alResizing=asEnum(e,AllowResizing)}get deferResizing(){return this._deferResizing}set deferResizing(e){this._deferResizing=asBoolean(e)}get autoSizeMode(){return this._autoSizeMode}set autoSizeMode(e){this._autoSizeMode=asEnum(e,AutoSizeMode)}get autoRowHeights(){return this._autoHeights}set autoRowHeights(e){this._autoHeights=asBoolean(e)}get quickAutoSize(){return this._quickSize}set quickAutoSize(e){this._quickSize=asBoolean(e,!0)}_getQuickAutoSize(){return isBoolean(this._quickSize)?this._quickSize:!this.formatItem.hasHandlers&&null==this.itemFormatter}get allowSorting(){return this._alSorting}set allowSorting(e){isBoolean(e)&&(e=e?AllowSorting.SingleColumn:AllowSorting.None);this._alSorting=asEnum(e,AllowSorting)}get allowPinning(){return this._alPinning}set allowPinning(e){if(e!=this._alPinning){isBoolean(e)&&(e=e?AllowPinning.SingleColumn:AllowPinning.None);this._alPinning=asEnum(e,AllowPinning);this.invalidate()}}get allowAddNew(){return this._alAddNew}set allowAddNew(e){if(e!=this._alAddNew){this._alAddNew=asBoolean(e);this._addHdl.updateNewRowTemplate()}}get newRowAtTop(){return this._addHdl.newRowAtTop}set newRowAtTop(e){this._addHdl.newRowAtTop=asBoolean(e)}get allowDelete(){return this._alDelete}set allowDelete(e){e!=this._alDelete&&(this._alDelete=asBoolean(e))}get allowMerging(){return this._alMerging}set allowMerging(e){if((e=asEnum(e,AllowMerging))!=this._alMerging){this._alMerging=e;this.invalidate()}}get showSelectedHeaders(){return this._ssHdr}set showSelectedHeaders(e){if((e=asEnum(e,HeadersVisibility))!=this._ssHdr){this._ssHdr=e;this.invalidate()}}get showMarquee(){return this._shMarquee}set showMarquee(e){if(e!=this._shMarquee){this._shMarquee=asBoolean(e);this.invalidate()}}get showPlaceholders(){return this._shPlcHld}set showPlaceholders(e){this._shPlcHld=asBoolean(e)}get showSort(){return this._shSort}set showSort(e){if(e!=this._shSort){this._shSort=asBoolean(e);this.invalidate()}}get showGroups(){return this._shGroups}set showGroups(e){if(e!=this._shGroups){this._shGroups=asBoolean(e);this._bindGrid(!1)}}get alternatingRowStep(){return this._altStep}set alternatingRowStep(e){if(e!=this._altStep){this._altStep=asInt(e,!1,!0);this.invalidate()}}get showAlternatingRows(){return this._altStep>0}set showAlternatingRows(e){_deprecated("showAlternatingRows","alternatingRowStep");this.alternatingRowStep=e?1:0}get showErrors(){return this._shErr}set showErrors(e){if(e!=this._shErr){this._clearCells();this._shErr=asBoolean(e)}}get errorTip(){return this._errorTip}set errorTip(e){if(e!=this._errorTip){this._clearCells();this._errorTip=asType(e,Tooltip,!0)}}get itemValidator(){return this._itemValidator}set itemValidator(e){if(e!=this.itemValidator){this._itemValidator=asFunction(e);this.invalidate()}}get validateEdits(){return this._valEdt}set validateEdits(e){this._valEdt=asBoolean(e)}get groupHeaderFormat(){return this._gHdrFmt}set groupHeaderFormat(e){if(e!=this._gHdrFmt){this._gHdrFmt=asString(e);this._bindGrid(!1)}}get allowDragging(){return this._alDragging}set allowDragging(e){if((e=asEnum(e,AllowDragging))!=this._alDragging){this._alDragging=e;this.invalidate()}}get itemsSource(){return this._items}set itemsSource(e){if(e!=this._items){let t=new CancelEventArgs;if(this.onItemsSourceChanging(t)){if(this._cv){let e=tryCast(this._cv,CollectionView);e&&e.sortConverter==this._bndSortConverter&&(e.sortConverter=null);this._cv.currentChanged.removeHandler(this._cvCurrentChanged,this);this._cv.collectionChanged.removeHandler(this._cvCollectionChanged,this);this._cv=null}this._items=e;this._cv=this._getCollectionView(e);this._lastCount=0;if(this._cv){this._cv.currentChanged.addHandler(this._cvCurrentChanged,this);this._cv.collectionChanged.addHandler(this._cvCollectionChanged,this);let e=tryCast(this._cv,CollectionView);e&&!e.sortConverter&&(e.sortConverter=this._bndSortConverter)}this._bindGrid(!0);this._selHdl._setSelectionMode(this.selectionMode);this.onItemsSourceChanged(t)}}}get collectionView(){return this._cv}get editableCollectionView(){return tryCast(this._cv,"IEditableCollectionView")}get childItemsPath(){return this._childItemsPath}set childItemsPath(e){if(e!=this._childItemsPath){assert(null==e||isArray(e)||isString(e),"childItemsPath should be an array or a string.");this._childItemsPath=e;this._bindGrid(!0)}}get rowHeaderPath(){return this._rowHdrPath?this._rowHdrPath.path:null}set rowHeaderPath(e){if(e!=this.rowHeaderPath){e=asString(e);this._rowHdrPath=e?new Binding(e):null;this.invalidate()}}get cells(){return this._gpCells}get columnHeaders(){return this._gpCHdr}get columnFooters(){return this._gpCFtr}get rowHeaders(){return this._gpRHdr}get topLeftCells(){return this._gpTL}get bottomLeftCells(){return this._gpBL}get rows(){return this._rows}get columns(){return this._cols}getColumn(e){return this.columns.getColumn(e)}get frozenRows(){return this.rows.frozen}set frozenRows(e){this.rows.frozen=e}get frozenColumns(){return this.columns.frozen}set frozenColumns(e){this.columns.frozen=e}get cloneFrozenCells(){return this._fzClone}set cloneFrozenCells(e){if(e!=this._fzClone){setText(this._fCt,null);this._fzClone=asBoolean(e,!0);this.invalidate()}}get sortRowIndex(){return this._sortRowIndex}set sortRowIndex(e){if(e!=this._sortRowIndex){this._sortRowIndex=asNumber(e,!0);this.invalidate()}}get editColumnIndex(){return this._editColIndex}set editColumnIndex(e){if(e!=this._editColIndex){this._editColIndex=asNumber(e,!0);this.invalidate()}}get scrollPosition(){return this._ptScrl.clone()}set scrollPosition(e){let t=this._root,i=-e.x;if(this.rightToLeft)switch(FlexGrid._getRtlMode()){case"rev":i=t.scrollWidth-t.clientWidth+e.x;break;case"neg":i=e.x;break;default:i=-e.x}t.scrollLeft=i;t.scrollTop=-e.y;this._updateScrollPosition()&&(this._forceScrollUpdate=!0)}get clientSize(){return this._szClient}get controlRect(){this._rcBounds||(this._rcBounds=getElementRect(this._root));return this._rcBounds}get scrollSize(){return new Size(this._gpCells.width,this._heightBrowser)}get viewRange(){return this._gpCells.viewRange}get cellFactory(){return this._cf}set cellFactory(e){if(e!=this._cf){this._clearCells();this._cf=asType(e,CellFactory,!1)}}get itemFormatter(){return this._itemFormatter}set itemFormatter(e){if(e!=this._itemFormatter){this._clearCells();this._itemFormatter=asFunction(e)}}canEditCell(e,t){return this._edtHdl._allowEdit(e,t)}getCellData(e,t,i){return this.cells.getCellData(e,t,i)}getCellBoundingRect(e,t,i){return this.cells.getCellBoundingRect(e,t,i)}setCellData(e,t,i,l=!0,s=!0){return this.cells.setCellData(e,t,i,l,s)}hitTest(e,t){isNumber(e)&&isNumber(t)&&(e=new Point(e,t));isBoolean(t)&&t&&(this._rcBounds=null);return new HitTestInfo(this,e)}getClipString(e,t,i,l){let s;s=null==t||isBoolean(t)?t?ClipStringOptions.CSV:ClipStringOptions.Default:t;assert(isNumber(s),"Unexpected value for ClipStringOptions parameter.");return this._edtHdl.getClipString(e,s,i,l)}setClipString(e,t){this._edtHdl.setClipString(e,t)}focus(e){this._setFocus(e)}dispose(){this.finishEditing(!0);this.itemsSource=null;super.dispose()}refresh(e=!0){super.refresh(e);this.finishEditing();if(e){this._updateColumnTypes();this.scrollPosition=this._ptScrl;let e=this._getDefaultRowHeight();this._rows._setDefaultSize(e);this._cols._setDefaultSize(4*e);this._hdrRows._setDefaultSize(e);this._hdrCols._setDefaultSize(Math.round(1.25*e));this._ftrRows._setDefaultSize(e);clearTimeout(this._toInv);this._toInv=null}this.refreshCells(e);let t=this._e;t&&(this._szCtl=new Size(t.offsetWidth,t.offsetHeight))}refreshCells(e,t,i){this.isUpdating||(e?this._updateLayout():this._updateContent(t,i))}refreshRange(e){for(let t=e.topRow;t<=e.bottomRow;t++)for(let i=e.leftCol;i<=e.rightCol;i++){let e=this.cells.getCellElement(t,i);if(e){let l=e[GridPanel._INDEX_KEY];this.cellFactory.updateCell(this.cells,t,i,e,l.rng)}}}autoSizeColumn(e,t=!1,i=4){this.autoSizeColumns(e,e,t,i)}autoSizeColumns(e,t,i=!1,l=4){let s=0,o=i?this.topLeftCells:this.columnHeaders,n=i?this.bottomLeftCells:this.columnFooters,r=i?this.rowHeaders:this.cells,a=this.viewRange;e=null==e?0:asInt(e);t=null==t?r.columns.length-1:asInt(t);a.row=Math.max(0,a.row-1e3);a.row2=Math.min(a.row2+1e3,this.rows.length-1);this.finishEditing()&&this.columns.deferUpdate(()=>{setCss(this._eCt,{width:this._gpCells.width});let i=createElement("<div "+FlexGrid._WJS_MEASURE+'="true"/>',r.hostElement,{visibility:"hidden"}),h=this._getCanvasContext();for(let d=e;d<=t&&d>-1&&d<r.columns.length;d++){let e=r.columns[d];if(e.isVisible){s=0;if(this.autoSizeMode&AutoSizeMode.Headers){for(let e=0;e<o.rows.length;e++)o.rows[e].isVisible&&(s=Math.max(this._getDesiredWidth(o,e,d,i),s));for(let e=0;e<n.rows.length;e++)n.rows[e].isVisible&&(s=Math.max(this._getDesiredWidth(n,e,d,i),s))}if(this.autoSizeMode&AutoSizeMode.Cells&&a.isValid)if(e._getQuickAutoSize()){let e=this._getWidestRow(r,a,d,h);s=Math.max(this._getDesiredWidth(r,e,d,i),s)}else for(let e=a.row;e<=a.row2&&e<r.rows.length;e++)r.rows[e].isVisible&&(s=Math.max(this._getDesiredWidth(r,e,d,i),s));s>0&&(e.width=s+l+2)}}this.cellFactory.disposeCell(i);removeChild(i)})}autoSizeRow(e,t=!1,i=0){this.autoSizeRows(e,e,t,i)}autoSizeRows(e,t,i=!1,l=0){let s=0,o=i?this.topLeftCells:this.rowHeaders,n=i?this.columnHeaders:this.cells;i=asBoolean(i);l=asNumber(l);e=null==e?0:asInt(e);t=null==t?n.rows.length-1:asInt(t);if(this.finishEditing()){setCss(this._eCt,{width:this._gpCells.width});let i=createElement("<div "+FlexGrid._WJS_MEASURE+'="true"/>',n.hostElement,{visibility:"hidden"});this.rows.deferUpdate(()=>{let r={};for(let a=e;a<=t&&a>-1&&a<n.rows.length;a++){if(n.rows[a].isVisible){s=0;this.autoSizeMode&AutoSizeMode.Headers&&(s=this._getDesiredRowHeight(o,a,i,r));this.autoSizeMode&AutoSizeMode.Cells&&(s=Math.max(this._getDesiredRowHeight(n,a,i,r),s));s>0&&(n.rows[a].height=s+l)}}});this.cellFactory.disposeCell(i);removeChild(i)}}get treeIndent(){return this._indent}set treeIndent(e){if(e!=this._indent){this._indent=asNumber(e,!1,!0);this.columns.onCollectionChanged()}}collapseGroupsToLevel(e){this.finishEditing()&&this.deferUpdate(()=>{let t=this.rows;t.deferUpdate(()=>{for(let i=0;i<t.length;i++){let l=t[i];l instanceof GroupRow&&(l.isCollapsed=l.level>=e)}})})}get selectionMode(){return this._selHdl.selectionMode}set selectionMode(e){(e=asEnum(e,SelectionMode))!=this.selectionMode&&(this._selHdl.selectionMode=e)}get selection(){return this._selHdl.selection.clone()}set selection(e){this._selHdl.selection=e}select(e,t=!0){return this._selHdl.select(e,t)}selectAll(){let e=this.rows.length,t=this.columns.length;return!(!e||!t)&&this.select(new CellRange(0,0,e-1,t-1),!1)}getSelectedState(e,t){return this.cells.getSelectedState(e,t,null)}get selectedRows(){let e=this.selectionMode,t=this.rows.filter(e=>e.isSelected);if(0==t.length&&e!=SelectionMode.None){let e=[];this.selectedRanges.forEach(t=>{for(let i=t.topRow;i<=t.bottomRow&&i>-1&&i<this.rows.length;i++)e.indexOf(i)<0&&e.push(i)});e.sort();t=e.map(e=>this.rows[e])}return t}set selectedRows(e){assert(this.selectionMode==SelectionMode.ListBox,"This property can be set only in ListBox mode.");e=asArray(e);this.deferUpdate(()=>{for(let t=0,i=!0;t<this.rows.length;t++){let l=this.rows[t],s=e&&e.indexOf(l)>-1;if(s&&i){i=!1;this.select(t,this.selection.col)}l.isSelected=s}})}get selectedItems(){let e=[];this.selectedRows.forEach(t=>{t&&t.dataItem&&e.push(t.dataItem)});return e}set selectedItems(e){assert(this.selectionMode==SelectionMode.ListBox,"This property can be set only in ListBox mode.");e=asArray(e);this.deferUpdate(()=>{for(let t=0,i=!0;t<this.rows.length;t++){let l=this.rows[t],s=e&&e.indexOf(l.dataItem)>-1;if(s&&i){i=!1;this.select(t,this.selection.col)}l.isSelected=s}})}get selectedRanges(){let e=[this.selection];this._selHdl.extendedSelection.forEach(t=>{e.push(t)});return e}set selectedRanges(e){if((e=asArray(e))&&e.length>0){this.select(e[0]);if(this.selectionMode==SelectionMode.MultiRange){let t=this._selHdl.extendedSelection;t.deferUpdate(()=>{t.clear();for(let i=1;i<e.length;i++)t.push(e[i])})}}}scrollIntoView(e,t,i){(null==this._maxOffsetY||this._rows._dirty||this._cols._dirty)&&this._updateLayout();let l=this.scrollPosition,s=this._szClient,o=s.width,n=s.height-this._gpCFtr.rows.getTotalSize(),r=this.cells._getFrozenPos();if((e=asInt(e))>-1&&e<this._rows.length&&e>=this._rows.frozen){let t=this._rows[e],i=this._getCssPage(t.pos);if(i!=this._cssPage){let e=this._maxOffsetY,l=Math.round(e*i);for(;l>t.pos;i-=.1)l=Math.round(e*i);this._offsetY=l}let s=t.pos-this._offsetY,o=s+t.renderSize;o>n-l.y&&(l.y=Math.max(-s,n-o));s-r.y<-l.y&&(l.y=-(s-r.y));i!=this._cssPage&&(this._cssPage=this._getCssPage(-l.y))}if((t=asInt(t))>-1&&t<this._cols.length&&t>=this._cols.frozen){let e=this._cols[t],i=e.pos+e.renderSize;i>-l.x+o&&(l.x=Math.max(-e.pos,o-i));e.pos-r.x<-l.x&&(l.x=-(e.pos-r.x))}if(!l.equals(this._ptScrl)){this.scrollPosition=l;if(i){this._updateScrollPosition();this.refresh()}return!0}if(this._focus&&this._activeCell&&e>-1&&t>-1){let e=this._root,t=e.scrollWidth==e.clientWidth,i=e.scrollHeight==e.clientHeight;if(t||i){let e=this._activeCell.getBoundingClientRect(),s=innerWidth,o=innerHeight,n=e.right<0||e.left>s,r=e.bottom<0||e.top>o;l.x=pageXOffset+(e.left<0?e.left:e.right>s?e.right-s:0);l.y=pageYOffset+(e.top<0?e.top:e.bottom>o?e.bottom-o:0);n&&t&&r&&i?scrollTo(l.x,l.y):n&&t?scrollTo(l.x,document.documentElement.scrollLeft):r&&i&&scrollTo(document.documentElement.scrollTop,l.y)}}return!1}isRangeValid(e){return e&&e.isValid&&e.bottomRow<this.rows.length&&e.rightCol<this.columns.length}startEditing(e=!0,t,i,l,s){return this._edtHdl.startEditing(e,t,i,l,s)}finishEditing(e){return this._edtHdl.finishEditing(e)}get activeCell(){return this._activeCell}get activeEditor(){return this._edtHdl.activeEditor}get editRange(){let e=this._edtHdl.editRange;return e?e.clone():null}get mergeManager(){return this._mrgMgr}set mergeManager(e){if(e!=this._mrgMgr){this._mrgMgr=asType(e,MergeManager,!0);this.invalidate()}}getMergedRange(e,t,i,l=!0){return this._mrgMgr?this._mrgMgr.getMergedRange(e,t,i,l):null}get keyActionTab(){return this._keyHdl._kaTab}set keyActionTab(e){this._keyHdl._kaTab=asEnum(e,KeyAction)}get keyActionEnter(){return this._keyHdl._kaEnter}set keyActionEnter(e){this._keyHdl._kaEnter=asEnum(e,KeyAction)}get preserveWhiteSpace(){return hasClass(this.hostElement,FlexGrid._WJS_WSPRE)}set preserveWhiteSpace(e){toggleClass(this.hostElement,FlexGrid._WJS_WSPRE,asBoolean(e))}get showDropDown(){return this._shDropDown}set showDropDown(e){if(e!=this._shDropDown){this._shDropDown=asBoolean(e,!0);this.invalidate()}}toggleDropDownList(){if(!this._tglDropDown){this._tglDropDown=!0;this._edtHdl._toggleListBox(null);this._tglDropDown=!1}return null!=this._edtHdl._lbx}static get defaultTypeWidth(){return FlexGrid._defTypeWidth}onItemsSourceChanging(e){this.itemsSourceChanging.raise(this,e);return!e.cancel}onItemsSourceChanged(e){this.itemsSourceChanged.raise(this,e)}onScrollPositionChanged(e){this.scrollPositionChanged.raise(this,e)}onSelectionChanging(e){this.selectionChanging.raise(this,e);return!e.cancel}onSelectionChanged(e){this.selectionChanged.raise(this,e)}onLoadingRows(e){this.loadingRows.raise(this,e);return!e.cancel}onLoadedRows(e){this.loadedRows.raise(this,e);this._autoRowHeights()}onUpdatingLayout(e){this.updatingLayout.raise(this,e);return!e.cancel}onUpdatedLayout(e){this.updatedLayout.raise(this,e)}onResizingColumn(e){this.resizingColumn.raise(this,e);return!e.cancel}onResizedColumn(e){this.resizedColumn.raise(this,e);this._autoRowHeights()}onAutoSizingColumn(e){this.autoSizingColumn.raise(this,e);return!e.cancel}onAutoSizedColumn(e){this.autoSizedColumn.raise(this,e)}onStarSizedColumns(e){this.starSizedColumns.raise(this,e);this._autoRowHeights()}onDraggingColumn(e){this.draggingColumn.raise(this,e);return!e.cancel}onDraggingColumnOver(e){this.draggingColumnOver.raise(this,e);return!e.cancel}onDraggedColumn(e){this.draggedColumn.raise(this,e)}onPinningColumn(e){this.pinningColumn.raise(this,e);return!e.cancel}onPinnedColumn(e){this.pinnedColumn.raise(this,e)}onResizingRow(e){this.resizingRow.raise(this,e);return!e.cancel}onResizedRow(e){this.resizedRow.raise(this,e)}onAutoSizingRow(e){this.autoSizingRow.raise(this,e);return!e.cancel}onAutoSizedRow(e){this.autoSizedRow.raise(this,e)}onDraggingRow(e){this.draggingRow.raise(this,e);return!e.cancel}onDraggingRowOver(e){this.draggingRowOver.raise(this,e);return!e.cancel}onDraggedRow(e){this.draggedRow.raise(this,e)}onGroupCollapsedChanging(e){this.groupCollapsedChanging.raise(this,e);return!e.cancel}onGroupCollapsedChanged(e){this.groupCollapsedChanged.raise(this,e)}onColumnGroupCollapsedChanging(e){this.columnGroupCollapsedChanging.raise(this,e);return!e.cancel}onColumnGroupCollapsedChanged(e){this.columnGroupCollapsedChanged.raise(this,e)}onSortingColumn(e){this.sortingColumn.raise(this,e);return!e.cancel}onSortedColumn(e){this.sortedColumn.raise(this,e)}onBeginningEdit(e){this.beginningEdit.raise(this,e);return!e.cancel}onPrepareCellForEdit(e){this.prepareCellForEdit.raise(this,e)}onCellEditEnding(e){this.cellEditEnding.raise(this,e);return!e.cancel&&!e.stayInEditMode}onCellEditEnded(e){this.cellEditEnded.raise(this,e);this._autoRowHeights()}onRowEditStarting(e){this.rowEditStarting.raise(this,e);return!e.cancel}onRowEditStarted(e){this.rowEditStarted.raise(this,e)}onRowEditEnding(e){this.rowEditEnding.raise(this,e)}onRowEditEnded(e){this.rowEditEnded.raise(this,e);this._autoRowHeights()}onRowAdded(e){this.rowAdded.raise(this,e);return!e.cancel}onDeletingRow(e){this.deletingRow.raise(this,e);return!e.cancel}onDeletedRow(e){this.deletedRow.raise(this,e)}onCopying(e){this.copying.raise(this,e);return!e.cancel}onCopied(e){this.copied.raise(this,e)}onPasting(e){this.pasting.raise(this,e);return!e.cancel}onPasted(e){this.pasted.raise(this,e)}onPastingCell(e){this.pastingCell.raise(this,e);return!e.cancel}onPastedCell(e){this.pastedCell.raise(this,e)}onFormatItem(e){this.formatItem.raise(this,e)}onUpdatingView(e){this.updatingView.raise(this,e);return!e.cancel}onUpdatedView(e){this.updatedView.raise(this,e)}_autoRowHeights(){if(this._autoHeights){clearTimeout(this._toAutoHeights);this._toAutoHeights=setTimeout(()=>{this._toAutoHeights=null;this.editRange||this.autoSizeRows()},Control._REFRESH_INTERVAL)}}_getShowErrors(){return this.showErrors&&this._hasValidation}_getHasValidation(){return this._hasValidation}_getError(e,t,i,l){if(isFunction(this.itemValidator)){if(e==this.cells)return this.itemValidator(t,i,l);if(e==this.rowHeaders)for(i=0;i<this.columns.length;i++){let e=this.itemValidator(t,i,l);if(e)return e}}let s=this._cv,o=s?s.getError:null;if(isFunction(o)){let s=e.rows,n=this.columns,r=s[t].dataItem;if(r&&!(r instanceof CollectionViewGroup))for(;t<s.length&&s[t].dataItem==r;t++){if(e==this.cells){return o(r,this._getBindingColumn(this.cells,t,n[i]).binding,l)}if(e==this.rowHeaders)for(i=0;i<n.length;i++){let e=o(r,this._getBindingColumn(this.cells,t,n[i]).binding);if(e)return e}}}return null}_setAria(e,t){setAttribute(this.cells.hostElement,"aria-"+e,t)}_setFocus(e){if(this.hostElement&&(e||!this.containsFocus())){let e=getActiveElement(),t=this.activeEditor,i=this._activeCell,l=this._eFocus,s=this._root;if(t){if(!contains(t,e)){t.focus();l.tabIndex=-1}}else if(i){if(!contains(i,e)&&e!=this._root){isIE()&&hasClass(i,"wj-group")&&(i=i.querySelector("."+CellFactory._WJC_COLLAPSE)||i);i.tabIndex=this._orgTabIndex;this._setFocusNoScroll(i);l.tabIndex=-1}}else if(!contains(l,e)&&e!=s){l.tabIndex=this._orgTabIndex;this._setFocusNoScroll(l)}if(!this.containsFocus()){l.tabIndex=this._orgTabIndex;this._setFocusNoScroll(l)}}}_setFocusNoScroll(e){if(getActiveElement()!=e){if(supportsFocusOptions())e.focus({preventScroll:!0});else{let t=this.scrollPosition,i=e.style,l=i.position;i.position="fixed";e.focus();i.position=l;this.scrollPosition=t}this._fixScroll()}}_getDefaultRowHeight(){let e=this.hostElement,t=this._eFocus,i=null;if(!t.offsetHeight){i=createElement('<div><div class="wj-cell">0</div></div>',document.body);e&&i.setAttribute("class",e.getAttribute("class"));t=i.children[0]}let l=t.offsetHeight;(isNaN(l)||l<=6)&&(l=28);removeChild(i);return l}_getCollectionView(e){return asCollectionView(e)}_getCanvasContext(){let e=document.createElement("canvas").getContext("2d"),t=getComputedStyle(this.hostElement);e.font=t.fontSize+" "+t.fontFamily.split(",")[0];return e}_getWidestRow(e,t,i,l){let s=0,o=0,n=e.columns[i].dataType==DataType.Boolean;for(let r=t.row;r<=t.row2;r++)if(e.rows[r].isVisible){let t=e.getCellData(r,i,!0),a=l.measureText(t).width,h=this.getMergedRange(e,r,i,!1);h&&h.columnSpan>1&&(a/=h.columnSpan);if(a>o){o=a;s=r}if(n)break}return s}_getDesiredWidth(e,t,i,l){let s=this.getMergedRange(e,t,i,!1),o=l.style;this.cellFactory.updateCell(e,t,i,l,s);o.width=o.top=o.left="";return l.offsetWidth/(s&&s.columnSpan>1?s.columnSpan:1)}_getDesiredHeight(e,t,i,l){let s=l.style,o=this.getMergedRange(e,t,i,!1),n=o?o.rowSpan:1;this.cellFactory.updateCell(e,t,i,l,o);l.innerHTML.trim()||(l.innerHTML="&nbsp;");s.height=s.top=s.left="";return l.offsetHeight/n}_getDesiredRowHeight(e,t,i,l){let s=0,o=this._getQuickAutoSize();for(let n=0;n<e.columns.length;n++){let r=e.columns[n];if(r.isVisible){let a,h=this.getMergedRange(e,t,n,!1);if(o){let s={ct:e.cellType,col:n,rng:h&&h.rowSpan>1?h.rowSpan:1,data:r.dataType!=DataType.Number||r.dataMap?e.getCellData(t,n,!0):"1"},o=JSON.stringify(s);if(null==(a=l[o])){a=this._getDesiredHeight(e,t,n,i);l[o]=a}}else a=this._getDesiredHeight(e,t,n,i);s=Math.max(a,s)}}return s}_getSortRowIndex(){return null!=this._sortRowIndex?this._sortRowIndex:this.columnHeaders.rows.length-1}_getDeleteColumnIndex(){return 0}_getEditColumnIndex(){return null!=this._editColIndex?this._editColIndex:this.rowHeaders.columns.length-1}_sortConverter(e,t,i,l){let s;if(l){this._mappedColumns=null;this._cv&&this._cv.sortDescriptions.forEach(e=>{if((s=this.getColumn(e.property))&&s.dataMap){this._mappedColumns||(this._mappedColumns={});this._mappedColumns[s.binding]=s.dataMap}});if(this._mouseHdl._htDown&&this._mouseHdl._htDown.col>-1){s=this.columns[this._mouseHdl._htDown.col];this._mappedColumns&&s.dataMap&&(this._mappedColumns[s.binding]=s.dataMap)}}if(this._mappedColumns){let t=this._mappedColumns[e.property];t&&t.sortByDisplayValues&&(i=t.getDisplayValue(i))}return i}_bindGrid(e){this.finishEditing();this.deferUpdate(()=>{this.autoGenerateColumns&&0==this._lastCount&&hasItems(this._cv)&&(e=!0);let t,i;this.preserveSelectedState&&(t=this._getMap())&&this.rows.forEach(e=>{e.isSelected&&e.dataItem&&t.set(e.dataItem,!0)});if(this.preserveOutlineState&&this.rows.maxGroupLevel>-1&&(i=this._getMap()))for(let e=0;e<this.rows.length;e++){let t=this.rows[e];if(t instanceof GroupRow&&t.isCollapsed&&t.dataItem){let e=t.dataItem;e instanceof CollectionViewGroup&&(e=e._path);i.set(e,!0)}}e&&this.columns.deferUpdate(()=>{this._bindColumns()});let l=new CancelEventArgs;if(this.onLoadingRows(l)){this.rows.deferUpdate(()=>{this._bindRows()});this.onLoadedRows(l)}this._selHdl.extendedSelection.clear();let s=0;t&&t.size&&this.rows.forEach(e=>{let i=e.dataItem;if(i&&t.has(i)){e.isSelected=!0;s++}});if(0==s&&this._lastCount>0&&this.selectionMode==SelectionMode.ListBox){let e=this.selection;for(let t=e.topRow;t<=e.bottomRow&&t>-1&&t<this.rows.length;t++)this.rows[t].isSelected=!0}i&&i.size&&this.rows.deferUpdate(()=>{this.rows.forEach(e=>{if(e instanceof GroupRow){let t=e.dataItem;t instanceof CollectionViewGroup&&(t=t._path);i.has(t)&&(e.isCollapsed=!0)}})});if(!this._lastCount){let e=this._cv;e&&e.items&&(this._lastCount=e.items.length)}});if(!this.rows.length){let e=this._selHdl.selection;e.row=e.row2=-1}if(this._cv){let t=e&&!this._toInv;this._syncSelection(t)}}_getMap(){return window.Map?new Map:null}_cvCollectionChanged(e,t){if(this.autoGenerateColumns&&0==this.columns.length){this._bindGrid(!0);return}let i=NotifyCollectionChangedAction;if(this.childItemsPath&&t.action!=i.Change)this._bindGrid(!1);else{switch(t.action){case i.Change:this.invalidate();return;case i.Add:if(t.index==this._cv.items.length-1){let e=this.rows.length;this.rows[e-1]instanceof _NewRowTemplate&&e--;this.rows.insert(e,new Row(t.item));return}assert(!1,"added item should be the last one.");break;case i.Remove:let e=this._findRow(t.item);if(e>-1){this.rows.removeAt(e);this._syncSelection();return}assert(!1,"removed item not found on grid.")}this._bindGrid(!1)}}_cvCurrentChanged(e,t){this._syncSelection()}_syncSelection(e){if(this._cv&&this.selectionMode!=SelectionMode.None){let t=this._selHdl.selection,i=t.row>-1&&t.row<this.rows.length?this.rows[t.row]:null,l=i?i.dataItem:null,s=this._cv;if(s instanceof CollectionView&&s.isUpdating)return;if(this.newRowAtTop&&i instanceof _NewRowTemplate)return;l instanceof CollectionViewGroup&&(l=null);if(l!=s.currentItem||e){let e=this.editableCollectionView;if(!this.childItemsPath||!e||!e.currentAddItem){let e=this._getRowIndex(s.currentPosition);if(e!=t.row||!this.childItemsPath){t=new CellRange(e,t.col,e,t.col2);this.select(t,!1);this.selectionMode&&this.scrollIntoView(t.row,-1)}}}}}_getRowIndex(e){if(this._cv){let t=this.rows;if(e>-1){let i=this._cv.items[e];for(;e<t.length;e++)if(t[e].dataItem===i)return e;return-1}{if(1==t.length&&t[0]instanceof _NewRowTemplate)return 0;let e=this.selection.row,i=e>-1?t[e]:null;return i&&(i instanceof GroupRow||null==i.dataItem)?e:-1}}return this.selection.row}_getCvIndex(e){return e>-1&&e<this.rows.length?this.rows[e].dataIndex:-1}_findRow(e){for(let t=0;t<this.rows.length;t++)if(this.rows[t].dataItem==e)return t;return-1}_updateLayout(){let e=new CancelEventArgs;if(!this.onUpdatingLayout(e))return;let t=this._hdrVis&HeadersVisibility.Row?this._hdrCols.getTotalSize():0,i=this._hdrVis&HeadersVisibility.Column?this._hdrRows.getTotalSize():0,l=this._ftrRows.getTotalSize(),s=this._rows.getTotalSize()+l;s<1&&(s=1);this._heightReal=s;this._heightBrowser=Math.min(s,FlexGrid._getMaxSupportedCssHeight());this._maxOffsetY=Math.max(0,s-this._heightBrowser);let o=getComputedStyle(this._eFocus);this._cellPadVert=parseInt(o.paddingTop)+parseInt(o.paddingBottom);this._cellPadHorz=parseInt(o.paddingLeft)+parseInt(o.paddingRight);this._cellPadLeft=parseInt(this.rightToLeft?o.paddingRight:o.paddingLeft);let n=this._heightBrowser+i-l,r=this._gpCells.width,a=this._heightBrowser;!r&&this.rows.length&&(r=.1);!a&&this.columns.length&&(a=.1);if(this.rightToLeft){setCss(this._eTL,{right:0,top:0,width:t,height:i});setCss(this._eCHdr,{right:t,top:0,height:i});setCss(this._eRHdr,{right:0,top:i,width:t});setCss(this._eCt,{right:t,top:i,width:r,height:a});setCss(this._fCt,{right:t,top:i});setCss(this._eBL,{right:0,top:n,width:t,height:l});setCss(this._eCFtr,{right:t,top:n,height:l})}else{setCss(this._eTL,{left:0,top:0,width:t,height:i});setCss(this._eCHdr,{left:t,top:0,height:i});setCss(this._eRHdr,{left:0,top:i,width:t});setCss(this._eCt,{left:t,top:i,width:r,height:a});setCss(this._fCt,{left:t,top:i});setCss(this._eBL,{left:0,top:n,width:t,height:l});setCss(this._eCFtr,{left:t,top:n,height:l})}this._stickyHdr&&this._updateStickyHeaders();let h=this.frozenRows||this.frozenColumns?"3":"";setCss([this._eTL,this._eBL,this._eCHdr,this._eCFtr,this._eRHdr,this._eMarquee],{zIndex:h});let d=this._root,c=d.offsetWidth-d.clientWidth,g=d.offsetHeight-d.clientHeight;setCss(this._eSz,{width:t+c+this._gpCells.width,height:i+g+this._heightBrowser});let u=null;if(this.columns._updateStarSizes(d.clientWidth-t)){u=d.clientWidth;setCss(this._eCt,{width:this._gpCells.width});this.onStarSizedColumns()}this._szClient=new Size(d.clientWidth-t,d.clientHeight-i);this._szClientSB=new Size(d.offsetWidth-t,d.offsetHeight-i);this._rcBounds=null;this._updateScrollHandler();this._updateContent(!1);c=d.offsetWidth-d.clientWidth;g=d.offsetHeight-d.clientHeight;setCss(this._eSz,{width:t+c+this._gpCells.width,height:i+g+this._heightBrowser});this._szClient=new Size(d.clientWidth-t,d.clientHeight-i);if(u&&u!=d.clientWidth&&this.columns._updateStarSizes(d.clientWidth-t)){setCss(this._eCt,{width:this._gpCells.width});this._updateContent(!1)}setCss([this._eCHdr,this._eCFtr,this._fCt],{width:this._szClient.width});setCss([this._eRHdr,this._fCt],{height:this._szClient.height});if(l){n=Math.min(n,this._szClient.height+i-l);setCss([this._eBL,this._eCFtr],{top:n})}this.onUpdatedLayout(e)}_updateStickyHeaders(){let e=!1,t=0;if(this._stickyHdr){let i=0,l=null;for(let e=this.hostElement;e;e=e.parentElement)if("inline"!=getComputedStyle(e).display){let t=e.getBoundingClientRect();null==l&&(l=t.top);i=Math.max(i,t.top)}t=-(l=Math.max(0,i-l-1));e=l>0;this._rcBounds=null}this._eTL.style.top=this._eCHdr.style.top=e?-t+"px":"";toggleClass(this._eTL,FlexGrid._WJS_STICKY,e);toggleClass(this._eCHdr,FlexGrid._WJS_STICKY,e)}_updateScrollHandler(){this._clipToScreen=this._getClipToScreen();let e=this._stickyHdr||this._clipToScreen;if(e!=this._scrollHandlerAttached){this._scrollHandlerAttached=e;e?this.addEventListener(window,"scroll",this._scroll.bind(this),!0):this.removeEventListener(window,"scroll")}}_getClipToScreen(){if(this.rows.length<=FlexGrid._MIN_VIRT_ROWS)return!1;if(this._root.scrollHeight>this._root.clientHeight)return!1;for(let e=this.hostElement;e&&e!=document.documentElement;e=e.parentElement){if("auto"==getComputedStyle(e).overflow)return!1}return!0}_scroll(e){if(contains(e.target,this.hostElement)){if(this._clipToScreen){this._afClip&&cancelAnimationFrame(this._afClip);this._afClip=requestAnimationFrame(()=>{this._afClip=null;this.finishEditing();this._updateContent(!0)})}if(this._stickyHdr){this._afSticky&&cancelAnimationFrame(this._afSticky);this._afSticky=requestAnimationFrame(()=>{this._afSticky=null;let e=new CancelEventArgs;if(this.onUpdatingLayout(e)){this._updateStickyHeaders();this.onUpdatedLayout(e)}})}}}_getCssPage(e){if(this._heightReal>this._heightBrowser){let t=this._szClient.height-this._gpCFtr.rows.getTotalSize();if(this._heightBrowser>t)return clamp(Math.round(e/(this._heightBrowser-t)*10)/10,0,1)}return 0}_updateScrollPosition(){let e=this._root,t=e.scrollTop,i=e.scrollLeft;this.rightToLeft&&"rev"==FlexGrid._getRtlMode()&&(i=e.scrollWidth-e.clientWidth-i);let l=new Point(-Math.abs(i),-t);if(!this._ptScrl.equals(l)){this._ptScrl=l;this.onScrollPositionChanged();return!0}return!1}_updateContent(e,t){let i=this._root,l=this.hostElement,s=this.cells.hostElement,o=this._activeCell,n=getActiveElement(),r=contains(l,n),a=closest(n,".wj-flexgrid")==l?n:null,h=new CancelEventArgs;if(!this.onUpdatingView(h))return;setAttribute(s,"role",this.rows.maxGroupLevel<0?"grid":"treegrid");this._hasValidation=isFunction(this._itemValidator)||this._cv&&isFunction(this._cv.getError);let d=!t&&this._errorTip&&this._errorTip._tips.length,c=this._getCssPage(-this._ptScrl.y);if(c!=this._cssPage){this._cssPage=c;this._offsetY=Math.round(this._maxOffsetY*c)}this._updateScrollPosition();this._updateMarquee();let g=this._gpCells._updateContent(e,t,this._offsetY),u=this._hdrVis;if(u&HeadersVisibility.Column&&(!t||this._ssHdr&u)){this._gpCHdr._updateContent(e,t,0);this.rightToLeft||(this._eCHdr.scrollLeft=0)}if(u&HeadersVisibility.Row&&(!t||this._ssHdr&u)){this._gpRHdr._updateContent(e,t,this._offsetY);this._eRHdr.scrollTop=0}u&&!t&&this._gpTL._updateContent(e,t,0);if(this._gpCFtr.rows.length){this._gpBL._updateContent(e,t,0);this._gpCFtr._updateContent(e,t,0)}if(d&&this._errorTip&&this._errorTip._tips.length){clearTimeout(this._toErrorTips);this._toErrorTips=setTimeout(()=>{this._errorTip.hide();let e=this._errorTip._tips;for(let t=0;t<e.length;t++){let i=e[t].element;if(!i.offsetHeight||!hasClass(i,"wj-state-invalid")){this._errorTip.setTooltip(i,null);t--}}},250)}if(this._useFrozenDiv()){this._updateFrozenCells(t);g&&hasClass(g,"wj-frozen")&&(g=null)}this._fCt.style.display=this._fCt.childElementCount?"":"none";this._activeCell=g;if(a)if(a!=i&&a!=this._eFocus&&contains(l,a)&&!contains(s,a)){getActiveElement()!==a&&a.focus();if(isIE()&&a instanceof HTMLInputElement&&!a.type.match(/checkbox|radio|range/i)){let e=a.selectionStart,t=a.selectionEnd;a.setSelectionRange(e,t)}}else{let e=g!==o;this._setFocus(e)}!a&&g&&(g.tabIndex=this.isDisabled?-1:this._orgTabIndex);o&&o!=g&&(o.tabIndex=-1);this._eFocus.tabIndex=null!=g||this.isDisabled?-1:this._orgTabIndex;r&&this.focus();this._fixScroll();this._rcBounds=null;this.onUpdatedView(h)}_fixScroll(){if(!this._updating){let e=this.hostElement,t=this._root?this._root.parentElement:null,i=this.rightToLeft;if(e){e.scrollTop&&(e.scrollTop=0);e.scrollLeft&&!i&&(e.scrollLeft=0)}if(t){t.scrollTop&&(t.scrollTop=0);t.scrollLeft&&!i&&(t.scrollLeft=0)}}}_clearCells(){for(let e in this)if("_"==e[0]){let t=this[e];t instanceof GridPanel&&t._clearCells()}this.invalidate()}_useFrozenDiv(){return isBoolean(this._fzClone)?this._fzClone:isIE()||isFirefox()||isSafari()||isMobile()}_updateFrozenCells(e){let t=this._fCt;if(this.frozenRows||this.frozenColumns){let i=this._eCt.querySelectorAll(".wj-frozen");if(e&&t.children.length==i.length){for(let e=0;e<i.length;e++)t.children[e].className=i[e].className;return}setText(t,null);if(!this.activeEditor){let e=this._errorTip,l=navigator.userAgent.indexOf("MSIE")>=0;for(let s=0;s<i.length;s++){let o=i[s];if(closest(o,".wj-flexgrid")==this.hostElement){let n=o[GridPanel._INDEX_KEY];if(l){let e="input[type=checkbox]",t=o.querySelector(e);o=o.cloneNode(!0);if(t){o.querySelector(e).checked=t.checked}}else o=o.cloneNode(!0);o[GridPanel._INDEX_KEY]=n;if(e){let t=e.getTooltip(i[s]);t&&e.setTooltip(o,t)}t.appendChild(o)}}}}else setText(t,null)}_updateMarquee(){let e=this._eMarquee,t=this._getMarqueeRect();if(t&&t.width&&t.height){let i=e.firstChild,l=e.offsetWidth-i.offsetWidth,s=e.offsetHeight-i.offsetHeight,o=this.cells.hostElement;setCss(e,{left:t.left+o.offsetLeft-l/2,top:t.top+o.offsetTop-s/2,width:t.width+l,height:t.height+s,display:""})}else e.style.display="none"}_getMarqueeRect(){if(!this._shMarquee)return null;let e=this._selHdl.selection;if(!this.isRangeValid(e))return null;e=(e=(e=this.cells._getAdjustedSelection(e)).combine(this.getMergedRange(this.cells,e.topRow,e.leftCol))).combine(this.getMergedRange(this.cells,e.bottomRow,e.rightCol));let t=this.cells.getCellBoundingRect(e.topRow,e.leftCol,!0),i=this.cells.getCellBoundingRect(e.bottomRow,e.rightCol,!0);if(this.rows.frozen){let l=Math.min(this.rows.length,this.rows.frozen),s=this.cells.getCellBoundingRect(l-1,0,!0);e.topRow>=l&&t.top<s.bottom&&(t.top=s.bottom);e.bottomRow>=l&&i.bottom<s.bottom&&(i.height=s.bottom-i.top)}if(this.columns.frozen){let l=Math.min(this.columns.length,this.columns.frozen),s=this.cells.getCellBoundingRect(0,l-1,!0);if(this.rightToLeft){e.leftCol>=l&&t.right>s.left&&(t.left=s.left-t.width);e.rightCol>=l&&i.left>s.left&&(i.left=s.left)}else{e.leftCol>=l&&t.left<s.right&&(t.left=s.right);e.rightCol>=l&&i.right<s.right&&(i.width=s.right-i.left)}}return this.rightToLeft?new Rect(i.left,t.top,t.right-i.left,i.bottom-t.top):new Rect(t.left,t.top,i.right-t.left,i.bottom-t.top)}_bindColumns(){let e=this.columns;for(let t=0;t<e.length;t++){if(e[t]._getFlag(RowColFlags.AutoGenerated)){e.removeAt(t);t--}}let t=this._cv,i=t?t.items:null;i&&i.length&&this.autoGenerateColumns&&this._getColumnTypes(i).forEach(t=>{let i=new Column(t);i._setFlag(RowColFlags.AutoGenerated,!0);i.name=i.binding;i.header=toHeaderCase(i.binding);let l=Object.getOwnPropertyDescriptor(t,i.binding);i.isReadOnly=l&&!l.writable&&!l.set;let s=FlexGrid._defTypeWidth[i.dataType];if(null!=s){if(isString(s)){let t=Math.round(parseFloat(s));s=s.indexOf("*")>-1?t*e.defaultSize:t}isNumber(s)&&s>0&&(i.width=s)}e.push(i)});this._updateColumnTypes()}_getColumnTypes(e){return getTypes(e)}_updateColumnTypes(){let e=this._cv;if(hasItems(e)){let t=e.items[0];this.columns.forEach(e=>{null==e.dataType&&e._binding&&(e.dataType=getType(e._binding.getValue(t)))})}}_getMapEditor(e,t){return!e.dataMap||e instanceof GroupRow?t.dataMap&&!t.editor?t.dataMapEditor:null:e.dataMapEditor}_getBindingColumn(e,t,i){return i}_getBindingColumns(){return this.columns}_getRowHeaderPath(){return this._rowHdrPath}_bindRows(){this.rows.clear();let e=this._cv;if(e&&e.items){let t=e.items,i=e.groups;if(this.childItemsPath)for(let e=0;e<t.length;e++)this._addNode(t,e,0);else if(null!=i&&i.length>0&&this.showGroups)for(let e=0;e<i.length;e++)this._addGroup(i[e]);else for(let e=0;e<t.length;e++)this._addBoundRow(t,e)}}_addBoundRow(e,t){let i=new Row(e[t]),l=this.rows;i._list=l;l[l.length++]=i}_addGroupRow(e){this.rows.push(new GroupRow(e))}_addNode(e,t,i){let l=e[t],s=this.childItemsPath,o=l[isArray(s)?s[i]:s],n=new GroupRow(l);n.level=i;this.rows.push(n);if(isArray(o))for(let e=0;e<o.length;e++)this._addNode(o,e,i+1)}_addGroup(e){this._addGroupRow(e);if(e.isBottomLevel){let t=e.items;for(let e=0;e<t.length;e++)this._addBoundRow(t,e)}else for(let t=0;t<e.groups.length;t++)this._addGroup(e.groups[t])}static _getSerializableProperties(e){let t=[];for(e=e.prototype;e!=Object.prototype;e=Object.getPrototypeOf(e)){let i=Object.getOwnPropertyNames(e);for(let l=0;l<i.length;l++){let s=i[l],o=Object.getOwnPropertyDescriptor(e,s);o&&o.set&&o.get&&"_"!=s[0]&&!s.match(/^(disabled|required|showDropDown)$/)&&t.push(s)}}return t}_hasColumnGroups(){return this._grpHdl.hasColumnGroups()}_getColumnGroup(e,t){return this._grpHdl.getColumnGroup(e,t)}_copy(e,t){if("columns"==e){let e=asArray(t);if(e.some(e=>null!=e.columns))this.columnGroups=e;else{this.columns.clear();e.forEach(e=>{let t=new Column(e);this.columns.push(t)})}return!0}return!1}_isInputElement(e){return e instanceof HTMLElement&&!hasClass(e,"wj-btn-glyph")&&("true"==e.contentEditable||null!=e.tagName.match(/^(INPUT|TEXTAREA|BUTTON|A|SELECT|OPTION|LABEL)$/i))}_isNativeCheckbox(e){return e instanceof HTMLInputElement&&"checkbox"==e.type&&!e.disabled&&!e.readOnly&&hasClass(e,CellFactory._WJC_CHECKBOX)&&closest(e,".wj-flexgrid")==this.hostElement}_wantsInput(e){return this._isInputElement(e)&&!this.activeEditor&&!this._isNativeCheckbox(e)&&!hasClass(e,"wj-grid-ime")&&contains(document.body,e)}static _getMaxSupportedCssHeight(){if(!FlexGrid._maxCssHeight){let e=265e5;isIE()?e=15e5:isFirefox()&&(e=175e5);FlexGrid._maxCssHeight=e}return FlexGrid._maxCssHeight}static _getRtlMode(){if(!FlexGrid._rtlMode){let e=createElement('<div dir="rtl"><div></div></div>');setCss(e,{visibility:"hidden",width:100,height:100,overflow:"auto"});setCss(e.firstChild,{width:2e3,height:2e3});document.body.appendChild(e);let t=e.scrollLeft;e.scrollLeft=-1e3;let i=e.scrollLeft;removeChild(e);FlexGrid._rtlMode=i<0?"neg":t>0?"rev":"std"}return FlexGrid._rtlMode}}FlexGrid._WJS_STICKY="wj-state-sticky";FlexGrid._WJS_MEASURE="wj-state-measuring";FlexGrid._WJS_UPDATING="wj-state-updating";FlexGrid._WJS_WSPRE="wj-whitespace-pre";FlexGrid._MIN_VIRT_ROWS=200;FlexGrid._defTypeWidth={[DataType.Number]:"0.714285714*"};FlexGrid.controlTemplate='<div><div wj-part="root"><div wj-part="cells" class="wj-cells"></div><div wj-part="marquee" class="wj-marquee"><div></div></div></div><div wj-part="fcells" aria-hidden="true" class="wj-cells wj-frozen-clone"></div><div wj-part="rh"><div wj-part="rhcells" class="wj-rowheaders"></div></div><div wj-part="cf"><div wj-part="cfcells" class="wj-colfooters"></div></div><div wj-part="ch"><div wj-part="chcells" class="wj-colheaders"></div></div><div wj-part="bl"><div wj-part="blcells" class="wj-bottomleft"></div></div><div wj-part="tl"><div wj-part="tlcells" class="wj-topleft"></div></div><div wj-part="focus" class="wj-cell">0</div><div wj-part="sz"></div></div>';export class _ImeHandler{constructor(e){this._updateImeFocusBnd=this._updateImeFocus.bind(this);this._cmpstartBnd=this._compositionstart.bind(this);this._keypressBnd=this._keypress.bind(this);this._g=e;let t=createElement('<textarea class="wj-grid-editor wj-form-control wj-grid-ime" aria-hidden="true"/>');setCss(t,_ImeHandler._cssHidden);disableAutoComplete(t);t.tabIndex=-1;this._tbx=t;e._root.appendChild(t);this._updateImeFocus();let i=e.hostElement,l=e.addEventListener.bind(e),s=this._updateImeFocusBnd;l(i,"blur",s,!0);l(i,"focus",s);l(i,"mousedown",s,!0);l(i,"mouseup",s,!0);l(t,"compositionstart",this._cmpstartBnd);isiOS()&&l(i,"keypress",this._keypressBnd);e.selectionChanged.addHandler(s,this);e.cellEditEnded.addHandler(this._cellEditEnded,this)}dispose(){let e=this._g,t=e.hostElement,i=this._tbx,l=e.removeEventListener.bind(e),s=this._updateImeFocusBnd;l(t,"blur",s);l(t,"focus",s);l(t,"mousedown",s);l(t,"mouseup",s);l(t,"keypress",this._keypressBnd);l(i,"compositionstart",this._cmpstartBnd);e.selectionChanged.removeHandler(s);e.cellEditEnded.removeHandler(this._cellEditEnded);removeChild(i)}_compositionstart(e){let t=this._g;if(!t.activeEditor){let i=t._selHdl.selection;if(t.startEditing(!1,i.row,i.col,!1,e)&&t.activeEditor&&"checkbox"!=t.activeEditor.type){i=t.editRange;let e=t.activeEditor,l=this._tbx,s=t.cells.hostElement,o=t.columns[i.col].pos+s.offsetLeft,n=t.rows[i.row].pos+s.offsetTop,r=t.getCellBoundingRect(i.row,i.col),a=closest(e,".wj-cell");r.width=a.offsetWidth;r.height=a.offsetHeight;i.row<t.frozenRows&&(n+=t._root.scrollTop);i.col<t.frozenColumns&&(o+=t._root.scrollLeft);let h=a.querySelector(".wj-btn.wj-right");h&&(r.width-=h.offsetWidth);"minLength,maxLength,pattern".split(",").forEach(t=>{setAttribute(l,t,e.getAttribute(t))});let d=e instanceof HTMLTextAreaElement;setAttribute(l,"wrap",d?"soft":"off");let c=getComputedStyle(a),g=c.paddingTop;if(i.rowSpan>1&&!d){let e=parseFloat(c.lineHeight);isNaN(e)&&(e=1.2*parseFloat(c.fontSize));g=Math.max(0,(r.height-e)/2)+"px"}let u={position:"absolute",left:o,top:n,width:r.width-1,height:r.height-1,paddingTop:g,paddingLeft:c.paddingLeft,paddingRight:c.paddingRight,textAlign:c.textAlign,zIndex:a.style.zIndex};if(t.rightToLeft){u.right=parseInt(a.style.right)+parseInt(t.cells.hostElement.style.right);u.left=""}setCss(l,u);t._edtHdl._edt=l;l.select();let _=e.value;setTimeout(()=>{if("　"==l.value||" "==l.value){l.value=_;setSelectionRange(l,_.length)}},20);e.value=""}}}_cellEditEnded(){let e=this._tbx;e.value="";setCss(e,_ImeHandler._cssHidden)}_keypress(e){if(!e.defaultPrevented&&e.target==this._tbx&&!(e.ctrlKey||e.altKey||e.metaKey||27==e.keyCode||this._g.activeEditor)){this._tbx.value="";this._compositionstart(e);e.stopPropagation()}}_updateImeFocus(){let e=this._g,t=this._tbx,i=getActiveElement();if(!e.activeEditor&&closest(i,".wj-flexgrid")==e.hostElement)if(this._enableIme()){if(i!=t){t.disabled=!1;t.select();t.focus()}}else{t.disabled=!0;t.value="";t.blur();e.focus()}}_enableIme(){let e=this._g,t=e._selHdl.selection;if(!e.canEditCell(t.row,t.col))return!1;let i=t.isValid?e._getBindingColumn(e.cells,t.row,e.columns[t.col]):null;return!(!i||i.editor||i.dataType==DataType.Boolean)}}_ImeHandler._cssHidden={position:"fixed",width:"1px",left:-32e3,top:-32e3,overflow:"hidden"};export class _ColumnGroupHandler{constructor(e){this._grid=e}createColumnGroups(e){let t=this._grid;this._groupDefs=asArray(e);t.autoGenerateColumns=!1;t.columns.clear();this._colGroups=[];e.forEach(e=>{this._colGroups.push(new ColumnGroup(e,null))});let i=1;this._colGroups.forEach(e=>{this._addColumnGroup(e);i=Math.max(i,e._getMaxLevel())});this._colGroups.forEach(e=>{e._expandRange(i)});let l=t.columnHeaders.rows;l.clear();for(let e=0;e<=i;e++){let t=new Row;l.splice(e,0,t);e<i&&(t.cssClassAll="wj-colgroup")}for(let e=0;e<l.length;e++)for(let i=0;i<t.columns.length;i++){let l=this.getColumnGroup(e,i);if(l){let s=l.header||toHeaderCase(l.binding);t.columnHeaders.setCellData(e,i,s)}}}_addColumnGroup(e){let t=this._grid;e._grid=t;e._rng.col=t.columns.length;0==e.columns.length?t.columns.push(e):e.columns.forEach(e=>{this._addColumnGroup(e)});e._rng.col2=t.columns.length-1}hasColumnGroups(){return null!=this._colGroups&&this._colGroups.length>0}getGroupDefinitions(){return this._groupDefs}getColumnGroup(e,t){let i=this._grid;if(e<i.columnHeaders.rows.length&&t<i.columns.length)for(let i=this._colGroups;i;){let l=i;for(let l=0;l<i.length;l++){let s=i[l],o=s._rng;if(o.containsColumn(t)){if(o.containsRow(e)||0==s.columns.length)return s;i=s.columns;break}}if(i==l)break}return null}}export class ColumnGroup extends Column{constructor(e,t){super();this._rng=new CellRange(0,-1);this._cols=[];this._lvl=0;this._collapsed=!1;this._pGrp=t;for(let e=t;e;e=e._pGrp)this._lvl++;this._rng.row=this._rng.row2=this._lvl;this.allowDragging=!1;copy(this,e)}get columns(){return this._cols}set columns(e){this._cols=[];e.forEach(e=>{let t=new ColumnGroup(e,this);this._cols.push(t)})}get parentGroup(){return this._pGrp}get collapseTo(){return this._collTo}set collapseTo(e){this._collTo=asString(e)}get isCollapsed(){return this._collapsed}set isCollapsed(e){if(e!=this._collapsed){let t=this._grid;if(t){let i=new CellRangeEventArgs(t.rowHeaders,this._rng,this);if(t.onColumnGroupCollapsedChanging(i)){this._collapsed=asBoolean(e);t.onColumnGroupCollapsedChanged(i)}}else this._collapsed=asBoolean(e)}setTimeout(()=>{this._updateCollapsedState()})}get grid(){return this._grid}_updateCollapsedState(){let e=this._grid.columns,t=this._rng,i=this._collapsed;this._cols.forEach(e=>{if(e instanceof ColumnGroup){e._collapsed=i;e._updateCollapsedState()}});let l=t.rightCol;if(this.collapseTo)switch(this.collapseTo){case"$first":l=t.leftCol;break;case"$last":l=t.rightCol;break;default:let i=e.getColumn(this.collapseTo);i&&t.containsColumn(i.index)&&(l=i.index)}for(let s=t.leftCol;s<=t.rightCol;s++)e[s].visible=!i||s==l}_getMaxLevel(){let e=this._lvl;this.columns.forEach(t=>{e=Math.max(e,t._getMaxLevel())});return e}_expandRange(e){let t=e-this._getMaxLevel();if(t>0){this._rng.row2+=t;this._cols.forEach(e=>{e._shiftRange(t)})}let i=this._grid.columns,l=this._rng;for(let t=l.col;t<=l.col2;t++){i[t]._rng.row2=e}}_shiftRange(e){this._rng.row+=e;this._rng.row2+=e;this._cols.forEach(t=>{t._shiftRange(e)})}}export class _AddNewHandler{constructor(e){this._nrt=new _NewRowTemplate;this._g=e;this._keydownBnd=this._keydown.bind(this);this._attach()}get newRowAtTop(){return this._top}set newRowAtTop(e){if(e!=this.newRowAtTop){this._top=asBoolean(e);this.updateNewRowTemplate();let t=this._g;if(this._top&&t.selectionMode==SelectionMode.ListBox){t.rows.forEach((e,t)=>{e._setFlag(RowColFlags.Selected,0==t,!0)});t.select(0,t.selection.col)}}}updateNewRowTemplate(){let e=this._g,t=e.editableCollectionView,i=e.rows,l=this._nrt,s=t&&t.canAddNew&&e.allowAddNew&&!e.isReadOnly,o=i.indexOf(l),n=this._top?0:i.length-1,r=!1;if(!s&&o>-1){let t=e.selection;t.row==o&&e.select(t.row-1,t.col);i.removeAt(o)}else if(s){if(o<0)r=!0;else if(o!=n){i.removeAt(o);r=!0}r&&(this._top?i.insert(0,l):i.push(l));if(l){l._ubv=null;l._setFlag(RowColFlags.ParentCollapsed,!1);this._top&&e.selectionMode==SelectionMode.ListBox||l._setFlag(RowColFlags.Selected,!1)}}}_attach(){let e=this._g;if(e){e.beginningEdit.addHandler(this._beginningEdit,this);e.pastingCell.addHandler(this._beginningEdit,this);e.rowEditEnded.addHandler(this._rowEditEnded,this);e.loadedRows.addHandler(this.updateNewRowTemplate,this);e.hostElement.addEventListener("keydown",this._keydownBnd,!0)}}_detach(){let e=this._g;if(e){e.beginningEdit.removeHandler(this._beginningEdit);e.pastingCell.removeHandler(this._beginningEdit);e.rowEditEnded.removeHandler(this._rowEditEnded);e.loadedRows.removeHandler(this.updateNewRowTemplate);e.hostElement.removeEventListener("keydown",this._keydownBnd,!0)}}_keydown(e){if(!e.defaultPrevented&&e.keyCode==Key.Escape&&null==this._g.activeEditor&&this._top&&this._nrt.dataItem){this._nrt.dataItem=null;this._g.invalidate()}}_beginningEdit(e,t){if(!t.cancel){let i=e.rows[t.row];if(i instanceof _NewRowTemplate){let l=e.editableCollectionView;if(l&&l.canAddNew)if(this._top){if(null==this._nrt.dataItem){let e=null,t=l.sourceCollection,i=l.newItemCreator;e=isFunction(i)?i():t&&t.length?new t[0].constructor:{};this._nrt.dataItem=e}}else{let s=l.currentAddItem&&l.currentAddItem==i.dataItem?l.currentAddItem:l.addNew();l.moveCurrentTo(s);let o=this._nrt.isSelected;this.updateNewRowTemplate();o&&t.row>-1&&(e.rows[t.row].isSelected=!0);e.refresh(!0);e.onRowAdded(t)||l.cancelNew()}}}}_rowEditEnded(e,t){let i=e.editableCollectionView,l=this._nrt.dataItem;if(i&&!this._committing)if(i.isAddingNew)i.commitNew();else if(l&&!t.cancel){this._committing=!0;this._nrt.dataItem=null;let s=i.addNew();for(let e in l)s[e]=l[e];e.onRowAdded(t)?i.commitNew():i.cancelNew();setTimeout(()=>{e.select(0,e.columns.firstVisibleIndex);this.updateNewRowTemplate()},20);this._committing=!1}}}export class _NewRowTemplate extends Row{}export var AllowMerging;!function(e){e[e.None=0]="None";e[e.Cells=1]="Cells";e[e.ColumnHeaders=2]="ColumnHeaders";e[e.RowHeaders=4]="RowHeaders";e[e.AllHeaders=6]="AllHeaders";e[e.All=7]="All"}(AllowMerging||(AllowMerging={}));export class MergeManager{constructor(e){this._g=e}getMergedRange(e,t,i,l=!0){let s=this._g,o=e.cellType,n=e.columns,r=e.rows,a=r[t],h=n[i];if(a instanceof _NewRowTemplate)return null;if(!(a instanceof Row&&h instanceof Column))return null;if(e==s.columnHeaders){let l=s._getColumnGroup(t,i);if(l){let t=l._rng,s=e.columns;if(s.isFrozen(t.col)!=s.isFrozen(t.col2)){t=t.clone();s.isFrozen(i)?t.col2=s.frozen-1:t.col=s.frozen}return t}}if(s.showGroups&&!s.childItemsPath&&a instanceof GroupRow&&a.dataItem instanceof CollectionViewGroup&&o==CellType.Cell){let e=new CellRange(t,i);if(h.aggregate==Aggregate.None){for(;e.col>0&&n[e.col-1].aggregate==Aggregate.None&&e.col!=n.frozen;)e.col--;for(;e.col2<n.length-1&&n[e.col2+1].aggregate==Aggregate.None&&e.col2+1!=n.frozen;)e.col2++}for(;e.col<i&&!n[e.col].visible;)e.col++;return e.isSingleCell?null:e}let d=!1,c=AllowMerging,g=CellType;switch(s.allowMerging){case c.None:d=!0;break;case c.Cells:d=o!=g.Cell;break;case c.ColumnHeaders:d=o!=g.ColumnHeader&&o!=g.TopLeft;break;case c.RowHeaders:d=o!=g.RowHeader&&o!=g.TopLeft;break;case c.AllHeaders:d=o==g.Cell}if(d)return null;if(n[i].allowMerging){let n=new CellRange(t,i),a=e._vrb,h=0,d=r.length-1;if(t>=r.frozen){if(l&&(o==CellType.Cell||o==CellType.RowHeader)&&s._vtRows<r.length&&a){h=a.topRow;d=a.bottomRow}}else r.length>r.frozen&&(d=r.frozen-1);for(let l=t-1;l>=h&&this._mergeCell(e,l,i,t,i);l--)n.row=l;for(let l=t+1;l<=d&&this._mergeCell(e,t,i,l,i);l++)n.row2=l;for(;n.row<t&&!r[n.row].visible;)n.row++;if(!n.isSingleCell)return n}if(r[t].allowMerging){let r=new CellRange(t,i),a=e._vrb,h=0,d=n.length-1;if(i>=n.frozen){if(l&&(o==CellType.Cell||o==CellType.ColumnHeader)&&s._vtCols<n.length&&a){h=a.leftCol;d=a.rightCol}}else d=n.frozen-1;for(let l=i-1;l>=h&&this._mergeCell(e,t,l,t,i);l--)r.col=l;for(let l=i+1;l<=d&&this._mergeCell(e,t,i,t,l);l++)r.col2=l;for(;r.col<i&&!n[r.col].visible;)r.col++;if(!r.isSingleCell)return r}return null}_mergeCell(e,t,i,l,s){let o=e.rows[t],n=e.rows[l];if(!o||!n)return!1;if(o instanceof GroupRow||o instanceof _NewRowTemplate||n instanceof GroupRow||n instanceof _NewRowTemplate)return!1;if(t!=l&&e.rows.isFrozen(t)!=e.rows.isFrozen(l))return!1;if(i!=s&&e.columns.isFrozen(i)!=e.columns.isFrozen(s))return!1;if(t!=l){if(i>0&&(o.allowMerging&&this._mergeCell(e,t,i-1,t,i)||n.allowMerging&&this._mergeCell(e,l,i-1,l,i)))return!1;if(s<e.columns.length-1&&(o.allowMerging&&this._mergeCell(e,t,s,t,s+1)||n.allowMerging&&this._mergeCell(e,l,s,l,s+1)))return!1}return e.getCellData(t,i,!0)==e.getCellData(l,s,!0)}}export class HitTestInfo{constructor(e,t){this._row=-1;this._col=-1;this._edge=0;let i;if(t instanceof Element){if(closest(t,".wj-flexgrid")!=e.hostElement)return;e=t;this._target=t}if(e instanceof Element&&!(e instanceof FlexGrid)){let t=closest(e,".wj-cell"),i=t?t[GridPanel._INDEX_KEY]:null;if(i){this._target=e;this._row=i.row;this._col=i.col;this._rng=i.rng;this._p=i.panel;this._g=i.panel.grid}return}if(e instanceof FlexGrid){this._target=e.hostElement;i=this._g=e}else{if(!(e instanceof GridPanel))throw"First parameter should be a FlexGrid or GridPanel.";this._target=e.hostElement;this._p=e;i=this._g=this._p.grid}if(t instanceof MouseEvent){this._target=t.target;"mousedown"==t.type&&(i._rcBounds=null)}t=mouseToPage(t);this._pt=t.clone();let l=i.controlRect,s=i._szClient,o=i.topLeftCells,n=i._eTL,r=i.headersVisibility,a=HeadersVisibility,h=r&a.Row?o.columns.getTotalSize():0,d=r&a.Column?o.rows.getTotalSize():0,c=r&a.Column?d+n.offsetTop:0,g=i._eBL,u=g.offsetHeight;t.x-=l.left;t.y-=l.top;i.rightToLeft&&(t.x=l.width-t.x);this._p||t.x>=0&&t.y>=n.offsetTop&&s&&t.x<=s.width+h&&t.y<=s.height+d&&(t.y<c?this._p=t.x<h?i.topLeftCells:i.columnHeaders:t.y<g.offsetTop?this._p=t.x<h?i.rowHeaders:i.cells:this._p=t.x<h?i.bottomLeftCells:i.columnFooters);if(null!=this._p){let e=this._p.rows,l=this._p.columns,s=this._p.cellType,o=CellType,n=this._p._getFrozenPos(),r=s==o.TopLeft||s==o.ColumnHeader?d:s==o.BottomLeft||s==o.ColumnFooter?u:e.getTotalSize(),a=s==o.TopLeft||s==o.BottomLeft||s==o.RowHeader?h:l.getTotalSize();if(s==o.RowHeader||s==o.Cell){t.y-=d;if(t.y>n.y||n.y<=0){t.y-=i._ptScrl.y;t.y+=this._p._getOffsetY()}}else s!=o.BottomLeft&&s!=o.ColumnFooter||(t.y-=g.offsetTop);if(s==o.ColumnHeader||s==o.Cell||s==o.ColumnFooter){t.x-=h;(t.x>n.x||n.x<=0)&&(t.x-=i._ptScrl.x)}s!=o.ColumnHeader&&s!=o.TopLeft||(t.y-=c-d);this._edge=0;let _=HitTestInfo._SZEDGE[this._g.isTouching?1:0];if(this._g.isTouching){_=HitTestInfo._SZEDGE[1];t.x-=_/2}this._row=t.y>r?-1:e.getItemAt(t.y);this._col=t.x>a?-1:l.getItemAt(t.x);if(this._row<0||this._col<0){this._p=null;return}if(this._col>-1){let e=l[this._col];t.x-e.pos<=_&&(this._edge|=1);let i=e.pos+e.renderSize-t.x;if(i<=_){this._edge|=4;i<=_/2&&(this._edge|=16)}}if(this._row>-1){let i=e[this._row];t.y-i.pos<=_&&(this._edge|=2);let l=i.pos+i.renderSize-t.y;if(l<=_){this._edge|=8;l<=_/2&&(this._edge|=32)}}}}get point(){return this._pt}get cellType(){return this._p?this._p.cellType:CellType.None}get panel(){return this._p}get grid(){return this._p?this._p.grid:null}get row(){return this._row}getRow(){return this._p&&this._row>-1?this._p.rows[this._row]:null}get col(){return this._col}getColumn(e){let t=this._p,i=t&&this._col>-1?t.columns[this._col]:null;i&&e&&(i=this._g._getBindingColumn(t,this._row,i));return i}get range(){this._rng||(this._rng=new CellRange(this._row,this._col));return this._rng}get edgeLeft(){return 0!=(1&this._edge)}get edgeTop(){return 0!=(2&this._edge)}get edgeRight(){return 0!=(4&this._edge)}get edgeFarRight(){return 0!=(16&this._edge)}get edgeBottom(){return 0!=(8&this._edge)}get edgeFarBottom(){return 0!=(32&this._edge)}get target(){return this._target}}HitTestInfo._SZEDGE=[6,30];export function softInput(){return _getModule("wijmo.input")}export class CellFactory{updateCell(e,t,i,l,s,o){let n=e.grid,r=n.rightToLeft,a=e.rows,h=e.columns,d=a[t],c=h[i],g=t,u=i,_=d instanceof GroupRow?d:null,p=d instanceof _NewRowTemplate?d:null,f=c.renderWidth,w=d.renderHeight,C=e.cellType,m="wj-cell",R="",E={display:""},y=CellType;0!=o&&l.firstElementChild&&(1==l.childNodes.length&&"checkbox"==l.firstElementChild.type||(l.textContent=""));if(s&&!s.isSingleCell){t=s.row;i=s.col;g=s.row2;u=s.col2;d=a[t];c=h[i];_=d instanceof GroupRow?d:null;let l=s.getRenderSize(e);w=l.height;f=l.width}let v=n._getBindingColumn(e,t,c),S=v.dataType||d.dataType,b=v.dataMap||d.dataMap,x=b&&C==y.Cell?n._getMapEditor(d,v):null,H=C==y.Cell&&(!_||n.childItemsPath),z=H&&x==DataMapEditor.RadioButtons,M=S==DataType.Boolean&&!b,T=c.pos,A=d.pos,D=n._ptScrl;if(n._useFrozenDiv()&&C==y.Cell&&!n.editRange)i<h.frozen&&g>=a.frozen?A+=D.y:t<a.frozen&&u>=h.frozen&&(T+=D.x);else{let e=n._szClient;if(g<a.frozen){A=Math.min(A,e.height);w=Math.min(w,Math.max(0,e.height-A));A-=D.y}if(u<h.frozen){T=Math.min(T,e.width);f=Math.min(f,Math.max(0,e.width-T));T-=D.x}}r?E.right=T+"px":E.left=T+"px";g>=a.frozen&&(A-=e._getOffsetY());E.top=A+"px";E.width=f+"px";E.height=w+"px";E.zIndex="";(t<a.frozen||i<h.frozen)&&(E.zIndex=t<a.frozen&&i<h.frozen?2:1);let I=!1,L=n.alternatingRowStep;if(L&&(!s||s.row==s.row2)){I=d.visibleIndex%(L+1)==0;1==L&&(I=!I)}if(C==y.Cell){_&&(m+=" wj-group");I&&(m+=" wj-alt");(t<a.frozen||i<h.frozen)&&(m+=" wj-frozen");p&&(m+=" wj-new");d.cssClass&&(m+=" "+d.cssClass);v.cssClass&&(m+=" "+v.cssClass)}else{m+=" wj-header";I&&(m+=" wj-header-alt");let t=!1;C!=y.ColumnHeader&&C!=y.TopLeft||n.allowResizing&AllowResizing.Columns&&(t=null!=n._mouseHdl._getResizeCol(e,u));t||C!=y.RowHeader||n.allowResizing&AllowResizing.Rows&&(t=null!=n._mouseHdl._getResizeRow(e,g));t&&(m+=" wj-big-header")}d.cssClassAll&&(m+=" "+d.cssClassAll);v.cssClassAll&&(m+=" "+v.cssClassAll);let F=SelectedState,P=e.getSelectedState(t,i,s);P!=F.None&&C==y.Cell&&!M&&n.editRange&&n.editRange.contains(t,i)&&(P=F.None);switch(P){case F.Active:m+=" wj-state-active";break;case F.Cursor:m+=" wj-state-selected wj-state-active";break;case F.Selected:m+=" wj-state-multi-selected"}g==a._lastFrozen&&(m+=" wj-frozen-row");u==h._lastFrozen&&(m+=" wj-frozen-col");(v.wordWrap||d.wordWrap)&&(m+=" wj-wrap");(v.multiLine||d.multiLine)&&(m+=" wj-multiline");let k=v.getAlignment(d);k&&(R=" wj-align-"+k);let B=C==y.ColumnHeader&&n._hasColumnGroups()?n._getColumnGroup(t,i):null;B&&B.align&&(R=" wj-align-"+B.align);E.paddingLeft=E.paddingRight=E.paddingTop=E.paddingBottom="";if(C==y.Cell&&n.rows.maxGroupLevel>-1&&i==h.firstVisibleIndex&&n.treeIndent){let e=_?Math.max(0,_.level):a.maxGroupLevel+1,t=Math.min(n.treeIndent*e+n._cellPadLeft,f-n._cellPadHorz)+"px";r?E.paddingRight=t:E.paddingLeft=t}f<=n._cellPadHorz&&(E.paddingLeft=E.paddingRight=0);if(0!=o){let s=e.getCellData(t,i,!1),o=e.getCellData(t,i,!0);if(C==y.Cell&&i==h.firstVisibleIndex&&_&&_.hasChildren&&!_isEditingCell(n,t,i)){let e=_getTreeBtn(_);o=escapeHtml(o)||_.getGroupHeader();l.innerHTML=e.outerHTML+" "+o;R=""}else if(C!=y.ColumnHeader||g!=n._getSortRowIndex()&&v==c)if(C!=y.RowHeader||i!=n._getEditColumnIndex()||o)if(C!=y.Cell||S!=DataType.Boolean||b||_&&!isBoolean(s))if(C==y.Cell&&!z&&_isEditingCell(n,t,i)){let s=v.inputType||d.inputType;s||(s=S!=DataType.Number||b?"text":"tel");if(!b&&!v.mask&&!d.mask){let l=e.getCellData(t,i,!1);if(isNumber(l)){let e=v.format||d.format,t=l.toString();if(e&&l!=Math.round(l)){let i=t.indexOf("e")<0?t.match(/\.(\d+)/)[1].length:20;e=e.replace(/([a-z])(\d*)(.*)/gi,"$01"+i+"$3")}o=Globalize.formatNumber(l,e,!0)}}l.innerHTML=(v.multiLine||d.multiLine)&&"checkbox"!=s?'<textarea wrap="soft"></textarea>':'<input type="'+s+'"/>';let r=l.children[0];addClass(r,"wj-grid-editor wj-form-control");disableAutoComplete(r);r.value=v.isContentHtml||d.isContentHtml?toPlainText(o):o;r.tabIndex=-1;r.required=v.getIsRequired(d);setAttribute(r,"aria-required",r.required);let a=v.maxLength||d.maxLength;a&&(r.maxLength=a);r.style.textAlign=v.getAlignment(d);let h=v.mask||d.mask;h&&new _MaskProvider(r,h);n.showPlaceholders&&(r.placeholder=v.header);n._edtHdl._edt=r}else{if(z){let s=[],o=e.getCellData(t,i,!1);b.getDisplayValues(d.dataItem).forEach(e=>{let t=b.getKeyValue(e)==o?" checked":"",i=n.isReadOnly||d.isReadOnly||c.isReadOnly?" disabled":"";s.push('<label><input type="radio" tabindex="-1"'+t+i+"><span>"+escapeHtml(e)+"</span></label>")});l.innerHTML=s.join(" ");m+=" "+CellFactory._WJC_RADIOMAP}let r=H?v._tpl:null;if(r){let e=CellFactory._tplCtx;e.value=s;e.text=o;e.item=d.dataItem;e.row=d;e.col=v;let t=isString(r)?evalTemplate(r,e):r(e,l);null==t||z||(l.innerHTML=t)}else z||(C==y.Cell&&(d.isContentHtml||v.isContentHtml)?l.innerHTML=o:l.textContent=o||"");if(B&&B.collapseTo){let e=B._rng;if(e&&e.columnSpan>1){let e=B.isCollapsed;l.innerHTML='<div role="button" class="'+CellFactory._WJC_COLLAPSE+'">'+_getGlyph(e?"plus":"minus")+"</div>&nbsp;"+l.innerHTML;e&&addClass(l,"wj-state-collapsed")}}}else{let e=l.firstChild;if(!n._isNativeCheckbox(e)){l.innerHTML='<label><input type="checkbox" class="'+CellFactory._WJC_CHECKBOX+'" tabindex="-1"/><span></span></label>';e=l.querySelector("input")}setChecked(e,s);e.disabled=!n.canEditCell(t,i);e.disabled&&(e.style.cursor="default");n.editRange&&n.editRange.contains(t,i)&&(n._edtHdl._edt=e)}else{let e=n.editableCollectionView,t=e?e.currentEditItem:null;l.innerHTML=t&&d.dataItem==t?_getGlyph("pencil"):d instanceof _NewRowTemplate?_getGlyph("asterisk"):""}else{l.innerHTML=escapeHtml(o);let e=v.currentSort;if(e&&n.showSort){m+=" wj-sort-"+("+"==e?"asc":"desc");l.innerHTML+="&nbsp;"+_getSortGlyph(v)}n.allowPinning&&contains(n.hostElement,l)&&_addPinButton(l,i<n.frozenColumns)}if(x==DataMapEditor.DropDownList&&n.showDropDown&&n.canEditCell(t,i)&&softInput()){let e=_getDropDownBtn();l.insertBefore(e,l.firstChild);_isEditingCell(n,t,i)&&(m+=" wj-hasdropdown")}}if(C==y.RowHeader||C==y.ColumnHeader){let e=C==y.RowHeader?!_&&!p&&d.allowDragging&&0!=(n.allowDragging&AllowDragging.Rows):c.allowDragging&&0!=(n.allowDragging&AllowDragging.Columns);setAttribute(l,"draggable",e?"true":null)}m+=R;l.className!=m&&(l.className=m);let N=l.style;for(let e in E)N[e]!==E[e]&&(N[e]=E[e]);if(n._edtHdl._edt&&n._edtHdl._edt.parentElement==l){let e=n._root,t=e.getBoundingClientRect(),i=l.getBoundingClientRect(),s=t.top+e.clientHeight-i.top,o=t.left+e.clientWidth-i.left;i.height>s&&(l.style.height=s+"px");i.width>o&&(l.style.width=o+"px")}if((C==y.Cell||C==y.RowHeader)&&n._getShowErrors()){let s=n._getError(e,t,i);n._edtHdl._setCellError(l,s)}n.itemFormatter&&n.itemFormatter(e,t,i,l);if(n.formatItem.hasHandlers){let s=CellFactory._fmtRng;s?s.setRange(t,i,g,u):s=CellFactory._fmtRng=new CellRange(t,i,g,u);let o=new FormatItemEventArgs(e,s,l);n.onFormatItem(o)}}disposeCell(e){}getEditorValue(e){let t=e._edtHdl._edt;if(t instanceof HTMLInputElement&&"checkbox"==t.type)return t.checked;if(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement){let e=t.value,i=t.maxLength;isNumber(i)&&i>-1&&e.length>i&&(e=e.substr(0,i));return e}return null}}CellFactory._WJC_RADIOMAP="wj-radio-map";CellFactory._WJC_CHECKBOX="wj-cell-check";CellFactory._WJC_COLLAPSE="wj-elem-collapse";CellFactory._WJC_DROPDOWN="wj-elem-dropdown";CellFactory._WJC_PIN="wj-elem-pin";CellFactory._tplDdBtn=_getButton(CellFactory._WJC_DROPDOWN,"down");CellFactory._tplCtx={row:null,col:null,value:null,text:null,item:null};function _isEditingCell(e,t,i){return e.editRange&&e.editRange.contains(t,i)}function _getDropDownBtn(){let e=CellFactory._ddBtn;if(!e){e=CellFactory._ddBtn=createElement(CellFactory._tplDdBtn);setAriaLabel(e,culture.FlexGrid.ariaLabels.toggleDropDown);setAttribute(e,"aria-expanded",!1)}return e.cloneNode(!0)}function _addPinButton(e,t){let i=_getButton(CellFactory._WJC_PIN,"pin"),l=createElement(i);toggleClass(l,"wj-state-pinned",t);setAttribute(l,"aria-pressed",t);e.insertBefore(l,e.firstChild)}function _getSortGlyph(e){let t=_getGlyph("+"==e.currentSort?"up":"down"),i=e.grid.collectionView;if(i&&i.sortDescriptions.length>1){let i=e.currentSortIndex;i>-1&&(t+='<span class="wj-sort-index">'+(i+1)+"</span>")}return t}function _getTreeBtn(e){let t=CellFactory._WJC_COLLAPSE,i=(e.isCollapsed?"":"down-")+(e.grid.rightToLeft?"left":"right"),l=createElement('<button class="wj-btn wj-btn-glyph '+t+'" type="button" tabindex="-1">'+_getGlyph(i)+"</button>");setAriaLabel(l,culture.FlexGrid.ariaLabels.toggleGroup);setAttribute(l,"aria-expanded",!e.isCollapsed);return l}function _getGlyph(e){return'<span class="wj-glyph-'+e+'"></span>'}function _getButton(e,t){return'<button class="wj-btn wj-btn-glyph wj-right {cls}" type="button" tabindex="-1">{glyph}</button>'.replace("{cls}",e).replace("{glyph}",_getGlyph(t))}const _LB_PAGE_SIZE=4;export class _EditHandler{constructor(e){this._fullEdit=!1;this._list=null;this._g=e;this._evtInput=document.createEvent("HTMLEvents");this._evtInput.initEvent("input",!0,!1);this._evtChange=document.createEvent("HTMLEvents");this._evtChange.initEvent("change",!0,!1);e.selectionChanging.addHandler((t,i)=>{if(this.finishEditing()){let t=e._selHdl.selection.row;if(t!=i.row){let l=e.rows.length;(t>-1&&t<l?e.rows[t].dataItem:null)!=(i.row>-1&&i.row<l?e.rows[i.row].dataItem:null)&&this._commitRowEdits()}}else i.cancel=!0});e.lostFocus.addHandler(()=>{let e=getActiveElement();e&&"fixed"==getComputedStyle(e).position?this.finishEditing():this._commitRowEdits()});let t=e.hostElement;e.addEventListener(t,"mousedown",t=>{if(t.defaultPrevented||0!=t.button)return;if(e._mouseHdl._szRowCol)return;let i=e.hitTest(t);i.cellType!=CellType.Cell&&i.cellType!=CellType.None&&(this.finishEditing()||this.finishEditing(!0))},!0);e.addEventListener(t,"compositionend",this._keypress.bind(this))}startEditing(e=!0,t,i,l,s){let o=this._g,n=o._selHdl.selection;t=asNumber(t,!0,!0);i=asNumber(i,!0,!0);null==t&&(t=n.row);null==i&&(i=n.col);null==l&&(l=!0);if(!this._allowEdit(t,i))return!1;let r=o.getMergedRange(o.cells,t,i,!1);r||(r=new CellRange(t,i));let a=o.rows[t].dataItem;o.scrollIntoView(r.row,r.col,!0);if(!o.select(r,!0))return!1;if(!o.rows[t]||a!=o.rows[t].dataItem)return!1;if(r.equals(this._rng))return!0;if(this.activeEditor&&!this.finishEditing())return!1;let h=new CellRangeEventArgs(o.cells,r,s);if(!o.onBeginningEdit(h))return!1;let d=o.editableCollectionView,c=!1;if(d){(c=(a=o.rows[t].dataItem)!=d.currentEditItem)&&o.onRowEditStarting(h);d.editItem(a);if(c){o.onRowEditStarted(h);this._edItem=a}}let g=o.rows[t],u=o._getBindingColumn(o.cells,t,o.columns[i]),_=u.dataMap||g.dataMap,p=DataMapEditor.RadioButtons,f=g.dataMap&&g.dataMapEditor==p||u.dataMap&&u.dataMapEditor==p;this._fullEdit=asBoolean(e);this._rng=r;this._list=null;if(_&&!f&&!u.editor){let e=_.getDisplayValues(a);(u.isContentHtml||g.isContentHtml)&&(e=e.map(e=>toPlainText(e)));this._list=e}if(f){let e=o._activeCell||o.hostElement.querySelector(".wj-cell.wj-state-active");if(e){this._edt=e.querySelector("input");this._updateRowHeaderCell(t)}}else r.isSingleCell?this._updateEditorCell(t,i,c):o.refresh(!1);let w=this._edt;if(w){if("checkbox"==w.type||"radio"==w.type)this._fullEdit=!1;else if(l){let e=0,l=w.value.length,n=!1,r=culture.Globalize.numberFormat["%"]||"%",a=o.getCellData(t,i,!1);isNumber(a)?n=w.value.indexOf(r)>-1:null==a&&(n=/^p/i.test(u.format))&&w.value.indexOf(r)<0&&(w.value+=r);if(n){let t=w.value;e=0;l=t.length;for(;l>0&&(t[l-1]==r||" "==t[l-1]);)l--;for(;e<l&&t[e]==r;)e++}s&&"keydown"==s.type&&s.keyCode==Key.Space&&(e=l);setSelectionRange(w,e,l);isIE()&&"right"==w.style.textAlign&&(w.style.paddingRight="1px")}o.onPrepareCellForEdit(h)}return null!=w&&!w.disabled&&!w.readOnly}finishEditing(e){let t=this._edt;if(!t){this._removeListBox();return!0}let i=this._g,l=this._rng,s=new CellEditEndingEventArgs(i.cells,l),o=i.containsFocus(),n=i.hostElement.querySelector(".wj-control.wj-state-focused");if(n){let e=Control.getControl(n);e&&e.onLostFocus(s)}s.cancel=e;if(!e&&i.validateEdits){let e=this._getValidationError();if(e){s.cancel=!0;let t=i.cells.getCellElement(l.row,l.col);if(t){this._setCellError(t,e);s.stayInEditMode=!0}}}this._cstEdtValue=null;if(!i.onCellEditEnding(s)&&s.stayInEditMode){o?setTimeout(()=>{t.select()}):t.select();this._fullEdit=!0;return!1}if(!s.cancel){s.data=i.cells.getCellData(l.topRow,l.leftCol,!1);let e=this._cstEdtValue,o=e&&!isUndefined(e.value)?e.value:i.cellFactory.getEditorValue(i);for(let e=l.topRow;e<=l.bottomRow&&e<i.rows.length;e++)for(let n=l.leftCol;n<=l.rightCol&&n<i.columns.length;n++){if(!i.cells.setCellData(e,n,o,!0,!1)&&i.validateEdits){let e=this._getValidationError(!0);if(e){s.cancel=!0;let i=closest(t,".wj-cell");if(i){this._setCellError(i,e);s.stayInEditMode=!0}return!1}}}t.value==this._edtValue&&t.dispatchEvent(this._evtChange)}this._edt=null;this._rng=null;this._list=null;this._edtValue=null;this._removeListBox();let r=closest(t,".wj-cell");contains(r,getActiveElement())&&i._setFocusNoScroll(r);!s.cancel&&s.refresh&&i._refreshOnEdit?i.refresh(!1):this._updateEditorCell(l.row,l.col,!1);o&&i.focus();i.onCellEditEnded(s);return!0}_setCustomEditorValue(e){this._cstEdtValue={value:e}}_setCellError(e,t){""==t&&(t=null);toggleClass(e,"wj-state-invalid",null!=t);let i=this._g.errorTip;i?i.setTooltip(e,t):setAttribute(e,"title",t)}get activeEditor(){return this._edt}get editRange(){return this._rng}getClipString(e,t,i,l){let s,o=this._g,n=o.selectionMode,r=[],a=0!=(t&ClipStringOptions.CSV),h=a?"\r\n":"\n",d=a?",":"\t",c=0!=(t&ClipStringOptions.InvisibleRows),g=SelectionMode;if(!e&&n!=g.ListBox){let e=o.rows;for(let t=0;t<e.length;t++)if(e[t].isSelected){n=g.ListBox;break}}if(!e){o._selHdl._expandSelection();e=o.selection;switch(n){case g.Row:case g.RowRange:case g.ListBox:e.col=0;e.col2=o.columns.length-1;break;case g.MultiRange:let s=o.selectedRanges;if(s.length>1){let e=this._sameCols(s),o=this._sameRows(s);if(e||o){(s=s.slice()).sort((e,t)=>{let i=e.topRow-t.topRow;return i||e.leftCol-t.leftCol});for(let e=0;e<s.length;e++){let t=s[e];for(let i=e+1;i<s.length;i++)if(t.contains(s[i])){s.splice(i,1);i--}}if(e){let e=[];s.forEach(s=>{e.push(this.getClipString(s,t,i,l));i=!1});return e.join(h)}if(o){let e;s.forEach(s=>{let o=this.getClipString(s,t,i,l).split(h);if(null==e){e=o;l=!1}else o.forEach((t,i)=>{e[i]+=d+t})});return e.join(h)}}}}}i&&(s=o.columnHeaders).rows.forEach((i,o)=>{if(c||i.isVisible){let i=this._getRowClipString(s,o,e,t,l);r.push(i)}});s=o.cells;if(n==g.ListBox)s.rows.forEach((i,o)=>{if(i.isSelected&&(c||i.isVisible)){let i=this._getRowClipString(s,o,e,t,l);r.push(i)}});else for(let i=e.topRow;i<=e.bottomRow;i++)if(c||s.rows[i].isVisible){let o=this._getRowClipString(s,i,e,t,l);r.push(o)}return r.join(h)}_getRowClipString(e,t,i,l,s){let o=[],n=e.rows[t],r=ClipStringOptions,a=0!=(l&r.CSV),h=0!=(l&r.InvisibleColumns),d=0==(l&r.Unformatted),c=0!=(l&r.SkipMerged);if(n.isVisible){if(s){let s=e.cellType==CellType.ColumnHeader?e.grid.topLeftCells:e.grid.rowHeaders;for(let n=0;n<s.columns.length;n++)if(h||s.columns[n].isVisible){let r=s.getCellData(t,n,!0);c&&this._skipMergedCell(e,i,t,n)&&(r="");o.push(this._getCellClipString(r,l))}}for(let s=i.leftCol;s<=i.rightCol;s++)if(h||e.columns[s].isVisible){let r=e.getCellData(t,s,d);!r&&n instanceof GroupRow&&s==e.columns.firstVisibleIndex&&(r=toPlainText(n.getGroupHeader()));c&&this._skipMergedCell(e,i,t,s)&&(r="");o.push(this._getCellClipString(r,l))}}return o.join(a?",":"\t")}_skipMergedCell(e,t,i,l){let s=e.grid.getMergedRange(e,i,l,!1);if(s){if(t){s.row=Math.max(t.topRow,s.row);s.col=Math.max(t.leftCol,s.col)}if(s.row!=i||s.col!=l)return!0}return!1}_getCellClipString(e,t){isString(e)||(e=isDate(e)?e.toJSON():null!=e?e.toString():"");e=e.replace(/\t/g," ");let i=0!=(t&ClipStringOptions.QuoteAll);(i=i||/\n|^"|"$/.test(e))||0==(t&ClipStringOptions.CSV)||(i=e.indexOf(",")>-1);i&&(e='"'+(e=e.replace(/"/g,'""'))+'"');return e}_sameRows(e){let t=e[0];for(let i=1;i<e.length;i++)if(e[i].topRow!=t.topRow||e[i].bottomRow!=t.bottomRow)return!1;return!0}_sameCols(e){let t=e[0];for(let i=1;i<e.length;i++)if(e[i].leftCol!=t.leftCol||e[i].rightCol!=t.rightCol)return!1;return!0}setClipString(e,t){let i=this._g,l=i.editableCollectionView,s=null==t,o=SelectionMode;if(s){i._selHdl._expandSelection();t=i.selection;switch(i.selectionMode){case o.Row:case o.RowRange:case o.ListBox:t.col=0;t.col2=i.columns.length-1;break;case o.MultiRange:let s=i.selectedRanges;if(s.length>1){l&&l.beginUpdate();s.forEach(t=>{i.setClipString(e,t)});l&&l.endUpdate();i.selectedRanges=s;return}}}t=asType(t,CellRange);let n=this._parseClipString(asString(e));!s&&n.length>t.rowSpan&&(n=n.slice(0,t.rowSpan));this._expandClipRows(n,t);let r=s?new CellRange(t.topRow,t.leftCol,t.topRow+n.length-1,t.leftCol+n[0].length-1):t,a=new CellRangeEventArgs(i.cells,r,e);if(!i.onPasting(a))return!1;r=new CellRange(t.topRow,t.leftCol);let h=!1,d=0,c=t.topRow,g=i.rows,u=i.columns,_=this._deferPaste(t,n.length);i.deferUpdate(()=>{let e=-1;if(l&&_){e=l.currentPosition;l.beginUpdate()}for(let e=0;e<n.length&&c<g.length;e++,c++){let s=g[c];if(!s.isVisible){e--;continue}let o=s.dataItem,p=l?l.currentEditItem:null;if(p&&o!=p){i.onRowEditEnding(a);i.onRowEditEnded(a)}if(o!=p){i.onRowEditStarting(a);i.onRowEditStarted(a)}s instanceof _NewRowTemplate&&l&&_&&(s.dataItem=l.addNew());let f=n[e],w=t.leftCol;for(let e=0;e<f.length&&w<u.length;e++,w++){let t=u[w];if(t.isVisible){if(this._allowEdit(c,w)){let n=f[e],a=n.length;a>1&&'"'==n[0]&&'"'==n[a-1]&&n.indexOf("\n")>-1&&(n=n.substr(1,a-2));let g=t.maxLength||s.maxLength;g&&(n=n.substr(0,g));let u=new CellRangeEventArgs(i.cells,new CellRange(c,w),n);if(i.onPastingCell(u)){if(l){l.editItem(o);this._edItem=l.currentEditItem}if(i.setCellData(c,w,u.data)){i.onPastedCell(u);h=!0}}r.row2=Math.max(r.row2,c+d);r.col2=Math.max(r.col2,w)}}else e--}if(this._edItem&&l instanceof CollectionView){let e=new NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Change,this._edItem,c);l.onCollectionChanged(e)}if(s instanceof _NewRowTemplate&&l&&_){s.dataItem=null;if(h){c--;d++;l.commitNew()}else l.cancelNew()}}if(l)if(_){l.moveCurrentToPosition(e);l.endUpdate(!0)}else{let e=l.currentAddItem;!e&&0==t.row&&i.newRowAtTop&&g[0]instanceof _NewRowTemplate&&(e=g[0].dataItem);if(e){l.editItem(e);this._edItem=e}}r.rowSpan>1&&0==r.topRow&&g[0]instanceof _NewRowTemplate&&(r.row=r.row2=0);i.select(r,!1)});i.onPasted(a);if(h&&closest(i.hostElement,"form")){let e=document.createEvent("HTMLEvents"),t=createElement("<input>",i.hostElement);e.initEvent("change",!0,!1);t.dispatchEvent(e);removeChild(t)}}_deferPaste(e,t){let i=this._g.rows;return t>1&&i.length>1&&i[0].dataItem!=i[1].dataItem}_parseClipString(e){e=(e=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n")).replace(/\n$/,"");let t=0,i=0,l=[];for(t=0;t<e.length;t++){let s='"'==e[t],o=!1,n=!1;for(i=t;i<e.length&&!n;i++){let r=e[i];switch(r){case'"':s&&(o=!o);break;case"\t":case"\n":if(!o){this._parseClipCell(l,e,t,i,"\n"==r);t=i;i==e.length-1&&(t=i+1);n=!0}}}if(i==e.length){this._parseClipCell(l,e,t,i,!1);break}}0==l.length&&l.push([""]);return l}_parseClipCell(e,t,i,l,s){e.length||e.push([]);let o=t.substr(i,l-i),n=o.length;n>2&&'"'==o[0]&&'"'==o[n-1]&&o.indexOf('""')>-1?o=(o=o.substr(1,n-2)).replace(/""/g,'"'):"\t"==o&&(o="");e[e.length-1].push(o);s&&e.push([])}_expandClipRows(e,t){let i=e.length,l=0;for(let t=0;t<i;t++)l=Math.max(l,e[t].length);let s=this._g,o=0,n=0;for(let e=t.topRow;e<=t.bottomRow;e++)s.rows[e].isVisible&&o++;for(let e=t.leftCol;e<=t.rightCol;e++)s.columns[e].isVisible&&n++;if(o>1||n>1){1==o&&(o=i);1==n&&(n=l);if(n%l==0&&o%i==0){for(let t=l;t<n;t++)for(let s=0;s<i;s++)e[s].push(e[s%i][t%l]);for(let t=i;t<o;t++)e.push(e[t%i])}}}_updateEditorCell(e,t,i){let l=this._g,s=l.cells.getCellElement(e,t),o=l._useFrozenDiv()&&(e<l.frozenRows||t<l.frozenColumns);if(!s||o||l._hasPendingUpdates())l.refresh(!1);else if(l.onUpdatingView(new CancelEventArgs)){this._updateCell(s);(i||l._getHasValidation())&&this._updateRowHeaderCell(e);l.onUpdatedView()}}_updateRowHeaderCell(e){let t=this._g;if(t.headersVisibility&HeadersVisibility.Row){let i=t.rowHeaders,l=t._getEditColumnIndex(),s=i.getCellElement(e,l);s&&this._updateCell(s)}}_updateCell(e){let t=new HitTestInfo(e,null),i=FlexGrid._WJS_UPDATING;if(t.panel){addClass(e,i);t.grid.cellFactory.updateCell(t.panel,t.row,t.col,e,t.range);removeClass(e,i)}}_getValidationError(e){let t=this._g,i="";if(t._getHasValidation()){let l=this._rng.row,s=this._rng.col,o=t.cellFactory.getEditorValue(t),n=t.getCellData(l,s,!1);if(e)i=t._getError(t.cells,l,s,!0);else{let e=t.activeEditor;e&&(i=e.validationMessage);if(!i&&t.setCellData(l,s,o,!0,!1)){i=t._getError(t.cells,l,s);t.setCellData(l,s,n,!1,!1)}}}return i}_allowEdit(e,t){let i=this._g;if(i.isReadOnly||i.selectionMode==SelectionMode.None)return!1;if(i.collectionView&&!i.editableCollectionView)return!1;if(null!=e){if(e<0||e>=i.rows.length)return!1;let t=i.rows[e];if(!t||t.isReadOnly||!t.isVisible)return!1}if(null!=t){if(t<0||t>=i.columns.length)return!1;let l=i._getBindingColumn(i.cells,e,i.columns[t]);if(!l||l.isReadOnly||!l.isVisible)return!1}return!0}_commitRowEdits(){let e=this._g;if(this.finishEditing()&&this._edItem){let t=e.editableCollectionView;if(t&&(t.currentEditItem||t.currentAddItem)){let i=new CellRangeEventArgs(e.cells,e.selection);e.onRowEditEnding(i);t.commitEdit();e.onRowEditEnded(i)}this._edItem=null}}_keydown(e){let t=this._edt;switch(e.keyCode){case Key.F2:this._fullEdit=!this._fullEdit;e.preventDefault();return!0;case Key.F4:this._toggleListBox(e);e.preventDefault();return!0;case Key.Space:if(t&&"checkbox"==t.type&&!t.disabled&&!t.readOnly){setChecked(t,t.indeterminate||!t.checked);this.finishEditing();e.preventDefault()}return!0;case Key.Enter:e.preventDefault();if(t&&e.altKey){let t=e.target;if(t instanceof HTMLTextAreaElement&&"soft"==t.wrap){let e=t.value,i=t.selectionStart,l=t.selectionEnd;t.value=e.substr(0,i)+"\n"+e.substr(l);setSelectionRange(t,i+1)}return!0}return!this.finishEditing();case Key.Tab:e.preventDefault();return!this.finishEditing();case Key.Escape:e.preventDefault();this.finishEditing(!0);return!0;case Key.Up:case Key.Down:case Key.Left:case Key.Right:case Key.PageUp:case Key.PageDown:case Key.Home:case Key.End:if(this._lbx)return this._keydownListBox(e);if(e.altKey)switch(e.keyCode){case Key.Up:case Key.Down:this._toggleListBox(e);e.preventDefault();return!0}if(!this._fullEdit&&this.finishEditing())return!1}return!0}_keydownListBox(e){let t=!0;if(this._lbx)switch(e.keyCode){case Key.Up:e.altKey?this._toggleListBox(e):this._lbx.selectedIndex>0&&this._lbx.selectedIndex--;break;case Key.Down:e.altKey?this._toggleListBox(e):this._lbx.selectedIndex++;break;case Key.Home:case Key.PageUp:this._lbx.selectedIndex=0;break;case Key.End:case Key.PageDown:this._lbx.selectedIndex=this._lbx.collectionView.items.length-1;break;default:t=!1}if(t){e.preventDefault();return!0}return!1}_keypress(e){if("AltLeft"==e.code||"AltRight"==e.code){e.preventDefault();return}let t=this._edt,i=e.charCode||32,l=this._list;if(t&&"checkbox"!=t.type&&getActiveElement()==t&&l&&l.length>0&&i>=32){let i=t.selectionStart,s=t.value.substr(0,i);if(e.target==t&&e.charCode){s+=String.fromCharCode(e.charCode);i++}let o=this._findString(l,s,!0);o<0&&(o=this._findString(l,s,!1));if(o>-1){let s=this._lbx;s&&(s.selectedIndex=o);t.value=l[o];setSelectionRange(t,i,t.value.length);t.dispatchEvent(this._evtInput);e.preventDefault&&e.preventDefault()}}}_findString(e,t,i){i||(t=t.toLowerCase());for(let l=0;l<e.length;l++){let s=e[l];if(null!=s){s=s.toString();i||(s=s.toLowerCase());if(0==s.indexOf(t))return l}}return-1}_toggleListBox(e,t){let i=this._g,l=i._selHdl.selection,s=i.isTouching;t||(t=l);if(this._lbx){this._removeListBox();if(l.intersects(t)){i.activeEditor?i.activeEditor.focus():i.containsFocus()||i.focus();return!0}}let o=i.rows[t.row],n=i._getBindingColumn(i.cells,t.row,i.columns[t.col]),r=i._getMapEditor(o,n);if(!softInput()||r!=DataMapEditor.DropDownList)return!1;if(!this.startEditing(!0,t.row,t.col,!s,e))return!1;let a=this._lbx=this._createListBox();a.showSelection();s&&a.focus();return!0}_createListBox(){let e=this._g,t=e.activeEditor,i=this._rng,l=e.rows[i.row],s=e._getBindingColumn(e.cells,i.row,e.columns[i.col]),o=s.isContentHtml||l.isContentHtml,n=s.dataMap||l.dataMap,r=s.dropDownCssClass||l.dropDownCssClass,a=document.createElement("div");this._removeListBox();addClass(a,"wj-dropdown-panel wj-grid-listbox");addClass(a,r);let h=t?t.value:e.getCellData(i.row,i.col,!0),d=new mInput.ListBox(a,{maxHeight:l.renderHeight*_LB_PAGE_SIZE,isContentHtml:o,itemsSource:n.getDisplayValues(l.dataItem),selectedValue:h});d.addEventListener(d.hostElement,"click",()=>{this._removeListBox();e.focus();this.finishEditing()});d.lostFocus.addHandler(()=>{this._removeListBox()});d.selectedIndexChanged.addHandler(()=>{let t=e.activeEditor;if(t){t.value=this._list[d.selectedIndex];t.dispatchEvent(this._evtInput);setSelectionRange(t,0,t.value.length)}});let c=e.cells.getCellElement(i.row,i.col);if(c){showPopup(a,c,!1,!1,!1);let e=c.querySelector("."+CellFactory._WJC_DROPDOWN);setAttribute(e,"aria-expanded",!0)}else{showPopup(a,e.getCellBoundingRect(i.row,i.col));a[Control._OWNR_KEY]=e.hostElement}return d}_removeListBox(){let e=this._lbx;if(e){this._lbx=null;hidePopup(e.hostElement,()=>{e.dispose()})}}}export class _CustomEditor{constructor(e,t){this._col=asType(e,Column);this._ctl=t;this._tbx=t.hostElement.querySelector("input");assert(this._col instanceof Column,"Invalid Column");assert(this._ctl instanceof Control,"Invalid edit control");assert(this._tbx instanceof HTMLInputElement,"Input element not found in editor");let i=this._ctl;this._prop=isUndefined(i.value)?isUndefined(i.checkedItems)?isUndefined(i.text)?null:"text":"checkedItems":"value";assert(null!=this._prop,"value, text properties not found in editor");let l=softInput();if(l){this._isDropDown=i instanceof l.DropDown;this._isComboBox=i instanceof l.ComboBox;this._isAutoComplete=i instanceof l.AutoComplete;this._isInputDateTime=i instanceof l.InputDateTime}this._updateFocusBnd=this._updateFocus.bind(this);this._keypressBnd=this._keypress.bind(this);this._keydownBnd=this._keydown.bind(this);this._cmpstartBnd=this._cmpstart.bind(this);this._mousedownBnd=this._mousedown.bind(this);this._hideEditor();this._updateFocus();this._connect();this._col.gridChanged.addHandler(this._connect,this)}get grid(){return this._g}get column(){return this._col}get control(){return this._ctl}dispose(){this._disconnect();this._isDropDown&&(this._isDropDown=!1);this._g=this._col=this._ctl=this._tbx=null}_connect(){if(this._col.grid!=this._g){this._disconnect();let e=this._col.grid;if(e){let t=e.hostElement,i=e.addEventListener.bind(e),l=this._updateFocusBnd;this._g=e;i(t,"keydown",this._keydownBnd,!0);i(t,"keypress",this._keypressBnd,!0);i(t,"mousedown",this._mousedownBnd,!0);i(t,"mouseup",l,!0);i(t,"blur",l,!0);i(t,"focus",l);i(this._tbx,"compositionstart",this._cmpstartBnd);e.selectionChanged.addHandler(l,this);e.prepareCellForEdit.addHandler(this._prepareCellForEdit,this);e.cellEditEnding.addHandler(this._cellEditEnding,this);e.cellEditEnded.addHandler(this._cellEditEnded,this);let s=this._col;e.showDropDown&&this._isDropDown&&(s.cellTemplate||(s.cellTemplate=CellFactory._tplDdBtn+" ${text}"))}}}_disconnect(){let e=this._g;if(e){let t=e.hostElement,i=e.removeEventListener.bind(e),l=this._updateFocusBnd;i(t,"keydown",this._keydownBnd);i(t,"keypress",this._keypressBnd);i(t,"mousedown",this._mousedownBnd);i(t,"mouseup",l);i(t,"blur",l);i(t,"focus",l);i(this._tbx,"compositionstart",this._cmpstartBnd);e.selectionChanged.removeHandler(l,this);e.prepareCellForEdit.removeHandler(this._prepareCellForEdit,this);e.cellEditEnding.removeHandler(this._cellEditEnding,this);e.cellEditEnded.removeHandler(this._cellEditEnded,this);let s=this._col,o=s.cellTemplate;isString(o)&&0==o.indexOf(CellFactory._tplDdBtn)&&(s.cellTemplate=null);this._g=null}}_prepareCellForEdit(e,t){if(!t.cancel&&t.getColumn(!0)==this._col){let e=this.grid,i=this._ctl,l=this._tbx,s=this._prop,o=t.range,n=t.data,r=n?n.type:"",a=e.getCellData(o.row,o.col,"text"==s),h=!1;this._isAutoComplete&&(i._oldText="");null==a&&i.isRequired||(i[s]=a);switch(r){case"keydown":case"mousedown":if(isUndefined(n.keyCode)||n.keyCode==Key.F4||n.altKey){h=this._isDropDown;if(this._isComboBox&&(null==a||isString(a))){let e=i.collectionView,t=-1;if(e){if(this._isAutoComplete&&(e.filter||i._rxHighlight)){i._rxHighlight=null;e.filter=null}i.selectedIndex=-1;t=a?i._findNext(a,1):-1}i.selectedIndex=t}}}e.showPlaceholders&&!i.placeholder&&(l.placeholder=this._col.header);this._showEditor();e._edtHdl._fullEdit=!0;if(n instanceof KeyboardEvent&&32==n.keyCode){setSelectionRange(l,l.value.length);n.preventDefault()}if(isIE())if("keypress"==r&&n.key){setTimeout(()=>{l.value=n.key;setSelectionRange(l,1);let e=document.createEvent("HTMLEvents");e.initEvent("input",!0,!1);l.dispatchEvent(e)});n.preventDefault()}else if("compositionstart"==r){let e=l.value.length;setSelectionRange(l,e)}if(h){this._isInputDateTime&&i._setDropdown(i._ddDate);i.isDroppedDown=!0}}}_cellEditEnding(e,t){if(!t.cancel&&t.getColumn(!0)==this._col){let e=this.grid,i=this._ctl,l=this._prop;if(this._isAutoComplete){let e=i.selectedIndex;if(isNumber(e)&&e<0){let e=i.collectionView;e&&1==e.items.length?i.selectedIndex=0:t.cancel=!0}}!t.cancel&&l&&e._edtHdl._setCustomEditorValue(i[l])}}_cellEditEnded(e,t){this._hideEditor();this._updateFocus()}_cmpstart(e){isIE()?setTimeout(()=>{this._activateEditor(e)}):this._activateEditor(e)}_keypress(e){e.defaultPrevented||this.grid.activeEditor||!contains(e.target,this._tbx)||e.ctrlKey||e.altKey||e.metaKey||27==e.keyCode||this._activateEditor(e)}_keydown(e){if(!e.defaultPrevented&&contains(e.target,this._tbx))if(this.grid.activeEditor){if(e.keyCode==Key.Enter&&this._isDropDown){let t=this._ctl;if(t.isDroppedDown){t.isDroppedDown=!1;e.preventDefault();e.stopImmediatePropagation()}}}else if(this._isDropDown){let t=e.keyCode;switch(t){case Key.F4:case Key.Up:case Key.Down:if(t==Key.F4||e.altKey){this._activateEditor(e);e.preventDefault()}}}}_mousedown(e){if(!e.defaultPrevented&&0==e.button&&!e.shiftKey&&!e.ctrlKey&&!e.metaKey&&this._isDropDown&&closestClass(e.target,CellFactory._WJC_DROPDOWN)){let t=this.grid,i=t.hitTest(e);if(i.getColumn(!0)==this._col){t.select(i.range);this._activateEditor(e);e.preventDefault()}}}_activateEditor(e){let t=this.grid;if(!t.activeEditor){let i=t._selHdl.selection;if(i.isValid)return t.startEditing(!0,i.row,i.col,!0,e)}return!1}_showEditor(){let e=this.grid,t=e.activeEditor,i=closest(t,".wj-cell");if(i){let l=this._tbx,s=this._ctl.hostElement;setCss(s,_CustomEditor._cssVisible);toggleClass(l,"wj-grid-ime",!1);i.innerHTML="";i.appendChild(s);e._edtHdl._edt=l;l.select();l.focus();t.value=""}}_hideEditor(){let e=this.grid,t=this._ctl.hostElement,i=this._tbx;this._isDropDown&&(this._ctl.isDroppedDown=!1);i.setCustomValidity("");i.blur();i.value="";setCss(t,_CustomEditor._cssHidden);toggleClass(i,"wj-grid-ime",!0);e&&t.parentElement!=e._root&&e._root.appendChild(t)}_updateFocus(){let e=this.grid;if(e&&!e.activeEditor){let t=e.hostElement,i=".wj-flexgrid",l=this._tbx;if(closest(getActiveElement(),i)==t)if(closest(l,i)!=t)this._hideEditor();else{if(e._selHdl.selection.col==this._col.index){l.tabIndex=0;l.select();l.focus()}else l.tabIndex=-1}}}}_CustomEditor._cssHidden={position:"fixed",left:-32e3,top:-32e3,width:"1px",height:"1px",overflow:"hidden",border:"none"};_CustomEditor._cssVisible={position:"absolute",left:0,top:0,width:"100%",height:"100%"};export var KeyAction;!function(e){e[e.None=0]="None";e[e.MoveDown=1]="MoveDown";e[e.MoveAcross=2]="MoveAcross";e[e.Cycle=3]="Cycle";e[e.CycleOut=4]="CycleOut";e[e.CycleEditable=5]="CycleEditable"}(KeyAction||(KeyAction={}));export class _KeyboardHandler{constructor(e){this._kaTab=KeyAction.None;this._kaEnter=KeyAction.MoveDown;this._g=e;let t=e.hostElement;e.addEventListener(t,"keypress",this._keypress.bind(this));e.addEventListener(t,"keydown",this._keydown.bind(this))}_keydown(e){let t=this._g,i=t._edtHdl,l=t.selection,s=e.ctrlKey||e.metaKey,o=e.shiftKey,n=e.altKey,r=e.target,a=e.char||e.key,h=!0;if(!s&&!n&&a&&1==a.length&&r.firstElementChild&&(" "!=a||!o)){let t=r.querySelectorAll("."+CellFactory._WJC_RADIOMAP+" label input");if(t&&t.length){let i=-1;for(let e=0;e<t.length;e++)if(t[e].checked){i=e;break}a=a.toLowerCase();for(let l=0;l<t.length;l++){let s=t[(i+l+1)%t.length],o=s.parentElement;if(" "==a||o.textContent[0].toLowerCase()==a){s.click();e.preventDefault();return}}}}if(t._wantsInput(r))return;let d=tryCast(t.rows[l.row],GroupRow),c=t.editableCollectionView,g=t._getKeyCode(e),u=SelMove,_=SelectionMode,p=e.defaultPrevented&&!(r instanceof HTMLInputElement);if((t.isRangeValid(l)&&!p||s&&65==g)&&(!t.activeEditor||!i._keydown(e)||t._isNativeCheckbox(t.activeEditor))){if(t.autoClipboard){if(s&&(67==g||45==g)){let i=new CellRangeEventArgs(t.cells,l);if(t.onCopying(i)){let e=HeadersVisibility,l=0!=(t.copyHeaders&e.Column),s=0!=(t.copyHeaders&e.Row),o=t.getClipString(null,!1,l,s)+"\r\n";t._eFocus.focus();Clipboard.copy(o);t.onCopied(i)}e.stopPropagation();return}if(s&&86==g||o&&45==g){t.isReadOnly||Clipboard.paste(e=>{t.setClipString(e)});e.stopPropagation();return}}(o||s)&&"Space"==e.code&&(g=Key.Space);switch(g){case Key.Space:if(o&&l.isValid)switch(t.selectionMode){case _.CellRange:case _.MultiRange:case _.Row:case _.RowRange:case _.ListBox:t.select(new CellRange(l.row,0,l.row,t.columns.length-1),!1)}else if(s&&l.isValid)switch(t.selectionMode){case _.CellRange:case _.MultiRange:t.select(new CellRange(0,l.col,t.rows.length-1,l.col),!1)}else(h=this._startEditing(!0,e))&&setTimeout(()=>{let e=t.activeEditor;if(e)if(e.disabled||e.readOnly)t.finishEditing();else if("checkbox"==e.type){setChecked(e,e.indeterminate||!e.checked);t.finishEditing()}});break;case 65:if(s)switch(t.selectionMode){case _.None:case _.Cell:break;default:t.selectAll()}else h=!1;break;case Key.Left:s||n?h=!1:l.isValid&&0==l.leftCol&&d&&!d.isCollapsed&&d.hasChildren?d.isCollapsed=!0:this._moveSel(u.None,s?u.Home:u.Prev,o);break;case Key.Right:s||e.altKey?h=!1:l.isValid&&0==l.leftCol&&d&&d.isCollapsed?d.isCollapsed=!1:this._moveSel(u.None,s?u.End:u.Next,o);break;case Key.Up:s?h=!1:e.altKey?h=i._toggleListBox(e):this._moveSel(u.Prev,u.None,o);break;case Key.Down:s?h=!1:e.altKey?h=i._toggleListBox(e):this._moveSel(u.Next,u.None,o);break;case Key.PageUp:this._moveSel(e.altKey?u.Home:u.PrevPage,u.None,o);if(t.rows.frozen&&t.selection.row<t.rows.frozen){let e=t.scrollPosition;e.y&&(t.scrollPosition=new Point(e.x,0))}break;case Key.PageDown:this._moveSel(e.altKey?u.End:u.NextPage,u.None,o);break;case Key.Home:this._moveSel(s?u.Home:u.None,u.Home,o);break;case Key.End:this._moveSel(s?u.End:u.None,u.End,o);break;case Key.Tab:h=this._performKeyAction(t.keyActionTab,o);break;case Key.Enter:h=this._performKeyAction(t.keyActionEnter,o);!o&&c&&null!=c.currentEditItem&&i._commitRowEdits();break;case Key.Escape:h=!1;if(c&&(c.currentAddItem||c.currentEditItem)){let e=new CellRangeEventArgs(t.cells,t.selection);e.cancel=!0;t.onRowEditEnding(e);c.currentAddItem&&c.cancelNew();c.currentEditItem&&c.cancelEdit();t.onRowEditEnded(e);h=!0}t._mouseHdl.resetMouseState();break;case Key.Delete:case Key.Back:h=this._deleteSel(e);break;case Key.F2:h=this._startEditing(!0,e);break;case Key.F4:h=i._toggleListBox(e);break;default:h=!1}if(h){t.containsFocus()||t.focus();e.preventDefault();e.stopPropagation()}}}_performKeyAction(e,t){let i=KeyAction,l=SelMove;switch(e){case i.MoveDown:this._moveSel(t?l.Prev:l.Next,l.None,!1);return!0;case i.MoveAcross:this._moveSel(l.None,t?l.Prev:l.Next,!1);return!0;case i.Cycle:this._moveSel(l.None,t?l.PrevCell:l.NextCell,!1);return!0;case i.CycleEditable:this._moveSel(l.None,t?l.PrevEditableCell:l.NextEditableCell,!1);return!0;case i.CycleOut:let e=this._g.selection;this._moveSel(l.None,t?l.PrevCell:l.NextCell,!1);return!e.equals(this._g.selection)}return!1}_keypress(e){let t=this._g;if(t._wantsInput(e.target)||e.defaultPrevented)return;let i=t._edtHdl;if(t.activeEditor)i._keypress(e);else if(e.charCode>Key.Space&&"AltLeft"!=e.code&&"AltRight"!=e.code)if(this._startEditing(!1,e)&&t.activeEditor){let l=getActiveElement();if(l instanceof HTMLInputElement&&"checkbox"!=l.type||l instanceof HTMLTextAreaElement){let s=t._selHdl.selection,o=t.getCellData(s.row,s.col,!0),n=t.getCellData(s.row,s.col,!1),r=culture.Globalize.numberFormat["%"]||"%",a=String.fromCharCode(e.charCode),h=isNumber(n)&&o.indexOf(r)>-1||""==o&&l.value==r;l.value=a+(h?r:"");setSelectionRange(l,1);l.dispatchEvent(i._evtInput);i._keypress(e);i._edtValue=l.value!=o?l.value:null;e.preventDefault()}}else if(t.autoSearch){let i=!1,l=t._selHdl.selection;if(e.charCode>32||32==e.charCode&&this._search){e.preventDefault();this._search+=String.fromCharCode(e.charCode);this._toSearch&&clearTimeout(this._toSearch);this._toSearch=setTimeout(()=>{this._toSearch=null;this._search=""},Control._SEARCH_DELAY);let s=this._findNext(l.row,l.col);if(s<0&&this._search.length>1){this._search=this._search[this._search.length-1];s=this._findNext(l.row,l.col)}if(s>-1){i=!0;t.select(s,l.col)}}i||(this._search="")}}_findNext(e,t){let i=this._g,l=i.rows.length;(e<0||1==this._search.length)&&e++;let s=this._search,o=i.caseSensitiveSearch;o||(s=s.toLowerCase());for(let n=0;n<l;n++){let r=(e+n)%l,a=i.getCellData(r,t,!0).trim();o||(a=a.toLowerCase());if(0==a.indexOf(s))return r}return-1}_moveSel(e,t,i){let l=this._g;l.selectionMode!=SelectionMode.None&&l._selHdl.moveSelection(e,t,i)}_deleteSel(e){let t=this._g,i=t.rows,l=t.editableCollectionView,s=t.selection,o=[],n=new CellRange,r=new CellEditEndingEventArgs(t.cells,n,e),a=SelectionMode;if(!t._edtHdl._allowEdit())return!1;if(t.allowDelete&&(null==l||l.canRemove&&!l.isAddingNew&&!l.isEditingItem)&&0==(o=i.filter(e=>e.isSelected)).length)switch(t.selectionMode){case a.CellRange:case a.MultiRange:let e=t._getDeleteColumnIndex();t.selectedRanges.forEach(l=>{if(l.leftCol==e&&l.rightCol==t.columns.length-1)for(let e=l.topRow;e>-1&&e<=l.bottomRow;e++){let t=i[e];o.indexOf(t)<0&&o.push(t)}});break;case a.Row:s.topRow>-1&&o.push(i[s.topRow]);break;case a.RowRange:for(let e=s.topRow;e>-1&&e<=s.bottomRow;e++)o.push(i[e])}if(o.length>0){t.deferUpdate(()=>{l&&l.beginUpdate();for(let e=o.length-1;e>=0;e--){let i=o[e];if(!(i instanceof _NewRowTemplate)){n.setRange(i.index,-1);if(t.onDeletingRow(r)){l&&i.dataItem?l.remove(i.dataItem):t.rows.removeAt(i.index);t.onDeletedRow(r)}}}l&&l.endUpdate(!1)});let e=s.topRow;e=Math.min(e,t.rows.length-1);for(;e>0&&t.rows[e]instanceof _NewRowTemplate;)e--;s.row=s.row2=e;t.select(s,!1);t.childItemsPath&&l&&l.refresh();return!0}if(0==o.length){t.deferUpdate(()=>{let i=t.scrollPosition;l&&l.beginUpdate();this._deleteRange(e,s);t.selectionMode==a.MultiRange&&t._selHdl.extendedSelection.forEach(t=>{this._deleteRange(e,t)});t.select(s,!1);t.scrollPosition=i;l&&l.endUpdate(!1)});return!0}return!1}_deleteRange(e,t){let i=this._g,l=i.editableCollectionView,s=new CellRange,o=new CellEditEndingEventArgs(i.cells,s,e),n=t.row>t.row2?1:-1;for(let e=t.row2;t.containsRow(e);e+=n){let n=i.rows[e];if(!n.isReadOnly)for(let r=t.leftCol;r<=t.rightCol;r++){if(!i._getBindingColumn(i.cells,e,i.columns[r]).getIsRequired(n)&&i.canEditCell(n.index,r)&&i.getCellData(e,r,!0)){s.setRange(e,r);o.cancel=!1;if(i.onBeginningEdit(o)){let t=n.dataItem,s=l?l.currentEditItem:null;if(s&&t!=s){i.onRowEditEnding(o);i.onRowEditEnded(o)}if(t!=s){i.onRowEditStarting(o);i.onRowEditStarted(o)}if(l){l.editItem(t);i._edtHdl._edItem=t}i.setCellData(e,r,"",!0,!1);i.onCellEditEnding(o);i.onCellEditEnded(o)}}}}}_startEditing(e,t,i,l){return this._g._edtHdl.startEditing(e,i,l,!0,t)}}const _AR_ALLCELLS=4,_WJC_DRAGSRC="wj-state-dragsrc",_WJC_FLEXGRID="wj-flexgrid";export var AllowResizing;!function(e){e[e.None=0]="None";e[e.Columns=1]="Columns";e[e.Rows=2]="Rows";e[e.Both=3]="Both";e[e.ColumnsAllCells=e.Columns|_AR_ALLCELLS]="ColumnsAllCells";e[e.RowsAllCells=e.Rows|_AR_ALLCELLS]="RowsAllCells";e[e.BothAllCells=e.Both|_AR_ALLCELLS]="BothAllCells"}(AllowResizing||(AllowResizing={}));export var AutoSizeMode;!function(e){e[e.None=0]="None";e[e.Headers=1]="Headers";e[e.Cells=2]="Cells";e[e.Both=3]="Both"}(AutoSizeMode||(AutoSizeMode={}));export var AllowDragging;!function(e){e[e.None=0]="None";e[e.Columns=1]="Columns";e[e.Rows=2]="Rows";e[e.Both=3]="Both"}(AllowDragging||(AllowDragging={}));export class _MouseHandler{constructor(e){let t=e.hostElement,i=e.addEventListener.bind(e),l=e.removeEventListener.bind(e);this._g=e;this._dvMarker=createElement('<div class="wj-marker">&nbsp;</div>');i(t,"mousedown",t=>{e._rcBounds=null;if(!t.defaultPrevented&&0==t.button){let s=t.target;if(!e.containsFocus()){let t=s instanceof HTMLElement&&s.tabIndex>-1?s:e._eFocus;e._setFocusNoScroll(t)}setTimeout(()=>{t.defaultPrevented||e.focus()});let o=closestClass(s,_WJC_FLEXGRID);if(o&&o!=e.hostElement||!e.activeEditor&&e._isInputElement(s)&&!this._hasRadioMap(t)&&!e._isNativeCheckbox(s)){let i=e.hitTest(t),l=CellType;switch(i.cellType){case l.Cell:e.select(i.range,!1);s instanceof HTMLElement&&"root"!=s.getAttribute("wj-part")&&s.focus();break;case l.ColumnHeader:case l.ColumnFooter:e.scrollIntoView(-1,i.col);break;case l.RowHeader:e.scrollIntoView(i.row,-1)}isIE()&&i.cellType!=l.Cell&&e._isInputElement(s)&&s.focus();return}let n=document;l(n,"mousemove");l(n,"mouseup");i(n,"mousemove",mouseMove);i(n,"mouseup",mouseUp);this._isDown=!0;this._mousedown(t)}});let mouseMove=e=>{this._mousemove(e)},mouseUp=e=>{this._isDown=!1;l(document,"mousemove");l(document,"mouseup");this._mouseup(e)};i(t,"mouseenter",t=>{e._rcBounds=null});i(t,"mousemove",this._hover.bind(this));i(t,"dblclick",this._dblclick.bind(this));i(t,"click",this._click.bind(this));i(t,"selectstart",t=>{e._isInputElement(t.target)||t.preventDefault()});i(t,"wheel",t=>{if(!t.defaultPrevented&&t.deltaY&&!t.ctrlKey&&!t.metaKey){let i=e._root,l=t.deltaY;if(i.scrollHeight>i.offsetHeight&&closestClass(t.target,_WJC_FLEXGRID)==e.hostElement){switch(t.deltaMode){case 1:l=e.rows.defaultSize*(l<0?-1:1);break;case 2:l=i.clientHeight*(l<0?-1:1);break;case 0:default:isSafari()&&(l=clamp(l,-150,150))}e._eFocus.focus();e.finishEditing(!1)&&(t.shiftKey?i.scrollLeft+=l:i.scrollTop+=l);t.preventDefault()}}});i(t,"dragstart",this._dragstart.bind(this));i(t,"dragover",this._dragover.bind(this));i(t,"dragleave",this._dragover.bind(this));i(t,"drop",this._drop.bind(this));i(t,"dragend",this._dragend.bind(this))}resetMouseState(){let e=this._g,t=e.hostElement;if(this._updating){this._updating=!1;e.endUpdate()}this._dragSrc&&removeClass(this._dragSrc,_WJC_DRAGSRC);this._showDragMarker(null);t&&(t.style.cursor="");isSafari()&&this._szRowCol&&e.invalidate();e.removeEventListener(document,"mousemove");e.removeEventListener(document,"mouseup");this._eMouse=null;this._isDown=null;this._htDown=null;this._lbSelState=null;this._szRowCol=null;this._szArgs=null;e._rcBounds=null}_mousedown(e){let t=this._g,i=e.target,l=t.hitTest(e),s=l.cellType,o=CellType,n=e.ctrlKey||e.metaKey;this._selDown=t.selection;this._ignoreClick=!1;if(l.panel==t.cells){if(closestClass(i,CellFactory._WJC_DROPDOWN)){let l=t.hitTest(i);t._edtHdl._toggleListBox(e,l.range);e.preventDefault();this._ignoreClick=!0;return}let s=t.editRange;if(s&&s.contains(l.range))return}let r=getActiveElement();if(i==r&&t._isInputElement(i))return;if(s==o.None){t.finishEditing();i!=t._root&&i!=t._fCt&&t._edtHdl._commitRowEdits();return}this._htDown=l;this._eMouse=e;if(null!=this._szRowCol){let i=t._eFocus;if(r!=i){i.tabIndex=0;i.focus()}this._ignoreClick=!0;this._handleResizing(e);return}let a=t.allowResizing,h=AllowResizing;if((s==o.RowHeader||s==o.TopLeft)&&l.edgeBottom&&a&h.Rows&&this._getResizeRowHt(l)){this._ignoreClick=!0;return}if((s==o.ColumnHeader||s==o.TopLeft)&&l.edgeRight&&a&h.Columns&&this._getResizeColHt(l)){this._ignoreClick=!0;return}let d=t.allowDragging,c=AllowDragging;switch(s){case o.Cell:case o.RowHeader:if(n&&t.selectionMode==SelectionMode.ListBox){this._lbSelState=t.rows[l.row].isSelected;closest(i,".wj-elem-collapse")&&(this._lbSelState=!1)}this._mouseSelect(e,e.shiftKey);if(s==o.RowHeader&&!(d&c.Rows)){e.preventDefault();t.focus()}break;case o.ColumnHeader:t.allowSorting||d&c.Columns||closest(i,"button")||this._mouseSelect(e,e.shiftKey)}}_mousemove(e){if(this._htDown&&!e.defaultPrevented){if(0==e.buttons&&this._eMouse&&e.timeStamp-this._eMouse.timeStamp>600){this.resetMouseState();return}this._eMouse=e;if(this._szRowCol)this._handleResizing(e);else{let t=this._g,i=t.allowDragging,l=AllowDragging,s=CellType;switch(this._htDown.cellType){case s.Cell:this._mouseSelect(e,!0);break;case s.RowHeader:i&l.Rows||this._mouseSelect(e,!0);break;case s.ColumnHeader:i&l.Columns||t.allowSorting||this._mouseSelect(e,!0)}}}}_mouseup(e){let t=this._g;if(t.isTouching&&(this._dragSrc||e.target instanceof HTMLHtmlElement))return;let i=t.hitTest(e),l=this._htDown;if(l&&!e.defaultPrevented){this._szArgs&&this._finishResizing(e);if(!this._szArgs&&i.panel==l.panel&&i.row==l.row&&i.col==l.col){let t=i.getColumn();if(t){if(!(t._getFlag(RowColFlags.HasTemplate)&&!t.cellTemplate)){let t=i.target;if(t!=l.target&&t instanceof HTMLElement){if(l.target instanceof HTMLInputElement){let e=i.point,s=l.point;Math.abs(e.x-s.x)+Math.abs(e.y-s.y)<10&&(t=t.querySelector("input")||t)}let s=document.createEvent("Event");s.initEvent("click",!0,!0);for(let t in e)/Key$|X$|Y$|^button|^(x|y|which)$/.test(t)&&(s[t]=e[t]);t.dispatchEvent(s)}}}}}this.resetMouseState()}_click(e){if(this._ignoreClick){this._ignoreClick=!1;e.preventDefault()}if(!e.defaultPrevented){let t=this._g,i=e.target,l=tryCast(i,HTMLInputElement);!l&&t.bigCheckboxes&&(l=i.querySelector("input."+CellFactory._WJC_CHECKBOX));if(l!=t.activeEditor&&t._isNativeCheckbox(l)){let s=t.hitTest(i);if(s.panel==t.cells){let i=t.getCellData(s.row,s.col,!1);if(t.startEditing(!1,s.row,s.col,!1,e)){t.activeEditor.checked=!i;t.finishEditing();t.focus()}else l.checked=i}return}if(this._hasRadioMap(e)){this._handleClick(e);return}if(t.rows.maxGroupLevel>-1&&closestClass(i,CellFactory._WJC_COLLAPSE)){let l=t.hitTest(i),s=t.rows[l.row];if(l.panel==t.cells&&s instanceof GroupRow){e.ctrlKey||e.metaKey?t.collapseGroupsToLevel(s.isCollapsed?s.level+1:s.level):s.isCollapsed=!s.isCollapsed;return}}if(!(e.ctrlKey||e.metaKey||e.shiftKey||t.activeEditor)){let l=t.hitTest(i);if(l.panel==t.cells){let i=t._selHdl.selection;if(i.equals(this._selDown)&&l.range.contains(i)){t.startEditing(!0,null,null,!0,e);return}}}this._handleClick(e)}}_handleClick(e){let t=this._g,i=e.target,l=t.hitTest(i),s=l.panel;if(!e.defaultPrevented&&l.grid==t){if(s==t.cells&&this._hasRadioMap(e)){let e=i instanceof HTMLInputElement?i:i.querySelector("input");if(e instanceof HTMLInputElement&&!e.disabled){if(e.parentElement instanceof HTMLLabelElement&&t.startEditing(!1,l.row,l.col,!1)){t.setCellData(l.row,l.col,e.parentElement.textContent);t.finishEditing()}}return}if(!t._isInputElement(i)){if(s==t.topLeftCells){let e=SelectionMode;switch(t.selectionMode){case e.None:case e.Cell:break;default:t.selectAll()}return}if(s==t.columnHeaders){if(t.allowPinning&&closestClass(i,CellFactory._WJC_PIN))this._clickPin(e,l);else if(closestClass(e.target,CellFactory._WJC_COLLAPSE)){let e=t._getColumnGroup(l.row,l.col);e&&(e.isCollapsed=!e.isCollapsed)}else{i instanceof HTMLSpanElement&&i.parentElement instanceof HTMLLabelElement&&(i=i.parentElement.querySelector("input"));i instanceof HTMLInputElement||this._clickSort(e,l);t.focus()}return}if(s==t.cells){if(l.row<0){this._clickSort(e,l);return}if(closestClass(i,CellFactory._WJC_COLLAPSE)){let i=t.rows[l.row];i instanceof GroupRow&&(e.ctrlKey?t.collapseGroupsToLevel(i.isCollapsed?i.level+1:i.level):i.isCollapsed=!i.isCollapsed);return}closestClass(i,CellFactory._WJC_DROPDOWN)&&t._edtHdl._toggleListBox(e,l.range)}}}}_hasRadioMap(e){let t=e.target;if(t instanceof HTMLInputElement||t instanceof HTMLLabelElement){let e=closestClass(t,CellFactory._WJC_RADIOMAP);return closestClass(e,_WJC_FLEXGRID)==this._g.hostElement}}_clickSort(e,t){let i=this._g,l=i.allowSorting,s=i.collectionView,o=s?s.sortDescriptions:null,n=e.ctrlKey||e.metaKey,r=e.shiftKey;if(!s||!s.canSort||l==AllowSorting.None)return;let a=t.panel.columns[t.col],h=i._getBindingColumn(t.panel,t.row,a),d=h?h._getBindingSort():null;if(!h.allowSorting||!d)return;if(a==h){let e=i.getMergedRange(t.panel,t.row,t.col,!1);if(e&&e.columnSpan>1)return}let c=new CellRangeEventArgs(t.panel,t.range,e);if(i.onSortingColumn(c)){i._edtHdl._commitRowEdits();let e=-1;for(let t=0;t<o.length;t++)if(o[t].property==d){e=t;break}o.deferUpdate(()=>{if(n&&r)o.clear();else if(e<0){l!=AllowSorting.MultiColumn&&o.clear();let e=new SortDescription(d,!0);o.push(e)}else if(n)o.splice(e,1);else{let t=new SortDescription(d,!o[e].ascending);o.splice(e,1,t)}});i.onSortedColumn(c)}}_clickPin(e,t){let i=this._g,l=i.columns,s=l.frozen,o=i.allowPinning;o==AllowPinning.Both&&(o=e.shiftKey?AllowPinning.ColumnRange:AllowPinning.SingleColumn);let n=new CellRangeEventArgs(i.cells,t.range);if(i.onPinningColumn(n)){if(o==AllowPinning.SingleColumn)if(t.col>=s){l.moveElement(t.col,s,!1);l.frozen++}else{l.moveElement(t.col,s-1,!1);l.frozen--}o==AllowPinning.ColumnRange&&(t.col+1!=s?l.frozen=t.col+1:l.frozen=0);i.onPinnedColumn(n)}}_dblclick(e){let t,i=this._g,l=i.hitTest(e),s=l.cellType,o=i.selection,n=l.range;if(e.defaultPrevented)return;let r=i.allowResizing,a=AllowResizing,h=CellType;if(l.edgeRight&&r&a.Columns){if(s==h.ColumnHeader||s==h.Cell&&r&_AR_ALLCELLS){e.ctrlKey&&o.containsColumn(l.col)&&(n=o);for(let l=n.leftCol;l<=n.rightCol;l++)if(i.columns[l].allowResizing){t=new CellRangeEventArgs(i.cells,new CellRange(-1,l));if(i.onAutoSizingColumn(t)&&i.onResizingColumn(t)){this._ignoreClick=!0;i.autoSizeColumn(l);i.onResizedColumn(t);i.onAutoSizedColumn(t);e.preventDefault()}}}else if(s==h.TopLeft&&l.panel.columns[l.col].allowResizing){t=new CellRangeEventArgs(l.panel,new CellRange(-1,l.col));if(i.onAutoSizingColumn(t)&&i.onResizingColumn(t)){this._ignoreClick=!0;i.autoSizeColumn(l.col,!0);i.onAutoSizedColumn(t);i.onResizedColumn(t);e.preventDefault()}}this.resetMouseState()}else if(l.edgeBottom&&r&a.Rows){if(s==h.RowHeader||s==h.Cell&&r&_AR_ALLCELLS){e.ctrlKey&&o.containsRow(l.row)&&(n=o);for(let l=n.topRow;l<=n.bottomRow;l++)if(i.rows[l].allowResizing){t=new CellRangeEventArgs(i.cells,new CellRange(l,-1));if(i.onAutoSizingRow(t)&&i.onResizingRow(t)){this._ignoreClick=!0;i.autoSizeRow(l);i.onResizedRow(t);i.onAutoSizedRow(t);e.preventDefault()}}}else if(s==h.TopLeft&&l.getRow().allowResizing){t=new CellRangeEventArgs(l.panel,new CellRange(l.row,-1));if(i.onAutoSizingRow(t)&&i.onResizingRow(t)){this._ignoreClick=!0;i.autoSizeRow(l.row,!0);i.onResizedRow(t);i.onAutoSizedRow(t);e.preventDefault()}}this.resetMouseState()}else;}_hover(e){if(!this._isDown){let t=this._g,i=t.hitTest(e),l="";this._szRowCol=this._getResizeColHt(i)||this._getResizeRowHt(i);this._szRowCol instanceof Column?l="col-resize":this._szRowCol instanceof Row&&(l="row-resize");this._szStart=this._szRowCol?this._szRowCol.renderSize:0;t.hostElement.style.cursor=l;return i}return null}_getResizeColHt(e){let t,i=this._g.allowResizing,l=e.cellType,s=CellType;if(i&AllowResizing.Columns&&(l==s.ColumnHeader||l==s.TopLeft||l==s.Cell&&i&_AR_ALLCELLS)){e.edgeRight&&(t=e.getColumn());e.edgeFarRight&&(t=this._getResizeCol(e.panel,e.col)||e.getColumn());e.edgeLeft&&(t=this._getResizeCol(e.panel,e.col,!0))}return t&&t.allowResizing?t:null}_getResizeRowHt(e){let t,i=this._g.allowResizing,l=e.cellType,s=CellType;if(i&AllowResizing.Rows&&(l==s.RowHeader||l==s.TopLeft||l==s.Cell&&i&_AR_ALLCELLS)){e.edgeBottom&&(t=e.getRow());e.edgeFarBottom&&(t=this._getResizeRow(e.panel,e.row)||e.getRow());e.edgeTop&&(t=this._getResizeRow(e.panel,e.row,!0))}return t&&t.allowResizing?t:null}_getResizeCol(e,t,i=!1){let l=this._g,s=e.columns;if(i){for(let e=t-1;e>=0;e--){let t=s[e];if(t.isVisible)return this._asResizable(t)}if(s==l.columns&&0!=(l.headersVisibility&HeadersVisibility.Row))for(let e=(s=l.rowHeaders.columns).length-1;e>=0;e--){let t=s[e];if(t.isVisible)return this._asResizable(t)}return null}for(let e=t+1;e<s.length;e++){let t=s[e];if(t.isVisible)return this._asResizable(t)}if(t==s.length-1&&s==l.rowHeaders.columns){s=l.columns;for(let e=0;e<s.length;e++){let t=s[e];if(t.isVisible)return this._asResizable(t)}}return null}_getResizeRow(e,t,i=!1){let l=this._g,s=e.rows;if(i){for(let e=t-1;e>=0;e--){let t=s[e];if(t.isVisible)return this._asResizable(t)}if(s==l.rows&&0!=(l.headersVisibility&HeadersVisibility.Column))for(let e=(s=l.columnHeaders.rows).length-1;e>=0;e--){let t=s[e];if(t.isVisible)return this._asResizable(t)}return null}for(let e=t+1;e<s.length;e++){let t=s[e];if(t.isVisible)return this._asResizable(t)}if(t==s.length-1&&s==l.columnHeaders.rows){s=l.rows;for(let e=0;e<s.length;e++){let t=s[e];if(t.isVisible)return this._asResizable(t)}}return null}_asResizable(e){return 0==e.renderSize&&e.allowResizing?e:null}_mouseSelect(e,t){let i=this._g;if(e&&this._htDown&&this._htDown.panel&&i.selectionMode!=SelectionMode.None){let l=new HitTestInfo(this._htDown.panel,e);this._handleSelection(l,t);!isIE9()&&e.button>=0&&e.target!=i._root&&((l=new HitTestInfo(i,e)).panel||setTimeout(()=>{this._isDown&&this._eMouse&&this._mouseSelect(this._eMouse,t)},100))}}_handleResizing(e){"mousedown"==e.type&&(isSafari()?setAttribute(e.target,"draggable",null):e.preventDefault());let t=this._szRowCol;if(t instanceof Column){let i=this._g,l=mouseToPage(e).x,s=Math.round(Math.max(_MouseHandler._SZ_MIN,this._szStart+(l-this._htDown.point.x)*(i.rightToLeft?-1:1)));if(t.renderSize!=s){if(null==this._szArgs){let e=i.rowHeaders.columns.indexOf(t)>-1?i.rowHeaders:i.cells;this._szArgs=new CellRangeEventArgs(e,new CellRange(-1,t.index))}this._szArgs.cancel=!1;i.onResizingColumn(this._szArgs)&&(i.deferResizing?this._showResizeMarker(s):t.width=s)}}let i=this._szRowCol;if(i instanceof Row){let t=this._g,l=mouseToPage(e).y,s=Math.round(Math.max(_MouseHandler._SZ_MIN,this._szStart+(l-this._htDown.point.y)));if(i.renderSize!=s){if(null==this._szArgs){let e=t.columnHeaders.rows.indexOf(i)>-1?t.columnHeaders:t.cells;this._szArgs=new CellRangeEventArgs(e,new CellRange(i.index,-1))}this._szArgs.cancel=!1;t.onResizingRow(this._szArgs)&&(t.deferResizing?this._showResizeMarker(s):i.height=s)}}}_dragstart(e){let t=this._g,i=this._htDown,l=AllowDragging;if(i){this._dragSrc=null;this._htDrag=null;if(!this._szRowCol){let s=new CellRangeEventArgs(i.panel,i.range);if(i.cellType==CellType.ColumnHeader&&t.allowDragging&l.Columns&&i.col>-1&&t.columns[i.col].allowDragging)t.onDraggingColumn(s)?this._dragSrc=e.target:e.preventDefault();else if(i.cellType==CellType.RowHeader&&t.allowDragging&l.Rows&&i.row>-1&&t.rows[i.row].allowDragging){let l=t.rows[i.row];l instanceof GroupRow||l instanceof _NewRowTemplate||(t.onDraggingRow(s)?this._dragSrc=e.target:e.preventDefault())}else i.cellType==CellType.TopLeft&&t.allowDragging&l.Columns&&i.col>-1&&t.topLeftCells.columns[i.col].allowDragging&&(t.onDraggingColumn(s)?this._dragSrc=e.target:e.preventDefault())}if(this._dragSrc&&e.dataTransfer&&!e.defaultPrevented){this._htDrag=i;_startDrag(e.dataTransfer,"move");e.stopPropagation();addClass(this._dragSrc,_WJC_DRAGSRC);t.beginUpdate();this._updating=!0}}}_dragend(e){this._dragSrc=null;this._htDrag=null;this.resetMouseState()}_dragover(e){let t=this._g,i=this._hitTest(e),l=this._dragSrc?this._htDrag:null,s=CellType,o=!1;if(l&&i.cellType==l.cellType){let e=new CellRangeEventArgs(i.panel,i.range,l);if(i.cellType==s.ColumnHeader){e.cancel=!t.columns.canMoveElement(l.col,i.col);o=t.onDraggingColumnOver(e)}else if(i.cellType==s.RowHeader){e.cancel=!t.rows.canMoveElement(l.row,i.row);o=t.onDraggingRowOver(e)}else if(i.cellType==s.TopLeft){e.cancel=!t.topLeftCells.columns.canMoveElement(l.col,i.col);o=t.onDraggingColumnOver(e)}}if(o){e.dataTransfer.dropEffect="move";e.preventDefault();e.stopPropagation();this._showDragMarker(i)}else this._showDragMarker(null);if(l&&t.autoScroll){let i=t.controlRect,s=t.scrollPosition,o=Control._DRAG_SCROLL_EDGE,n=Control._DRAG_SCROLL_STEP;if(l.panel==t.columnHeaders){e.pageX-i.left<o&&(s.x+=n);i.right-e.pageX<o&&(s.x-=n)}else if(l.panel==t.rowHeaders){e.pageY-i.top<o&&(s.y+=n);i.bottom-e.pageY<o&&(s.y-=n)}if(!s.equals(t._ptScrl)){t.scrollPosition=s;t._rcBounds=null}}}_drop(e){let t=this._g,i=this._hitTest(e),l=this._dragSrc?this._htDrag:null,s=CellType;if(l&&i.cellType==l.cellType){let e=t.selection,o=new CellRangeEventArgs(i.panel,i.range,l);if(i.cellType==s.ColumnHeader){t.columns.moveElement(l.col,i.col);t.select(e.row,i.col);t.onDraggedColumn(o)}else if(i.cellType==s.RowHeader){t.rows.moveElement(l.row,i.row);t.select(i.row,e.col);t.onDraggedRow(o)}else if(i.cellType==s.TopLeft){t.topLeftCells.columns.moveElement(l.col,i.col);t.onDraggedColumn(o)}}this.resetMouseState()}_hitTest(e){let t=this._g;t._rcBounds=null;return t.hitTest(e)}_showResizeMarker(e){let t,i=this._g,l=i._ptScrl,s=this._szArgs.panel.cellType,o=CellType,n=this._dvMarker,r=i.cells.hostElement;n.parentElement!=r&&r.appendChild(n);if(this._szRowCol instanceof Column){t={left:this._szRowCol.pos+e-1,top:-1e3,right:"",bottom:0,width:3,height:""};s!=o.TopLeft&&s!=o.RowHeader||(t.left-=i._eTL.offsetWidth+l.x);s==o.Cell&&this._szRowCol.index<i.frozenColumns&&(t.left-=l.x);i.rightToLeft&&(t.left=r.clientWidth-t.left-t.width)}else{t={left:-1e3,top:this._szRowCol.pos+e-1,right:0,bottom:"",width:"",height:3};s!=o.TopLeft&&s!=o.ColumnHeader||(t.top-=i._eTL.offsetHeight+l.y);s==o.Cell&&this._szRowCol.index<i.frozenRows&&(t.top-=l.y)}setCss(n,t)}_showDragMarker(e){let t=this._dvMarker;if(!e||!e.panel){removeChild(t);this._rngTarget=null;return}if(e.range.equals(this._rngTarget))return;this._rngTarget=e.range;let i=e.panel.hostElement;t.parentElement!=i&&i.appendChild(t);let l=this._g,s=l._ptScrl,o=CellType,n={left:0,top:0,width:6,height:6,right:"",bottom:""};switch(e.cellType){case o.TopLeft:case o.ColumnHeader:let i=e.panel.columns[e.col];n.left=i.pos-n.width/2;n.height=e.panel.height;this._htDown&&e.col>this._htDown.col&&(n.left+=i.renderWidth);e.cellType==o.ColumnHeader&&e.col<l.frozenColumns&&(n.left-=s.x);l.rightToLeft&&(n.left=t.parentElement.clientWidth-n.left-n.width);break;case o.RowHeader:let r=e.getRow();n.top=r.pos-n.height/2;n.width=e.panel.width;e.row>this._htDown.row&&(n.top+=r.renderHeight);e.row<l.frozenRows&&(n.top-=s.y)}setCss(t,n)}_finishResizing(e){let t=this._g,i=t.selection,l=this._szArgs,s=this._eMouse&&this._eMouse.ctrlKey,o=CellType;if(l&&!l.cancel){if(l.col>-1){let n=l.col,r=mouseToPage(e).x,a=Math.round(Math.max(_MouseHandler._SZ_MIN,this._szStart+(r-this._htDown.point.x)*(this._g.rightToLeft?-1:1)));l.panel.columns[n].width=Math.round(a);t.onResizedColumn(l);if(s&&this._htDown.cellType==o.ColumnHeader&&i.containsColumn(n))for(let e=i.leftCol;e<=i.rightCol;e++)if(t.columns[e].allowResizing&&e!=n){l=new CellRangeEventArgs(t.cells,new CellRange(-1,e));if(t.onResizingColumn(l)){t.columns[e].size=t.columns[n].size;t.onResizedColumn(l)}}e.preventDefault()}if(l.row>-1){let n=l.row,r=mouseToPage(e).y,a=Math.round(Math.max(_MouseHandler._SZ_MIN,this._szStart+(r-this._htDown.point.y)));l.getRow().height=Math.round(a);t.onResizedRow(l);if(s&&this._htDown.cellType==o.RowHeader&&i.containsRow(n))for(let e=i.topRow;e<=i.bottomRow;e++)if(t.rows[e].allowResizing&&e!=n){l=new CellRangeEventArgs(t.cells,new CellRange(e,-1));if(t.onResizingRow(l)){t.rows[e].size=t.rows[n].size;t.onResizedRow(l)}}e.preventDefault()}}}_handleSelection(e,t){let i=this._g,l=i._selHdl.selection,s=new CellRange(e.row,e.col),o=CellType,n=SelectionMode;if(s.isValid)if(null==this._lbSelState){switch(e.cellType){case o.RowHeader:s.col=0;s.col2=i.columns.length-1;break;case o.ColumnHeader:switch(i.selectionMode){case n.Row:case n.Cell:s.row=s.row2=l.row;t=!1;break;default:s.row=0;s.row2=i.rows.length-1}}if(t){if(i.anchorCursor){s.row=l.row;s.col=l.col}else{s.row2=l.row2;s.col2=l.col2}if(!s.isValid){let e=this._htDown;e&&(s=new CellRange(e.row,e.col))}}if(i.selectionMode==SelectionMode.MultiRange){let l=i._mouseHdl._eMouse,o=l&&(l.ctrlKey||l.metaKey),n=i._selHdl,r=n.selection,a=n.extendedSelection;if(o){if(!t&&n._deselectRange(s))n.selection.isValid&&(s=null);else if(r.isValid&&!r.intersects(s)){(e.panel!=i.cells?this._splitRange(r):[r.clone()]).forEach(e=>{a.push(e)})}}else a.clear()}if(s){i.select(s,!1);switch(e.cellType){case o.RowHeader:i.scrollIntoView(e.row,-1);break;case o.ColumnHeader:i.scrollIntoView(-1,e.col);break;default:i.scrollIntoView(e.row,e.col)}}else{let t=new CellRangeEventArgs(i.cells,new CellRange(e.row,e.col));i.onSelectionChanging(t);i.onSelectionChanged(t);i.invalidate()}}else{i.rows[e.row].isSelected=!this._lbSelState;i.scrollIntoView(e.row,e.col)}}_splitRange(e){let t=this._g,i=t.columns.length,l=t.rows.length,s=[];if(e.columnSpan==i)for(let t=e.topRow;t<=e.bottomRow;t++)s.push(new CellRange(t,0,t,i-1));else if(e.rowSpan==l)for(let t=e.leftCol;t<=e.rightCol;t++)s.push(new CellRange(0,t,l-1,t));else s.push(e.clone());return s}}_MouseHandler._SZ_MIN=0;_registerModule("wijmo.grid",selfModule);