/*!
    *
    * Wijmo Library 5.20202.724
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

import{asFunction,asType,CancelEventArgs,Color,isFunction,Rect,Size,isObject,assert,asInt,asString,changeType,isArray,isString,DataType,Point,_getModule,removeChild,clamp,EventArgs,_registerModule}from"wijmo/wijmo";import*as pdf from"wijmo/wijmo.pdf";import*as selfModule from"wijmo/wijmo.grid.pdf";export function softGrid(){return _getModule("wijmo.grid")}export function softDetail(){return _getModule("wijmo.grid.detail")}export function softMultiRow(){return _getModule("wijmo.grid.multirow")}export function softSheet(){return _getModule("wijmo.grid.sheet")}export function softOlap(){return _getModule("wijmo.olap")}export function softTransposed(){return _getModule("wijmo.grid.transposed")}export function softTransposedMultiRow(){return _getModule("wijmo.grid.transposedmultirow")}export var ScaleMode;!function(e){e[e.ActualSize=0]="ActualSize";e[e.PageWidth=1]="PageWidth";e[e.SinglePage=2]="SinglePage"}(ScaleMode||(ScaleMode={}));export var ExportMode;!function(e){e[e.All=0]="All";e[e.Selection=1]="Selection"}(ExportMode||(ExportMode={}));export var _CellType;!function(e){e[e.None=0]="None";e[e.Cell=1]="Cell";e[e.ColumnHeader=2]="ColumnHeader";e[e.RowHeader=3]="RowHeader";e[e.TopLeft=4]="TopLeft";e[e.ColumnFooter=5]="ColumnFooter";e[e.BottomLeft=6]="BottomLeft"}(_CellType||(_CellType={}));export function _merge(e,t,r=!1){!e&&t&&(e={});if(t&&e)for(var o in t){var l=t[o],i=e[o];if(isObject(l)){if(void 0===i||!isObject(i)&&r){if(isFunction(l.clone)){e[o]=i=l.clone();continue}e[o]=i={}}isObject(i)&&_merge(e[o],l,r)}else(void 0===i||r&&void 0!==l)&&(e[o]=l)}return e}export function _combineColumns(e,t){return{aggregate:t.aggregate,binding:t.binding,name:t.name,dataType:t.dataType,wordWrap:t.wordWrap,getAlignment:()=>t.getAlignment(),index:e.index,visibleIndex:e.visibleIndex,isVisible:e.isVisible,renderWidth:e.renderWidth}}export class PdfFormatItemEventArgs extends CancelEventArgs{constructor(e,t,r,o,l,i,s,n,a){super();this.cancelBorders=!1;this._p=e;this._rng=t;"undefined"!=typeof HTMLElement&&(this._cell=asType(r,HTMLElement,!0));this._canvas=o;this._clientRect=l;this._contentRect=i;this._style=s;this._getFormattedCell=n;this._getTextRect=a}get panel(){return this._p}get range(){return this._rng.clone()}get row(){return this._rng.row}get col(){return this._rng.col}get data(){return this._data}set data(e){this._data=e}get canvas(){return this._canvas}get cell(){return this._cell}get clientRect(){return this._clientRect}get contentRect(){return this._contentRect}drawBackground(e){_CellRenderer._drawBackground(this.canvas,this.clientRect,e||this.style.backgroundColor)}getFormattedCell(){return asFunction(this._getFormattedCell)()}get style(){return this._style}get textTop(){!this._textRect&&isFunction(this._getTextRect)&&(this._textRect=this._getTextRect());return this._textRect?this._textRect.top:this._contentRect.top}}export class _FlexGridPdfCoreConverter{static draw(e,t,r,o,l,i){assert(!!e,"The flex argument cannot be null.");assert(!!t,"The doc argument cannot be null.");null==(i=this._applyDefaultDrawSettings(i)).scaleMode&&(i.scaleMode=null==o?ScaleMode.ActualSize:null==l?ScaleMode.PageWidth:ScaleMode.SinglePage);this._drawInternal(e,t,r,o,l,i)}static _applyDefaultDrawSettings(e){return _merge(_merge({},e),_FlexGridPdfCoreConverter.DefaultDrawSettings)}static _drawInternal(e,t,r,o,l,i){var s=null!=r,n=new Size(t.width,t.height);r||(r=new Point(0,t.y));isArray(i.embeddedFonts)&&i.embeddedFonts.forEach(e=>{t.registerFont(e)});var a=this._getRowsToRender(e,i),d=new FlexGridRenderer(e,i,a,this.BorderWidth,!0),h=new Rect(r.x||0,r.y||0,o||n.width,l||n.height),g=this._getScaleFactor(d,i.scaleMode,h),c=this._getPages(d,a,h,i,s,g),u=(i.progress?this._getCellsCount(e,i,c):0)/i._progressMax,p=0,f=0,w=i.progress?()=>{if(++p-f>=50){f=p;i.progress(p/u)}}:null;i.progress&&i.progress(0);for(var _=0;_<c.length;_++){_>0&&t.addPage();var m=c[_],C=0===m.pageCol?h.left:0,R=0===m.pageRow?h.top:0;t.saveState();t.paths.rect(0,0,t._widthCtm,t._heightCtm).clip();t.scale(g,g,new Point(C,R));t.translate(C,R);var x=new FlexGridRenderer(e,i,m.range,this.BorderWidth,_===c.length-1);x.render(t,w);t.restoreState();t.x=C;t.y=R+x.renderSize.height*g}i.progress&&0<i._progressMax&&i.progress(i._progressMax)}static _getCellsCount(e,t,r){for(var o=0,l=0;l<r.length;l++){o+=new FlexGridRenderer(e,t,r[l].range,0,!1).getCellsCount()}return o}static _getRowsToRender(e,t){var r=[];t.exportMode==ExportMode.All?r.push(new _CellRange(0,0,e.rows.length-1,e.columns.length-1)):r=e.getSelection();var o=new RowRange(r);if(!t.drawDetailRows){var l=[];o.forEach(e.cells,(t,r,o)=>{if(!e.isDetailRow(t)){var i=l.length;i&&l[i-1].bottomRow+1===o?l[i-1].row2++:l.push(new _CellRange(o,r.col,o,r.col2))}});o=new RowRange(l)}return o}static _getScaleFactor(e,t,r){var o=1;if(t==ScaleMode.ActualSize)return o;var l=e.renderSize;if(t==ScaleMode.SinglePage){(i=Math.min(r.width/l.width,r.height/l.height))<1&&(o=i)}else{var i;(i=r.width/l.width)<1&&(o=i)}return o}static _getPages(e,t,r,o,l,i){var s=[],n=[],a=pdf.pxToPt,d=e.flex,h=e.showColumnHeader,g=e.showColumnFooter,c=e.showRowHeader,u=h?a(d.columnHeaders.height):0,p=g?a(d.columnFooters.height):0,f=c?a(d.rowHeaders.width):0,w=o.scaleMode==ScaleMode.ActualSize||o.scaleMode==ScaleMode.PageWidth,_=o.scaleMode==ScaleMode.ActualSize,m=(r.width-r.left)*(1/i),C=(r.height-r.top)*(1/i),R=r.width*(1/i),x=r.height*(1/i),b=u+p,S=f,v=l&&o.scaleMode==ScaleMode.ActualSize;if(w){var y=0;t.forEach(d.cells,(t,r,o,l)=>{var i=s.length?x:C;if(e.isRenderableRow(t)){var n=a(t.renderHeight);y++;b+=n;(h||y>1)&&(b-=this.BorderWidth);if(b>i){if(u+n>i||v){s.push(l);b=u}else{s.push(l-1);b=u+n}h&&(b-=this.BorderWidth)}}})}var T=t.length()-1;T<0&&(T=0);s.length&&s[s.length-1]===T||s.push(T);if(_)for(var G=0,P=t.leftCol;P<=t.rightCol;P++){var M=d.columns[P];if(M.isVisible){var F=a(M.renderWidth),A=n.length?R:m;G++;S+=F;(c||G>1)&&(S-=this.BorderWidth);if(S>A){if(f+F>A||v){n.push(P);S=f}else{n.push(P-1);S=f+F}c&&(S-=this.BorderWidth)}}}n.length&&n[n.length-1]===t.rightCol||n.push(t.rightCol);var z=[],H=!1,W=1,D=l&&o.maxPages>0?1:o.maxPages;for(P=0;P<s.length&&!H;P++)for(var L=0;L<n.length&&!H;L++,W++)if(!(H=W>D)){var B=0===P?0:s[P-1]+1,E=0===L?t.leftCol:n[L-1]+1;z.push(new PdfPageRowRange(t.subrange(B,s[P]-B+1,E,n[L]),L,P))}return z}}_FlexGridPdfCoreConverter.BorderWidth=1;_FlexGridPdfCoreConverter.DefFont=new pdf.PdfFont;_FlexGridPdfCoreConverter.DefaultDrawSettings={customCellContent:!1,drawDetailRows:!1,exportMode:ExportMode.All,maxPages:Number.MAX_VALUE,repeatMergedValuesAcrossPages:!0,recalculateStarWidths:!0,styles:{cellStyle:{font:{family:_FlexGridPdfCoreConverter.DefFont.family,size:_FlexGridPdfCoreConverter.DefFont.size,style:_FlexGridPdfCoreConverter.DefFont.style,weight:_FlexGridPdfCoreConverter.DefFont.weight},padding:1.5,verticalAlign:"middle"},headerCellStyle:{font:{weight:"bold"}}},quickCellStyles:!0,_progressMax:1};class FlexGridRenderer{constructor(e,t,r,o,l){this._flex=e;this._borderWidth=o;this._lastPage=l;this._settings=t||{};this._topLeft=new PanelSectionRenderer(this,e.topLeftCells,this.showRowHeader&&this.showColumnHeader?new RowRange([new _CellRange(0,0,e.topLeftCells.rows.length-1,e.topLeftCells.columns.length-1)]):new RowRange([]),o);this._rowHeader=new PanelSectionRenderer(this,e.rowHeaders,this.showRowHeader?r.clone(0,e.rowHeaders.columns.length-1):new RowRange([]),o);this._columnHeader=new PanelSectionRenderer(this,e.columnHeaders,this.showColumnHeader?new RowRange([new _CellRange(0,r.leftCol,e.columnHeaders.rows.length-1,r.rightCol)]):new RowRange([]),o);this._cells=new PanelSectionRenderer(this,e.cells,r,o);this._bottomLeft=new PanelSectionRenderer(this,e.bottomLeftCells,this.showRowHeader&&this.showColumnFooter?new RowRange([new _CellRange(0,0,e.bottomLeftCells.rows.length-1,e.bottomLeftCells.columns.length-1)]):new RowRange([]),o);this._columnFooter=new PanelSectionRenderer(this,e.columnFooters,this.showColumnFooter?new RowRange([new _CellRange(0,r.leftCol,e.columnFooters.rows.length-1,r.rightCol)]):new RowRange([]),o)}get settings(){return this._settings}isRenderableRow(e){return e.isVisible&&!this._flex.isNewRow(e)}getCellsCount(){return this._topLeft.getCellsCount()+this._rowHeader.getCellsCount()+this._columnHeader.getCellsCount()+this._cells.getCellsCount()+this._bottomLeft.getCellsCount()+this._columnFooter.getCellsCount()}render(e,t){var r=Math.max(0,Math.max(this._topLeft.renderSize.width,this._rowHeader.renderSize.width)-this._borderWidth),o=Math.max(0,Math.max(this._topLeft.renderSize.height,this._columnHeader.renderSize.height)-this._borderWidth);this._topLeft.render(e,0,0,t);this._rowHeader.render(e,0,o,t);this._columnHeader.render(e,r,0,t);this._cells.render(e,r,o,t);o=Math.max(0,o+this._cells.renderSize.height-this._borderWidth);this._bottomLeft.render(e,0,o,t);this._columnFooter.render(e,r,o,t)}get flex(){return this._flex}get renderSize(){var e=Math.max(this._topLeft.renderSize.height,this._columnHeader.renderSize.height)+Math.max(this._rowHeader.renderSize.height,this._cells.renderSize.height)+Math.max(this._bottomLeft.renderSize.height,this._columnFooter.renderSize.height),t=Math.max(this._topLeft.renderSize.width,this._rowHeader.renderSize.width)+Math.max(this._columnHeader.renderSize.width,this._cells.renderSize.width);this._columnHeader.visibleRows>0&&(e-=this._borderWidth);this._columnFooter.visibleRows>0&&(e-=this._borderWidth);this._rowHeader.visibleColumns>0&&(t-=this._borderWidth);return new Size(t,e)}get showColumnHeader(){return this._flex.showColumnHeader}get showRowHeader(){return this._flex.showRowHeader}get showColumnFooter(){return this._lastPage&&this._flex.showColumnFooter}alignMergedTextToTheTopRow(e){return this._flex.alignMergedTextToTheTopRow(e)}getColumn(e,t,r){return this._flex.getColumn(e,t,r)}isAlternatingRow(e){return this._flex.isAlternatingRow(e)}isGroupRow(e){return this._flex.isGroupRow(e)}isNewRow(e){return this._flex.isNewRow(e)}isExpandableGroupRow(e){return this._flex.isExpandableGroupRow(e)}isBooleanCell(e,t,r){return this._flex.isBooleanCell(e,t,r)}getCellStyle(e,t,r){return this._flex.getCellStyle(e,t,r)}}class PanelSection{constructor(e,t){this._panel=e;this._range=t.clone()}get visibleRows(){if(null==this._visibleRows){this._visibleRows=0;this._range.forEach(this._panel,e=>{this.isRenderableRow(e)&&this._visibleRows++})}return this._visibleRows}get visibleColumns(){if(null==this._visibleColumns){this._visibleColumns=0;if(this._range.isValid)for(var e=this._range.leftCol;e<=this._range.rightCol;e++)this._panel.columns[e].isVisible&&this._visibleColumns++}return this._visibleColumns}get size(){if(null==this._size){var e=this._range.getRenderSize(this._panel);this._size=new Size(pdf.pxToPt(e.width),pdf.pxToPt(e.height))}return this._size}get range(){return this._range}get panel(){return this._panel}isRenderableRow(e){return e.isVisible}}class PanelSectionRenderer extends PanelSection{constructor(e,t,r,o){super(t,r);this._gr=e;this._borderWidth=o}get gr(){return this._gr}get renderSize(){if(null==this._renderSize){this._renderSize=this.size.clone();this.visibleColumns>1&&(this._renderSize.width-=this._borderWidth*(this.visibleColumns-1));this.visibleRows>1&&(this._renderSize.height-=this._borderWidth*(this.visibleRows-1))}return this._renderSize}getRangeWidth(e,t){for(var r=0,o=0,l=this.panel,i=e;i<=t;i++){var s=l.columns[i];if(s.isVisible){o++;r+=s.renderWidth}}r=pdf.pxToPt(r);o>1&&(r-=this._borderWidth*(o-1));return r}getRangeHeight(e,t){for(var r=0,o=0,l=this.panel,i=e;i<=t;i++){var s=l.rows[i];if(this.isRenderableRow(s)){o++;r+=s.renderHeight}}r=pdf.pxToPt(r);o>1&&(r-=this._borderWidth*(o-1));return r}getCellsCount(){var e=0,t=this.range,r=this.panel,o=new GetMergedRangeProxy(this._gr.flex);if(!t.isValid)return e;t.forEach(r,(l,i,s)=>{if(this.isRenderableRow(l))for(var n=t.leftCol;n<=t.rightCol;n++){var a=!1,d=void 0;if(r.columns[n].isVisible){var h;if(h=o.getMergedRange(r,s,n)){let e=s===h.firstVisibleRow,r=n===h.leftCol,o=s===i.topRow,l=n===i.leftCol,g=h.rowSpan>1,c=h.columnSpan>1;if(g&&c&&(e&&r||o&&l)||g&&!c&&(e||o)||!g&&c&&(r||l)){a=!0;c&&(d=Math.min(t.rightCol,h.rightCol))}}else a=!0;a&&e++;d&&(n=d)}}});return e}render(e,t,r,o){var l=this.range;if(l.isValid){for(var i={},s=this.panel,n=new GetMergedRangeProxy(this._gr.flex),a=new _CellRangeExt(s,0,0,0,0),d=new _CellRenderer(this,e,this._borderWidth),h=l.leftCol;h<=l.rightCol;h++)i[h]=r;l.forEach(s,(e,r,h)=>{if(this.isRenderableRow(e))for(var g=t,c=l.leftCol;c<=l.rightCol;c++){var u,p=this.gr.getColumn(s,h,c),f=void 0,w=void 0,_=!1,m=void 0;if(p.isVisible){var C,R=this._gr.flex.getCellContent(this.panel,e,p,c);if(C=n.getMergedRange(s,h,c)){a.copyFrom(C);let e=h===C.firstVisibleRow,t=c===C.leftCol,o=h===r.topRow,s=c===r.leftCol,n=C.rowSpan>1,d=C.columnSpan>1;if(n&&d&&(e&&t||o&&s)||n&&!d&&(e||o)||!n&&d&&(t||s)){_=!0;u=e&&t||this.gr.settings.repeatMergedValuesAcrossPages?R:"";f=n?this.getRangeHeight(h,Math.min(C.bottomRow,r.bottomRow)):this.getRangeHeight(h,h);if(d){w=this.getRangeWidth(Math.max(l.leftCol,C.leftCol),Math.min(l.rightCol,C.rightCol));m=Math.min(l.rightCol,C.rightCol);for(var x=c+1;x<=m;x++)i[x]+=f-this._borderWidth}}null==w&&(w=this.getRangeWidth(c,c))}else{a.setRange(h,c,h,c);_=!0;u=R;f=this.getRangeHeight(h,h);w=this.getRangeWidth(c,c)}if(_){d.renderCell(u,e,p,a,new Rect(g,i[c],w,f));o&&o()}f&&(i[c]+=f-this._borderWidth);w&&(g+=w-this._borderWidth);m&&(c=m)}}})}}isRenderableRow(e){return this._gr.isRenderableRow(e)}}export class _CellRenderer{static _drawBackground(e,t,r){r&&t.width>0&&t.height>0&&e.paths.rect(t.left,t.top,t.width,t.height).fill(r)}constructor(e,t,r){this._pr=e;this._area=t;this._borderWidth=r}renderCell(e,t,r,o,l){var i,s=this._pr.gr.flex,n=this._pr.panel,getGridCell=e=>s.getCell(n,o.topRow,o.leftCol,e),a=null,d=this._pr.gr.getCellStyle(n,t,r),h=this._pr.gr.settings.customCellContent,g=isFunction(this._pr.gr.settings.formatItem);if(h){var c=s.getComputedStyle(n,a=getGridCell(g));d.color=c.color;d.backgroundColor=c.backgroundColor;var u=s.getComputedDefBorderColor();d.borderLeftColor="none"!=c.borderLeftStyle?c.borderLeftColor:u;d.borderRightColor="none"!=c.borderRightStyle?c.borderRightColor:u;d.borderTopColor="none"!=c.borderTopStyle?c.borderTopColor:u;d.borderBottomColor="none"!=c.borderBottomStyle?c.borderBottomColor:u;d.font=new pdf.PdfFont(c.fontFamily,pdf._asPt(c.fontSize,!0,void 0),c.fontStyle,c.fontWeight);d.textAlign=c.textAlign}if(d.font&&!(d.font instanceof pdf.PdfFont)){let e=d.font;d.font=new pdf.PdfFont(e.family,e.size,e.style,e.weight)}d.boxSizing="border-box";d.borderWidth=this._borderWidth;d.borderStyle="solid";h||this._pr.gr.isExpandableGroupRow(t)&&0===r.visibleIndex||(d.textAlign=r.getAlignment(t));if(n.cellType===_CellType.Cell&&s.rows.maxGroupLevel>=0&&o.leftCol===s.columns.firstVisibleIndex){var p=s.isGroupRow(t)?Math.max(t.level,0):s.rows.maxGroupLevel+1,f=pdf._asPt(d.paddingLeft||d.padding),w=pdf.pxToPt(p*s.treeIndent);d.paddingLeft=f+w}var _=this._measureCell(e,n,t,r,d,l);let m=o.rowSpan>1&&o.visibleRowsCount>1&&this._pr.gr.alignMergedTextToTheTopRow(n)?new Rect(_.contentRect.left,_.contentRect.top,_.contentRect.width,_.contentRect.height/(o.visibleRowsCount||1)):_.contentRect;if(g){(i=new PdfFormatItemEventArgs(n,o,a,this._area,_.rect,_.contentRect,d,()=>a||getGridCell(!0),()=>_.textRect=this._calculateTextRect(e,n,t,r,m,d))).data=e;this._pr.gr.settings.formatItem(i);if(i.data!==e){e=asString(i.data);_.textRect=null}}let C=!i||!i.cancel,R=!i||!i.cancelBorders;C&&!_.textRect&&(_.textRect=this._calculateTextRect(e,n,t,r,m,d));this._renderCell(e,t,r,o,_,d,C,R)}_renderCell(e,t,r,o,l,i,s,n){if(s||n){this._renderEmptyCell(l,i,s,n);s&&(this._isBooleanCellAndValue(e,this._pr.panel,t,r)?this._renderBooleanCell(e,l,i):this._renderTextCell(e,l,i))}}_isBooleanCellAndValue(e,t,r,o){return this._pr.gr.isBooleanCell(t,r,o)&&this._isBoolean(e)}_isBoolean(e){var t=isString(e)&&e.toLowerCase();return"true"===t||"false"===t||!0===e||!1===e}_measureCell(e,t,r,o,l,i){this._decompositeStyle(l);var s=i.left,n=i.top,a=i.height,d=i.width,h=this._parseBorder(l),g=h.left.width,c=h.top.width,u=h.bottom.width,p=h.right.width,f=this._parsePadding(l),w=0,_=0,m=0,C=0;if("content-box"===l.boxSizing||void 0===l.boxSizing){w=f.top+a+f.bottom;_=f.left+d+f.right;m=a;C=d}else{if("border-box"!==l.boxSizing)throw"Invalid value: "+l.boxSizing;if(pdf._IE&&l instanceof CSSStyleDeclaration){w=f.top+f.bottom+a;_=f.left+f.right+d}else{w=Math.max(a-c-u,0);_=Math.max(d-g-p,0)}m=Math.max(w-f.top-f.bottom,0);C=Math.max(_-f.left-f.right,0)}return{rect:i=new Rect(s,n,d,a),clientRect:new Rect(s+g,n+c,_,w),contentRect:new Rect(s+g+f.left,n+c+f.top,C,m),textRect:null}}_decompositeStyle(e){if(e){var t;if(t=e.borderColor){e.borderLeftColor||(e.borderLeftColor=t);e.borderRightColor||(e.borderRightColor=t);e.borderTopColor||(e.borderTopColor=t);e.borderBottomColor||(e.borderBottomColor=t)}if(t=e.borderWidth){e.borderLeftWidth||(e.borderLeftWidth=t);e.borderRightWidth||(e.borderRightWidth=t);e.borderTopWidth||(e.borderTopWidth=t);e.borderBottomWidth||(e.borderBottomWidth=t)}if(t=e.borderStyle){e.borderLeftStyle||(e.borderLeftStyle=t);e.borderRightStyle||(e.borderRightStyle=t);e.borderTopStyle||(e.borderTopStyle=t);e.borderBottomStyle||(e.borderBottomStyle=t)}if(t=e.padding){e.paddingLeft||(e.paddingLeft=t);e.paddingRight||(e.paddingRight=t);e.paddingTop||(e.paddingTop=t);e.paddingBottom||(e.paddingBottom=t)}}}_parseBorder(e){var t={left:{width:0},top:{width:0},bottom:{width:0},right:{width:0}};"none"!==e.borderLeftStyle&&(t.left={width:pdf._asPt(e.borderLeftWidth),style:e.borderLeftStyle,color:e.borderLeftColor});"none"!==e.borderTopStyle&&(t.top={width:pdf._asPt(e.borderTopWidth),style:e.borderTopStyle,color:e.borderTopColor});"none"!==e.borderBottomStyle&&(t.bottom={width:pdf._asPt(e.borderBottomWidth),style:e.borderBottomStyle,color:e.borderBottomColor});"none"!==e.borderRightStyle&&(t.right={width:pdf._asPt(e.borderRightWidth),style:e.borderRightStyle,color:e.borderRightColor});return t}_parsePadding(e){return{left:pdf._asPt(e.paddingLeft),top:pdf._asPt(e.paddingTop),bottom:pdf._asPt(e.paddingBottom),right:pdf._asPt(e.paddingRight)}}_renderEmptyCell(e,t,r,o){var l=e.rect.left,i=e.rect.top,s=e.clientRect.width,n=e.clientRect.height,a=e.clientRect.left-e.rect.left,d=e.clientRect.top-e.rect.top,h=e.rect.top+e.rect.height-(e.clientRect.top+e.clientRect.height),g=e.rect.left+e.rect.width-(e.clientRect.left+e.clientRect.width);if(o&&(a||g||h||d)){var c=t.borderLeftColor||t.borderColor,u=t.borderRightColor||t.borderColor,p=t.borderTopColor||t.borderColor,f=t.borderBottomColor||t.borderColor;if(a&&d&&h&&g&&a===g&&a===h&&a===d&&c===u&&c===f&&c===p){var w=a,_=w/2;this._area.paths.rect(l+_,i+_,s+w,n+w).stroke(new pdf.PdfPen(c,w))}else{a&&this._area.paths.polygon([[l,i],[l+a,i+d],[l+a,i+d+n],[l,i+d+n+h]]).fill(c);d&&this._area.paths.polygon([[l,i],[l+a,i+d],[l+a+s,i+d],[l+a+s+g,i]]).fill(p);g&&this._area.paths.polygon([[l+a+s+g,i],[l+a+s,i+d],[l+a+s,i+d+n],[l+a+s+g,i+d+n+h]]).fill(u);h&&this._area.paths.polygon([[l,i+d+n+h],[l+a,i+d+n],[l+a+s,i+d+n],[l+a+s+g,i+d+n+h]]).fill(f)}}r&&_CellRenderer._drawBackground(this._area,e.clientRect,t.backgroundColor)}_renderBooleanCell(e,t,r){if(!(!t.textRect||t.textRect.height<=0||t.textRect.width<=0)){var o=t.textRect.left,l=t.textRect.top,i=t.textRect.height;this._area.paths.rect(o,l,i,i).fillAndStroke(Color.fromRgba(255,255,255),new pdf.PdfPen(void 0,.5));if(!0===changeType(e,DataType.Boolean,"")){var s=i/20,n=i-.5-2*s,a=i/8;this._area.document.saveState();this._area.translate(o+.25+s,l+.25+s).paths.moveTo(a/2,.6*n).lineTo(n-.6*n,n-a).lineTo(n-a/2,a/2).stroke(new pdf.PdfPen(void 0,a));this._area.document.restoreState()}}}_renderTextCell(e,t,r){!e||!t.textRect||t.textRect.height<=0||t.textRect.width<=0||this._area.drawText(e,t.textRect.left,t.textRect.top,{brush:r.color,font:r.font,height:t.textRect.height,width:t.textRect.width,align:"center"===r.textAlign?pdf.PdfTextHorizontalAlign.Center:"right"===r.textAlign?pdf.PdfTextHorizontalAlign.Right:"justify"===r.textAlign?pdf.PdfTextHorizontalAlign.Justify:pdf.PdfTextHorizontalAlign.Left})}_calculateTextRect(e,t,r,o,l,i){if(null!=e&&!isString(e))return null;var s=l.clone();if(this._isBooleanCellAndValue(e,t,r,o)){var n=this._getTextLineHeight(i.font);switch(i.verticalAlign){case"middle":s.top=l.top+l.height/2-n/2;break;case"bottom":s.top=l.top+l.height-n}switch(i.textAlign){case"justify":case"center":s.left=l.left+l.width/2-n/2;break;case"right":s.left=l.left+l.width-n}s.height=s.width=n}else if(s.height>0&&s.width>0){switch(i.verticalAlign){case"bottom":if((d=this._area.measureText(e,i.font,{height:s.height,width:s.width})).size.height<s.height){var a=(h=this._area.document._document).currentLineHeight(!0)-h.currentLineHeight(!1);s.top+=s.height-d.size.height-a;s.height=d.size.height}break;case"middle":var d;if((d=this._area.measureText(e,i.font,{height:s.height,width:s.width})).size.height<s.height){var h;a=(h=this._area.document._document).currentLineHeight(!0)-h.currentLineHeight(!1);s.top+=s.height/2-(d.size.height-a)/2;s.height=d.size.height}}o.wordWrap||r.wordWrap||(s.height=this._getTextLineHeight(i.font))}return s}_getTextLineHeight(e){return this._area.lineHeight(e)}}class GetMergedRangeProxy{constructor(e){this._columns={};this._flex=e}getMergedRange(e,t,r){let o=this._columns[r];if(o&&t>=o.topRow&&t<=o.bottomRow)return o;{let o=this._flex.getMergedRange(e,t,r),l=e.columns,i=e.rows;if(o&&!o.isSingleCell&&(!l[o.col].isVisible||!l[o.col2].isVisible||!i[o.row].isVisible||!i[o.row2].isVisible)){o=o.clone();for(;o.col<o.col2&&!l[o.col].isVisible;)o.col++;for(;o.col2>o.col&&!l[o.col2].isVisible;)o.col2--;for(;o.row<o.row2&&!i[o.row].isVisible;)o.row++;for(;o.row2>o.row&&!i[o.row2].isVisible;)o.row2--}o&&o.isSingleCell&&(o=null);return this._columns[r]=o?new _CellRangeExt(e,o):null}}}export class _CellRange{constructor(e,t,r,o){if("number"==typeof e){this._row=e;this._col=t;this._row2=r;this._col2=o}else{this._row=e.row;this._col=e.col;this._row2=e.row2;this._col2=e.col2}}get row(){return this._row}set row(e){this._row=e}get col(){return this._col}set col(e){this._col=e}get row2(){return this._row2}set row2(e){this._row2=e}get col2(){return this._col2}set col2(e){this._col2=e}get topRow(){return Math.min(this._row,this._row2)}get bottomRow(){return Math.max(this._row,this._row2)}get leftCol(){return Math.min(this._col,this._col2)}get rightCol(){return Math.max(this._col,this._col2)}get columnSpan(){return Math.abs(this._col2-this._col)+1}get rowSpan(){return Math.abs(this._row2-this._row)+1}get isValid(){return this._row>-1&&this._col>-1&&this._row2>-1&&this._col2>-1}get isSingleCell(){return this._row===this._row2&&this._col===this._col2}copyFrom(e){this.setRange(e.row,e.col,e.row2,e.col2)}clone(){return new _CellRange(this._row,this._col,this._row2,this._col2)}getRenderSize(e){let t=new Size(0,0);if(this.isValid){for(let r=this.topRow;r<=this.bottomRow;r++)t.height+=e.rows[r].renderHeight;for(let r=this.leftCol;r<=this.rightCol;r++)t.width+=e.columns[r].renderWidth}return t}setRange(e=-1,t=-1,r=e,o=t){this._row=asInt(e);this._col=asInt(t);this._row2=asInt(r);this._col2=asInt(o)}}export class _CellRangeExt extends _CellRange{constructor(e,t,r,o,l){super(t,r,o,l);this.firstVisibleRow=-1;this.visibleRowsCount=0;if(e){var i=this.topRow,s=this.bottomRow,n=e.rows.length;if(n>0)for(var a=i;a<=s&&a<n;a++)if(e.rows[a].isVisible){this.firstVisibleRow<0&&(this.firstVisibleRow=a);this.visibleRowsCount++}}}copyFrom(e){super.copyFrom(e);this.firstVisibleRow=e.firstVisibleRow;this.visibleRowsCount=e.visibleRowsCount}clone(){return new _CellRangeExt(null,this.row,this.col,this.row2,this.col2)}}class RowRange{constructor(e){this._ranges=e||[]}length(){for(var e=0,t=0;t<this._ranges.length;t++){var r=this._ranges[t];r.isValid&&(e+=r.bottomRow-r.topRow+1)}return e}get isValid(){return this._ranges.length&&this._ranges[0].isValid}get leftCol(){return this._ranges.length?this._ranges[0].leftCol:-1}get rightCol(){return this._ranges.length?this._ranges[0].rightCol:-1}clone(e,t){for(var r=[],o=0;o<this._ranges.length;o++){var l=this._ranges[o].clone();arguments.length>0&&(l.col=e);arguments.length>1&&(l.col2=t);r.push(l)}return new RowRange(r)}getRenderSize(e){for(var t=new Size(0,0),r=0;r<this._ranges.length;r++){var o=this._ranges[r].getRenderSize(e);t.width=Math.max(t.width,o.width);t.height+=o.height}return t}forEach(e,t){for(var r=0,o=0;o<this._ranges.length;o++){var l=this._ranges[o];if(l.isValid)for(var i=l.topRow;i<=l.bottomRow;i++)t(e.rows[i],l,i,r++)}}subrange(e,t,r,o){var l=[];if(e>=0&&t>0)for(var i=0,s=0,n=0;n<this._ranges.length&&t>0;n++,i=s+1){var a=this._ranges[n];if(!(e>(s=i+(a.bottomRow-a.topRow)))){var d=e>i?a.topRow+(e-i):a.topRow,h=Math.min(a.bottomRow,d+t-1),g=arguments.length>2?r:a.leftCol,c=arguments.length>2?o:a.rightCol;l.push(new _CellRange(d,g,h,c));t-=h-d+1}}return new RowRange(l)}}class PdfPageRowRange{constructor(e,t,r){this._col=t;this._row=r;this._range=e}get range(){return this._range}get pageCol(){return this._col}get pageRow(){return this._row}}var _fc,PdfWebWorkerResponseStatus;function getFakeCell(e){if(!_fc){_fc=document.createElement("div");softGrid()&&_fc.setAttribute(softGrid().FlexGrid._WJS_MEASURE,"true")}_fc.style.cssText="";_fc.style.visibility="hidden";let t=e.hostElement,r=t.children.length?t.children[0]:t;_fc.parentNode!==r&&r.appendChild(_fc);return _fc}export function _removeFakeCell(){if(_fc){removeChild(_fc);_fc=null}}export class FlexGridPdfConverter{static draw(e,t,r,o,l){this.drawToPosition(e,t,null,r,o,l)}static drawToPosition(e,t,r,o,l,i){assert(!!e,"The flex argument cannot be null.");assert(!!t,"The doc argument cannot be null.");let s,n=softGrid()&&e instanceof softGrid().FlexGrid,a=e;try{i=_FlexGridPdfCoreConverter._applyDefaultDrawSettings(i);let d=e;if(n){if(i&&i.recalculateStarWidths){s=a.columns.getTotalSize();a.columns._updateStarSizes(pdf.ptToPx(t.width))}d=this._getFlexGridAdapter(a,i)}_FlexGridPdfCoreConverter.draw(d,t,r,o,l,i)}finally{_removeFakeCell();n&&i&&i.recalculateStarWidths&&a.columns._updateStarSizes(s)}}static export(e,t,r){assert(!!e,"The flex argument cannot be null.");assert(!!t,"The fileName argument cannot be empty.");var o=(r=this._applyDefaultExportSettings(r)).documentOptions.ended;r.documentOptions.ended=(e,i)=>{r.progress&&r.progress(1);o&&!1===o.apply(l,[e,i])||pdf.saveBlob(i.blob,t);e.dispose()};var l=new pdf.PdfDocument(r.documentOptions);this.drawToPosition(e,l,null,null,null,r);l.end()}static _getFlexGridAdapter(e,t){return new(softMultiRow()&&e instanceof softMultiRow().MultiRow&&MultiRowAdapter||softSheet()&&e instanceof softSheet().FlexSheet&&FlexSheetAdapter||softOlap()&&e instanceof softOlap().PivotGrid&&PivotGridAdapter||softTransposed()&&e instanceof softTransposed().TransposedGrid&&_TransposedGridAdapter||softTransposedMultiRow()&&e instanceof softTransposedMultiRow().TransposedMultiRow&&TransposedMultiRowAdapter||FlexGridAdapter)(e,t)}static _applyDefaultExportSettings(e){return _merge(_merge({},e),this._DefaultExportSettings)}}FlexGridPdfConverter._DefaultExportSettings=_merge({scaleMode:ScaleMode.PageWidth,documentOptions:{compress:!1,pageSettings:{margins:{left:36,right:36,top:18,bottom:18}}},_progressMax:.9},_FlexGridPdfCoreConverter.DefaultDrawSettings);class FlexGridAdapter{constructor(e,t){this._defBorderColor=null;this._flex=e;this._settings=t;t.quickCellStyles&&(this._styleCache=new StyleCache(200))}get flex(){return this._flex}get settings(){return this._settings}get columns(){return this._flex.columns}get rows(){return this._flex.rows}get bottomLeftCells(){return this._flex.bottomLeftCells}get cells(){return this._flex.cells}get columnFooters(){return this._flex.columnFooters}get columnHeaders(){return this._flex.columnHeaders}get rowHeaders(){return this._flex.rowHeaders}get topLeftCells(){return this._flex.topLeftCells}get treeIndent(){return this._flex.treeIndent}getSelection(){var e=[],t=this._flex.selection,r=softGrid();switch(this._flex.selectionMode){case r.SelectionMode.None:break;case r.SelectionMode.Cell:case r.SelectionMode.CellRange:e.push(t);break;case r.SelectionMode.Row:e.push(new r.CellRange(t.topRow,0,t.topRow,this._flex.cells.columns.length-1));break;case r.SelectionMode.RowRange:e.push(new r.CellRange(t.topRow,0,t.bottomRow,this._flex.cells.columns.length-1));break;case r.SelectionMode.ListBox:for(var o=-1,l=0;l<this._flex.rows.length;l++){if(this._flex.rows[l].isSelected){o<0&&(o=l);l===this._flex.rows.length-1&&e.push(new r.CellRange(o,0,l,this._flex.cells.columns.length-1))}else{o>=0&&e.push(new r.CellRange(o,0,l-1,this._flex.cells.columns.length-1));o=-1}}}return e}getCell(e,t,r,o){var l=e.getCellElement(t,r);if(!l){l=getFakeCell(e);this._flex.cellFactory.updateCell(e,t,r,l,null,o)}return l}getComputedDefBorderColor(){if(null==this._defBorderColor){let e=window.getComputedStyle(this._flex.hostElement);this._defBorderColor="none"!=e.borderRightStyle?e.borderRightColor:"none"!=e.borderBottomStyle?e.borderBottomColor:"none"!=e.borderLeftStyle?e.borderLeftColor:"none"!=e.borderTopStyle?e.borderTopColor:"rgba(0,0,0,0.2)"}return this._defBorderColor}getComputedStyle(e,t){let r;t.className=t.className.replace("wj-state-selected","");t.className=t.className.replace("wj-state-multi-selected","");if(this._styleCache){let o=e.hostElement,l=t.style.cssText.split(/;\s+/).filter(e=>{var t=e.substring(0,e.indexOf(":"));return/^(color|backgroundColor|borderColor|font|textAlign)/i.test(t)}).join(";"),i=t;do{l=i.className+l}while(i!==o&&(i=i.parentElement));if(!(r=this._styleCache.getValue(l))){r=window.getComputedStyle(t);r=this._styleCache.add(l,r)}}else r=window.getComputedStyle(t);return r}getMergedRange(e,t,r){return this._flex.getMergedRange(e,t,r,!1)}get showColumnHeader(){return!!(this._flex.headersVisibility&softGrid().HeadersVisibility.Column)}get showRowHeader(){return!!(this._flex.headersVisibility&softGrid().HeadersVisibility.Row)}get showColumnFooter(){return this._flex.columnFooters.rows.length>0}alignMergedTextToTheTopRow(e){return!1}getCellData(e,t,r){return e.getCellData(t,r,!0)}getCellContent(e,t,r,o){var l=this.getCellData(e,t.index,o),i=r.isContentHtml,s=softGrid();if(!l&&e.cellType===s.CellType.Cell){var n=t;if(n instanceof s.GroupRow&&n.dataItem&&n.dataItem.groupDescription&&r.index===e.columns.firstVisibleIndex){i=!0;l=n.getGroupHeader()}}if(this.settings.customCellContent){let i=this.getCell(e,t.index,o,!0);!(l=i.textContent.trim())&&this.isBooleanCell(e,t,r)&&(l=null==(l=this._extractCheckboxValue(i))?"":l+"")}else if(i){let t=getFakeCell(e);t.innerHTML=l;l=t.textContent.trim()}return l}isBooleanCell(e,t,r){return r.dataType===DataType.Boolean&&e.cellType===softGrid().CellType.Cell&&(!this.isExpandableGroupRow(t)||r.visibleIndex>0)}getColumn(e,t,r){return e.columns[r]}isAlternatingRow(e){let t=!1,r=this._flex.alternatingRowStep;if(r){t=e.visibleIndex%(r+1)==0;1==r&&(t=!t)}return t}isGroupRow(e){return e instanceof softGrid().GroupRow}isNewRow(e){return e instanceof softGrid()._NewRowTemplate}isDetailRow(e){return softDetail()&&e instanceof softDetail().DetailRow}isExpandableGroupRow(e){return e instanceof softGrid().GroupRow&&e.hasChildren}getCellStyle(e,t,r){var o=this.settings.styles,l=_merge({},o.cellStyle),i=this._flex,s=softGrid();switch(e.cellType){case s.CellType.Cell:this.isExpandableGroupRow(t)?_merge(l,o.groupCellStyle,!0):this.isAlternatingRow(t)&&_merge(l,o.altCellStyle,!0);break;case s.CellType.ColumnHeader:case s.CellType.RowHeader:case s.CellType.TopLeft:case s.CellType.BottomLeft:_merge(l,o.headerCellStyle,!0);break;case s.CellType.ColumnFooter:_merge(l,o.headerCellStyle,!0);_merge(l,o.footerCellStyle,!0)}!this.settings.customCellContent&&i._getShowErrors()&&i._getError(e,t.index,r.index)&&_merge(l,o.errorCellStyle,!0);return l}_extractCheckboxValue(e){var t=e.querySelector("input[type=checkbox]");if(t&&"none"!==t.style.display&&"hidden"!==t.style.visibility)return t.checked}}class FlexSheetAdapter extends FlexGridAdapter{getCellData(e,t,r){return e.cellType===softGrid().CellType.Cell?e.rows[t]instanceof softSheet().HeaderRow?this.flex.columnHeaders.getCellData(t,r,!0):this.flex.getCellValue(t,r,!0):super.getCellData(e,t,r)}getCellStyle(e,t,r){var o=super.getCellStyle(e,t,r),l=this.flex.selectedSheet.findTable(t.index,r.index);if(l){var i=l.getRange(),s=t.index-i.topRow,n=r.index-i.leftCol,a=l._getTableCellAppliedStyles(s,n);a&&(a.font=new pdf.PdfFont(a.fontFamily,pdf._asPt(a.fontSize,!0,void 0),a.fontStyle,a.fontWeight));_merge(o,a,!0)}return o}get showColumnHeader(){return!1}get showRowHeader(){return!1}get showColumnFooter(){return!1}}class MultiRowAdapter extends FlexGridAdapter{getColumn(e,t,r){return _combineColumns(super.getColumn(e,t,r),this.flex.getBindingColumn(e,t,r))}isAlternatingRow(e){if(e instanceof softMultiRow()._MultiRow){let t=!1,r=this.flex.alternatingRowStep;if(r){t=e.dataIndex%(r+1)==0;1==r&&(t=!t)}return t}return super.isAlternatingRow(e)}}class PivotGridAdapter extends FlexGridAdapter{alignMergedTextToTheTopRow(e){let t=softGrid();return!this.flex.centerHeadersVertically&&(e.cellType===t.CellType.ColumnHeader||e.cellType===t.CellType.RowHeader)}}export class _TransposedGridAdapter extends FlexGridAdapter{static getBindingColumn(e,t){let r=null,o=e.rows;o&&o[t]&&o[t].dataItem&&(r=o[t].dataItem._rowInfo);assert(null==r||r instanceof softGrid().Column,"Expected a null value or an instance of the wijmo.grid.Column class.");return r}getColumn(e,t,r){let o=super.getColumn(e,t,r);if(e.cellType!=softGrid().CellType.Cell)return o;{let r=_TransposedGridAdapter.getBindingColumn(e,t);return r?_combineColumns(o,r):o}}}class TransposedMultiRowAdapter extends FlexGridAdapter{getColumn(e,t,r){let o=super.getColumn(e,t,r);if(e.cellType!=softGrid().CellType.Cell)return o;{let l=this.flex.getBindingColumn(e,t,r);return l?_combineColumns(o,l):o}}}class StyleCache{constructor(e){this._cache={};this._size=0;this._max=e}add(e,t){this._size>=this._max&&this.clear();let r=this._cache[e]=this._cloneStyle(t);this._size++;return r}clear(){this._cache={};this._size=0}getValue(e){return this._cache[e]||null}hasKey(e){return!!this._cache[e]}_cloneStyle(e){if(!e)return null;for(var t={},toCamel=e=>e.replace(/\-([a-z])/g,(e,t,r)=>r>0?t.toUpperCase():t),r=0,o=e.length;r<o;r++){var l=e[r];t[toCamel(l)]=e.getPropertyValue(l)}return t}}!function(e){e[e.Done=1]="Done";e[e.Progress=2]="Progress"}(PdfWebWorkerResponseStatus||(PdfWebWorkerResponseStatus={}));const DefGridName="";export class PdfWebWorkerExportDoneEventArgs extends EventArgs{constructor(e){super();this._buf=e}get blob(){this._blob||(this._blob=new Blob([new Uint8Array(this._buf)],{type:"application/pdf"}));return this._blob}get buffer(){return this._buf}}export class PdfWebWorkerClient{static exportGrid(e,t,r,o,l,i){(o=FlexGridPdfConverter._applyDefaultExportSettings(o)).progress=o.progress||i;this.addGrid(e,t,DefGridName,o);this.export(e,o.documentOptions,e=>{isFunction(l)&&!1===l(e)||pdf.saveBlob(e.blob,r)},i)}static export(e,t,r,o){e.addEventListener("message",(function handler(t){let l=t.data;switch(l.status){case PdfWebWorkerResponseStatus.Done:e.removeEventListener("message",handler);isFunction(r)&&r(new PdfWebWorkerExportDoneEventArgs(l.data));break;case PdfWebWorkerResponseStatus.Progress:o&&o(l.data);break;default:throw`Unknown status: ${l.status}`}}));let l=this._clientDataToArrayBuffer(e);e.postMessage({content:l,settings:t},[l]);this._clearClientData(e)}static addGrid(e,t,r,o){let l=this._gridToJson(t,o);this._addClientData(e,JSON.stringify(l),r,o,!0)}static addImage(e,t,r,o){let l=isString(t)&&t.indexOf("data:image/svg")>=0?t:pdf._PdfImageHelper.getDataUri(t);this._addClientData(e,l,r,o)}static addString(e,t,r){this._addClientData(e,t,r,null)}static serializeGrid(e,t){let r=this._gridToJson(e,t);return strToBuf(JSON.stringify(r))}static _addClientData(e,t,r,o,l=!1){asType(e,Worker);asString(r);asString(t,!0);let i=e;i.clientData=i.clientData||{};i.clientData[r]={content:t,settings:o?JSON.stringify(o):null};var s=i.clientData[r];if(l){s.isGrid=!0;s.progressMessaging=!!o&&isFunction(o.progress)}}static _clearClientData(e){delete e.clientData}static _clientDataToArrayBuffer(e){let t=e;return strToBuf(JSON.stringify(t.clientData||{}))}static _gridToJson(e,t){t=FlexGridPdfConverter._applyDefaultExportSettings(t);let r,o;try{r=new pdf.PdfDocument(t.documentOptions);if(t&&t.recalculateStarWidths){o=e.columns.getTotalSize();e.columns._updateStarSizes(pdf.ptToPx(r.width))}return this._getJsonConverter(e,t).convert()}finally{_removeFakeCell();t&&t.recalculateStarWidths&&e.columns._updateStarSizes(o);if(null!=r){r.dispose();r=null}}}static _getJsonConverter(e,t){return new(softMultiRow()&&e instanceof softMultiRow().MultiRow&&MultiRowJsonConverter||softOlap()&&e instanceof softOlap().PivotGrid&&PivotGridJsonConverter||softTransposed()&&e instanceof softTransposed().TransposedGrid&&TransposedGridJsonConverter||softTransposedMultiRow()&&e instanceof softTransposedMultiRow().TransposedMultiRow&&TransposedMultirowJsonConverter||FlexGridJsonConverter)(e,t,FlexGridPdfConverter._getFlexGridAdapter(e,t))}}export class PdfWebWorker{static initExportGrid(){this.initExport((e,t)=>{var r=t[DefGridName];if(r.progressMessaging){r.settings._progressMax=FlexGridPdfConverter._DefaultExportSettings._progressMax;r.settings.progress=e=>{this.sendExportProgress(e)};e.ended.addHandler(()=>{this.sendExportProgress(1)})}FlexGridPdfConverter.draw(r.content,e,null,null,r.settings);e.end()})}static initExport(e){self.addEventListener("message",(function handler(t){self.removeEventListener("message",handler);let r=t.data,o=JSON.parse(bufToStr(r.content)),l=r.settings||{};l.ended=(e,t)=>{blobToBuf(t.blob,e=>{self.postMessage({data:e,status:PdfWebWorkerResponseStatus.Done},[e])})};let i=new pdf.PdfDocument(l);Object.keys(o).forEach(e=>{let t=o[e];t.settings&&(t.settings=JSON.parse(t.settings));if(t.isGrid){t.settings&&PdfWebWorker._disableUnsupportedFeatures(t.settings);t.content=PdfWebWorker._deserializeGridFromString(t.content,t.settings)}});e(i,o)}))}static sendExportProgress(e){e=clamp(e,0,1);self.postMessage({data:e,status:PdfWebWorkerResponseStatus.Progress})}static deserializeGrid(e,t){return this._deserializeGridFromString(bufToStr(e),t)}static _deserializeGridFromString(e,t){return this._getJsonAdapter(JSON.parse(e),FlexGridPdfConverter._applyDefaultExportSettings(t))}static _disableUnsupportedFeatures(e){e.customCellContent=!1}static _getJsonAdapter(e,t){switch(e.typeName){case"MultiRow":return new MultiRowJsonAdapter(e,t);case"PivotGrid":return new PivotGridJsonAdapter(e,t);case"TransposedGrid":return new TransposedGridJsonAdapter(e,t);case"TransposedMultiRow":return new TransposedMultiRowJsonAdapter(e,t);default:return new FlexGridJsonAdapter(e,t)}}}function bufToStr(e){for(var t=new Uint16Array(e),r="",o=0,l=t.length;o<l;o++)r+=String.fromCharCode(t[o]);return r}function strToBuf(e){for(var t=new ArrayBuffer(2*e.length),r=new Uint16Array(t),o=0,l=e.length;o<l;o++)r[o]=e.charCodeAt(o);return t}function blobToBuf(e,t){asFunction(t);var r=new FileReader;r.onload=function(e){t(e.target.result)};r.readAsArrayBuffer(e)}var RowState,ColState;!function(e){e[e.None=0]="None";e[e.Alternate=1]="Alternate";e[e.Group=2]="Group";e[e.ExpandableGroup=4]="ExpandableGroup";e[e.New=8]="New";e[e.Visible=16]="Visible";e[e.Detail=32]="Detail"}(RowState||(RowState={}));!function(e){e[e.None=0]="None";e[e.Visible=1]="Visible"}(ColState||(ColState={}));class FlexGridJsonConverter{constructor(e,t,r){this._flex=e;this._settings=t;this._adapter=r}convert(){var e={};e.typeName=this._getTypeName(this._flex);e.selection=this._serializeSelection();e.showColumnFooter=this.adapter.showColumnFooter;e.showColumnHeader=this.adapter.showColumnHeader;e.showRowHeader=this.adapter.showRowHeader;e.treeIndent=this._flex.treeIndent;e.bottomLeftCells=this._serializePanel(this._flex.bottomLeftCells);e.cells=this._serializePanel(this._flex.cells);e.columnFooters=this._serializePanel(this._flex.columnFooters);e.columnHeaders=this._serializePanel(this._flex.columnHeaders);e.rowHeaders=this._serializePanel(this._flex.rowHeaders);e.topLeftCells=this._serializePanel(this._flex.topLeftCells);return e}get adapter(){return this._adapter}get flex(){return this._flex}_getTypeName(e){return e.constructor.toString().match(/function\s*(\w+)/)[1]}_getRowState(e){var t=RowState.None;this.adapter.isAlternatingRow(e)&&(t|=RowState.Alternate);e instanceof softGrid().GroupRow&&(t|=RowState.Group);this.adapter.isDetailRow(e)&&(t|=RowState.Detail);this.adapter.isExpandableGroupRow(e)&&(t|=RowState.ExpandableGroup);e instanceof softGrid()._NewRowTemplate&&(t|=RowState.New);e.isVisible&&(t|=RowState.Visible);return t}_getColumnState(e){var t=ColState.None;e.isVisible&&(t|=ColState.Visible);return t}_serializeSelection(){let e=this.adapter.getSelection(),t=[];for(let o=0;o<e.length;o++){var r=e[o];t.push([r.row,r.col,r.row2,r.col2])}return t}_serializeColumns(e){let t=[];for(let r=0,o=(e||[]).length;r<o;r++){let o=e[r],l=null;if(o){l={aggregate:o.aggregate,renderWidth:o.renderWidth,visibleIndex:o.visibleIndex};let e=o.getAlignment();e&&(l.alignment=e);let t=this._getColumnState(o);t!==ColState.None&&(l.state=t);o.binding&&(l.binding=o.binding);null!=o.dataType&&(l.dataType=o.dataType);null!=o.name&&(l.name=o.name);o.wordWrap&&(l.wordWrap=!0)}t.push(l)}return t}_serializePanel(e){let t={cellType:e.cellType,height:e.height,width:e.width},getAlignment=e=>{if(e.align)return e.align;if(!e.dataMap)switch(e.dataType){case DataType.Boolean:return"center";case DataType.Number:return"right"}return null};t.mergedRanges=this._serializeMergedRanges(e);t.columns=this._serializeColumns(e.columns);t.columnsFirstVisibleIndex=e.columns.firstVisibleIndex;t.rows=[];t.rowsMaxGroupLevel=e.rows.maxGroupLevel;let r=!this._settings.customCellContent&&this._flex._getShowErrors();for(let o=0,l=e.rows.length,i=e.columns.length;o<l;o++){let l=e.rows[o],s={renderHeight:l.renderHeight};t.rows.push(s);let n=getAlignment(l);n&&(s.alignment=n);l instanceof softGrid().GroupRow&&(s.level=l.level);let a=this._getRowState(l);a!==RowState.None&&(s.state=a);l.binding&&(s.binding=l.binding);null!=l.dataType&&(s.dataType=l.dataType);l.wordWrap&&(s.wordWrap=!0);s.cells=[];let d=softGrid();for(let t=0;t<i;t++){let l=this._adapter.getCellContent(e,e.rows[o],e.columns[t],t);if(isFunction(this._settings.formatItem)){let r=new PdfFormatItemEventArgs(e,new d.CellRange(o,t),null,null,null,null,null,()=>this._adapter.getCell(e,o,t,!0),null);r.data=l;this._settings.formatItem(r);r.data!==l&&(l=r.data)}s.cells[t]=l;if(r&&this._flex._getError(e,o,t)){s.errors||(s.errors={});s.errors[t]=1}}}return t}_serializeMergedRanges(e){for(var t=[],r=[],o=0;o<e.columns.length;o++)r[o]=0;for(var l=0;l<e.rows.length;l++)for(var i=0;i<e.columns.length;i++)if(!(l<r[i])){var s=e.grid.getMergedRange(e,l,i);if(null!=s&&!s.isSingleCell){t.push([s.row,s.col,s.row2,s.col2]);for(var n=s.col;n<=s.col2;n++)r[n]=s.row2+1;s.col===s.col2||(i=s.col2)}}return t}}class MultiRowJsonConverter extends FlexGridJsonConverter{convert(){let e=super.convert();e.rowsPerItem=this.flex.rowsPerItem;return e}_serializePanel(e){let t=super._serializePanel(e);t.cellGroups=this._serializeCellGroup(e);return t}_serializeCellGroup(e){let t=[],r=[],o=softGrid(),l=this.flex.rowsPerItem;e.cellType!==o.CellType.TopLeft&&e.cellType!==o.CellType.ColumnHeader||(l=e.rows.length);for(let o=0;o<l;o++){r[o]=[];for(let l=0;l<e.columns.length;l++){let i=this.flex.getBindingColumn(e,o,l),s=t.indexOf(i);r[o][l]=s<0?t.push(i)-1:s}}return{bindingColumns:this._serializeColumns(t),mappings:r}}}class PivotGridJsonConverter extends FlexGridJsonConverter{convert(){let e=super.convert();e.centerHeadersVertically=this.flex.centerHeadersVertically;return e}}class TransposedGridJsonConverter extends FlexGridJsonConverter{convert(){let e=super.convert(),t=new Array(this.flex.cells.rows.length),r=this.flex.cells;for(var o=0,l=r.rows.length;o<l;o++)t[o]=_TransposedGridAdapter.getBindingColumn(r,o);e.rowInfo=this._serializeColumns(t);return e}}class TransposedMultirowJsonConverter extends FlexGridJsonConverter{convert(){let e=super.convert();e.cellGroups=this._serializeCellGroup();e.columnsPerItem=this.flex.columnsPerItem;return e}_serializeCellGroup(){let e=[],t=[],r=this.flex.columnsPerItem,o=this.flex.cells;for(let l=0;l<o.rows.length;l++){t[l]=[];for(let i=0;i<r;i++){let r=this.flex.getBindingColumn(o,l,i),s=e.indexOf(r);t[l][i]=s<0?e.push(r)-1:s}}return{bindingColumns:this._serializeColumns(e),mappings:t}}}class RowJson{constructor(e,t){this.index=t;this.binding=e.binding;this.dataType=e.dataType;this.alignment=e.alignment;this.level=e.level;this.renderHeight=e.renderHeight;this.cells=e.cells;this.wordWrap=e.wordWrap||!1;this.errors=e.errors;this._state=e.state}get isAlternatingRow(){return(this._state&RowState.Alternate)!==RowState.None}get isGroupRow(){return(this._state&RowState.Group)!==RowState.None}get isDetailRow(){return(this._state&RowState.Detail)!==RowState.None}get isExpandableGroupRow(){return(this._state&RowState.ExpandableGroup)!==RowState.None}get isNewRow(){return(this._state&RowState.New)!==RowState.None}get isVisible(){return(this._state&RowState.Visible)!==RowState.None}}class ColumnJson{constructor(e,t){this.index=t;this.binding=e.binding;this.dataType=e.dataType;this.aggregate=e.aggregate;this.name=e.name;this.renderWidth=e.renderWidth;this.visibleIndex=e.visibleIndex;this.wordWrap=e.wordWrap||!1;this._alignment=e.alignment;this._state=e.state}getAlignment(e){return this._alignment?this._alignment:e&&e.alignment?e.alignment:""}get isVisible(){return(this._state&ColState.Visible)!==ColState.None}}class RowJsonCollection{constructor(e,t=-1){this.maxGroupLevel=t;this.length=e.length;for(let t=0;t<e.length;t++)this[t]=new RowJson(e[t],t)}}class ColumnJsonCollection{constructor(e,t=-1){this.firstVisibleIndex=t;this.length=e.length;for(let t=0;t<e.length;t++){let r=e[t];this[t]=r?new ColumnJson(e[t],t):null}}}class GridJsonPanel{constructor(e){this.height=e.height;this.width=e.width;this.cellType=e.cellType;this.columns=new ColumnJsonCollection(e.columns,e.columnsFirstVisibleIndex);this.rows=new RowJsonCollection(e.rows,e.rowsMaxGroupLevel);this._mergedRanges=this._deserializeMergedRanges(e.mergedRanges)}getCellData(e,t){return this.rows[e].cells[t]}getMergedRange(e,t){let r=this._mergedRanges[e];if(r)for(let e=0,l=r.length;e<l;e++){var o=r[e];if(t>=o.col&&t<=o.col2)return o}return null}_deserializeMergedRanges(e){let t=[];e=e||[];for(let e=0,r=this.rows.length;e<r;e++)t[e]=[];for(let r=0,o=e.length;r<o;r++){let o=e[r],l=new _CellRange(o[0],o[1],o[2],o[3]);for(let e=l.row;e<=l.row2;e++)t[e].push(l)}return t}}class FlexGridJsonAdapter{constructor(e,t){this.settings=t;this.bottomLeftCells=this.deserializePanel(e.bottomLeftCells);this.cells=this.deserializePanel(e.cells);this.columnFooters=this.deserializePanel(e.columnFooters);this.columnHeaders=this.deserializePanel(e.columnHeaders);this.rowHeaders=this.deserializePanel(e.rowHeaders);this.topLeftCells=this.deserializePanel(e.topLeftCells);this.treeIndent=e.treeIndent;this.showColumnFooter=e.showColumnFooter;this.showColumnHeader=e.showColumnHeader;this.showRowHeader=e.showRowHeader;this._selection=[];for(let t=0;t<e.selection.length;t++){let r=e.selection[t];this._selection.push(new _CellRange(r[0],r[1],r[2],r[3]))}}get columns(){return this.cells.columns}get rows(){return this.cells.rows}getSelection(){return this._selection}getCell(e,t,r,o){throw"Not implemented"}getComputedDefBorderColor(){throw"Not implemented"}getComputedStyle(e,t){throw"Not implemented"}getMergedRange(e,t,r){return e.getMergedRange(t,r)}alignMergedTextToTheTopRow(e){return!1}getCellData(e,t,r){return e.getCellData(t,r)}getCellContent(e,t,r,o){return this.getCellData(e,t.index,o)}isBooleanCell(e,t,r){return r.dataType===DataType.Boolean&&e.cellType===_CellType.Cell&&!this.isExpandableGroupRow(t)}getColumn(e,t,r){return e.columns[r]}isAlternatingRow(e){return e.isAlternatingRow}isGroupRow(e){return e.isGroupRow}isNewRow(e){return e.isNewRow}isDetailRow(e){return e.isDetailRow}isExpandableGroupRow(e){return e.isExpandableGroupRow}getCellStyle(e,t,r){var o=this.settings.styles,l=_merge({},o.cellStyle);switch(e.cellType){case _CellType.Cell:this.isExpandableGroupRow(t)?_merge(l,o.groupCellStyle,!0):this.isAlternatingRow(t)&&_merge(l,o.altCellStyle,!0);break;case _CellType.ColumnHeader:case _CellType.RowHeader:case _CellType.TopLeft:case _CellType.BottomLeft:_merge(l,o.headerCellStyle,!0);break;case _CellType.ColumnFooter:_merge(l,o.headerCellStyle,!0);_merge(l,o.footerCellStyle,!0)}t.errors&&t.errors[r.index]&&_merge(l,o.errorCellStyle,!0);return l}deserializePanel(e){return new GridJsonPanel(e)}}class PivotGridJsonAdapter extends FlexGridJsonAdapter{constructor(e,t){super(e,t);this._centerHeadersVertically=e.centerHeadersVertically}alignMergedTextToTheTopRow(e){return!this._centerHeadersVertically&&(e.cellType===_CellType.ColumnHeader||e.cellType===_CellType.RowHeader)}}class MultiRowJsonPanel extends GridJsonPanel{constructor(e){super(e);e.cellGroups&&(this._cellGroups={bindingColumns:new ColumnJsonCollection(e.cellGroups.bindingColumns),mappings:e.cellGroups.mappings})}getColumn(e,t,r){var o=this.columns[t];if(this._cellGroups){this.cellType!==_CellType.ColumnHeader&&this.cellType!==_CellType.BottomLeft&&(e%=r);return _combineColumns(o,this._cellGroups.bindingColumns[this._cellGroups.mappings[e][t]])}return o}}class MultiRowJsonAdapter extends FlexGridJsonAdapter{constructor(e,t){super(e,t);this._rowsPerItem=e.rowsPerItem}deserializePanel(e){return new MultiRowJsonPanel(e)}getColumn(e,t,r){return e.getColumn(t,r,this._rowsPerItem)}}class TransposedGridJsonAdapter extends FlexGridJsonAdapter{constructor(e,t){super(e,t);this._rowInfo=new ColumnJsonCollection(e.rowInfo)}getColumn(e,t,r){let o=super.getColumn(e,t,r);if(e.cellType!==_CellType.Cell)return o;{let e=this._rowInfo[t];return e?_combineColumns(o,e):o}}}class TransposedMultiRowJsonAdapter extends FlexGridJsonAdapter{constructor(e,t){super(e,t);this._columnsPerItem=e.columnsPerItem;e.cellGroups&&(this._cellGroups={bindingColumns:new ColumnJsonCollection(e.cellGroups.bindingColumns),mappings:e.cellGroups.mappings})}getColumn(e,t,r){let o=super.getColumn(e,t,r);if(this._cellGroups&&e.cellType===_CellType.Cell){r%=this._columnsPerItem;return _combineColumns(o,this._cellGroups.bindingColumns[this._cellGroups.mappings[t][r]])}return o}}_registerModule("wijmo.grid.pdf",selfModule);