/*!
    *
    * Wijmo Library 5.20202.724
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

import{assert,asType,hasClass,createElement,asBoolean,setChecked,isString,isNumber,copy,closestClass,Event,CancelEventArgs,DataType,_registerModule}from"wijmo/wijmo";import{FlexGrid,Column,GroupRow,CellRange,CellFactory,SelectionMode,HeadersVisibility}from"wijmo/wijmo.grid";import*as selfModule from"wijmo/wijmo.grid.selector";const _CLS_CB_ITEM="wj-column-selector",_CLS_CB_GROUP="wj-column-selector-group";export class Selector{constructor(e,t){this._col=null;this._grid=null;this._isFixedCol=!1;this._isBound=!1;this._showCheckAll=!0;this._clickBnd=this._click.bind(this);this._mousedownBnd=this._mousedown.bind(this);this.columnChanging=new Event;this.columnChanged=new Event;this.itemChecked=new Event;this._initialize();this.column=this._getColumn(e);copy(this,t)}get column(){return this._col}set column(e){if((e=this._getColumn(e))!=this._col&&this.onColumnChanging(new CancelEventArgs)){let t=this._grid;if(t){let e=t.hostElement;t.formatItem.removeHandler(this._formatItem,this);t.removeEventListener(e,"click",this._clickBnd);t.removeEventListener(e,"mousedown",this._mousedownBnd)}let i=this._col=asType(e,Column,!0);this._grid=t=i?i.grid:null;this._isFixedCol=!!t&&t.columns.indexOf(i)<0;i&&!this._isBound&&(i.allowMerging=!1);t&&!this._isBound&&(t.selectionMode=SelectionMode.Cell);if(t){let e=t.hostElement;t.formatItem.addHandler(this._formatItem,this);t.addEventListener(e,"click",this._clickBnd,!0);t.addEventListener(e,"mousedown",this._mousedownBnd,!0)}this.onColumnChanged()}}get showCheckAll(){return this._showCheckAll}set showCheckAll(e){if(e!=this._showCheckAll){this._showCheckAll=asBoolean(e);this._grid&&this._grid.invalidate()}}onColumnChanging(e){this.columnChanging.raise(this,e);return!e.cancel}onColumnChanged(e){this.columnChanged.raise(this,e)}onItemChecked(e){this.itemChecked.raise(this,e)}_initialize(){}_click(e){if(!e.defaultPrevented&&e.target instanceof HTMLElement){let t=this._grid,i=this._col,s=e.target,o=t.hitTest(s);if(i&&o&&o.getColumn()==i){if(s instanceof HTMLInputElement&&hasClass(s,_CLS_CB_ITEM)){let l,n=o.panel.rows,h=n[o.range.topRow];if(n==t.columnHeaders.rows){l=new CellRange(0,0,t.rows.length-1,0);if(this._isBound){let e=t.selection;e.col=e.col2=i.index;t.select(e)}}else l=this._isGroupRow(h)?h.getCellRange():o.range;if(l.isValid){this._setRangeChecked(s.checked,l);this.onItemChecked()}t.invalidate();e.preventDefault();return}if(hasClass(s,"wj-cell")&&t.bigCheckboxes&&this._isBound&&(this._isFixedCol||this._isGroupRow(o.getRow()))){let t=s.querySelector("input."+_CLS_CB_ITEM);if(t instanceof HTMLInputElement){t.click();e.preventDefault()}}}}}_mousedown(e){let t=this._grid,i=this._col,s=t.editableCollectionView;if(this._isBound&&i&&s&&s.currentEditItem){let s=t.hitTest(e);if(s.getColumn()==i&&this._isGroupRow(s.getRow())){let t=closestClass(e.target,_CLS_CB_GROUP);t instanceof HTMLInputElement&&t.click()}}}_isGroupRow(e){return e instanceof GroupRow&&(!this._grid.childItemsPath||e.getCellRange().rowSpan>1)}_getRowChecked(e,t=e){let i=0,s=0,o=this._col._binding;for(let l=e;l<=t&&(!i||!s);l++){let e=this._grid.rows[l],t=e.dataItem;if(t&&!this._isGroupRow(e)){(this._isBound?o.getValue(t):e.isSelected)?i++:s++}}return!(!i||s)||!(s&&!i)&&null}_setRangeChecked(e,t){let i=this._grid,s=i.rows,o=this._col,l=o?o._binding:null,n=i.selection,h=this._isBound?i.editableCollectionView:null;if(!this._isBound||!i.isReadOnly&&h&&l){h&&h.beginUpdate();i.deferUpdate(()=>{for(let o=t.bottomRow;o>=t.topRow;o--){let t=s[o],n=t.dataItem;if(n)if(this._isGroupRow(t))i.childItemsPath&&!this._isBound&&(t.isSelected=e);else if(this._isBound){h&&h.editItem(n);l.setValue(n,e)}else t.isSelected=e}});if(h){h.commitEdit();h.endUpdate();i.selection=n}}}_formatItem(e,t){let i=t.getColumn(),s=e.editRange;if(i&&i==this._col&&(!s||!s.contains(t.row,t.col))&&t.panel.rows!=e.columnFooters.rows){let s,o=t.getRow(),l=t.cell,n="";if(t.panel.rows==e.columnHeaders.rows){if(this._showCheckAll&&t.range.bottomRow==t.panel.rows.length-1){s=this._getRowChecked(0,e.rows.length-1);n=_CLS_CB_ITEM+" "+_CLS_CB_GROUP}}else if(this._isGroupRow(o)){let e=o.getCellRange();s=this._getRowChecked(e.row,e.row2);n=_CLS_CB_ITEM+" "+_CLS_CB_GROUP}else if(o.dataItem&&!this._isBound){s=this._getRowChecked(t.row);n=_CLS_CB_ITEM}if(n){if(this._isFixedCol||this._isBound&&this._isGroupRow(o)){let e=l.querySelector("."+CellFactory._WJC_COLLAPSE);l.textContent="";e&&l.appendChild(e)}let t=createElement('<label><input type="checkbox" class="'+n+'" tabindex="-1"><span></span></label>'),h=t.querySelector("input");setChecked(h,s);if(this._isBound&&(i.isReadOnly||e.selectionMode==SelectionMode.None)){h.disabled=!0;h.style.cursor="default"}l.insertBefore(t,l.firstChild)}}}_getColumn(e){if(e instanceof FlexGrid){let t=e,i=t.rowHeaders.columns;e=t.headersVisibility&HeadersVisibility.Row&&i.length?i[0]:t.columns[0]}this._grid&&(isString(e)||isNumber(e))&&(e=this._grid.getColumn(e));return e instanceof Column?e:null}}export class BooleanChecker extends Selector{constructor(e,t){super(e,t)}onColumnChanged(e){let t=this.column;assert(!t||t.dataType==DataType.Boolean,"BooleanChecker should be bound to boolean columns");super.onColumnChanged(e)}_initialize(){this._isBound=!0}}_registerModule("wijmo.grid.selector",selfModule);