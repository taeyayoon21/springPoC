/*!
    *
    * Wijmo Library 5.20202.724
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

import{assert,copy,asInt,addClass,asArray,hasItems,isArray,toggleClass,toHeaderCase,tryCast,Binding,CollectionView,ObservableArray,NotifyCollectionChangedEventArgs,NotifyCollectionChangedAction,getType,_registerModule}from"wijmo/wijmo";import{MergeManager,CellRange,CellType,Column,Row,AllowDragging,AllowSorting,ColumnCollection,FlexGrid}from"wijmo/wijmo.grid";import*as selfModule from"wijmo/wijmo.grid.transposedmultirow";export class _MultiRow extends Row{constructor(e,t){super(e);this._idxData=t}}export class _Cell extends Column{constructor(e){super();this._row=this._col=0;this._rowspan=this._colspan=1;copy(this,e)}get row(){return this._row}set row(e){this._row=asInt(e,!1,!0)}get col(){return this._col}set col(e){this._col=asInt(e,!1,!0)}get colspan(){return this._colspan}set colspan(e){this._colspan=asInt(e,!1,!0);assert(this._colspan>0,"colspan must be >= 1")}get rowspan(){return this._rowspan}set rowspan(e){this._rowspan=asInt(e,!1,!0);assert(this._rowspan>0,"colspan must be >= 1")}}export class _CellGroup extends _Cell{constructor(e,t){super();this._colstart=0;this._rowstart=0;this._layout=e;this._g=e._grid;copy(this,t);if(!this._cells)throw"Cell group with no cells?";let o=0,l=0;this._cells.forEach((e,t)=>{for(;!this._cellFits(e,t,o,l);)0==(l=(l+1)%this.colspan)&&o++;e.row=o;e.col=l});let s=1,r=1;this._cells.forEach(e=>{s=Math.max(s,e.row+e.rowspan);r=Math.max(r,e.col+e.colspan)});this.rowspan=s;this.colspan=r}_copy(e,t){if("cells"==e){this._cells=[];isArray(t)&&t.forEach(e=>{let t=new _Cell(e);t.binding&&!t.header&&(t.header=toHeaderCase(t.binding));this._cells.push(t);this.colspan=Math.max(this.colspan,t.colspan)});return!0}return!1}get cells(){return this._cells}closeGroup(e){if(e>this.colspan){this._cells.forEach(t=>{t.col==this.colspan-1&&(t.colspan=e-t.col)});this.colspan=e}this._cells.forEach(e=>{for(;e.col+e.colspan<this.colspan&&!this._slotTaken(e.row,e.col+e.colspan);)e.colspan++});this._cells.forEach(e=>{for(;e.row+e.rowspan<this.rowspan&&!this._slotTaken(e.row+e.rowspan,e.col);)e.rowspan++});for(let e=0;e<this.rowspan;e++)for(let t=0;t<this.colspan;t++)assert(this._slotTaken(e,t),"Invalid layout (empty cells).");this._cols=new ColumnCollection(this._g,this._g.columns.defaultSize);this._rng=new Array(e*this.rowspan);this._cells.forEach(e=>{for(let t=0;t<e.rowspan;t++)for(let o=0;o<e.colspan;o++){let l=(e.row+t)*this.colspan+(e.col+o);this._cols.setAt(l,e);let s=new CellRange(e.row,e.col,e.row+e.rowspan-1,e.col+e.colspan-1);s.isSingleCell||(this._rng[l]=s)}});this._rng[-1]=new CellRange(this._rowstart,this._colstart,this._rowstart+this._rowspan-1,this._colstart)}getMergedRange(e,t,o){if(o<0)return this._rng[-1];let l=t-this._rowstart,s=o%this.colspan,r=this._rng[l*this.colspan+s];e.cellType==CellType.RowHeader&&o++;let n=t-l,i=o-s;return r?new CellRange(n+r.row,i+r.col,n+r.row2,i+r.col2):null}getBindingColumn(e,t,o){if(o<0)return this;let l=t-this._rowstart,s=o%this.colspan;return this._cols[l*this.colspan+s]}_cellFits(e,t,o,l){if(l>0&&l+e.colspan>this.colspan)return!1;for(let s=0;s<e.colspan;s++)if(this._slotTaken(o,l+s,t))return!1;this.colspan=Math.max(this.colspan,l+e.colspan-1);return!0}_slotTaken(e,t,o=this._cells.length){for(let l=0;l<o;l++){let o=this._cells[l];if(e>=o.row&&e<=o.row+o.rowspan-1&&t>=o.col&&t<=o.col+o.colspan-1)return!0}return!1}_updateCellTypes(e){this._cols.forEach(t=>{let o=t;null==o.dataType&&o._binding&&(o.dataType=getType(o._binding.getValue(e)))})}}export class _MergeManager extends MergeManager{getMergedRange(e,t,o,l=!0){let s=e.grid;if(t<0||t>=e.rows.length||o<0||o>=e.columns.length)return null;switch(e.cellType){case CellType.Cell:case CellType.RowHeader:let l=e.rows[t].dataItem._rowInfo.index,r=o;e.cellType==CellType.RowHeader&&r--;let n=s._getGroupByRow(t);assert(n instanceof _CellGroup,"Failed to get the group!");let i=n.getMergedRange(e,l,r);if(i){let o=l,s=t;if(t>0){o=e.rows[t-1].dataItem._rowInfo.index;s=t-1}i.row<=o?i.row=s:i.row=t;let r=l,n=t;if(t<e.rows.length-1){r=e.rows[t+1].dataItem._rowInfo.index;n=t+1}i.row2>=r?i.row2=n:i.row2=t}assert(!i||i.contains(t,o),"Merged range must contain source cell");return i;case CellType.ColumnHeader:let a=s.columnsPerItem,h=o-o%a,u=Math.min(h+a-1,e.columns.length-1);return new CellRange(0,h,e.rows.length-1,u);case CellType.TopLeft:return new CellRange(0,0,e.rows.length-1,e.columns.length-1)}return null}}export class _MultiRowLayout{constructor(e,t){this._columnsPerItem=1;this._bindingGroups=[];this._groupsByRow={};this._grid=e;this._bindingGroups=this._parseCellGroups(t)}get totalRowSpan(){let e=this._bindingGroups;if(e&&e.length){let t=e[e.length-1];return t._rowstart+t.rowspan}return 0}_parseCellGroups(e){let t=[],o=1;if(e){for(let l=0,s=0;l<e.length;l++){let r=new _CellGroup(this,e[l]);r._rowstart=s;s+=r._rowspan;o=Math.max(o,r._colspan);t.push(r)}t.forEach(e=>{e.closeGroup(o)});this._columnsPerItem=o}return t}_getGroupByRow(e){let t=this._getGroupIndexByRow(e);return t>-1?this._bindingGroups[t]:null}_getGroupIndexByRow(e){let t=this._groupsByRow[e];if(t)return t;let o=this._bindingGroups;for(let t=0;t<o.length;t++){let l=o[t];if(e>=l._rowstart&&e<=l._rowstart+l._rowspan-1){this._groupsByRow[e]=t;return t}}return-1}_updateCellTypes(e){this._bindingGroups.forEach(t=>{t._updateCellTypes(e)})}}export class TransposedMultiRow extends FlexGrid{constructor(e,t){super(e);this._bindingColumns={};this._keyPrefix="item";addClass(this.hostElement,"wj-transposed-multirow");this._layout=new _MultiRowLayout(this,null);this.allowDragging=AllowDragging.None;this.allowSorting=AllowSorting.None;this.mergeManager=new _MergeManager(this);this.formatItem.addHandler(this._formatItem,this);this._rowInfo=new ColumnCollection(this,this.columns.defaultSize);this.initialize(t);this._rowInfo.collectionChanged.addHandler(this._rowInfoChanged,this)}get layoutDefinition(){return this._layoutDef}set layoutDefinition(e){this._layoutDef=asArray(e);this._layout=new _MultiRowLayout(this,e);this._rowInfoChanged()}getBindingColumn(e,t,o){if(e.cellType!=CellType.Cell)return null;let l=e.rows[t].dataItem._rowInfo.index,s=l+"_"+o,r=this._bindingColumns[s];if(r)return r;let n=this._getGroupByRow(t).getBindingColumn(e,l,o);if(n){r=new Column;FlexGrid._getSerializableProperties(Column).forEach(e=>{null!=n[e]&&(r[e]=n[e])});let e=Math.floor(o/this.columnsPerItem),t=o%this.columnsPerItem;r.binding=this._keyPrefix+e+"_"+t;this._bindingColumns[s]=r}return r}get columnsPerItem(){return this._layout._columnsPerItem}get allowAddNew(){return!1}set allowAddNew(e){assert(!e,"TransposedMultiRow does not support items addition.")}get allowDelete(){return!1}set allowDelete(e){assert(!e,"TransposedMultiRow does not support items deletion.")}get allowDragging(){return AllowDragging.None}set allowDragging(e){assert(e===AllowDragging.None,"TransposedMultiRow does not support dragging.");if(e!==this._alDragging){this._alDragging=e;this.invalidate()}}get allowPinning(){return!1}set allowPinning(e){assert(!e,"TransposedMultiRow does not support pinning.")}get allowSorting(){return AllowSorting.None}set allowSorting(e){assert(e===AllowSorting.None,"TransposedMultiRow does not support sorting.");this._alSorting=e}get columnLayout(){throw"TransposedMultiRow does not support column layout."}set columnLayout(e){throw"TransposedMultiRow does not support column layout."}refresh(e){let t=this._rowInfo;if(t._dirty){t._dirty=!1;this._rowInfoChanged()}else super.refresh(e)}onLoadedRows(e){let t=this.columnHeaders.columns;for(let e=0;e<t.length;e++)this.columnHeaders.setCellData(0,e,"");let o=this.columns;for(let e=0;e<o.length;e++){let t=o[e];t.align=null;t.dataType=0}let l=this.rowHeaders.columns;this.rows.forEach(e=>{let t=e.dataItem._rowInfo;if(t)for(let o=l.length-2;o>=0;o--){let l=t.headers[o]||toHeaderCase(t.bindings[o]);this.rowHeaders.setCellData(e.index,o+1,l)}});l[0].visible=!1;for(let e=1;e<l.length;e++){l[e].align="left";l[e].visible=!0;l[e].width=this.columns.defaultSize}super.onLoadedRows(e)}_getGroupByRow(e){let t=this.cells.rows[e].dataItem._rowInfo.index,o=this._layout._getGroupByRow(t);assert(o instanceof _CellGroup,"Failed to get the group!");return o}_addBoundRow(e,t){let o=e[t];this.rows.push(new _MultiRow(o,t))}_updateColumnTypes(){super._updateColumnTypes();let e=this.collectionView;if(hasItems(e)&&this._layout){let t=e.items[0]._arr;t&&t.length>0&&this._layout._updateCellTypes(t[0])}}_getBindingColumn(e,t,o){if(this._layout){e==this.cells&&(o=this.getBindingColumn(e,t,o.index));return o}return super._getBindingColumn(e,t,o)}_getCollectionView(e){let t=null;null!=this._view&&this._view.collectionChanged.removeHandler(this._sourceViewChanged);if(isArray(e))e=this._transposeItemsSource(e);else if(e){this._view&&this._view.collectionChanged.removeHandler(this._sourceViewChanged);this._view=tryCast(e,"ICollectionView");if(this._view){this._view.collectionChanged.addHandler(this._sourceViewChanged,this);e instanceof CollectionView&&(t=e.getError);e=this._transposeItemsSource(this._view.items)}}this.autoGenerateColumns=!0;let o=super._getCollectionView(e);t&&o instanceof CollectionView&&(o.getError=(e,o)=>{let l=e._keys.indexOf(o),s=l%e._bnd.length,r=Math.floor(l/e._bnd.length);return t(e._arr[r],e._bnd[s].path)});return o}_rowInfoChanged(){let e=this.selection,t=this.itemsSource;this._bindingColumns={};this.itemsSource=null;this.itemsSource=t;e&&e.isValid&&(this.selection=e)}_formatItem(e,t){let o=this.columnsPerItem,l=t.panel,s=l.cellType,r=l.rows[t.range.row],n=(l.rows[t.range.row2],t.cell);s==CellType.RowHeader&&toggleClass(n,"wj-group-header",0==t.range.row);if(s==CellType.Cell||s==CellType.RowHeader){let e=this._getGroupByRow(t.row);toggleClass(n,"wj-group-start",e._rowstart==t.range.row);toggleClass(n,"wj-group-end",e._rowstart+e._rowspan-1==t.range.row2)}if(o>1&&(s==CellType.Cell||s==CellType.ColumnHeader)){toggleClass(n,"wj-record-start",t.range.col%o==0);toggleClass(n,"wj-record-end",t.range.col2%o==o-1)}let i=this.alternatingRowStep;if(i&&s==CellType.Cell){let e=this._layout.totalRowSpan,t=this._layout._bindingGroups.length,o=Math.floor(r.dataIndex/e)*t,l=r.dataIndex%e;o+=this._layout._getGroupIndexByRow(l)+1;toggleClass(n,"wj-alt",o%(i+1)==0)}}_sourceViewChanged(e,t){this.activeEditor||this.invalidate()}_transposeItemsSource(e){let t=new ObservableArray;if(this._layout&&this._layout._bindingGroups.length){this._getRowInfo(e).forEach((o,l)=>{let s=this._createKeys(e);if(this._supportsProxies()){let l=this._createProxy(e,o,s);t.push(l)}else{let l=this._createTransposedObject(e,o,s);t.push(l)}});e instanceof ObservableArray&&e.collectionChanged.addHandler(()=>{let e=new NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Reset);t.onCollectionChanged(e);this._rowInfoChanged()})}return t}_createKeys(e){let t=Array.apply(null,{length:this.columnsPerItem}),o=e.map((e,o)=>t.map((e,t)=>this._keyPrefix+o+"_"+t));return[].concat.apply([],o)}_supportsProxies(){return null!=window.Proxy}_createProxy(e,t,o){let l={_arr:e,_rowInfo:t,_bnd:t.bindings.map(e=>new Binding(e)),_keys:o};return new Proxy(l,{ownKeys:e=>e._keys,getOwnPropertyDescriptor:()=>({enumerable:!0,configurable:!0,writable:!0}),get:(e,t)=>{let o=e._keys.indexOf(t);if(o>-1){let t=e._bnd,l=e._arr,s=t.length,r=o%s,n=Math.floor(o/s);return t[r].getValue(l[n])}return e[t]},set:(e,t,o)=>{let l=e._keys.indexOf(t);if(l>-1){let t=e._bnd,s=e._arr,r=t.length,n=l%r,i=Math.floor(l/r);t[n].setValue(s[i],o);if(s instanceof ObservableArray){let e=new NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Change,s[i],i);s.onCollectionChanged(e)}return!0}return!1}})}_createTransposedObject(e,t,o){let l={_arr:e,_rowInfo:t,_bnd:t.bindings.map(e=>new Binding(e)),_keys:o};for(let t=0;t<o.length;t++){let s=o[t];Object.defineProperty(l,s,{enumerable:!0,get:()=>{let o=l._bnd,s=o.length,r=t%s,n=Math.floor(t/s);return o[r].getValue(e[n])},set:o=>{let s=l._bnd,r=s.length,n=t%r,i=Math.floor(t/r);s[n].setValue(e[i],o);if(e instanceof ObservableArray){let t=new NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Change,e[i],i);e.onCollectionChanged(t)}return!0}})}return l}_getRowInfo(e){let t=[];if(this._layout){let e=this.rowHeaders.columns,o=this.columnsPerItem+1;for(;e.length>o;)e.removeAt(e.length-1);for(;e.length<o;)e.push(new Column);this._layout._bindingGroups.forEach(e=>{for(let o=0;o<e.rowspan;o++){let l={index:e._rowstart+o,bindings:[],headers:[]};for(let t=0;t<e.colspan;t++)for(let s=0;s<e.cells.length;s++){let r=e.cells[s];if(o>=r.row&&o<r.row+r.rowspan&&t>=r.col&&t<r.col+r.colspan){l.bindings.push(r.binding);l.headers.push(r.header);break}}t.push(l)}})}return t}}_registerModule("wijmo.grid.transposedmultirow",selfModule);