/*!
    *
    * Wijmo Library 5.20202.724
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

import{_getModule,assert,asArray,asBoolean,asFunction,asInt,asNumber,asString,isDate,isFunction,isNumber,isString,changeType,clamp,copy,httpRequest,Event,DataType,DateTime,RequestErrorEventArgs,CollectionView,_registerModule}from"wijmo/wijmo";import*as selfModule from"wijmo/wijmo.odata";export function softGrid(){return _getModule("wijmo.grid")}export function softFilter(){return _getModule("wijmo.grid.filter")}export class ODataCollectionView extends CollectionView{constructor(e,t,s){super();this._count=0;this._sortOnServer=!0;this._pageOnServer=!0;this._filterOnServer=!0;this._deferCommits=!1;this._hasPendingChanges=!1;this._showDatesAsGmt=!1;this._inferDataTypes=!0;this._reviverBnd=this._reviver.bind(this);this.loading=new Event;this.loaded=new Event;this.error=new Event;this.hasPendingChangesChanged=new Event;this._url=asString(e,!1);this._tbl=asString(t);copy(this,s);this.sortDescriptions.collectionChanged.addHandler(()=>{this.sortOnServer&&!this.hasPendingChanges&&this._getData()});this.itemsEdited.collectionChanged.addHandler(this._updateHasChanges,this);this.itemsAdded.collectionChanged.addHandler(this._updateHasChanges,this);this.itemsRemoved.collectionChanged.addHandler(this._updateHasChanges,this);this._getData()}get tableName(){return this._tbl}get entityType(){return this._entityType}set entityType(e){this._entityType=asString(e)}get fields(){return this._fields}set fields(e){if(this._fields!=e){this._fields=asArray(e);this._getData()}}get requestHeaders(){return this._requestHeaders}set requestHeaders(e){this._requestHeaders=e}get keys(){return this._keys}set keys(e){this._keys=asArray(e)}get expand(){return this._expand}set expand(e){this._expand=asString(e)}get jsonReviver(){return this._jsonReviver}set jsonReviver(e){this._jsonReviver=asFunction(e)}get dataTypes(){return this._dataTypes}set dataTypes(e){this._dataTypes=e}get inferDataTypes(){return this._inferDataTypes}set inferDataTypes(e){if(e!=this.inferDataTypes){this._inferDataTypes=asBoolean(e);this._getData()}}get showDatesAsGmt(){return this._showDatesAsGmt}set showDatesAsGmt(e){if(e!=this.showDatesAsGmt){this._showDatesAsGmt=asBoolean(e);this._getData()}}get sortOnServer(){return this._sortOnServer}set sortOnServer(e){if(e!=this._sortOnServer){this._sortOnServer=asBoolean(e);this._getData()}}get pageOnServer(){return this._pageOnServer}set pageOnServer(e){if(e!=this._pageOnServer){this._pageOnServer=asBoolean(e);this.pageSize&&this._getData()}}get filterOnServer(){return this._filterOnServer}set filterOnServer(e){if(e!=this._filterOnServer){this._filterOnServer=asBoolean(e);this._getData()}}get filterDefinition(){return this._filterDef}set filterDefinition(e){if(e!=this._filterDef){this._filterDef=asString(e);this._getData()}}updateFilterDefinition(e){this.filterOnServer&&softGrid()&&softFilter()&&e instanceof softFilter().FlexGridFilter&&(this.filterDefinition=this._asODataFilter(e))}get oDataVersion(){return this._odv}set oDataVersion(e){this._odv=asNumber(e)}get isLoading(){return this._loading}get deferCommits(){return this._deferCommits}set deferCommits(e){this._deferCommits=asBoolean(e);this.deferCommits&&(this.trackChanges=!0)}onLoading(e){this.loading.raise(this,e)}onLoaded(e){this.loaded.raise(this,e)}load(){this._getData()}onError(e){this.error.raise(this,e);return!e.cancel}onHasPendingChangesChanged(e){this.hasPendingChangesChanged.raise(this,e)}implementsInterface(e){return"IEditableCollectionView"==e?null!=this.keys&&this.keys.length>0:super.implementsInterface(e)}commitNew(){if(!this.deferCommits){let e={Accept:"application/json"};if(this.requestHeaders)for(let t in this.requestHeaders)e[t]=this.requestHeaders[t];let t=this.currentAddItem;if(t){let s=this._getWriteUrl();httpRequest(s,{method:"POST",requestHeaders:e,data:this._convertToDbFormat(t),success:e=>{let s=JSON.parse(e.responseText,this._reviverBnd);this.keys.forEach(e=>{t[e]=s[e]});this.refresh()},error:this._error.bind(this)})}}super.commitNew()}commitEdit(){if(!this.deferCommits){let e=this.currentEditItem;if(e&&!this.currentAddItem&&this._getChangedFields(e,this._edtClone)){let t=this._getWriteUrl(this._edtClone);httpRequest(t,{method:"PATCH",requestHeaders:this.requestHeaders,data:this._convertToDbFormat(e),error:this._error.bind(this)})}}super.commitEdit()}remove(e){if(!this.deferCommits&&e&&e!=this.currentAddItem&&this.items.indexOf(e)>-1){let t=this._getWriteUrl(e);httpRequest(t,{method:"DELETE",requestHeaders:this.requestHeaders,error:this._error.bind(this)})}super.remove(e)}commitChanges(e){if(this.deferCommits){let t=[];this.itemsEdited.forEach(e=>{t.push({method:"PATCH",url:this._getWriteUrl(e),data:this._convertToDbFormat(e)})});this.itemsAdded.forEach(e=>{t.push({method:"POST",url:this._getWriteUrl(),data:this._convertToDbFormat(e)})});this.itemsRemoved.forEach(e=>{t.push({method:"DELETE",url:this._getWriteUrl(e)})});if(t.length){let s=(new Date).getTime().toString();httpRequest(this._getServiceUrl()+"$batch",{method:"POST",requestHeaders:{"Content-Type":'multipart/mixed; boundary="'+s+'"'},data:this._encodeBatch(t,s),success:e=>{this.clearChanges();this.load()},error:e=>{if(this.onError(new RequestErrorEventArgs(e)))throw"HttpRequest Error: "+e.status+" "+e.statusText},complete:t=>{isFunction(e)&&e(t)}})}}}cancelChanges(){if(this.deferCommits){this.clearChanges();this.load()}}get hasPendingChanges(){return!!this.deferCommits&&(this.itemsAdded.length>0||this.itemsEdited.length>0||this.itemsRemoved.length>0)}get totalItemCount(){return this._count}get pageCount(){return this.pageSize?Math.ceil(this.totalItemCount/this.pageSize):1}get pageSize(){return this._pgSz}set pageSize(e){if(e!=this._pgSz){this._pgSz=asInt(e);if(this.pageOnServer){this._pgIdx=clamp(this._pgIdx,0,this.pageCount-1);this._getData()}else this.refresh()}}onPageChanging(e){super.onPageChanging(e);!e.cancel&&this.pageOnServer&&this._getData();return!e.cancel}_getPageView(){return this.pageOnServer?this._view:super._getPageView()}_performRefresh(){let e=this._canFilter,t=this._canSort;this._canFilter=!this._filterOnServer;this._canSort=!this._sortOnServer;super._performRefresh();this._canFilter=e;this._canSort=t}_updateHasChanges(){let e=this.hasPendingChanges;if(e!=this._hasPendingChanges){this._hasPendingChanges=e;this.onHasPendingChangesChanged()}}_storeItems(e,t){t?Array.prototype.push.apply(this.sourceCollection,e):this.sourceCollection=e}_getReadUrl(e){let t=this._getServiceUrl();e?t=0==e.indexOf("http")?e:t+e:this._tbl&&(t+=this._tbl);return t}_getReadParams(e){let t={};(!e||e.indexOf("$format")<0&&e.indexOf("%24format")<0)&&(t.$format="json");if(!e&&this._tbl){this._odv<4?t.$inlinecount="allpages":t.$count=!0;this.fields&&(t.$select=this.fields.join(","));this.expand&&(t.$expand=this.expand);if(this.sortOnServer&&this.sortDescriptions.length){let e="";this.sortDescriptions.forEach(t=>{e&&(e+=",");e+=t.property;t.ascending||(e+=" desc")});t.$orderby=e}if(this.pageOnServer&&this.pageSize>0){t.$skip=this.pageIndex*this.pageSize;t.$top=this.pageSize}this.filterDefinition&&(t.$filter=this._encodeFilterDefinition())}return t}_encodeFilterDefinition(){return this.filterDefinition.replace(/%/g,"%25").replace(/\+/g,"%2B").replace(/\//g,"%2F").replace(/\?/g,"%3F").replace(/#/g,"%23").replace(/&/g,"%26")}_getData(e,t){this._toGetData&&clearTimeout(this._toGetData);this._toGetData=setTimeout(()=>{if(null==this._odv){this._getSchema();return}this._loading=!0;this.onLoading();let s=httpRequest(this._getReadUrl(e),{requestHeaders:this.requestHeaders,data:this._getReadParams(e),success:t=>{let s=JSON.parse(t.responseText,this._reviverBnd),i=s.d?s.d.results:s.value,r=s.d?s.d.__count:s["odata.count"]||s["@odata.count"];null!=r&&(this._count=parseInt(r));if(this.pageIndex>0&&this.pageIndex>=this.pageCount){let e=this.pageIndex;this.moveToLastPage();if(this.pageIndex!=e)return}e||this.inferDataTypes&&!this._dataTypesInferred&&(this._dataTypesInferred=this._getInferredDataTypes(i));let a=this.dataTypes?this.dataTypes:this._dataTypesInferred;a&&i.forEach(e=>{this._convertItem(a,e)});this._storeItems(i,null!=e);this.refresh();if(e=s.d?s.d.__next:s["odata.nextLink"]||s["@odata.nextLink"])this._getData(e);else{this._loading=!1;this.onLoaded()}},error:e=>{this._loading=!1;this.onLoaded();if(this.onError(new RequestErrorEventArgs(e)))throw"HttpRequest Error: "+e.status+" "+e.statusText}});isFunction(t)&&t(s)},100)}_convertToDbFormat(e){let t={};for(let s in e){let i=e[s];isDate(i)&&this._showDatesAsGmt?i=new Date(i.getTime()-6e4*i.getTimezoneOffset()):isNumber(i)&&this._odv<4&&(i=i.toString());t[s]=i}this.entityType&&(t["odata.type"]=this.entityType);return t}_reviver(e,t){if("string"==typeof t&&ODataCollectionView._rxDate.test(t)){t=0==t.indexOf("/Date(")?new Date(parseInt(t.substr(6))):new Date(t);isDate(t)&&this._showDatesAsGmt&&(t=new Date(t.getTime()+6e4*t.getTimezoneOffset()))}return this._jsonReviver?this._jsonReviver(e,t):t}_convertItem(e,t){for(let s in e){let i=e[s],r=t[s];if(null!=r){r=i==DataType.Date&&isString(r)&&0==r.indexOf("/Date(")?new Date(parseInt(r.substr(6))):changeType(r,i,null);isDate(r)&&this._showDatesAsGmt&&(r=new Date(r.getTime()+6e4*r.getTimezoneOffset()));t[s]=r}}}_getInferredDataTypes(e){let t=null;if(e.length>0){let s={};e.forEach(e=>{this._extend(s,e)});for(let e in s){let i=s[e];if(isString(i)&&ODataCollectionView._rxDate.test(i)){t||(t={});t[e]=DataType.Date}}}return t}_getServiceUrl(){let e=this._url;"/"!=e[e.length-1]&&(e+="/");return e}_getSchema(){let e=this._getServiceUrl()+"$metadata",t=ODataCollectionView._odvCache;this._odv=t[e];this._odv?this._getData():httpRequest(e,{requestHeaders:this.requestHeaders,success:s=>{let i=s.responseText.match(/<.*Version\s*=\s*"([0-9.]+)"/),r=i?parseFloat(i[1]):4;t[e]=this._odv=r},error:s=>{t[e]=this._odv=4},complete:e=>{this._getData()}})}_getWriteUrl(e){let t=this._getServiceUrl()+this._tbl;if(e){assert(this.keys&&this.keys.length>0,"write operations require keys.");let s=[];this.keys.forEach(t=>{let i=e[t];null==i&&(i="");isString(i)&&(i="'"+i+"'");s.push(1==this.keys.length?i:t+"="+i)});s.length&&(t+="("+s.join(",")+")")}return t}_asODataFilter(e){let t="";for(let s=0;s<e.grid.columns.length;s++){let i=e.grid.columns[s],r=e.getColumnFilter(i,!1);if(r&&r.isActive){t&&(t+=" and ");r.conditionFilter&&r.conditionFilter.isActive?t+=this._asODataConditionFilter(r.conditionFilter):r.valueFilter&&r.valueFilter.isActive&&(t+=this._asODataValueFilter(r.valueFilter))}}return t}_asODataValueFilter(e){let t=e.column,s=t.binding,i=t.dataMap,r="";for(let a in e.showValues){let e=changeType(a,t.dataType,t.format);i&&isString(e)&&(e=i.getKeyValue(e));r&&(r+=" or ");r+=this._asEquals(s,e,t.dataType)}r.length&&(r="("+r+")");return r}_asEquals(e,t,s){return s==DataType.Date?"("+e+" ge "+this._asODataValue(t,s)+" and "+e+" lt "+this._asODataValue(DateTime.addDays(t,1),s)+")":""===t||null==t?"("+e+" eq null or "+e+" eq '')":"("+e+" eq "+this._asODataValue(t,s)+")"}_asODataConditionFilter(e){let t=this._asODataCondition(e,e.condition1),s=this._asODataCondition(e,e.condition2);return t&&s?"("+t+(e.and?" and ":" or ")+s+")":t?"("+t+")":s?"("+s+")":null}_asODataCondition(e,t){let s=e.column,i=s.binding,r=s.dataMap,a=t.value;r&&isString(a)&&(a=r.getKeyValue(a));a=this._asODataValue(a,e.column.dataType);switch(t.operator){case 0:return i+" eq "+a;case 1:return i+" ne "+a;case 2:return i+" gt "+a;case 3:return i+" ge "+a;case 4:return i+" lt "+a;case 5:return i+" le "+a;case 6:return"startswith("+i+","+a+")";case 7:return"endswith("+i+","+a+")";case 8:return this._odv>=4?"contains("+i+","+a+")":"substringof("+a.toLowerCase()+", tolower("+i+"))";case 9:return this._odv>=4?"not contains("+i+","+a+")":"not substringof("+a.toLowerCase()+", tolower("+i+"))"}}_asODataValue(e,t){if(isDate(e)){this._showDatesAsGmt&&(e=new Date(e.getTime()-6e4*e.getTimezoneOffset()));e=e.toJSON();this._odv<4&&(e="datetime'"+e.substr(0,10)+"'");return e}return isString(e)?"'"+e.replace(/'/g,"''")+"'":null!=e?e.toString():t==DataType.String?"''":null}_error(e){if(this.onError(new RequestErrorEventArgs(e))){this._getData();throw"HttpRequest Error: "+e.status+" "+e.statusText}}_encodeBatch(e,t){let s=[],i="changeset-"+t;s.push("--"+t,"Content-Type: multipart/mixed; boundary="+i,"");e.forEach((e,t)=>{s.push("--"+i,"Content-Type: application/http","Content-Transfer-Encoding: binary","Content-ID: "+t,"",e.method.toUpperCase()+" "+e.url+" HTTP/1.1","Host: "+location.host);e.data&&s.push("Content-Type: application/json","",JSON.stringify(e.data));s.push("")});s.push("--"+i+"--","");s.push("--"+t+"--","");return s.join("\r\n")}}ODataCollectionView._odvCache={};ODataCollectionView._rxDate=/^\d{4}\-\d{2}\-\d{2}T\d{2}\:\d{2}\:\d{2}|\/Date\([\d\-]*?\)/;const _MIN_DATA_WINDOW=100;export class ODataVirtualCollectionView extends ODataCollectionView{constructor(e,t,s){super(e,t,{pageOnServer:!0,sortOnServer:!0,canGroup:!1});this._start=0;this._end=100;this._refresh=!1;copy(this,s);this._data=[];this.sourceCollection=this._data;this._firstLoad=!0;this.setWindow(0,_MIN_DATA_WINDOW)}setWindow(e,t){this._toSetWindow&&clearTimeout(this._toSetWindow);this._toSetWindow=setTimeout(()=>{this._toSetWindow=null;this._performSetWindow(e,t)},50)}get requestCanceled(){this._requestCanceled||(this._requestCanceled=new Event);return this._requestCanceled}onRequestCanceled(e){this.requestCanceled.raise(this,e)}get pageOnServer(){return!0}set pageOnServer(e){if(!e)throw"ODataVirtualCollectionView requires pageOnServer = true."}get sortOnServer(){return!0}set sortOnServer(e){if(!asBoolean(e))throw"ODataVirtualCollectionView requires sortOnServer = true."}get filterOnServer(){return!0}set filterOnServer(e){if(!asBoolean(e))throw"ODataVirtualCollectionView requires filterOnServer = true."}get canGroup(){return this._canGroup}set canGroup(e){if(asBoolean(e))throw"ODataVirtualCollectionView does not support grouping."}_performRefresh(){this.isLoading||(this._refresh=!0);super._performRefresh()}_getReadParams(e){let t=super._getReadParams(e);if(!e){t.$skip=this._start||0;t.$top=Math.max(this._end-this._start+1,this.pageSize,_MIN_DATA_WINDOW)}return t}_storeItems(e,t){if(this._refresh||this._data.length!=this.totalItemCount){this._data.length=this.totalItemCount;for(let e=0;e<this._data.length;e++)this._data[e]=new _NullValue(e);this._refresh=!1}t||(this._loadOffset=0);let s=this._loadOffset+(this._start||0);for(let t=0;t<e.length;t++)this._data[t+s]=e[t];this._loadOffset+=e.length;setTimeout(()=>{this._firstLoad&&this.currentPosition<0&&e.length&&this.moveCurrentToFirst();this._firstLoad=!1})}_performSetWindow(e,t){if(this._pendingRequest){this._pendingRequest.abort();this._pendingRequest=null;this.onRequestCanceled()}e=asInt(e);t=asInt(t);assert(e<=t,"start must be <= end.");let s=this._data;this._start=this._end=e;for(let i=e;i<=t&&i<s.length;i++)if(s[i]instanceof _NullValue){this._start=i;break}for(let e=t;e>=this._start&&e<s.length;e--)if(s[e]instanceof _NullValue){this._end=e;break}(this._start!=this._end||s[this._start]instanceof _NullValue)&&this._getData(null,e=>{this._pendingRequest=e})}}class _NullValue{constructor(e){this._id=e}}_registerModule("wijmo.odata",selfModule);