/*!
    *
    * Wijmo Library 5.20202.724
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

var __extends=this&&this.__extends||function(){var extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)}}(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,r=1,o=arguments.length;r<o;r++){t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)};import{_getModule,ObservableArray,Event,EventArgs,isArray,asString,copy,httpRequest,Control,CollectionView,DataType,SortDescription,CancelEventArgs,RequestErrorEventArgs,assert,getType,clamp,changeType,culture,isObject,isString,isFunction,asBoolean,asInt,asArray,isNumber,_registerModule}from"wijmo/wijmo";import*as selfModule from"wijmo/wijmo.cloud";var OAuth2=function(){function OAuth2(e,t,r,o){var n=this;this.userChanged=new Event;this.error=new Event;this._gapi=window.gapi;if(this._gapi)this._gapiLoaded(e,t,r);else{var i=document.createElement("script");i.src="https://apis.google.com/js/api.js";i.onload=function(){return n._gapiLoaded(e,t,r)};document.head.appendChild(i)}copy(this,o)}Object.defineProperty(OAuth2.prototype,"user",{get:function(){var e=this._auth();if(e&&e.isSignedIn.get()){var t=e.currentUser.get().getBasicProfile();return{id:t.getId(),name:t.getName(),firstName:t.getGivenName(),lastName:t.getFamilyName(),imageUrl:t.getImageUrl(),eMail:t.getEmail()}}return null},enumerable:!0,configurable:!0});Object.defineProperty(OAuth2.prototype,"accessToken",{get:function(){var e=this._gapi.auth.getToken();return e?e.access_token:null},enumerable:!0,configurable:!0});Object.defineProperty(OAuth2.prototype,"idToken",{get:function(){var e=this._gapi.auth.getToken();return e?e.id_token:null},enumerable:!0,configurable:!0});OAuth2.prototype.signIn=function(){this._auth().signIn()};OAuth2.prototype.signOut=function(){this._auth().signOut()};OAuth2.prototype.onUserChanged=function(e){this.userChanged.raise(this,e)};OAuth2.prototype.onError=function(e){this.error.raise(this,e)};OAuth2.prototype._gapiLoaded=function(e,t,r){var o=this,n=this._gapi=window.gapi;assert(n,"Failed to load google gapi.");n.load("client:auth2",(function(){var i=r&&r.length?r.join(" "):"";i=i||"https://www.googleapis.com/auth/userinfo.email";n.client.init({apiKey:e,clientId:t,scope:i}).then((function(){o._auth().isSignedIn.listen((function(){o.onUserChanged()}));o.onUserChanged()}),(function(e){o.onError(new OAuthError(e))}))}))};OAuth2.prototype._auth=function(){return this._gapi&&this._gapi.auth2?this._gapi.auth2.getAuthInstance():null};return OAuth2}();export{OAuth2};var OAuthError=function(e){__extends(OAuthError,e);function OAuthError(t){var r=e.call(this)||this;r._error=t;return r}Object.defineProperty(OAuthError.prototype,"error",{get:function(){return this._error},enumerable:!0,configurable:!0});return OAuthError}(EventArgs);export{OAuthError};var Snapshot=function(e){__extends(Snapshot,e);function Snapshot(t,r){var o=e.call(this)||this;o._loading=!1;o._deferCommits=!1;o._hasPendingChanges=!1;o.loading=new Event;o.loaded=new Event;o.error=new Event;o.hasPendingChangesChanged=new Event;o._checkType("CollectionReference",t,"firestore","doc","onSnapshot");o._collection=t;copy(o,r);o.itemsEdited.collectionChanged.addHandler(o._updateHasChanges,o);o.itemsAdded.collectionChanged.addHandler(o._updateHasChanges,o);o.itemsRemoved.collectionChanged.addHandler(o._updateHasChanges,o);o._getData();return o}Object.defineProperty(Snapshot.prototype,"query",{get:function(){return this._query},set:function(e){if(e!=this._query){this._checkType("Query",e,"firestore","onSnapshot");this._query=e;this._getData()}},enumerable:!0,configurable:!0});Object.defineProperty(Snapshot.prototype,"deferCommits",{get:function(){return this._deferCommits},set:function(e){this._deferCommits=asBoolean(e);this.deferCommits&&(this.trackChanges=!0)},enumerable:!0,configurable:!0});Snapshot.prototype.commitChanges=function(){var e=this;if(this.deferCommits&&this.hasPendingChanges){var t=this._collection.firestore.batch();this.itemsEdited.forEach((function(r){var o=e._getItemDoc(r),n=e._getItemData(r);t.update(o,n)}));this.itemsAdded.forEach((function(r){var o=e._getItemDoc(r),n=e._getItemData(r);t.set(o,n)}));this.itemsRemoved.forEach((function(r){var o=e._getItemDoc(r);t.delete(o)}));t.commit().then((function(){e.clearChanges();e._getData(!0)})).catch((function(t){return e._raiseError(t,!0)}))}};Snapshot.prototype.cancelChanges=function(){if(this.deferCommits){this.clearChanges();this._getData(!0)}};Object.defineProperty(Snapshot.prototype,"hasPendingChanges",{get:function(){return!!this.deferCommits&&(this.itemsAdded.length>0||this.itemsEdited.length>0||this.itemsRemoved.length>0)},enumerable:!0,configurable:!0});Object.defineProperty(Snapshot.prototype,"isLoading",{get:function(){return this._loading},enumerable:!0,configurable:!0});Snapshot.prototype.load=function(e){this._getData(e)};Snapshot.prototype.onLoading=function(e){this.loading.raise(this,e);return!e.cancel};Snapshot.prototype.onLoaded=function(e){this.loaded.raise(this,e)};Snapshot.prototype.onError=function(e){if(this._loading){this._loading=!1;this.onLoaded()}this.error.raise(this,e);return!e.cancel};Snapshot.prototype.onHasPendingChangesChanged=function(e){this.hasPendingChangesChanged.raise(this,e)};Snapshot.prototype.commitNew=function(){var t=this;if(!this.deferCommits){var r=this.currentAddItem;r&&this._collection.add(this._getItemData(r)).catch((function(e){return t._raiseError(e,!0)}))}e.prototype.commitNew.call(this)};Snapshot.prototype.commitEdit=function(){var t=this;if(!this.deferCommits){var r=this.currentEditItem;if(r&&!this.currentAddItem&&this._getChangedFields(r,this._edtClone)){var o=this._getItemDoc(r),n=this._getItemData(r);o.update(n).catch((function(e){return t._raiseError(e,!0)}))}}e.prototype.commitEdit.call(this)};Snapshot.prototype.remove=function(t){var r=this;if(!this.deferCommits&&t&&t!=this.currentAddItem){this._getItemDoc(t).delete().catch((function(e){return r._raiseError(e,!0)}))}e.prototype.remove.call(this,t)};Snapshot.prototype._raiseError=function(e,t){this.onError(new FirestoreErrorEventArgs(e));t&&this._getData(!0)};Snapshot.prototype._updateHasChanges=function(){var e=this.hasPendingChanges;if(e!=this._hasPendingChanges){this._hasPendingChanges=e;this.onHasPendingChangesChanged()}};Snapshot.prototype._getItemDoc=function(e){var t=e&&e.$META?e.$META.id:this._generateID();return this._collection.doc(t)};Snapshot.prototype._getItemData=function(e){var t={};for(var r in e)"$META"!=r&&(t[r]=e[r]);return t};Snapshot.prototype._getData=function(e){var t=this;this._toGetData&&clearTimeout(this._toGetData);this._toGetData=setTimeout((function(){t._toGetData=null;t._loading=!0;if(t.onLoading(new CancelEventArgs)){t._unsubscribe&&t._unsubscribe();t._unsubscribe=t._getQuery().onSnapshot((function(r){var o=[],n=e||!t._loading?t.currentPosition:null;r.forEach((function(e){o.push(__assign({$META:{id:e.id}},e.data()))}));t.sourceCollection=o;null!=n&&t.moveCurrentToPosition(n);if(t._loading){t._loading=!1;t.onLoaded()}}),(function(e){return t._raiseError(e,!0)}))}}),Control._REFRESH_INTERVAL)};Snapshot.prototype._generateID=function(){for(var e="";e.length<20;)e+=Math.random().toString(36).substr(2,5);return e};Snapshot.prototype._checkType=function(e,t){for(var r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];if(null!=t)for(var n=0;n<r.length;n++){var i=r[n];null==t[i]&&assert(!1,'Expected "'+e+'" but the value does not have "'+i+'".')}};Snapshot.prototype._getQuery=function(){return this._query||this._collection};return Snapshot}(CollectionView);export{Snapshot};var FirestoreErrorEventArgs=function(e){__extends(FirestoreErrorEventArgs,e);function FirestoreErrorEventArgs(t){var r=e.call(this)||this;r._error=t;return r}Object.defineProperty(FirestoreErrorEventArgs.prototype,"error",{get:function(){return this._error},enumerable:!0,configurable:!0});Object.defineProperty(FirestoreErrorEventArgs.prototype,"message",{get:function(){return this._error.message},enumerable:!0,configurable:!0});return FirestoreErrorEventArgs}(CancelEventArgs);export{FirestoreErrorEventArgs};var Sheet=function(e){__extends(Sheet,e);function Sheet(t,r,o){var n=e.call(this)||this;n._loading=!1;n.loading=new Event;n.loaded=new Event;n.error=new Event;n._gSheet=t;n._title=r;n._id=o;n._getData();t.accessTokenChanged.addHandler((function(){t.accessToken&&!n.items.length&&n._getData(!0)}));return n}Object.defineProperty(Sheet.prototype,"googleSheet",{get:function(){return this._gSheet},enumerable:!0,configurable:!0});Object.defineProperty(Sheet.prototype,"title",{get:function(){return this._title},enumerable:!0,configurable:!0});Sheet.prototype.load=function(e){this._getData(e)};Object.defineProperty(Sheet.prototype,"isLoading",{get:function(){return this._loading},enumerable:!0,configurable:!0});Sheet.prototype.onLoading=function(e){this.loading.raise(this,e);return!e.cancel};Sheet.prototype.onLoaded=function(e){this.loaded.raise(this,e)};Sheet.prototype.onError=function(e){if(this._loading){this._loading=!1;this.onLoaded()}this.error.raise(this,e);return!e.cancel};Sheet.prototype.commitNew=function(){var t=this.currentAddItem;t&&this._saveItem(t);e.prototype.commitNew.call(this)};Sheet.prototype.commitEdit=function(){var t=this.currentEditItem;t&&!this.currentAddItem&&this._getChangedFields(t,this._edtClone)&&this._saveItem(t);e.prototype.commitEdit.call(this)};Sheet.prototype.remove=function(t){var r=this;if(t&&t!=this.currentAddItem){var o=this.sourceCollection.indexOf(t);assert(o>-1,"Item not found.");var n=o+1;assert(null!=this._id,"Sheet doesn't have an ID ? ");var i=this.googleSheet,s=i._getUrl(":batchUpdate");httpRequest(s,{method:"POST",requestHeaders:i._getRequestHeaders(),data:{requests:[{deleteDimension:{range:{sheetId:this._id,dimension:"ROWS",startIndex:n,endIndex:n+1}}}]},error:function(e){return r._handleError(e,!1)}})}e.prototype.remove.call(this,t)};Sheet.prototype._getData=function(e){var t=this;this._toGetData&&clearTimeout(this._toGetData);this._toGetData=setTimeout((function(){t._loading=!0;t._itemKeys=null;if(t.onLoading(new CancelEventArgs)){var r=t.currentPosition,o=t.googleSheet,n=o._getUrl("/values/"+t.title+"!2:2");httpRequest(n,{requestHeaders:o._getRequestHeaders(),data:{valueRenderOption:"UNFORMATTED_VALUE",dateTimeRenderOption:"FORMATTED_STRING"},success:function(n){var i=JSON.parse(n.responseText).values[0],s=o._getUrl("/values/"+t.title);httpRequest(s,{requestHeaders:o._getRequestHeaders(),data:{valueRenderOption:"UNFORMATTED_VALUE",dateTimeRenderOption:"SERIAL_NUMBER"},success:function(o){var n=JSON.parse(o.responseText).values;t.sourceCollection=t._parseData(n,i);e&&t.moveCurrentToPosition(r);t._loading=!1;t.onLoaded()},error:function(e){return t._handleError(e,!1)}})},error:function(e){return t._handleError(e,!1)}})}}),Control._REFRESH_INTERVAL)};Sheet.prototype._parseData=function(e,t){for(var r=[],o=e[0],n=!0,i=0;i<o.length&&n;i++){var s=o[i];s&&isString(s)&&o.indexOf(s)==i||(n=!1)}if(n)e.splice(0,1);else{var a=[];for(i=0;i<o.length;i++)a.push(this._toSheetHeader(i));o=a}this._itemKeys=o;var l=[],h=this._gSheet.columnDataTypes,c=DataType;o.forEach((function(e){var t=c.Object;h&&h.forEach((function(r){r.pattern.test(e)&&(t=r.dataType)}));l.push(t)}));e.forEach((function(e){var n={};o.forEach((function(r,o){var i=e[o],s=t[o],a=l[o];a==c.Object&&isNumber(i)&&isString(s)&&s.length&&(a=c.Date);a!=c.Object&&(i=a==c.Date&&isNumber(i)?new Date(86400*(i-25568)*1e3):changeType(i,a));n[r]=i}));r.push(n)}));return r};Sheet.prototype._toSheetHeader=function(e){return e<26?String.fromCharCode(65+e):this._toSheetHeader(Math.floor(e/26)-1)+this._toSheetHeader(e%26)};Sheet.prototype._saveItem=function(e){var t=this,r=this.sourceCollection.indexOf(e);assert(r>-1,"Item not found?");var o=[];this._itemKeys.forEach((function(t){var r=e[t];o.push(null!=r?r.toString():"")}));var n=this.googleSheet,i=(r+2).toString(),s=this.title+"!A"+i+":Z"+i,a=n._getUrl("/values/"+s);a+=(a.indexOf("?key=")>-1?"&":"?")+"valueInputOption=USER_ENTERED";httpRequest(a,{method:"PUT",requestHeaders:n._getRequestHeaders(),data:{range:s,values:[o]},error:function(e){return t._handleError(e,!0)}})};Sheet.prototype._handleError=function(e,t){this.onError(new RequestErrorEventArgs(e));t&&this._getData(!0)};return Sheet}(CollectionView);export{Sheet};var GoogleSheet=function(){function GoogleSheet(e,t,r){this._sheetId="";this._accessToken="";this._apiKey="";this._loading=!1;this._sheets=new ObservableArray;this.loading=new Event;this.loaded=new Event;this.error=new Event;this.accessTokenChanged=new Event;this._sheetId=asString(e,!1);this._apiKey=asString(t,!1);copy(this,r);this._getSheetInfo()}Object.defineProperty(GoogleSheet.prototype,"sheetId",{get:function(){return this._sheetId},enumerable:!0,configurable:!0});Object.defineProperty(GoogleSheet.prototype,"apiKey",{get:function(){return this._apiKey},enumerable:!0,configurable:!0});Object.defineProperty(GoogleSheet.prototype,"accessToken",{get:function(){return this._accessToken},set:function(e){if(e!=this._accessToken){this._accessToken=asString(e);this.onAccessTokenChanged()}},enumerable:!0,configurable:!0});Object.defineProperty(GoogleSheet.prototype,"columnDataTypes",{get:function(){return this._colTypes},set:function(e){this._colTypes=e},enumerable:!0,configurable:!0});Object.defineProperty(GoogleSheet.prototype,"sheets",{get:function(){return this._sheets},enumerable:!0,configurable:!0});GoogleSheet.prototype.getSheet=function(e){for(var t=0;t<this._sheets.length;t++){var r=this._sheets[t];if(r.title==e)return r}return null};Object.defineProperty(GoogleSheet.prototype,"isLoading",{get:function(){return this._loading},enumerable:!0,configurable:!0});GoogleSheet.prototype.onLoading=function(e){this.loading.raise(this,e)};GoogleSheet.prototype.onLoaded=function(e){this.loaded.raise(this,e)};GoogleSheet.prototype.onError=function(e){if(this._loading){this._loading=!1;this.onLoaded()}this.error.raise(this,e);return!e.cancel};GoogleSheet.prototype.onAccessTokenChanged=function(e){this.accessTokenChanged.raise(this,e)};GoogleSheet.prototype._copy=function(e,t){var r=this;if("sheets"==e&&isArray(t)){t.forEach((function(e){var t=new Sheet(r,e);r.sheets.push(t)}));return!0}return!1};GoogleSheet.prototype._getUrl=function(e){var t="https://sheets.googleapis.com/v4/spreadsheets/"+this.sheetId;e&&(t+=e);this.apiKey&&(t+="?key="+this.apiKey);return t};GoogleSheet.prototype._getRequestHeaders=function(){var e={"Content-Type":"application/json"};this.accessToken&&(e.Authorization="Bearer "+this.accessToken);return e};GoogleSheet.prototype._getSheetInfo=function(){var e=this;this._loading=!0;this.onLoading();httpRequest(this._getUrl(),{requestHeaders:this._getRequestHeaders(),data:{fields:"sheets.properties"},success:function(t){var r=JSON.parse(t.responseText),o=r.sheets;e.sheets.length?e.sheets.forEach((function(e){for(var t=0;t<o.length;t++){var r=o[t].properties;if(r.title==e.title){e._id=r.sheetId;break}}assert(null!=e._id,'Could not find sheet "'+e.title+'".')})):r.sheets.forEach((function(t){var r=t.properties;if("GRID"==r.sheetType){var o=new Sheet(e,r.title,r.sheetId);e.sheets.push(o)}}))},error:function(t){e.onError(new RequestErrorEventArgs(t))},complete:function(t){e._loading=!1;e.onLoaded()}})};return GoogleSheet}();export{GoogleSheet};var Firestore=function(){function Firestore(e,t,r){this._projectId="";this._collections=new ObservableArray;this._accessToken="";this._idToken="";this._fbToken="";this._apiKey="";this.accessTokenChanged=new Event;this._projectId=asString(e,!1);this._apiKey=asString(t,!1);copy(this,r)}Object.defineProperty(Firestore.prototype,"projectId",{get:function(){return this._projectId},enumerable:!0,configurable:!0});Object.defineProperty(Firestore.prototype,"apiKey",{get:function(){return this._apiKey},enumerable:!0,configurable:!0});Object.defineProperty(Firestore.prototype,"accessToken",{get:function(){return this._accessToken},set:function(e){if(e!=this._accessToken){this._accessToken=asString(e);this.onAccessTokenChanged()}},enumerable:!0,configurable:!0});Object.defineProperty(Firestore.prototype,"idToken",{get:function(){return this._idToken},set:function(e){var t=this;if(e!=this._idToken){this._idToken=asString(e);if(this._idToken){var r="https://identitytoolkit.googleapis.com/v1/accounts:signInWithIdp?key="+this._apiKey;httpRequest(r,{method:"POST",data:{requestUri:window.location.href,postBody:"id_token="+this._idToken+"&providerId=google.com",returnSecureToken:!0,returnIdpCredential:!0},success:function(e){var r=JSON.parse(e.responseText);t._fbToken=r.idToken;t.onAccessTokenChanged()},error:function(e){t._fbToken="";t.onAccessTokenChanged()}})}else{this._fbToken="";this.onAccessTokenChanged()}}},enumerable:!0,configurable:!0});Object.defineProperty(Firestore.prototype,"collections",{get:function(){return this._collections},enumerable:!0,configurable:!0});Firestore.prototype.getCollection=function(e){for(var t=this._collections,r=0;r<t.length;r++){var o=t[r];if(o.name==e)return o}return null};Firestore.prototype.onAccessTokenChanged=function(e){this.accessTokenChanged.raise(this,e)};Firestore.prototype._copy=function(e,t){var r=this;if("collections"==e&&isArray(t)){t.forEach((function(e){var t=new Collection(r,e);r.collections.push(t)}));return!0}return!1};return Firestore}();export{Firestore};export function softGridFilter(){return _getModule("wijmo.grid.filter")}var Collection=function(e){__extends(Collection,e);function Collection(t,r,o){var n=e.call(this)||this;n._loading=!1;n._sortOnServer=!1;n._pageOnServer=!1;n._filterOnServer=!1;n._deferCommits=!1;n._hasPendingChanges=!1;n._orderBy=[];n._fieldFilters=[];n._limit=0;n.loading=new Event;n.loaded=new Event;n.error=new Event;n.hasPendingChangesChanged=new Event;n._store=t;n._name=r;copy(n,o);n.sortDescriptions.collectionChanged.addHandler((function(){n.sortOnServer&&!n.hasPendingChanges&&n._getData(!0)}));t.accessTokenChanged.addHandler((function(){t.accessToken&&!n.items.length&&n.load()}));n.itemsEdited.collectionChanged.addHandler(n._updateHasChanges,n);n.itemsAdded.collectionChanged.addHandler(n._updateHasChanges,n);n.itemsRemoved.collectionChanged.addHandler(n._updateHasChanges,n);n._getData();return n}Object.defineProperty(Collection.prototype,"store",{get:function(){return this._store},enumerable:!0,configurable:!0});Object.defineProperty(Collection.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0});Object.defineProperty(Collection.prototype,"fields",{get:function(){return this._fields},set:function(e){if(e!=this._fields){this._fields=asArray(e);this._getData(!0)}},enumerable:!0,configurable:!0});Object.defineProperty(Collection.prototype,"limit",{get:function(){return this._limit},set:function(e){if(e!=this._limit){this._limit=asInt(e);this._getData(!0)}},enumerable:!0,configurable:!0});Object.defineProperty(Collection.prototype,"sortOnServer",{get:function(){return this._sortOnServer},set:function(e){if(e!=this._sortOnServer){this._sortOnServer=asBoolean(e);this._getData(!0)}},enumerable:!0,configurable:!0});Object.defineProperty(Collection.prototype,"pageOnServer",{get:function(){return this._pageOnServer},set:function(e){if(e!=this._pageOnServer){this._pageOnServer=asBoolean(e);this.pageSize&&this._getData(!0)}},enumerable:!0,configurable:!0});Object.defineProperty(Collection.prototype,"filterOnServer",{get:function(){return this._filterOnServer},set:function(e){if(e!=this._filterOnServer){this._filterOnServer=asBoolean(e);if(softGridFilter()){null==Collection._filterCulture&&(Collection._filterCulture=culture.FlexGridFilter);if(this._filterOnServer){for(var t=culture.FlexGridFilter,r=t.numberOperators,o=0;o<r.length;o++)if(r[o].op==softGridFilter().Operator.NE){r.splice(o,1);break}t.stringOperators=r}else culture.FlexGridFilter=Collection._filterCulture}this._getData(!0)}},enumerable:!0,configurable:!0});Object.defineProperty(Collection.prototype,"deferCommits",{get:function(){return this._deferCommits},set:function(e){this._deferCommits=asBoolean(e);this.deferCommits&&(this.trackChanges=!0)},enumerable:!0,configurable:!0});Collection.prototype.commitChanges=function(e){var t=this;if(this.deferCommits){var r=[];this.itemsEdited.forEach((function(e){r.push({update:t._itemToDoc(e)})}));this.itemsAdded.forEach((function(e){var o=t._itemToDoc(e);o.name="projects/"+t.store.projectId+"/databases/(default)/documents/"+t.name+"/"+t._generateID();r.push({update:o})}));this.itemsRemoved.forEach((function(e){r.push({delete:e.$META.name})}));r.length&&httpRequest(this._getUrl(":beginTransaction"),{method:"POST",requestHeaders:this._getRequestHeaders(),success:function(o){var n=JSON.parse(o.responseText);httpRequest(t._getUrl(":commit"),{method:"POST",data:{writes:r,transaction:n.transaction},requestHeaders:t._getRequestHeaders(),success:function(e){t.clearChanges();t.load()},complete:function(t){isFunction(e)&&e(t)},error:function(e){return t._raiseError(e,!0)}})},error:function(e){return t._raiseError(e,!0)}})}};Collection.prototype.cancelChanges=function(){if(this.deferCommits){this.clearChanges();this.load()}};Object.defineProperty(Collection.prototype,"hasPendingChanges",{get:function(){return!!this.deferCommits&&(this.itemsAdded.length>0||this.itemsEdited.length>0||this.itemsRemoved.length>0)},enumerable:!0,configurable:!0});Object.defineProperty(Collection.prototype,"isLoading",{get:function(){return this._loading},enumerable:!0,configurable:!0});Collection.prototype.load=function(e){this._getData(e)};Collection.prototype.select=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.fields=e;return this};Collection.prototype.orderBy=function(e,t){void 0===t&&(t=!0);e?this._orderBy.push(new SortDescription(asString(e),asBoolean(t))):this._orderBy=[];this._getData(!1);return this};Collection.prototype.where=function(e,t,r){if(e){switch(t.toUpperCase()){case"==":t="EQUAL";break;case">":t="GREATER_THAN";break;case">=":t="GREATER_THAN_OR_EQUAL";break;case"<":t="LESS_THAN";break;case"<=":t="LESS_THAN_OR_EQUAL";break;case"IN":t="IN";assert(isArray(r),"IN operator requires array values.");break;default:assert(!1,"Unknown operator (should be ==, >, >=, <, <=, or IN).")}for(var o=0;o<this._fieldFilters.length;o++){var n=this._fieldFilters[o].fieldFilter;if(n.field.fieldPath==e&&n.op==t){this._fieldFilters.splice(o,1);break}}this._fieldFilters.push({fieldFilter:{field:{fieldPath:e},op:t,value:this._getValueObject(r)}})}else this._fieldFilters=[];this._getData(!1);return this};Collection.prototype.onLoading=function(e){this.loading.raise(this,e);return!e.cancel};Collection.prototype.onLoaded=function(e){this.loaded.raise(this,e)};Collection.prototype.onError=function(e){if(this._loading){this._loading=!1;this.onLoaded()}this.error.raise(this,e);return!e.cancel};Collection.prototype.onHasPendingChangesChanged=function(e){this.hasPendingChangesChanged.raise(this,e)};Object.defineProperty(Collection.prototype,"totalItemCount",{get:function(){var e=this._totalCount;return this.pageOnServer?null!=e?e:1e6:this.items.length},set:function(e){this._totalCount=asInt(e)},enumerable:!0,configurable:!0});Object.defineProperty(Collection.prototype,"pageCount",{get:function(){return this.pageSize?Math.ceil(this.totalItemCount/this.pageSize):1},enumerable:!0,configurable:!0});Object.defineProperty(Collection.prototype,"pageSize",{get:function(){return this._pgSz},set:function(e){if(e!=this._pgSz){this._pgSz=asInt(e);if(this.pageOnServer){this._pgIdx=clamp(this._pgIdx,0,this.pageCount-1);this._getData(!0)}else this.refresh()}},enumerable:!0,configurable:!0});Collection.prototype.onPageChanging=function(t){e.prototype.onPageChanging.call(this,t);!t.cancel&&this.pageOnServer&&(0==this.pageIndex&&0==this.items.length?t.cancel=!0:this._getData(!0));return!t.cancel};Collection.prototype.commitNew=function(){var t=this;if(!this.deferCommits){var r=this.currentAddItem;if(r){var o=this._itemToDoc(r);httpRequest(this._getUrl(),{method:"POST",data:{fields:o.fields},requestHeaders:this._getRequestHeaders(),success:function(e){var o=JSON.parse(e.responseText);t._saveDocName(o,r);t._totalCount++},error:function(e){return t._raiseError(e,!0)}})}}e.prototype.commitNew.call(this)};Collection.prototype.commitEdit=function(){var t=this;if(!this.deferCommits){var r=this.currentEditItem;if(r&&!this.currentAddItem&&this._getChangedFields(r,this._edtClone)){var o=this._itemToDoc(r);httpRequest(this._getUrl(o),{method:"PATCH",data:{fields:o.fields},requestHeaders:this._getRequestHeaders(),error:function(e){return t._raiseError(e,!0)}})}}e.prototype.commitEdit.call(this)};Collection.prototype.remove=function(t){var r=this;if(!this.deferCommits&&t&&t!=this.currentAddItem){var o=this._itemToDoc(t);httpRequest(this._getUrl(o),{method:"DELETE",requestHeaders:this._getRequestHeaders(),success:function(e){return r._totalCount--},error:function(e){return r._raiseError(e,!0)}})}e.prototype.remove.call(this,t)};Collection.prototype.updateFilterDefinition=function(e){this._filterProvider=null;if(this.filterOnServer&&softGridFilter()&&e instanceof softGridFilter().FlexGridFilter){this._filterProvider=e;this._totalCount=null;this.moveCurrentToFirst();this._getData(!0)}};Collection.prototype._getPageView=function(){return this.pageOnServer?this._view:e.prototype._getPageView.call(this)};Collection.prototype._generateID=function(){for(var e="";e.length<20;)e+=Math.random().toString(36).substr(2,5);return e};Collection.prototype._updateHasChanges=function(){var e=this.hasPendingChanges;if(e!=this._hasPendingChanges){this._hasPendingChanges=e;this.onHasPendingChangesChanged()}};Collection.prototype._getData=function(e){var t=this;this._toGetData&&clearTimeout(this._toGetData);this._toGetData=setTimeout((function(){t._toGetData=null;t._loading=!0;if(t.onLoading(new CancelEventArgs)){var r=t.currentPosition;httpRequest(t._getUrl(":runQuery"),{method:"POST",data:t._getQuery(),requestHeaders:t._getRequestHeaders(),success:function(o){var n=JSON.parse(o.responseText),i=t._parseData(n),s=t.pageSize;if(t.pageOnServer&&s&&i.length<s){var a=n[0].skippedResults||0;t._totalCount=a+i.length;if(0==i.length&&t.pageIndex>0){t.moveToLastPage();return}}t.sourceCollection=i;e&&t.moveCurrentToPosition(r);t._loading=!1;t.onLoaded()},error:function(e){return t._raiseError(e,!1)}})}}),Control._REFRESH_INTERVAL)};Collection.prototype._getQuery=function(){var e={from:[{collectionId:this.name}]};this.fields&&this.fields.length&&(e.select={fields:this.fields.map((function(e){return{fieldPath:e}}))});var t=this._fieldFilters;!t.length&&this._filterProvider&&this.filterOnServer&&(t=this._getQueryFilters());t&&t.length&&(e.where=1==t.length?t[0]:{compositeFilter:{filters:t,op:"AND"}});var r=[];t&&t.length&&t.forEach((function(e){var t=e.fieldFilter;"IN"!=t.op&&"EQUAL"!=t.op&&r.push({field:t.field.fieldPath,asc:!0})}));this._orderBy.forEach((function(e){r.push({field:e.property,asc:e.ascending})}));!r.length&&this.sortOnServer&&this.sortDescriptions.forEach((function(e){r.push({field:e.property,asc:e.ascending})}));r.length&&(e.orderBy=r.map((function(e){return{field:{fieldPath:e.field},direction:e.asc?"ASCENDING":"DESCENDING"}})));var o=this.pageSize;if(this.pageOnServer&&o){e.limit=o;e.offset=o*this.pageIndex}!e.limit&&this.limit>0&&(e.limit=this.limit);return{structuredQuery:e}};Collection.prototype._parseData=function(e){var t=this,r=[];isArray(e)&&e.forEach((function(e){var o=t._docToItem(e);o&&r.push(o)}));return r};Collection.prototype._raiseError=function(e,t){this.onError(new RequestErrorEventArgs(e));t&&this._getData(!0)};Collection.prototype._saveDocName=function(e,t){if(e.name&&!t.$META){t.$META={name:e.name};return!0}return!1};Collection.prototype._docToItem=function(e){e.name||(e=e.document);if(!e||!e.name)return null;var t={};this._saveDocName(e,t);for(var r in e.fields)t[r]=this._getDocValue(e.fields[r]);return t};Collection.prototype._getDocValue=function(e){var t=this,r=null;for(var o in e){r=e[o];switch(o){case"integerValue":r=parseInt(r);break;case"timestampValue":r=new Date(r);break;case"mapValue":var n={};for(var i in r.fields)n[i]=this._getDocValue(r.fields[i]);r=n;break;case"arrayValue":r=r.values?r.values.map((function(e){return t._getDocValue(e)})):[]}}return r};Collection.prototype._itemToDoc=function(e){var t={},r=e.$META;r&&r.name&&(t.name=r.name);t.fields={};for(var o in e)"$META"!=o&&(t.fields[o]=this._getValueObject(e[o]));return t};Collection.prototype._getValueObject=function(e){var t=this,r={},o=DataType;switch(getType(e)){case o.String:r.stringValue=e;break;case o.Boolean:r.booleanValue=e;break;case o.Date:r.timestampValue=e.toJSON();break;case o.Number:e==Math.round(e)?r.integerValue=e.toString():r.doubleValue=e;break;case o.Array:r.arrayValue={values:e.map((function(e){return t._getValueObject(e)}))};break;case o.Object:var n={};for(var i in e)n[i]=this._getValueObject(e[i]);r.mapValue={fields:n};break;default:assert(!1,"failed to create value object.")}return r};Collection.prototype._getRequestHeaders=function(){var e={},t=this.store._fbToken||this.store.accessToken;t&&(e.Authorization="Bearer "+t);return e};Collection.prototype._getUrl=function(e){var t="https://firestore.googleapis.com/v1/";if(isObject(e)&&e.name)return t+e.name;e=e||"/"+this.name;return t+"projects/"+this.store.projectId+"/databases/(default)/documents"+e};Collection.prototype._getQueryFilters=function(){var e=[],t=this._filterProvider;if(softGridFilter()&&t instanceof softGridFilter().FlexGridFilter)for(var r=0;r<t.grid.columns.length;r++){var o=t.grid.columns[r],n=t.getColumnFilter(o,!1);if(n&&n.isActive){n.conditionFilter&&n.conditionFilter.isActive?this._getQueryConditionFilter(e,n.conditionFilter):n.valueFilter&&n.valueFilter.isActive&&this._getQueryValueFilter(e,n.valueFilter);break}}return e};Collection.prototype._getQueryConditionFilter=function(e,t){var r=t.column.binding,o=this._getQuerySimpleFilter(t.condition1,r),n=this._getQuerySimpleFilter(t.condition2,r);o&&n&&t.and?e.push({compositeFilter:{op:t.and?"AND":"OR",filters:[o,n]}}):o?e.push(o):n&&e.push(n)};Collection.prototype._getQuerySimpleFilter=function(e,t){return e.isActive?{fieldFilter:{field:{fieldPath:t},op:this._getFilterOperator(e.operator),value:this._getValueObject(e.value)}}:null};Collection.prototype._getFilterOperator=function(e){var t=softGridFilter().Operator;switch(e){case t.EQ:return"EQUAL";case t.GE:return"GREATER_THAN_OR_EQUAL";case t.GT:return"GREATER_THAN";case t.LE:return"LESS_THAN_OR_EQUAL";case t.LT:return"LESS_THAN"}assert(!1,t[e]+" operator not supported (use EQ, GT, GE, LT, or LE)")};Collection.prototype._getQueryValueFilter=function(e,t){var r=t.column,o=r.dataMap,n=[];for(var i in t.showValues){var s=changeType(i,r.dataType,r.format);o&&isString(s)&&(s=o.getKeyValue(s));n.push(s);if(n.length>=10)break}n.length&&e.push({fieldFilter:{field:{fieldPath:r.binding},op:"IN",value:this._getValueObject(n)}})};Collection._filterCulture=null;return Collection}(CollectionView);export{Collection};_registerModule("wijmo.cloud",selfModule);