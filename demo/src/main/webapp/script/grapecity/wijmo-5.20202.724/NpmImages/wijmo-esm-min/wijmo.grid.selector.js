/*!
    *
    * Wijmo Library 5.20202.724
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

var __extends=this&&this.__extends||function(){var extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)}}();import{assert,asType,hasClass,createElement,asBoolean,setChecked,isString,isNumber,copy,closestClass,Event,CancelEventArgs,DataType,_registerModule}from"wijmo/wijmo";import{FlexGrid,Column,GroupRow,CellRange,CellFactory,SelectionMode,HeadersVisibility}from"wijmo/wijmo.grid";import*as selfModule from"wijmo/wijmo.grid.selector";var _CLS_CB_ITEM="wj-column-selector",_CLS_CB_GROUP="wj-column-selector-group",Selector=function(){function Selector(e,t){this._col=null;this._grid=null;this._isFixedCol=!1;this._isBound=!1;this._showCheckAll=!0;this._clickBnd=this._click.bind(this);this._mousedownBnd=this._mousedown.bind(this);this.columnChanging=new Event;this.columnChanged=new Event;this.itemChecked=new Event;this._initialize();this.column=this._getColumn(e);copy(this,t)}Object.defineProperty(Selector.prototype,"column",{get:function(){return this._col},set:function(e){if((e=this._getColumn(e))!=this._col&&this.onColumnChanging(new CancelEventArgs)){var t=this._grid;if(t){var o=t.hostElement;t.formatItem.removeHandler(this._formatItem,this);t.removeEventListener(o,"click",this._clickBnd);t.removeEventListener(o,"mousedown",this._mousedownBnd)}var i=this._col=asType(e,Column,!0);this._grid=t=i?i.grid:null;this._isFixedCol=!!t&&t.columns.indexOf(i)<0;i&&!this._isBound&&(i.allowMerging=!1);t&&!this._isBound&&(t.selectionMode=SelectionMode.Cell);if(t){o=t.hostElement;t.formatItem.addHandler(this._formatItem,this);t.addEventListener(o,"click",this._clickBnd,!0);t.addEventListener(o,"mousedown",this._mousedownBnd,!0)}this.onColumnChanged()}},enumerable:!0,configurable:!0});Object.defineProperty(Selector.prototype,"showCheckAll",{get:function(){return this._showCheckAll},set:function(e){if(e!=this._showCheckAll){this._showCheckAll=asBoolean(e);this._grid&&this._grid.invalidate()}},enumerable:!0,configurable:!0});Selector.prototype.onColumnChanging=function(e){this.columnChanging.raise(this,e);return!e.cancel};Selector.prototype.onColumnChanged=function(e){this.columnChanged.raise(this,e)};Selector.prototype.onItemChecked=function(e){this.itemChecked.raise(this,e)};Selector.prototype._initialize=function(){};Selector.prototype._click=function(e){if(!e.defaultPrevented&&e.target instanceof HTMLElement){var t=this._grid,o=this._col,i=e.target,n=t.hitTest(i);if(o&&n&&n.getColumn()==o){if(i instanceof HTMLInputElement&&hasClass(i,_CLS_CB_ITEM)){var s=void 0,l=n.panel.rows,r=l[n.range.topRow];if(l==t.columnHeaders.rows){s=new CellRange(0,0,t.rows.length-1,0);if(this._isBound){var c=t.selection;c.col=c.col2=o.index;t.select(c)}}else s=this._isGroupRow(r)?r.getCellRange():n.range;if(s.isValid){this._setRangeChecked(i.checked,s);this.onItemChecked()}t.invalidate();e.preventDefault();return}if(hasClass(i,"wj-cell")&&t.bigCheckboxes&&this._isBound&&(this._isFixedCol||this._isGroupRow(n.getRow()))){var a=i.querySelector("input."+_CLS_CB_ITEM);if(a instanceof HTMLInputElement){a.click();e.preventDefault()}}}}};Selector.prototype._mousedown=function(e){var t=this._grid,o=this._col,i=t.editableCollectionView;if(this._isBound&&o&&i&&i.currentEditItem){var n=t.hitTest(e);if(n.getColumn()==o&&this._isGroupRow(n.getRow())){var s=closestClass(e.target,_CLS_CB_GROUP);s instanceof HTMLInputElement&&s.click()}}};Selector.prototype._isGroupRow=function(e){return e instanceof GroupRow&&(!this._grid.childItemsPath||e.getCellRange().rowSpan>1)};Selector.prototype._getRowChecked=function(e,t){void 0===t&&(t=e);for(var o=0,i=0,n=this._col._binding,s=e;s<=t&&(!o||!i);s++){var l=this._grid.rows[s],r=l.dataItem;if(r&&!this._isGroupRow(l)){(this._isBound?n.getValue(r):l.isSelected)?o++:i++}}return!(!o||i)||!(i&&!o)&&null};Selector.prototype._setRangeChecked=function(e,t){var o=this,i=this._grid,n=i.rows,s=this._col,l=s?s._binding:null,r=i.selection,c=this._isBound?i.editableCollectionView:null;if(!this._isBound||!i.isReadOnly&&c&&l){c&&c.beginUpdate();i.deferUpdate((function(){for(var s=t.bottomRow;s>=t.topRow;s--){var r=n[s],a=r.dataItem;if(a)if(o._isGroupRow(r))i.childItemsPath&&!o._isBound&&(r.isSelected=e);else if(o._isBound){c&&c.editItem(a);l.setValue(a,e)}else r.isSelected=e}}));if(c){c.commitEdit();c.endUpdate();i.selection=r}}};Selector.prototype._formatItem=function(e,t){var o=t.getColumn(),i=e.editRange;if(o&&o==this._col&&(!i||!i.contains(t.row,t.col))&&t.panel.rows!=e.columnFooters.rows){var n=t.getRow(),s=t.cell,l="",r=void 0;if(t.panel.rows==e.columnHeaders.rows){if(this._showCheckAll&&t.range.bottomRow==t.panel.rows.length-1){r=this._getRowChecked(0,e.rows.length-1);l=_CLS_CB_ITEM+" "+_CLS_CB_GROUP}}else if(this._isGroupRow(n)){var c=n.getCellRange();r=this._getRowChecked(c.row,c.row2);l=_CLS_CB_ITEM+" "+_CLS_CB_GROUP}else if(n.dataItem&&!this._isBound){r=this._getRowChecked(t.row);l=_CLS_CB_ITEM}if(l){if(this._isFixedCol||this._isBound&&this._isGroupRow(n)){var a=s.querySelector("."+CellFactory._WJC_COLLAPSE);s.textContent="";a&&s.appendChild(a)}var h=createElement('<label><input type="checkbox" class="'+l+'" tabindex="-1"><span></span></label>'),u=h.querySelector("input");setChecked(u,r);if(this._isBound&&(o.isReadOnly||e.selectionMode==SelectionMode.None)){u.disabled=!0;u.style.cursor="default"}s.insertBefore(h,s.firstChild)}}};Selector.prototype._getColumn=function(e){if(e instanceof FlexGrid){var t=e,o=t.rowHeaders.columns;e=t.headersVisibility&HeadersVisibility.Row&&o.length?o[0]:t.columns[0]}this._grid&&(isString(e)||isNumber(e))&&(e=this._grid.getColumn(e));return e instanceof Column?e:null};return Selector}();export{Selector};var BooleanChecker=function(e){__extends(BooleanChecker,e);function BooleanChecker(t,o){return e.call(this,t,o)||this}BooleanChecker.prototype.onColumnChanged=function(t){var o=this.column;assert(!o||o.dataType==DataType.Boolean,"BooleanChecker should be bound to boolean columns");e.prototype.onColumnChanged.call(this,t)};BooleanChecker.prototype._initialize=function(){this._isBound=!0};return BooleanChecker}(Selector);export{BooleanChecker};_registerModule("wijmo.grid.selector",selfModule);