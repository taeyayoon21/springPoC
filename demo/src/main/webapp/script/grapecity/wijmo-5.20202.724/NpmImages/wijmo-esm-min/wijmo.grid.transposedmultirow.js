/*!
    *
    * Wijmo Library 5.20202.724
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

var __extends=this&&this.__extends||function(){var extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)}}();import{assert,copy,asInt,addClass,asArray,hasItems,isArray,toggleClass,toHeaderCase,tryCast,Binding,CollectionView,ObservableArray,NotifyCollectionChangedEventArgs,NotifyCollectionChangedAction,getType,_registerModule}from"wijmo/wijmo";import{MergeManager,CellRange,CellType,Column,Row,AllowDragging,AllowSorting,ColumnCollection,FlexGrid}from"wijmo/wijmo.grid";import*as selfModule from"wijmo/wijmo.grid.transposedmultirow";var _MultiRow=function(e){__extends(_MultiRow,e);function _MultiRow(t,o){var r=e.call(this,t)||this;r._idxData=o;return r}return _MultiRow}(Row);export{_MultiRow};var _Cell=function(e){__extends(_Cell,e);function _Cell(t){var o=e.call(this)||this;o._row=o._col=0;o._rowspan=o._colspan=1;copy(o,t);return o}Object.defineProperty(_Cell.prototype,"row",{get:function(){return this._row},set:function(e){this._row=asInt(e,!1,!0)},enumerable:!0,configurable:!0});Object.defineProperty(_Cell.prototype,"col",{get:function(){return this._col},set:function(e){this._col=asInt(e,!1,!0)},enumerable:!0,configurable:!0});Object.defineProperty(_Cell.prototype,"colspan",{get:function(){return this._colspan},set:function(e){this._colspan=asInt(e,!1,!0);assert(this._colspan>0,"colspan must be >= 1")},enumerable:!0,configurable:!0});Object.defineProperty(_Cell.prototype,"rowspan",{get:function(){return this._rowspan},set:function(e){this._rowspan=asInt(e,!1,!0);assert(this._rowspan>0,"colspan must be >= 1")},enumerable:!0,configurable:!0});return _Cell}(Column);export{_Cell};var _CellGroup=function(e){__extends(_CellGroup,e);function _CellGroup(t,o){var r=e.call(this)||this;r._colstart=0;r._rowstart=0;r._layout=t;r._g=t._grid;copy(r,o);if(!r._cells)throw"Cell group with no cells?";var n=0,l=0;r._cells.forEach((function(e,t){for(;!r._cellFits(e,t,n,l);)0==(l=(l+1)%r.colspan)&&n++;e.row=n;e.col=l}));var i=1,s=1;r._cells.forEach((function(e){i=Math.max(i,e.row+e.rowspan);s=Math.max(s,e.col+e.colspan)}));r.rowspan=i;r.colspan=s;return r}_CellGroup.prototype._copy=function(e,t){var o=this;if("cells"==e){this._cells=[];isArray(t)&&t.forEach((function(e){var t=new _Cell(e);t.binding&&!t.header&&(t.header=toHeaderCase(t.binding));o._cells.push(t);o.colspan=Math.max(o.colspan,t.colspan)}));return!0}return!1};Object.defineProperty(_CellGroup.prototype,"cells",{get:function(){return this._cells},enumerable:!0,configurable:!0});_CellGroup.prototype.closeGroup=function(e){var t=this;if(e>this.colspan){this._cells.forEach((function(o){o.col==t.colspan-1&&(o.colspan=e-o.col)}));this.colspan=e}this._cells.forEach((function(e){for(;e.col+e.colspan<t.colspan&&!t._slotTaken(e.row,e.col+e.colspan);)e.colspan++}));this._cells.forEach((function(e){for(;e.row+e.rowspan<t.rowspan&&!t._slotTaken(e.row+e.rowspan,e.col);)e.rowspan++}));for(var o=0;o<this.rowspan;o++)for(var r=0;r<this.colspan;r++)assert(this._slotTaken(o,r),"Invalid layout (empty cells).");this._cols=new ColumnCollection(this._g,this._g.columns.defaultSize);this._rng=new Array(e*this.rowspan);this._cells.forEach((function(e){for(var o=0;o<e.rowspan;o++)for(var r=0;r<e.colspan;r++){var n=(e.row+o)*t.colspan+(e.col+r);t._cols.setAt(n,e);var l=new CellRange(e.row,e.col,e.row+e.rowspan-1,e.col+e.colspan-1);l.isSingleCell||(t._rng[n]=l)}}));this._rng[-1]=new CellRange(this._rowstart,this._colstart,this._rowstart+this._rowspan-1,this._colstart)};_CellGroup.prototype.getMergedRange=function(e,t,o){if(o<0)return this._rng[-1];var r=t-this._rowstart,n=o%this.colspan,l=this._rng[r*this.colspan+n];e.cellType==CellType.RowHeader&&o++;var i=t-r,s=o-n;return l?new CellRange(i+l.row,s+l.col,i+l.row2,s+l.col2):null};_CellGroup.prototype.getBindingColumn=function(e,t,o){if(o<0)return this;var r=t-this._rowstart,n=o%this.colspan;return this._cols[r*this.colspan+n]};_CellGroup.prototype._cellFits=function(e,t,o,r){if(r>0&&r+e.colspan>this.colspan)return!1;for(var n=0;n<e.colspan;n++)if(this._slotTaken(o,r+n,t))return!1;this.colspan=Math.max(this.colspan,r+e.colspan-1);return!0};_CellGroup.prototype._slotTaken=function(e,t,o){void 0===o&&(o=this._cells.length);for(var r=0;r<o;r++){var n=this._cells[r];if(e>=n.row&&e<=n.row+n.rowspan-1&&t>=n.col&&t<=n.col+n.colspan-1)return!0}return!1};_CellGroup.prototype._updateCellTypes=function(e){this._cols.forEach((function(t){var o=t;null==o.dataType&&o._binding&&(o.dataType=getType(o._binding.getValue(e)))}))};return _CellGroup}(_Cell);export{_CellGroup};var _MergeManager=function(e){__extends(_MergeManager,e);function _MergeManager(){return null!==e&&e.apply(this,arguments)||this}_MergeManager.prototype.getMergedRange=function(e,t,o,r){void 0===r&&(r=!0);var n=e.grid;if(t<0||t>=e.rows.length||o<0||o>=e.columns.length)return null;switch(e.cellType){case CellType.Cell:case CellType.RowHeader:var l=e.rows[t].dataItem._rowInfo.index,i=o;e.cellType==CellType.RowHeader&&i--;var s=n._getGroupByRow(t);assert(s instanceof _CellGroup,"Failed to get the group!");var a=s.getMergedRange(e,l,i);if(a){var u=l,p=t;if(t>0){u=e.rows[t-1].dataItem._rowInfo.index;p=t-1}a.row<=u?a.row=p:a.row=t;var c=l,_=t;if(t<e.rows.length-1){c=e.rows[t+1].dataItem._rowInfo.index;_=t+1}a.row2>=c?a.row2=_:a.row2=t}assert(!a||a.contains(t,o),"Merged range must contain source cell");return a;case CellType.ColumnHeader:var g=n.columnsPerItem,h=o-o%g,f=Math.min(h+g-1,e.columns.length-1);return new CellRange(0,h,e.rows.length-1,f);case CellType.TopLeft:return new CellRange(0,0,e.rows.length-1,e.columns.length-1)}return null};return _MergeManager}(MergeManager);export{_MergeManager};var _MultiRowLayout=function(){function _MultiRowLayout(e,t){this._columnsPerItem=1;this._bindingGroups=[];this._groupsByRow={};this._grid=e;this._bindingGroups=this._parseCellGroups(t)}Object.defineProperty(_MultiRowLayout.prototype,"totalRowSpan",{get:function(){var e=this._bindingGroups;if(e&&e.length){var t=e[e.length-1];return t._rowstart+t.rowspan}return 0},enumerable:!0,configurable:!0});_MultiRowLayout.prototype._parseCellGroups=function(e){var t=[],o=1;if(e){for(var r=0,n=0;r<e.length;r++){var l=new _CellGroup(this,e[r]);l._rowstart=n;n+=l._rowspan;o=Math.max(o,l._colspan);t.push(l)}t.forEach((function(e){e.closeGroup(o)}));this._columnsPerItem=o}return t};_MultiRowLayout.prototype._getGroupByRow=function(e){var t=this._getGroupIndexByRow(e);return t>-1?this._bindingGroups[t]:null};_MultiRowLayout.prototype._getGroupIndexByRow=function(e){var t=this._groupsByRow[e];if(t)return t;for(var o=this._bindingGroups,r=0;r<o.length;r++){var n=o[r];if(e>=n._rowstart&&e<=n._rowstart+n._rowspan-1){this._groupsByRow[e]=r;return r}}return-1};_MultiRowLayout.prototype._updateCellTypes=function(e){this._bindingGroups.forEach((function(t){t._updateCellTypes(e)}))};return _MultiRowLayout}();export{_MultiRowLayout};var TransposedMultiRow=function(e){__extends(TransposedMultiRow,e);function TransposedMultiRow(t,o){var r=e.call(this,t)||this;r._bindingColumns={};r._keyPrefix="item";addClass(r.hostElement,"wj-transposed-multirow");r._layout=new _MultiRowLayout(r,null);r.allowDragging=AllowDragging.None;r.allowSorting=AllowSorting.None;r.mergeManager=new _MergeManager(r);r.formatItem.addHandler(r._formatItem,r);r._rowInfo=new ColumnCollection(r,r.columns.defaultSize);r.initialize(o);r._rowInfo.collectionChanged.addHandler(r._rowInfoChanged,r);return r}Object.defineProperty(TransposedMultiRow.prototype,"layoutDefinition",{get:function(){return this._layoutDef},set:function(e){this._layoutDef=asArray(e);this._layout=new _MultiRowLayout(this,e);this._rowInfoChanged()},enumerable:!0,configurable:!0});TransposedMultiRow.prototype.getBindingColumn=function(e,t,o){if(e.cellType!=CellType.Cell)return null;var r=e.rows[t].dataItem._rowInfo.index,n=r+"_"+o,l=this._bindingColumns[n];if(l)return l;var i=this._getGroupByRow(t).getBindingColumn(e,r,o);if(i){l=new Column;FlexGrid._getSerializableProperties(Column).forEach((function(e){null!=i[e]&&(l[e]=i[e])}));var s=Math.floor(o/this.columnsPerItem),a=o%this.columnsPerItem;l.binding=this._keyPrefix+s+"_"+a;this._bindingColumns[n]=l}return l};Object.defineProperty(TransposedMultiRow.prototype,"columnsPerItem",{get:function(){return this._layout._columnsPerItem},enumerable:!0,configurable:!0});Object.defineProperty(TransposedMultiRow.prototype,"allowAddNew",{get:function(){return!1},set:function(e){assert(!e,"TransposedMultiRow does not support items addition.")},enumerable:!0,configurable:!0});Object.defineProperty(TransposedMultiRow.prototype,"allowDelete",{get:function(){return!1},set:function(e){assert(!e,"TransposedMultiRow does not support items deletion.")},enumerable:!0,configurable:!0});Object.defineProperty(TransposedMultiRow.prototype,"allowDragging",{get:function(){return AllowDragging.None},set:function(e){assert(e===AllowDragging.None,"TransposedMultiRow does not support dragging.");if(e!==this._alDragging){this._alDragging=e;this.invalidate()}},enumerable:!0,configurable:!0});Object.defineProperty(TransposedMultiRow.prototype,"allowPinning",{get:function(){return!1},set:function(e){assert(!e,"TransposedMultiRow does not support pinning.")},enumerable:!0,configurable:!0});Object.defineProperty(TransposedMultiRow.prototype,"allowSorting",{get:function(){return AllowSorting.None},set:function(e){assert(e===AllowSorting.None,"TransposedMultiRow does not support sorting.");this._alSorting=e},enumerable:!0,configurable:!0});Object.defineProperty(TransposedMultiRow.prototype,"columnLayout",{get:function(){throw"TransposedMultiRow does not support column layout."},set:function(e){throw"TransposedMultiRow does not support column layout."},enumerable:!0,configurable:!0});TransposedMultiRow.prototype.refresh=function(t){var o=this._rowInfo;if(o._dirty){o._dirty=!1;this._rowInfoChanged()}else e.prototype.refresh.call(this,t)};TransposedMultiRow.prototype.onLoadedRows=function(t){for(var o=this,r=this.columnHeaders.columns,n=0;n<r.length;n++)this.columnHeaders.setCellData(0,n,"");var l=this.columns;for(n=0;n<l.length;n++){var i=l[n];i.align=null;i.dataType=0}var s=this.rowHeaders.columns;this.rows.forEach((function(e){var t=e.dataItem._rowInfo;if(t)for(var r=s.length-2;r>=0;r--){var n=t.headers[r]||toHeaderCase(t.bindings[r]);o.rowHeaders.setCellData(e.index,r+1,n)}}));s[0].visible=!1;for(n=1;n<s.length;n++){s[n].align="left";s[n].visible=!0;s[n].width=this.columns.defaultSize}e.prototype.onLoadedRows.call(this,t)};TransposedMultiRow.prototype._getGroupByRow=function(e){var t=this.cells.rows[e].dataItem._rowInfo.index,o=this._layout._getGroupByRow(t);assert(o instanceof _CellGroup,"Failed to get the group!");return o};TransposedMultiRow.prototype._addBoundRow=function(e,t){var o=e[t];this.rows.push(new _MultiRow(o,t))};TransposedMultiRow.prototype._updateColumnTypes=function(){e.prototype._updateColumnTypes.call(this);var t=this.collectionView;if(hasItems(t)&&this._layout){var o=t.items[0]._arr;o&&o.length>0&&this._layout._updateCellTypes(o[0])}};TransposedMultiRow.prototype._getBindingColumn=function(t,o,r){if(this._layout){t==this.cells&&(r=this.getBindingColumn(t,o,r.index));return r}return e.prototype._getBindingColumn.call(this,t,o,r)};TransposedMultiRow.prototype._getCollectionView=function(t){var o=null;null!=this._view&&this._view.collectionChanged.removeHandler(this._sourceViewChanged);if(isArray(t))t=this._transposeItemsSource(t);else if(t){this._view&&this._view.collectionChanged.removeHandler(this._sourceViewChanged);this._view=tryCast(t,"ICollectionView");if(this._view){this._view.collectionChanged.addHandler(this._sourceViewChanged,this);t instanceof CollectionView&&(o=t.getError);t=this._transposeItemsSource(this._view.items)}}this.autoGenerateColumns=!0;var r=e.prototype._getCollectionView.call(this,t);o&&r instanceof CollectionView&&(r.getError=function(e,t){var r=e._keys.indexOf(t),n=r%e._bnd.length,l=Math.floor(r/e._bnd.length);return o(e._arr[l],e._bnd[n].path)});return r};TransposedMultiRow.prototype._rowInfoChanged=function(){var e=this.selection,t=this.itemsSource;this._bindingColumns={};this.itemsSource=null;this.itemsSource=t;e&&e.isValid&&(this.selection=e)};TransposedMultiRow.prototype._formatItem=function(e,t){var o=this.columnsPerItem,r=t.panel,n=r.cellType,l=r.rows[t.range.row],i=(r.rows[t.range.row2],t.cell);n==CellType.RowHeader&&toggleClass(i,"wj-group-header",0==t.range.row);if(n==CellType.Cell||n==CellType.RowHeader){var s=this._getGroupByRow(t.row);toggleClass(i,"wj-group-start",s._rowstart==t.range.row);toggleClass(i,"wj-group-end",s._rowstart+s._rowspan-1==t.range.row2)}if(o>1&&(n==CellType.Cell||n==CellType.ColumnHeader)){toggleClass(i,"wj-record-start",t.range.col%o==0);toggleClass(i,"wj-record-end",t.range.col2%o==o-1)}var a=this.alternatingRowStep;if(a&&n==CellType.Cell){var u=this._layout.totalRowSpan,p=this._layout._bindingGroups.length,c=Math.floor(l.dataIndex/u)*p,_=l.dataIndex%u;c+=this._layout._getGroupIndexByRow(_)+1;toggleClass(i,"wj-alt",c%(a+1)==0)}};TransposedMultiRow.prototype._sourceViewChanged=function(e,t){this.activeEditor||this.invalidate()};TransposedMultiRow.prototype._transposeItemsSource=function(e){var t=this,o=new ObservableArray;if(this._layout&&this._layout._bindingGroups.length){this._getRowInfo(e).forEach((function(r,n){var l=t._createKeys(e);if(t._supportsProxies()){var i=t._createProxy(e,r,l);o.push(i)}else{var s=t._createTransposedObject(e,r,l);o.push(s)}}));e instanceof ObservableArray&&e.collectionChanged.addHandler((function(){var e=new NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Reset);o.onCollectionChanged(e);t._rowInfoChanged()}))}return o};TransposedMultiRow.prototype._createKeys=function(e){var t=this,o=Array.apply(null,{length:this.columnsPerItem}),r=e.map((function(e,r){return o.map((function(e,o){return t._keyPrefix+r+"_"+o}))}));return[].concat.apply([],r)};TransposedMultiRow.prototype._supportsProxies=function(){return null!=window.Proxy};TransposedMultiRow.prototype._createProxy=function(e,t,o){var r={_arr:e,_rowInfo:t,_bnd:t.bindings.map((function(e){return new Binding(e)})),_keys:o};return new Proxy(r,{ownKeys:function(e){return e._keys},getOwnPropertyDescriptor:function(){return{enumerable:!0,configurable:!0,writable:!0}},get:function(e,t){var o=e._keys.indexOf(t);if(o>-1){var r=e._bnd,n=e._arr,l=r.length,i=o%l,s=Math.floor(o/l);return r[i].getValue(n[s])}return e[t]},set:function(e,t,o){var r=e._keys.indexOf(t);if(r>-1){var n=e._bnd,l=e._arr,i=n.length,s=r%i,a=Math.floor(r/i);n[s].setValue(l[a],o);if(l instanceof ObservableArray){var u=new NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Change,l[a],a);l.onCollectionChanged(u)}return!0}return!1}})};TransposedMultiRow.prototype._createTransposedObject=function(e,t,o){for(var r={_arr:e,_rowInfo:t,_bnd:t.bindings.map((function(e){return new Binding(e)})),_keys:o},_loop_1=function(t){var n=o[t];Object.defineProperty(r,n,{enumerable:!0,get:function(){var o=r._bnd,n=o.length,l=t%n,i=Math.floor(t/n);return o[l].getValue(e[i])},set:function(o){var n=r._bnd,l=n.length,i=t%l,s=Math.floor(t/l);n[i].setValue(e[s],o);if(e instanceof ObservableArray){var a=new NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Change,e[s],s);e.onCollectionChanged(a)}return!0}})},n=0;n<o.length;n++)_loop_1(n);return r};TransposedMultiRow.prototype._getRowInfo=function(e){var t=[];if(this._layout){for(var o=this.rowHeaders.columns,r=this.columnsPerItem+1;o.length>r;)o.removeAt(o.length-1);for(;o.length<r;)o.push(new Column);this._layout._bindingGroups.forEach((function(e){for(var o=0;o<e.rowspan;o++){for(var r={index:e._rowstart+o,bindings:[],headers:[]},n=0;n<e.colspan;n++)for(var l=0;l<e.cells.length;l++){var i=e.cells[l];if(o>=i.row&&o<i.row+i.rowspan&&n>=i.col&&n<i.col+i.colspan){r.bindings.push(i.binding);r.headers.push(i.header);break}}t.push(r)}}))}return t};return TransposedMultiRow}(FlexGrid);export{TransposedMultiRow};_registerModule("wijmo.grid.transposedmultirow",selfModule);